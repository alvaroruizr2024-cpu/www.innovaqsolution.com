<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SumaERP - Sistema ERP</title>
    <meta name="description" content="SumaERP - ERP Peru Comercio Exterior SIRE">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>Σ</text></svg>">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/prop-types@15/prop-types.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body, #root { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
const { useState, useMemo, useCallback, useEffect, useRef, createContext, useContext } = React;
const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell, PieChart, Pie, LineChart, Line, CartesianGrid, Legend, AreaChart, Area, RadarChart, Radar, PolarGrid, PolarAngleAxis, PolarRadiusAxis, ScatterChart, Scatter, ZAxis, ComposedChart } = Recharts;


/* Lucide-compatible SVG icon factory for ComEx module */
const _ic = (paths) => ({ className = "", style, ...props } = {}) => (
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={{ display: "inline-block", verticalAlign: "middle", ...style }} {...props}>{paths}</svg>
);
const Package = _ic(<><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></>);
const Ship = _ic(<><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0021 14l-9-4-9 4c0 2.9.94 5.34 2.81 7.76"/><path d="M19 13V7a2 2 0 00-2-2H7a2 2 0 00-2 2v6"/><path d="M12 1v4"/></>);
const FileText = _ic(<><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>);
const Calculator = _ic(<><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="8" y2="10"/><line x1="12" y1="10" x2="12" y2="10"/><line x1="16" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/><line x1="12" y1="18" x2="16" y2="18"/></>);
const AlertTriangle = _ic(<><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>);
const Clock = _ic(<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>);
const DollarSign = _ic(<><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></>);
const TrendingUp = _ic(<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>);
const CheckCircle = _ic(<><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>);
const XCircle = _ic(<><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></>);
const ChevronRight = _ic(<polyline points="9 18 15 12 9 6"/>);
const ChevronDown = _ic(<polyline points="6 9 12 15 18 9"/>);
const ChevronLeft = _ic(<polyline points="15 18 9 12 15 6"/>);
const Plus = _ic(<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>);
const Trash2 = _ic(<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>);
const Edit3 = _ic(<><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></>);
const RefreshCw = _ic(<><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></>);
const Download = _ic(<><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>);
const Upload = _ic(<><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>);
const Search = _ic(<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>);
const Filter = _ic(<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>);
const ArrowUpDown = _ic(<><path d="M7 3v18"/><path d="M3 7l4-4 4 4"/><path d="M17 21V3"/><path d="M21 17l-4 4-4-4"/></>);
const BarChart3 = _ic(<><rect x="3" y="12" width="4" height="9" rx="1"/><rect x="10" y="7" width="4" height="14" rx="1"/><rect x="17" y="3" width="4" height="18" rx="1"/></>);
const PieChartIcon = _ic(<><path d="M21.21 15.89A10 10 0 118 2.83"/><path d="M22 12A10 10 0 0012 2v10z"/></>);
const Calendar = _ic(<><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>);
const Globe = _ic(<><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></>);
const Anchor = _ic(<><circle cx="12" cy="5" r="3"/><line x1="12" y1="22" x2="12" y2="8"/><path d="M5 12H2a10 10 0 0020 0h-3"/></>);
const Warehouse = _ic(<><path d="M22 8.35V20a2 2 0 01-2 2H4a2 2 0 01-2-2V8.35A2 2 0 013.26 6.5l8-3.2a2 2 0 011.48 0l8 3.2A2 2 0 0122 8.35z"/><path d="M6 18h12"/><path d="M6 14h12"/></>);
const FileSpreadsheet = _ic(<><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></>);
const AlertCircle = _ic(<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>);
const Info = _ic(<><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>);
const Check = _ic(<polyline points="20 6 9 17 4 12"/>);
const X = _ic(<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>);
const Eye = _ic(<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>);
const Lock = _ic(<><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></>);
const Unlock = _ic(<><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 019.9-1"/></>);
const History = _ic(<><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 106 5.3L3 8"/><path d="M12 7v5l4 2"/></>);
const ExternalLink = _ic(<><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></>);
const Settings = _ic(<><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></>);
const Layers = _ic(<><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>);
const Save = _ic(<><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>);
const FileDown = _ic(<><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 18 15 15"/></>);
const Loader2 = _ic(<path d="M21 12a9 9 0 11-6.219-8.56"/>);
const Bell = _ic(<><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></>);

const P = { bg: "#05070c", c1: "#0a0e17", c2: "#0f1520", c3: "#141c2c", bd: "#1a2540", hv: "#111b30", tx: "#d6e0f0", s1: "#8095b3", s2: "#4a6080", blue: "#0A84FF", grn: "#32D74B", org: "#FF9F0A", red: "#FF453A", pur: "#BF5AF2", cyan: "#64D2FF", yel: "#FFD60A", tl: "#2AC7B8", pk: "#FF375F", lime: "#A8E06C" };
const nn = v => (typeof v === "number" ? v : parseFloat(v) || 0);
const $ = (v, c = "PEN") => { const p = c === "USD" ? "US$ " : c === "EUR" ? "€ " : "S/ "; return p + Math.abs(nn(v)).toLocaleString("es-PE", { minimumFractionDigits: 2, maximumFractionDigits: 2 }); };
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
const today = () => new Date().toISOString().slice(0, 10);
const TC = 3.742;
const pct = (a, b) => b > 0 ? ((a / b) * 100).toFixed(1) + "%" : "0%";

const sv = ch => () => (<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">{ch}</svg>);
const I = {
  Da: sv(<g><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></g>),
  Sa: sv(<g><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></g>),
  Bx: sv(<path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>),
  Iv: sv(<path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>),
  Pp: sv(<g><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></g>),
  Gl: sv(<g><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></g>),
  Cd: sv(<g><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></g>),
  Sh: sv(<g><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.4 14.6V8a2 2 0 00-2-2H6.6a2 2 0 00-2 2v6.6"/><line x1="12" y1="2" x2="12" y2="6"/></g>),
  Tk: sv(<g><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></g>),
  Bk: sv(<g><path d="M3 21h18"/><path d="M3 10h18"/><path d="M5 6l7-3 7 3"/><path d="M4 10v11"/><path d="M20 10v11"/><path d="M8 14v3"/><path d="M12 14v3"/><path d="M16 14v3"/></g>),
  Bo: sv(<g><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></g>),
  Cl: sv(<g><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="10" y2="10"/><line x1="14" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="10" y2="14"/><line x1="14" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="16" y2="18"/></g>),
  Dl: sv(<g><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></g>),
  Sp: sv(<g><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 012 2v7"/><path d="M6 9v12"/></g>),
  Se: sv(<g><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></g>),
  Db: sv(<g><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></g>),
  Dw: sv(<g><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></g>),
  Sc: sv(<g><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></g>),
  Lo: sv(<g><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></g>),
  Fl: sv(<g><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></g>),
  St: sv(<g><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></g>),
  Cr: sv(<g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>),
  Ge: sv(<g><circle cx="12" cy="12" r="3"/><path d="M12 1v2m0 18v2m-9-11h2m18 0h2m-4.2-5.8l-1.4 1.4M6.6 17.4l-1.4 1.4m0-13.6l1.4 1.4m10.8 10.8l1.4 1.4"/></g>),
  Im: sv(<g><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></g>),
  Ht: sv(<g><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></g>),
  Aw: sv(<g><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></g>),
  Br: sv(<g><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></g>),
  Ky: sv(<g><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.778 7.778 5.5 5.5 0 017.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></g>),
  Tg: sv(<g><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></g>),
  Us: sv(<g><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></g>),
  Gd: sv(<g><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></g>),
  Ai: sv(<g><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></g>),
  Hm: sv(<g><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></g>),
  Wh: sv(<g><path d="M3 3h18v7H3z"/><path d="M3 10h18v11H3z"/><path d="M8 10v11"/><path d="M16 10v11"/><path d="M12 3v7"/></g>),
  Cp: sv(<g><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></g>),
  Cg: sv(<g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 114 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></g>),
  Pl: () => (<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>),
  Ed: () => (<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>),
  Tr: () => (<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>),
  Ck: () => (<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="20 6 9 17 4 12"/></svg>),
  Wn: () => (<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#FF9F0A" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>),
  Xx: () => (<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>),
};

const GoogleIcon = () => (<svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>);
const YapeIcon = () => (<svg width="22" height="22" viewBox="0 0 40 40"><circle cx="20" cy="20" r="20" fill="#6C2DC7"/><text x="20" y="26" textAnchor="middle" fill="#fff" fontSize="16" fontWeight="800" fontFamily="sans-serif">Y</text></svg>);

/* UI */
function Badge({ s, c: cl }) {
  const cm = { Emitida: P.blue, Pagada: P.grn, Pagado: P.grn, Pendiente: P.org, Anulada: P.red, "En Transito": P.pur, Activo: P.grn, Nacionalizado: P.cyan, Aprobada: P.grn, Cesado: P.red, Vacaciones: P.cyan, Borrador: P.s2, Corriente: P.blue, Ahorro: P.grn, CTS: P.org, Documentacion: P.org, FREE: P.org, BASICO: P.blue, PRO: P.pur, EMPRESA: P.tl, "En Proceso": P.org, Aprobado: P.grn, Rechazado: P.red, Vigente: P.grn, Vencido: P.red, "Por Vencer": P.org, Abierta: P.blue, Cerrada: P.s2, Presente: P.grn, Ausente: P.red, Tardanza: P.org, Falta: P.red, Permiso: P.cyan, Alta: P.red, Media: P.org, Baja: P.grn, Completado: P.grn, Onboarding: P.cyan, "Periodo Prueba": P.org, Contratado: P.grn, Descartado: P.red, Finalista: P.pur, Entrevista: P.blue, Postulante: P.s2,
    EN_EJECUCION: P.blue, PROGRAMADA: P.org, CONFORME: P.grn, CUARENTENA: P.org, "EN_INSPECCIÓN": P.org, APROBADO: P.grn, RECHAZADO: P.red, OK_STOCK: P.grn, COMPRA: P.red, VENCIDO: P.red, PROXIMO: P.org, OK: P.grn, MATERIAL: P.blue, CENTRAL: P.pur, OBRA: P.org, PANIOL: P.tl, ENVIADA: P.blue, ESTRUCTURAS: P.blue, ARQUITECTURA: P.org, "NC - Deformación": P.red, HERRAMIENTA: P.cyan, EQUIPO: P.pur };
  const cc = cl || cm[s] || P.s2;
  return (<span style={{ background: cc + "14", color: cc, border: `1px solid ${cc}25`, padding: "2px 7px", borderRadius: 4, fontSize: 9.5, fontWeight: 600, whiteSpace: "nowrap", letterSpacing: .2 }}>{s}</span>);
}

function K({ l, v, icon, color: c, sub: s, onClick: oc, glow, mini }) {
  return (
    <div onClick={oc} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 9, padding: mini ? "8px 10px" : "12px 14px", position: "relative", overflow: "hidden", cursor: oc ? "pointer" : "default", boxShadow: glow ? `0 0 20px ${c}12` : "none" }}
      onMouseEnter={e => { if (oc) e.currentTarget.style.borderColor = c + "50"; }} onMouseLeave={e => { e.currentTarget.style.borderColor = P.bd; }}>
      <div style={{ position: "absolute", top: -12, right: -12, width: 50, height: 50, background: `radial-gradient(circle,${c}0c,transparent 70%)`, borderRadius: "50%" }} />
      <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}>
        <span style={{ color: P.s1, fontSize: 9, fontWeight: 600, textTransform: "uppercase", letterSpacing: .5 }}>{l}</span>
        <span style={{ color: c, opacity: .4 }}>{icon}</span>
      </div>
      <div style={{ fontSize: mini ? 14 : 16, fontWeight: 700, letterSpacing: -.3 }}>{v}</div>
      {s && <div style={{ fontSize: 9, color: P.s2, marginTop: 2 }}>{s}</div>}
    </div>
  );
}

function Btn({ children, p, d, s, g, onClick: oc, dis, full, style: st }) {
  return (<button disabled={dis} onClick={oc} style={{ background: d ? "linear-gradient(135deg,#FF453A,#c33)" : p ? "linear-gradient(135deg,#0A84FF,#06c)" : g ? "transparent" : P.c2, color: p || d ? "#fff" : g ? P.blue : "#6b7a94", border: p || d ? "none" : g ? "none" : `1px solid ${P.bd}`, borderRadius: 6, padding: s ? "3px 8px" : "6px 12px", fontSize: s ? 9.5 : 10.5, fontWeight: 600, cursor: dis ? "not-allowed" : "pointer", display: "inline-flex", alignItems: "center", justifyContent: "center", gap: 4, opacity: dis ? .5 : 1, whiteSpace: "nowrap", width: full ? "100%" : "auto", ...st }}>{children}</button>);
}

function Inp({ l, v, onChange: oc, type: t = "text", opts, ro, req, ph, w }) {
  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 3, minWidth: w || "auto" }}>
      {l && <label style={{ color: P.s1, fontSize: 8.5, fontWeight: 600, textTransform: "uppercase", letterSpacing: .4 }}>{l}{req && <span style={{ color: P.red }}>*</span>}</label>}
      {opts ? (<select value={v || ""} onChange={e => oc(e.target.value)} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 5, padding: "7px 9px", color: P.tx, fontSize: 11, outline: "none" }}><option value="">—</option>{opts.map(o => <option key={o} value={o}>{o}</option>)}</select>
      ) : (<input type={t} value={v || ""} onChange={e => oc(e.target.value)} placeholder={ph} readOnly={ro} style={{ background: ro ? P.bg : P.c1, border: `1px solid ${P.bd}`, borderRadius: 5, padding: "7px 9px", color: ro ? P.s2 : P.tx, fontSize: 11, outline: "none", width: "100%", boxSizing: "border-box" }} />)}
    </div>
  );
}

function G({ children, c: cols = 2 }) { return (<div style={{ display: "grid", gridTemplateColumns: `repeat(${cols},1fr)`, gap: 10 }}>{children}</div>); }

function Modal({ open, onClose, title, children, wide, xwide }) {
  if (!open) return null;
  return (
    <div style={{ position: "fixed", inset: 0, zIndex: 1000, display: "flex", alignItems: "center", justifyContent: "center" }}>
      <div style={{ position: "absolute", inset: 0, background: "rgba(0,0,0,.65)", backdropFilter: "blur(4px)" }} onClick={onClose} />
      <div onClick={e => e.stopPropagation()} style={{ position: "relative", background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 12, width: xwide ? 850 : wide ? 700 : 460, maxHeight: "88vh", display: "flex", flexDirection: "column", boxShadow: "0 25px 60px rgba(0,0,0,.5)" }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "12px 18px", borderBottom: `1px solid ${P.bd}` }}>
          <span style={{ fontSize: 13, fontWeight: 700 }}>{title}</span>
          <button onClick={onClose} style={{ background: "none", border: "none", color: P.s2, cursor: "pointer" }}><I.Xx /></button>
        </div>
        <div style={{ flex: 1, overflow: "auto", padding: "16px 18px" }}>{children}</div>
      </div>
    </div>
  );
}

function Toast({ msg, type, onDone }) {
  useEffect(() => { const t = setTimeout(onDone, 3000); return () => clearTimeout(t); }, [onDone]);
  const c = type === "ok" ? P.grn : type === "err" ? P.red : P.blue;
  return (<div style={{ position: "fixed", bottom: 20, right: 20, zIndex: 2000, background: c + "18", border: `1px solid ${c}30`, borderRadius: 8, padding: "10px 16px", color: c, fontSize: 11, fontWeight: 600, display: "flex", alignItems: "center", gap: 6, boxShadow: `0 6px 24px ${c}12`, maxWidth: 380 }}>{type === "ok" ? <I.Ck /> : <I.Wn />}{msg}</div>);
}

function Confirm({ open, msg, onYes, onNo, btnText }) {
  if (!open) return null;
  return (<div style={{ position: "fixed", inset: 0, zIndex: 1100, display: "flex", alignItems: "center", justifyContent: "center" }}><div style={{ position: "absolute", inset: 0, background: "rgba(0,0,0,.6)" }} onClick={onNo} /><div onClick={e => e.stopPropagation()} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 10, padding: 20, width: 360, boxShadow: "0 20px 50px rgba(0,0,0,.5)" }}><div style={{ color: P.tx, fontSize: 13, marginBottom: 14 }}>{msg}</div><div style={{ display: "flex", gap: 8, justifyContent: "flex-end" }}><Btn onClick={onNo}>Cancelar</Btn><Btn d onClick={onYes}>{btnText || "Confirmar"}</Btn></div></div></div>);
}

function Tabs({ tabs, active, onChange }) {
  return (<div style={{ display: "flex", gap: 2, background: P.c2, borderRadius: 7, padding: 3, border: `1px solid ${P.bd}` }}>
    {tabs.map(t => (<button key={t.id} onClick={() => onChange(t.id)} style={{ background: active === t.id ? P.blue + "18" : "transparent", color: active === t.id ? P.blue : P.s2, border: active === t.id ? `1px solid ${P.blue}30` : "1px solid transparent", borderRadius: 5, padding: "5px 10px", fontSize: 9.5, fontWeight: 600, cursor: "pointer", display: "flex", alignItems: "center", gap: 4 }}>{t.icon}{t.l}</button>))}
  </div>);
}

function ProgressBar({ value, max, color, label }) {
  const p = max > 0 ? (value / max) * 100 : 0;
  return (<div style={{ display: "flex", alignItems: "center", gap: 6, width: "100%" }}>
    {label && <span style={{ fontSize: 9, color: P.s1, minWidth: 60 }}>{label}</span>}
    <div style={{ flex: 1, height: 6, background: P.c2, borderRadius: 3, overflow: "hidden" }}><div style={{ height: "100%", width: `${Math.min(p, 100)}%`, background: color || P.blue, borderRadius: 3, transition: "width .3s" }} /></div>
    <span style={{ fontSize: 9, color: color, fontWeight: 600, minWidth: 30 }}>{p.toFixed(0)}%</span>
  </div>);
}

/* ===== HR DATA ===== */
const initHR = () => ({
  empleados: [],
  requisiciones: [],
  postulantes: [],
  asistencia: [],
  vacaciones: [],
  capacitaciones: [],
  prestamos: [],
  solicitudesESS: [],
});

/* PAYROLL ENGINE */
function calcNomina(emp) {
  const s = nn(emp.sueldo), as2 = nn(emp.asignacion), bo = nn(emp.bonos);
  const bruto = s + as2 + bo;
  const onp = s * .13;
  const essalud = s * .09;
  const vidaLey = s > 0 ? 12.5 : 0;
  const afp = emp.cuspp ? s * .1321 : 0;
  const retQuinta = bruto > 2616.67 ? ((bruto * 12 - 31400) * .08) / 12 : 0;
  const prestDescuento = 0;
  const totalDeducciones = (emp.cuspp ? afp : onp) + retQuinta + prestDescuento + vidaLey;
  const neto = bruto - totalDeducciones;
  const costoEmpresa = bruto + essalud + (bruto / 12) + (bruto / 12) + (bruto * .0833);
  return { bruto, onp, afp, essalud, vidaLey, retQuinta, totalDeducciones, neto, costoEmpresa, cts: bruto * .0833, gratificacion: bruto / 6 };
}

/* CAPTURE DASHBOARD */
function captureEl(el, type = "png") {
  if (!el) return;
  const c = document.createElement("canvas");
  const s = 2;
  c.width = el.offsetWidth * s; c.height = el.offsetHeight * s;
  const ctx = c.getContext("2d");
  ctx.scale(s, s); ctx.fillStyle = P.bg; ctx.fillRect(0, 0, el.offsetWidth, el.offsetHeight);
  const data = new XMLSerializer().serializeToString(el);
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${el.offsetWidth}" height="${el.offsetHeight}"><foreignObject width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="font-family:sans-serif">${data}</div></foreignObject></svg>`;
  const img = new Image();
  img.onload = () => {
    ctx.drawImage(img, 0, 0);
    c.toBlob(blob => {
      if (blob && navigator.clipboard?.write) {
        navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]).then(() => {
          if (_exportModalSetter) _exportModalSetter({ imageMode: true, imageType: type });
        }).catch(() => {
          if (_exportModalSetter) _exportModalSetter({ imageMode: true, imageType: type, fallback: true });
        });
      } else {
        if (_exportModalSetter) _exportModalSetter({ imageMode: true, imageType: type, fallback: true });
      }
    }, type === "jpg" ? "image/jpeg" : "image/png", .95);
  };
  img.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

/* EXPORT CSV */
let _exportModalSetter = null;
function exportCSV(data, cols, fn) {
  const headers = cols.map(c => c.l);
  const rows = data.map(row => cols.map(c => row[c.k] ?? ""));
  const numCols = new Set(cols.map((c, i) => ["subtotal", "igv", "total", "baseImponible", "mtoIGV", "mtoTotal", "mtoBase", "tipoCambio", "Monto"].includes(c.k) ? i : -1).filter(i => i >= 0));
  let tsv = headers.join("\t") + "\n";
  rows.forEach(r => { tsv += r.map(c => String(c ?? "").replace(/\t/g, " ").replace(/\n/g, " ")).join("\t") + "\n"; });
  if (_exportModalSetter) { _exportModalSetter({ content: tsv, filename: fn, headers, rows, numCols }); }
}

/* SIRE */
const SIRE_V = [{ k: "periodo", l: "Periodo" }, { k: "cuo", l: "CUO" }, { k: "correlativo", l: "Correlativo" }, { k: "fechaEmision", l: "Fec.Emision" }, { k: "tipoCdp", l: "TipoCDP" }, { k: "serie", l: "Serie" }, { k: "numero", l: "Numero" }, { k: "tipoDocCli", l: "TipoDoc" }, { k: "numDocCli", l: "NumDoc" }, { k: "razonSocial", l: "RazonSocial" }, { k: "baseImponible", l: "BaseImp" }, { k: "igv", l: "IGV" }, { k: "total", l: "Total" }, { k: "moneda", l: "Moneda" }, { k: "tipoCambio", l: "TC" }, { k: "estado", l: "Estado" }];
const SIRE_C = [{ k: "periodo", l: "Periodo" }, { k: "cuo", l: "CUO" }, { k: "correlativo", l: "Correlativo" }, { k: "fechaEmision", l: "Fec.Emision" }, { k: "tipoCdp", l: "TipoCDP" }, { k: "serie", l: "Serie" }, { k: "numero", l: "Numero" }, { k: "tipoDocProv", l: "TipoDoc" }, { k: "numDocProv", l: "NumDoc" }, { k: "razonSocial", l: "RazonSocial" }, { k: "baseImponible", l: "BaseImp" }, { k: "igv", l: "IGV" }, { k: "total", l: "Total" }, { k: "moneda", l: "Moneda" }, { k: "tipoCambio", l: "TC" }, { k: "dua", l: "DUA" }, { k: "estado", l: "Estado" }];
const TCPD = { Factura: "01", Boleta: "03", "Nota Credito": "07", "Nota Debito": "08" };

/* PLANS */
const PLANS = [
  { id: "free", name: "Free Trial", price: 0, period: "7 dias", color: P.org, icon: <I.Cr />, features: ["Dashboard basico", "5 facturas/mes", "1 usuario", "Soporte email"], badge: "7 DIAS GRATIS" },
  { id: "basico", name: "Basico", price: 89, period: "/mes", color: P.blue, icon: <I.St />, features: ["Ventas + Compras SIRE", "50 facturas/mes", "3 usuarios", "Export Google Sheets", "Soporte prioritario"], popular: false },
  { id: "pro", name: "Profesional", price: 189, period: "/mes", color: P.pur, icon: <I.Sp />, features: ["Todo en Basico", "Facturas ilimitadas", "10 usuarios", "Comercio Exterior", "Contabilidad PCGE", "Landed Cost Engine", "Dashboard Pro"], popular: true },
  { id: "empresa", name: "Empresa", price: 389, period: "/mes", color: P.tl, icon: <I.Gl />, features: ["Todo en Pro", "Usuarios ilimitados", "Multi-empresa", "API acceso", "BD completa", "Soporte 24/7", "Implementacion"], popular: false },
];

/* ===== EMPRESAS CLIENTES ===== */
const EMPRESAS_CLIENTES = [
  { ruc: "20612044326", razon: "SERVICIOS W&G SAC", tipo: "SAC", sector: "Servicios", estado: "Activo", plan: "PRO", color: "#0A84FF" },
  { ruc: "20604890471", razon: "TRANSPORTES YURIKO SAC", tipo: "SAC", sector: "Transporte", estado: "Activo", plan: "BASICO", color: "#32D74B" },
  { ruc: "20604557829", razon: "IVAO CONSTRUCTORA SAC", tipo: "SAC", sector: "Construccion", estado: "Activo", plan: "PRO", color: "#FF9F0A" },
  { ruc: "20606826436", razon: "E&J RAMOS CONSTRUCTORA SAC", tipo: "SAC", sector: "Construccion", estado: "Activo", plan: "BASICO", color: "#BF5AF2" },
  { ruc: "20605878483", razon: "GRUPO EDUCATIVO SAN GABRIEL", tipo: "Asociacion", sector: "Educacion", estado: "Activo", plan: "PRO", color: "#64D2FF" },
  { ruc: "20602317596", razon: "INVERSIONES TURISTICAS SC 77", tipo: "SAC", sector: "Turismo", estado: "Activo", plan: "BASICO", color: "#FFD60A" },
  { ruc: "20603968981", razon: "COOPAC DANPER", tipo: "Cooperativa", sector: "Financiero", estado: "Activo", plan: "EMPRESA", color: "#2AC7B8" },
  { ruc: "10712856241", razon: "ASMAD RODRIGUEZ VERONICA", tipo: "Persona Natural", sector: "Independiente", estado: "Activo", plan: "BASICO", color: "#FF375F" },
  { ruc: "20607184705", razon: "INVERSIONES AGRONORTE JPLASENCIA EIRL", tipo: "EIRL", sector: "Agroindustria", estado: "Activo", plan: "PRO", color: "#A8E06C" },
  { ruc: "20540013129", razon: "BLACK STAR SAC", tipo: "SAC", sector: "Comercio", estado: "Activo", plan: "BASICO", color: "#0A84FF" },
  { ruc: "20605768564", razon: "TRACKING LOGISTIC EIRL", tipo: "EIRL", sector: "Logistica", estado: "Activo", plan: "PRO", color: "#BF5AF2" },
];

/* Generate initial scanned documents per company for demo */
const DOC_TIPOS = ["Factura", "Boleta", "Nota Credito", "Nota Debito", "Recibo Honorarios"];
const DOC_ESTADOS_SCAN = ["Procesado", "En Proceso", "Pendiente", "Observado"];
const PROVEEDORES_DEMO = ["Comercial Lima SAC", "Distribuidora Norte EIRL", "Ferreteria Central SA", "Transportes Rapido SRL", "Servicios Generales Peru SAC", "Alimentos del Sur SAC", "Tech Solutions PE", "Materiales Andinos SAC"];

const generateDocsForEmpresa = (ruc, razon) => {
  const docs = [];
  const numDocs = 3 + Math.floor(Math.random() * 5);
  for (let i = 0; i < numDocs; i++) {
    const tipo = DOC_TIPOS[Math.floor(Math.random() * 3)];
    const subtotal = Math.floor(Math.random() * 25000 + 500);
    const igv = +(subtotal * 0.18).toFixed(2);
    const total = +(subtotal + igv).toFixed(2);
    const day = String(Math.floor(Math.random() * 28) + 1).padStart(2, "0");
    const month = Math.random() > 0.5 ? "01" : "02";
    docs.push({
      id: Date.now().toString(36) + Math.random().toString(36).slice(2, 7) + i,
      empresaRuc: ruc,
      empresaRazon: razon,
      serie: tipo === "Factura" ? "E001" : tipo === "Boleta" ? "B001" : "NC01",
      numero: String(Math.floor(Math.random() * 90000 + 10000)).padStart(8, "0"),
      fecha: `2026-${month}-${day}`,
      tipo,
      proveedor: PROVEEDORES_DEMO[Math.floor(Math.random() * PROVEEDORES_DEMO.length)],
      rucProv: "20" + String(Math.floor(Math.random() * 9e8 + 1e8)),
      moneda: Math.random() > 0.85 ? "USD" : "PEN",
      subtotal, igv, total,
      estado: DOC_ESTADOS_SCAN[Math.floor(Math.random() * DOC_ESTADOS_SCAN.length)],
      scanDate: `2026-${month}-${day}`,
      scanIA: Math.random() > 0.3 ? "Aprobado IA" : "Revision Manual",
      cuentaContable: ["6011", "6032", "6321", "6511", "6591"][Math.floor(Math.random() * 5)],
      modulo: Math.random() > 0.4 ? "compras" : "contable",
      archivo: `scan_${ruc}_${i + 1}.pdf`,
      confianzaIA: Math.floor(Math.random() * 20 + 80),
    });
  }
  return docs;
};

const initScannedDocs = () => [];

/* INITIAL DATA */
/* === MRPII DATA === */
const OBRAS_MRP = [
  { obra_id: 1, codigo: "OBR-2026-001", nombre: "Torre Norte Residencial", ubicacion: "Trujillo, La Libertad", presupuesto_base: 12500000, avance_pct: 34.5, fecha_inicio: "2026-01-06", fecha_fin: "2026-12-20" },
  { obra_id: 2, codigo: "OBR-2026-002", nombre: "Centro Comercial Plaza Sur", ubicacion: "Lima, Lima", presupuesto_base: 28000000, avance_pct: 12.8, fecha_inicio: "2026-02-01", fecha_fin: "2027-06-30" },
];
const ALMACENES_MRP = [
  { almacen_id: 1, obra_id: 1, tipo: "CENTRAL", nombre: "Almacen Central Torre Norte", direccion: "Av. España 1450" },
  { almacen_id: 2, obra_id: 1, tipo: "OBRA", nombre: "Almacen Frente A", direccion: "Obra - Sector A" },
  { almacen_id: 3, obra_id: 1, tipo: "PANIOL", nombre: "Pañol Principal", direccion: "Contenedor #3" },
];
const INSUMOS_MRP = [
  { insumo_id: 1, codigo: "MAT-00102", descripcion: "Cemento Portland Tipo I (42.5 kg)", unidad: "bls", tipo: "MATERIAL", stock_actual: 342, stock_cuarentena: 0, stock_minimo: 200, precio_unit: 28.50, codigo_sunat: "25232100" },
  { insumo_id: 2, codigo: "MAT-00205", descripcion: "Arena Gruesa", unidad: "m³", tipo: "MATERIAL", stock_actual: 18.5, stock_cuarentena: 0, stock_minimo: 10, precio_unit: 65.00, codigo_sunat: "25171500" },
  { insumo_id: 3, codigo: "MAT-00310", descripcion: "Piedra Chancada 1/2\"", unidad: "m³", tipo: "MATERIAL", stock_actual: 22.3, stock_cuarentena: 0, stock_minimo: 12, precio_unit: 80.00, codigo_sunat: "25171600" },
  { insumo_id: 4, codigo: "MAT-00415", descripcion: "Acero Corrugado ø 3/8\"", unidad: "kg", tipo: "MATERIAL", stock_actual: 4850, stock_cuarentena: 1200, stock_minimo: 2000, precio_unit: 4.20, codigo_sunat: "30102200" },
  { insumo_id: 5, codigo: "MAT-00520", descripcion: "Ladrillo KK 18 huecos", unidad: "und", tipo: "MATERIAL", stock_actual: 15200, stock_cuarentena: 0, stock_minimo: 5000, precio_unit: 0.85, codigo_sunat: "30111500" },
  { insumo_id: 6, codigo: "MAT-00601", descripcion: "Tuberia PVC SAP 4\"", unidad: "und", tipo: "MATERIAL", stock_actual: 45, stock_cuarentena: 0, stock_minimo: 20, precio_unit: 42.00, codigo_sunat: "40141700" },
  { insumo_id: 7, codigo: "MAT-00705", descripcion: "Alambre Negro Recocido #16", unidad: "kg", tipo: "MATERIAL", stock_actual: 280, stock_cuarentena: 0, stock_minimo: 100, precio_unit: 5.80, codigo_sunat: "31151600" },
  { insumo_id: 8, codigo: "MAT-00812", descripcion: "Madera Tornillo p/Encofrado", unidad: "p²", tipo: "MATERIAL", stock_actual: 1850, stock_cuarentena: 0, stock_minimo: 500, precio_unit: 8.50, codigo_sunat: "30103600" },
];
const MPS_PERIODOS = [
  { periodo: "SEM-07", partida_id: 1, partida_desc: "Concreto f'c=210 en Zapatas", metrado_prog: 42.75, fecha_inicio: "2026-02-09", fecha_fin: "2026-02-20", estado: "EN_EJECUCION" },
  { periodo: "SEM-09", partida_id: 2, partida_desc: "Concreto f'c=210 en Columnas", metrado_prog: 21.15, fecha_inicio: "2026-02-23", fecha_fin: "2026-03-06", estado: "PROGRAMADA" },
  { periodo: "SEM-11", partida_id: 3, partida_desc: "Concreto f'c=210 en Vigas", metrado_prog: 34.10, fecha_inicio: "2026-03-09", fecha_fin: "2026-03-20", estado: "PROGRAMADA" },
  { periodo: "SEM-11", partida_id: 5, partida_desc: "Acero f'y=4200 en Columnas", metrado_prog: 4500, fecha_inicio: "2026-03-09", fecha_fin: "2026-03-20", estado: "PROGRAMADA" },
  { periodo: "SEM-13", partida_id: 4, partida_desc: "Concreto f'c=210 en Losas", metrado_prog: 62.50, fecha_inicio: "2026-03-23", fecha_fin: "2026-04-03", estado: "PROGRAMADA" },
  { periodo: "SEM-15", partida_id: 6, partida_desc: "Muro Ladrillo KK Soga", metrado_prog: 620, fecha_inicio: "2026-04-06", fecha_fin: "2026-04-17", estado: "PROGRAMADA" },
];
const EXPLOSION_MRP = [
  { periodo: "SEM-09", insumo: "Cemento Portland Tipo I", unidad: "bls", demanda_bruta: 216.07, stock: 342, en_transito: 0, necesidad_neta: 0, accion: "OK_STOCK" },
  { periodo: "SEM-09", insumo: "Arena Gruesa", unidad: "m³", demanda_bruta: 11.55, stock: 18.5, en_transito: 0, necesidad_neta: 0, accion: "OK_STOCK" },
  { periodo: "SEM-09", insumo: "Piedra Chancada 1/2\"", unidad: "m³", demanda_bruta: 11.77, stock: 22.3, en_transito: 0, necesidad_neta: 0, accion: "OK_STOCK" },
  { periodo: "SEM-11", insumo: "Cemento Portland Tipo I", unidad: "bls", demanda_bruta: 348.48, stock: 125.93, en_transito: 0, necesidad_neta: 222.55, accion: "COMPRA" },
  { periodo: "SEM-11", insumo: "Acero Corrugado ø 3/8\"", unidad: "kg", demanda_bruta: 4725.00, stock: 4850, en_transito: 1200, necesidad_neta: 0, accion: "OK_STOCK" },
  { periodo: "SEM-11", insumo: "Arena Gruesa", unidad: "m³", demanda_bruta: 18.62, stock: 6.95, en_transito: 0, necesidad_neta: 11.67, accion: "COMPRA" },
  { periodo: "SEM-11", insumo: "Piedra Chancada 1/2\"", unidad: "m³", demanda_bruta: 18.98, stock: 10.53, en_transito: 0, necesidad_neta: 8.45, accion: "COMPRA" },
  { periodo: "SEM-13", insumo: "Cemento Portland Tipo I", unidad: "bls", demanda_bruta: 638.85, stock: 0, en_transito: 300, necesidad_neta: 338.85, accion: "COMPRA" },
  { periodo: "SEM-13", insumo: "Arena Gruesa", unidad: "m³", demanda_bruta: 34.13, stock: 0, en_transito: 14, necesidad_neta: 20.13, accion: "COMPRA" },
  { periodo: "SEM-15", insumo: "Ladrillo KK 18 huecos", unidad: "und", demanda_bruta: 26040, stock: 15200, en_transito: 0, necesidad_neta: 10840, accion: "COMPRA" },
];
const KARDEX_MRP = [
  { kardex_id: 1, fecha: "2026-02-03", tipo_op: "01", desc_op: "Compra Nacional", documento: "F001-004521", insumo: "Cemento Portland Tipo I", entrada_qty: 500, entrada_cu: 28.50, entrada_total: 14250.00, salida_qty: 0, salida_cu: 0, salida_total: 0, saldo_qty: 842, saldo_cu: 28.35, saldo_total: 23870.70 },
  { kardex_id: 2, fecha: "2026-02-05", tipo_op: "19", desc_op: "Salida Produccion", documento: "VS-2026-0089", insumo: "Cemento Portland Tipo I", entrada_qty: 0, entrada_cu: 0, entrada_total: 0, salida_qty: 200, salida_cu: 28.35, salida_total: 5670.00, saldo_qty: 642, saldo_cu: 28.35, saldo_total: 18200.70 },
  { kardex_id: 3, fecha: "2026-02-07", tipo_op: "19", desc_op: "Salida Produccion", documento: "VS-2026-0094", insumo: "Cemento Portland Tipo I", entrada_qty: 0, entrada_cu: 0, entrada_total: 0, salida_qty: 150, salida_cu: 28.35, salida_total: 4252.50, saldo_qty: 492, saldo_cu: 28.35, saldo_total: 13948.20 },
  { kardex_id: 4, fecha: "2026-02-10", tipo_op: "20", desc_op: "Devolucion de Obra", documento: "DEV-2026-0012", insumo: "Cemento Portland Tipo I", entrada_qty: 15, entrada_cu: 28.35, entrada_total: 425.25, salida_qty: 0, salida_cu: 0, salida_total: 0, saldo_qty: 507, saldo_cu: 28.35, saldo_total: 14373.45 },
  { kardex_id: 5, fecha: "2026-02-10", tipo_op: "01", desc_op: "Compra Nacional", documento: "F001-004589", insumo: "Acero Corrugado ø 3/8\"", entrada_qty: 6050, entrada_cu: 4.20, entrada_total: 25410.00, salida_qty: 0, salida_cu: 0, salida_total: 0, saldo_qty: 6050, saldo_cu: 4.20, saldo_total: 25410.00 },
  { kardex_id: 6, fecha: "2026-02-12", tipo_op: "19", desc_op: "Salida Produccion", documento: "VS-2026-0101", insumo: "Cemento Portland Tipo I", entrada_qty: 0, entrada_cu: 0, entrada_total: 0, salida_qty: 165, salida_cu: 28.35, salida_total: 4677.75, saldo_qty: 342, saldo_cu: 28.35, saldo_total: 9695.70 },
];
const RECEPCIONES_MRP = [
  { recepcion_id: 1, oc: "OC-2026-01042", proveedor: "Distribuidora Pacasmayo S.A.", fecha: "2026-02-03", insumo: "Cemento Portland Tipo I", cantidad: 500, unidad: "bls", estado_ppi: "APROBADO", inspector: "Ing. C. Medina", ppi_resultado: "CONFORME" },
  { recepcion_id: 2, oc: "OC-2026-01055", proveedor: "Siderperu S.A.C.", fecha: "2026-02-10", insumo: "Acero Corrugado ø 3/8\"", cantidad: 6050, unidad: "kg", estado_ppi: "CUARENTENA", inspector: "Ing. R. Torres", ppi_resultado: "EN_INSPECCION" },
  { recepcion_id: 3, oc: "OC-2026-01060", proveedor: "Ladrillera Lark S.A.", fecha: "2026-02-11", insumo: "Ladrillo KK 18 huecos", cantidad: 8000, unidad: "und", estado_ppi: "APROBADO", inspector: "Almacenero", ppi_resultado: "CONFORME" },
  { recepcion_id: 4, oc: "OC-2026-01048", proveedor: "Tuboplast S.A.", fecha: "2026-02-12", insumo: "Tuberia PVC SAP 4\"", cantidad: 30, unidad: "und", estado_ppi: "RECHAZADO", inspector: "Ing. IISS", ppi_resultado: "NC - Deformacion" },
];
const REQUISICIONES_MRP = [
  { req_id: "REQ-2026-0078", fecha: "2026-02-10", solicitante: "Ing. Residente", partida: "05.02.01", insumo: "Cemento Portland Tipo I", cantidad: 300, unidad: "bls", prioridad: "ALTA", estado: "APROBADA", monto_est: 8550.00 },
  { req_id: "REQ-2026-0079", fecha: "2026-02-10", solicitante: "Maestro de Obra", partida: "05.02.01", insumo: "Arena Gruesa", cantidad: 14, unidad: "m³", prioridad: "ALTA", estado: "APROBADA", monto_est: 910.00 },
  { req_id: "REQ-2026-0080", fecha: "2026-02-11", solicitante: "MRP Automatico", partida: "05.03.01", insumo: "Piedra Chancada 1/2\"", cantidad: 10, unidad: "m³", prioridad: "MEDIA", estado: "ENVIADA", monto_est: 800.00 },
  { req_id: "REQ-2026-0081", fecha: "2026-02-12", solicitante: "Ing. Residente", partida: "07.01.01", insumo: "Ladrillo KK 18 huecos", cantidad: 12000, unidad: "und", prioridad: "BAJA", estado: "BORRADOR", monto_est: 10200.00 },
  { req_id: "REQ-2026-0082", fecha: "2026-02-13", solicitante: "MRP Automatico", partida: "05.04.01", insumo: "Cemento Portland Tipo I", cantidad: 340, unidad: "bls", prioridad: "ALTA", estado: "ENVIADA", monto_est: 9690.00 },
];
const EQUIPOS_MRP = [
  { equipo_id: 1, descripcion: "Excavadora CAT 320", placa: "PLQ-4521", horometro: 4280, prox_mto: 4300, tipo_mto: "Cambio aceite", hrs_rest: 20, estado: "PROXIMO" },
  { equipo_id: 2, descripcion: "Grua Torre Liebherr 120", placa: "—", horometro: 1950, prox_mto: 2000, tipo_mto: "Revision general", hrs_rest: 50, estado: "PROXIMO" },
  { equipo_id: 3, descripcion: "Mixer Concreto #3", placa: "AXV-789", horometro: 8510, prox_mto: 8500, tipo_mto: "Cambio filtros", hrs_rest: -10, estado: "VENCIDO" },
  { equipo_id: 4, descripcion: "Generador 50 KVA", placa: "—", horometro: 3100, prox_mto: 3500, tipo_mto: "Cambio aceite", hrs_rest: 400, estado: "OK" },
  { equipo_id: 5, descripcion: "Compactadora Wacker", placa: "—", horometro: 620, prox_mto: 750, tipo_mto: "Revision", hrs_rest: 130, estado: "OK" },
  { equipo_id: 6, descripcion: "Vibrador Concreto 4HP", placa: "—", horometro: 1205, prox_mto: 1250, tipo_mto: "Cambio carbones", hrs_rest: 45, estado: "PROXIMO" },
];
const HERRAMIENTAS_MRP = [
  { id: 1, herramienta: "Amoladora Bosch 7\"", codigo_qr: "HER-0045", operario: "Juan Perez", dni: "45678912", frente: "Sector A - Columnas", despacho: "2026-02-13 07:15", limite: "2026-02-13 17:00", estado: "VIGENTE", valor_rep: 380 },
  { id: 2, herramienta: "Taladro Percutor DeWalt", codigo_qr: "HER-0089", operario: "Carlos Rios", dni: "78912345", frente: "Sector B - IISS", despacho: "2026-02-13 07:30", limite: "2026-02-13 17:00", estado: "VIGENTE", valor_rep: 520 },
  { id: 3, herramienta: "Rotomartillo Hilti TE50", codigo_qr: "HER-0012", operario: "Miguel Soto", dni: "32165498", frente: "Sector A - Vigas", despacho: "2026-02-12 07:00", limite: "2026-02-12 17:00", estado: "VENCIDA", valor_rep: 2800 },
  { id: 4, herramienta: "Sierra Circular Makita", codigo_qr: "HER-0067", operario: "Pedro Diaz", dni: "65432178", frente: "Encofrado - Piso 2", despacho: "2026-02-13 08:00", limite: "2026-02-13 17:00", estado: "VIGENTE", valor_rep: 650 },
  { id: 5, herramienta: "Nivel Laser Bosch", codigo_qr: "HER-0023", operario: "Luis Ramos", dni: "98765432", frente: "Topografia", despacho: "2026-02-11 07:00", limite: "2026-02-11 17:00", estado: "VENCIDA", valor_rep: 1450 },
];
const MERMAS_MRP = [
  { partida: "04.01.01 - Concreto Zapatas", insumo: "Cemento Portland Tipo I", consumo_teorico: 437.26, consumo_real: 448.50, merma: 11.24, merma_pct: 2.57, clasificacion: "MERMA_NORMAL" },
  { partida: "04.01.01 - Concreto Zapatas", insumo: "Arena Gruesa", consumo_teorico: 23.35, consumo_real: 24.10, merma: 0.75, merma_pct: 3.21, clasificacion: "MERMA_NORMAL" },
  { partida: "04.01.01 - Concreto Zapatas", insumo: "Piedra Chancada 1/2\"", consumo_teorico: 23.79, consumo_real: 24.85, merma: 1.06, merma_pct: 4.46, clasificacion: "MERMA_NORMAL" },
  { partida: "06.01.01 - Acero Columnas", insumo: "Acero Corrugado ø 3/8\"", consumo_teorico: 3360.00, consumo_real: 3580.00, merma: 220.00, merma_pct: 6.55, clasificacion: "MERMA_ANORMAL" },
  { partida: "04.01.01 - Concreto Zapatas", insumo: "Alambre Negro #16", consumo_teorico: 85.50, consumo_real: 82.00, merma: -3.50, merma_pct: -4.09, clasificacion: "EFICIENTE" },
];
const KPI_MRP = { rotacion: 4.2, meta_rotacion: 4.0, quiebre: 1.3, meta_quiebre: 2.0, exactitud: 96.8, meta_exactitud: 95.0, dias_stock: 11, ppi_cumpl: 97.5, meta_ppi: 100, tasa_rechazo: 2.1, meta_rechazo: 3.0, merma_global: 3.8, meta_merma: 5.0, disponib_equip: 87.2, meta_disp: 85.0, retorno_herr: 96.5, meta_retorno: 98.0 };
const mrpBadge = (estado) => { const m = { APROBADO: "Aprobado", APROBADA: "Aprobada", CONFORME: "Conforme", CUARENTENA: "En Cuarentena", EN_INSPECCION: "En Inspeccion", ENVIADA: "Enviada", RECHAZADO: "Rechazado", BORRADOR: "Borrador", PROGRAMADA: "Programada", EN_EJECUCION: "En Ejecucion", OK_STOCK: "Stock OK", COMPRA: "Requiere Compra", VIGENTE: "Vigente", VENCIDA: "Vencida", OK: "OK", PROXIMO: "Proximo", VENCIDO: "Vencido", MERMA_NORMAL: "Merma Normal", MERMA_ANORMAL: "Merma Anormal", EFICIENTE: "Eficiente", ALTA: "Alta", MEDIA: "Media", BAJA: "Baja" }; return m[estado] || estado; };
const mrpColor = (estado) => { const g = ["APROBADO", "APROBADA", "CONFORME", "OK_STOCK", "OK", "VIGENTE", "EFICIENTE", "BAJA"]; const r = ["RECHAZADO", "COMPRA", "VENCIDO", "VENCIDA", "MERMA_ANORMAL", "ALTA"]; return g.includes(estado) ? P.grn : r.includes(estado) ? P.red : P.org; };
const fmtN = (n, d = 2) => Number(n).toLocaleString("es-PE", { minimumFractionDigits: d, maximumFractionDigits: d });
const fmtI = (n) => Number(n).toLocaleString("es-PE");
const mrpVal = INSUMOS_MRP.reduce((a, i) => a + i.stock_actual * i.precio_unit, 0);

/* === CONTABLE DATA === */
const PCGE_DATA = [
  { id: "1", code: "10", name: "Efectivo y Equivalentes de Efectivo", type: "ASSET", level: 1, balance: 245680.50, children: [
    { id: "1.1", code: "10.01", name: "Caja", type: "ASSET", level: 2, balance: 15200.00, children: [
      { id: "1.1.1", code: "10.01.01", name: "Caja MN", type: "ASSET", level: 3, balance: 8700.00, isDetail: true, children: [] },
      { id: "1.1.2", code: "10.01.02", name: "Caja ME", type: "ASSET", level: 3, balance: 6500.00, isDetail: true, children: [] },
    ]},
    { id: "1.2", code: "10.04", name: "Cuentas Corrientes", type: "ASSET", level: 2, balance: 230480.50, children: [
      { id: "1.2.1", code: "10.04.01", name: "BCP Cuenta Corriente MN", type: "ASSET", level: 3, balance: 180480.50, isDetail: true, children: [] },
      { id: "1.2.2", code: "10.04.02", name: "BBVA Cuenta Corriente ME", type: "ASSET", level: 3, balance: 50000.00, isDetail: true, children: [] },
    ]},
  ]},
  { id: "2", code: "12", name: "Cuentas por Cobrar Comerciales", type: "ASSET", level: 1, balance: 389500.00, children: [
    { id: "2.1", code: "12.01", name: "Facturas por Cobrar", type: "ASSET", level: 2, balance: 342000.00, isDetail: true, children: [] },
    { id: "2.2", code: "12.02", name: "Anticipos de Clientes", type: "ASSET", level: 2, balance: 47500.00, isDetail: true, children: [] },
  ]},
  { id: "3", code: "40", name: "Tributos y Aportes al Sistema", type: "LIABILITY", level: 1, balance: 67890.00, children: [
    { id: "3.1", code: "40.11", name: "IGV - Cuenta Propia", type: "LIABILITY", level: 2, balance: 45200.00, children: [
      { id: "3.1.1", code: "40.11.01", name: "IGV por Pagar", type: "LIABILITY", level: 3, balance: 45200.00, isDetail: true, children: [] },
    ]},
    { id: "3.2", code: "40.17", name: "Impuesto a la Renta", type: "LIABILITY", level: 2, balance: 22690.00, isDetail: true, children: [] },
  ]},
  { id: "4", code: "60", name: "Compras", type: "EXPENSE", level: 1, balance: 523400.00, children: [
    { id: "4.1", code: "60.01", name: "Mercaderias", type: "EXPENSE", level: 2, balance: 423400.00, isDetail: true, children: [] },
    { id: "4.2", code: "60.03", name: "Materiales Auxiliares", type: "EXPENSE", level: 2, balance: 100000.00, isDetail: true, children: [] },
  ]},
  { id: "5", code: "70", name: "Ventas", type: "REVENUE", level: 1, balance: 892300.00, children: [
    { id: "5.1", code: "70.01", name: "Mercaderias", type: "REVENUE", level: 2, balance: 792300.00, isDetail: true, children: [] },
    { id: "5.2", code: "70.04", name: "Prestacion de Servicios", type: "REVENUE", level: 2, balance: 100000.00, isDetail: true, children: [] },
  ]},
];
const SIRE_CONC = [
  { id: 1, ruc: "20512345678", razon: "Tech Solutions SAC", serie: "F001", correlativo: "00001234", fecha: "2026-01-15", base: 10000.00, igv: 1800.00, total: 11800.00, status: "MATCHED" },
  { id: 2, ruc: "20498765432", razon: "Importadora Global SAC", serie: "F002", correlativo: "00005678", fecha: "2026-01-16", base: 25000.00, igv: 4500.00, total: 29500.00, status: "MATCHED" },
  { id: 3, ruc: "20534567890", razon: "Servicios Digitales SRL", serie: "E001", correlativo: "00000456", fecha: "2026-01-17", base: 5000.00, igv: 900.00, total: 5900.00, status: "AMOUNT_DIFF", diff: -50.00 },
  { id: 4, ruc: "20523456789", razon: "Logistica Express EIRL", serie: "F001", correlativo: "00002345", fecha: "2026-01-18", base: 8500.00, igv: 1530.00, total: 10030.00, status: "MISSING_ERP" },
  { id: 5, ruc: "20545678901", razon: "Consulting Group SAC", serie: "F003", correlativo: "00000789", fecha: "2026-01-19", base: 15000.00, igv: 2700.00, total: 17700.00, status: "MISSING_SUNAT" },
  { id: 6, ruc: "20512345678", razon: "Tech Solutions SAC", serie: "F001", correlativo: "00001234", fecha: "2026-01-15", base: 10000.00, igv: 1800.00, total: 11800.00, status: "DUPLICATE" },
  { id: 7, ruc: "20567890123", razon: "Distribuidora Lima SAC", serie: "F001", correlativo: "00003456", fecha: "2026-01-20", base: 32000.00, igv: 5760.00, total: 37760.00, status: "MATCHED" },
  { id: 8, ruc: "20578901234", razon: "Minera Andina SAC", serie: "F002", correlativo: "00007890", fecha: "2026-01-21", base: 120000.00, igv: 21600.00, total: 141600.00, status: "MATCHED" },
  { id: 9, ruc: "20589012345", razon: "Farmacia del Pueblo SRL", serie: "E001", correlativo: "00001234", fecha: "2026-01-22", base: 3200.00, igv: 576.00, total: 3776.00, status: "AMOUNT_DIFF", diff: 12.50 },
  { id: 10, ruc: "20590123456", razon: "Constructora Piramide SAC", serie: "F001", correlativo: "00004567", fecha: "2026-01-23", base: 85000.00, igv: 15300.00, total: 100300.00, status: "MATCHED" },
];
const CASHFLOW_D = Array.from({ length: 90 }, (_, i) => { const d = new Date(2026, 1, 13); d.setDate(d.getDate() + i); const b = 50000 + Math.sin(i / 7) * 20000; return { date: d.toLocaleDateString("es-PE", { day: "2-digit", month: "short" }), inflows: Math.round(b + Math.random() * 15000), outflows: Math.round(b * 0.7 + Math.random() * 12000), optimista: Math.round(b * 1.3), probable: Math.round(b), pesimista: Math.round(b * 0.6) }; });
const SHADOW_ALERTS = [
  { id: 1, type: "RUC No Habido", severity: "CRITICAL", entity: "20512345678 - Tech Solutions SAC", desc: "RUC reportado como NO HABIDO por SUNAT. Se bloqueo el registro de factura F001-00001234.", recommendation: "Solicitar al proveedor regularizar su condicion ante SUNAT antes de procesar pagos.", time: "Hace 5 min", resolved: false },
  { id: 2, type: "Gasto Representacion", severity: "WARNING", entity: "Cuenta 63.02 - Gastos de Representacion", desc: "El acumulado de gastos de representacion (S/ 18,450) alcanza el 87% del limite deducible (0.5% de ingresos brutos).", recommendation: "Quedan S/ 2,780 disponibles. Considere reclasificar gastos no esenciales.", time: "Hace 20 min", resolved: false },
  { id: 3, type: "Bancarizacion", severity: "CRITICAL", entity: "Factura F002-00005678 - Importadora Global SAC", desc: "Operacion por S/ 29,500.00 sin medio de pago bancarizado registrado. El gasto no sera deducible.", recommendation: "Registrar el medio de pago (transferencia/cheque) o el gasto perdera deducibilidad tributaria.", time: "Hace 1 hora", resolved: false },
  { id: 4, type: "Boletas Exceso", severity: "WARNING", entity: "Registro de Compras - Enero 2026", desc: "Las boletas de venta acumulan S/ 12,300 (5.2% de compras en RCE). Limite: 6%.", recommendation: "Monitorear. Quedan S/ 1,890 antes de alcanzar el tope deducible del periodo.", time: "Hace 2 horas", resolved: false },
  { id: 5, type: "Detraccion Pendiente", severity: "INFO", entity: "3 facturas con detraccion pendiente", desc: "Existen 3 facturas de compra con detraccion calculada pero no depositada. Monto total: S/ 4,230.", recommendation: "Generar archivo BN y depositar antes del 5to dia habil del mes siguiente.", time: "Hace 3 horas", resolved: false },
  { id: 6, type: "Tipo de Cambio", severity: "INFO", entity: "Diferencia TC - Factura USD", desc: "Se detecto diferencia de tipo de cambio > 0.5% entre TC SUNAT y TC aplicado en factura E001-00000456.", recommendation: "Verificar y ajustar el tipo de cambio aplicado. Usar TC venta SUNAT del dia de emision.", time: "Hace 4 horas", resolved: true },
];
const DETR_CODES = [
  { code: "004", name: "Azucar y melaza", rate: 10 }, { code: "005", name: "Alcohol etilico", rate: 10 },
  { code: "010", name: "Intermediacion laboral", rate: 12 }, { code: "012", name: "Arrendamiento de bienes", rate: 10 },
  { code: "014", name: "Otros servicios empresariales", rate: 12 }, { code: "017", name: "Fabricacion de bienes por encargo", rate: 10 },
  { code: "019", name: "Transporte de carga", rate: 4 }, { code: "020", name: "Contratos de construccion", rate: 4 },
  { code: "022", name: "Demas servicios gravados con IGV", rate: 12 }, { code: "037", name: "Demas bienes gravados con IGV", rate: 10 },
];
const COST_CENTERS = [
  { id: "cc1", code: "ADM", name: "Administracion", budget: 180000, spent: 142500, children: [{ id: "cc1.1", code: "ADM-FIN", name: "Finanzas", budget: 80000, spent: 62000 }, { id: "cc1.2", code: "ADM-RH", name: "Recursos Humanos", budget: 60000, spent: 48500 }, { id: "cc1.3", code: "ADM-LEG", name: "Legal", budget: 40000, spent: 32000 }] },
  { id: "cc2", code: "COM", name: "Comercial", budget: 250000, spent: 198000, children: [{ id: "cc2.1", code: "COM-VEN", name: "Ventas", budget: 150000, spent: 128000 }, { id: "cc2.2", code: "COM-MKT", name: "Marketing", budget: 100000, spent: 70000 }] },
  { id: "cc3", code: "OPE", name: "Operaciones", budget: 420000, spent: 365000, children: [{ id: "cc3.1", code: "OPE-LOG", name: "Logistica", budget: 200000, spent: 178000 }, { id: "cc3.2", code: "OPE-PRD", name: "Produccion", budget: 220000, spent: 187000 }] },
  { id: "cc4", code: "TEC", name: "Tecnologia", budget: 150000, spent: 112000, children: [{ id: "cc4.1", code: "TEC-DEV", name: "Desarrollo", budget: 90000, spent: 72000 }, { id: "cc4.2", code: "TEC-INF", name: "Infraestructura", budget: 60000, spent: 40000 }] },
];
const PORTAL_SUBS = [
  { id: 1, provider: "Tech Solutions SAC", ruc: "20512345678", doc: "F001-00001234", date: "2026-01-15", amount: 11800, entryStatus: "APPROVED", step: 5 },
  { id: 2, provider: "Importadora Global SAC", ruc: "20498765432", doc: "F002-00005678", date: "2026-01-16", amount: 29500, entryStatus: "PENDING", step: 4 },
  { id: 3, provider: "Servicios Digitales SRL", ruc: "20534567890", doc: "E001-00000456", date: "2026-01-17", amount: 5900, entryStatus: "PENDING", step: 3 },
  { id: 4, provider: "Logistica Express EIRL", ruc: "20523456789", doc: "F001-00002345", date: "2026-01-18", amount: 10030, entryStatus: "REJECTED", step: 2 },
];
const sireStatusC = { MATCHED: P.grn, AMOUNT_DIFF: P.org, MISSING_ERP: P.red, MISSING_SUNAT: P.pur, DUPLICATE: P.s2 };
const sireStatusL = { MATCHED: "Coincide", AMOUNT_DIFF: "Dif.Monto", MISSING_ERP: "Falta ERP", MISSING_SUNAT: "Falta SUNAT", DUPLICATE: "Duplicado" };
const sevCfg = { CRITICAL: { c: P.red, icon: "🔴" }, WARNING: { c: P.org, icon: "🟡" }, INFO: { c: P.blue, icon: "🔵" } };
const typeColors = { ASSET: P.blue, LIABILITY: P.red, EQUITY: P.pur, REVENUE: P.grn, EXPENSE: P.org };
const typeLabels = { ASSET: "Activo", LIABILITY: "Pasivo", EQUITY: "Patrimonio", REVENUE: "Ingreso", EXPENSE: "Gasto" };
const fmtK = (n) => n >= 1000000 ? `${(n/1000000).toFixed(1)}M` : n >= 1000 ? `${(n/1000).toFixed(0)}K` : n.toFixed(2);

const initData = () => ({
  facturas: [],
  compras: [],
  productos: [],
  empleados: [],
  imports: [],
  exports: [],
  bancos: [],
  asientos: [],
});

/* ===== LOGIN ===== */
function LoginScreen({ onLogin }) {
  const [email, setEmail] = useState(""); const [role, setRole] = useState(""); const [step, setStep] = useState(1); const [loading, setLoading] = useState(false);
  const [loginMode, setLoginMode] = useState("email"); // "email" | "ruc"
  const [rucInput, setRucInput] = useState(""); const [rucError, setRucError] = useState("");
  const [selectedEmpresa, setSelectedEmpresa] = useState(null);
  const roles = [{ id: "cliente", l: "Cliente Empresa", d: "Compras, contabilidad, documentos escaneados", color: P.grn }, { id: "contador", l: "Contador", d: "Contabilidad, SIRE, todas las empresas, BD", color: P.blue }, { id: "admin", l: "Administrador", d: "Control total, IA procesamiento, configuracion", color: P.pur }];
  const hGoogle = () => { setLoading(true); setTimeout(() => { setEmail("alvaro.ruiz.r.2024@gmail.com"); setStep(2); setLoading(false); }, 1000); };
  const handleRucLogin = () => {
    const found = EMPRESAS_CLIENTES.find(e => e.ruc === rucInput.trim());
    if (found) { setSelectedEmpresa(found); setRucError(""); setLoading(true); setTimeout(() => onLogin({ email: `${found.ruc}@sumaerp.pe`, role: "cliente", empresa: found, empresaRuc: found.ruc, empresaRazon: found.razon }), 800); }
    else { setRucError("RUC no registrado en el sistema. Contacte al administrador."); }
  };
  return (
    <div style={{ minHeight: "100vh", background: `radial-gradient(ellipse at 30% 20%,#0a1628,${P.bg} 70%)`, display: "flex", alignItems: "center", justifyContent: "center", fontFamily: "'DM Sans',-apple-system,sans-serif", color: P.tx }}>
      <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
      <div style={{ width: 440 }}>
        <div style={{ textAlign: "center", marginBottom: 28 }}>
          <div style={{ width: 52, height: 52, borderRadius: 13, background: "linear-gradient(135deg,#0A84FF,#BF5AF2)", display: "inline-flex", alignItems: "center", justifyContent: "center", fontSize: 26, fontWeight: 800, color: "#fff", marginBottom: 10, boxShadow: "0 8px 32px rgba(10,132,255,.3)" }}>Σ</div>
          <div style={{ fontSize: 20, fontWeight: 800 }}>SumaERP</div>
          <div style={{ fontSize: 10, color: P.s2, marginTop: 3 }}>ERP · Peru · Comercio Exterior · SIRE · Contabilidad IA</div>
        </div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 14, padding: 24, boxShadow: "0 20px 60px rgba(0,0,0,.4)" }}>
          {step === 1 ? (<>
            <div style={{ fontSize: 15, fontWeight: 700, marginBottom: 12 }}>Iniciar Sesion</div>
            {/* Login mode tabs */}
            <div style={{ display: "flex", gap: 3, marginBottom: 14, background: P.c2, borderRadius: 7, padding: 3, border: `1px solid ${P.bd}` }}>
              {[{ id: "email", l: "Email / Google" }, { id: "ruc", l: "Empresa (RUC)" }].map(m => (
                <button key={m.id} onClick={() => { setLoginMode(m.id); setRucError(""); }} style={{ flex: 1, background: loginMode === m.id ? P.blue + "18" : "transparent", color: loginMode === m.id ? P.blue : P.s2, border: loginMode === m.id ? `1px solid ${P.blue}30` : "1px solid transparent", borderRadius: 5, padding: "6px 10px", fontSize: 10, fontWeight: 600, cursor: "pointer" }}>{m.l}</button>
              ))}
            </div>
            {loginMode === "email" ? (<>
              <button onClick={hGoogle} disabled={loading} style={{ width: "100%", display: "flex", alignItems: "center", justifyContent: "center", gap: 10, padding: "11px", background: "#fff", border: "1px solid #dadce0", borderRadius: 8, cursor: "pointer", fontSize: 13, fontWeight: 500, color: "#3c4043" }}>{loading ? <div style={{ width: 18, height: 18, border: "2px solid #ddd", borderTopColor: "#4285F4", borderRadius: "50%", animation: "spin .8s linear infinite" }} /> : <GoogleIcon />}{loading ? "Conectando..." : "Continuar con Google"}</button>
              <div style={{ display: "flex", alignItems: "center", gap: 10, margin: "14px 0" }}><div style={{ flex: 1, height: 1, background: P.bd }} /><span style={{ fontSize: 8, color: P.s2 }}>O INGRESA MANUAL</span><div style={{ flex: 1, height: 1, background: P.bd }} /></div>
              <Inp l="Gmail" v={email} onChange={setEmail} ph="usuario@gmail.com" />
              <div style={{ marginTop: 10 }}><Btn p full onClick={() => { if (email.includes("@")) setStep(2); }} style={{ padding: "9px", fontSize: 12, borderRadius: 7 }}>Continuar</Btn></div>
            </>) : (<>
              <div style={{ marginBottom: 8 }}>
                <Inp l="RUC de la Empresa" v={rucInput} onChange={v => { setRucInput(v.replace(/\D/g, "").slice(0, 11)); setRucError(""); }} ph="Ej: 20612044326" />
                {rucError && <div style={{ fontSize: 9, color: P.red, marginTop: 4, display: "flex", alignItems: "center", gap: 3 }}><I.Wn /> {rucError}</div>}
                {rucInput.length === 11 && EMPRESAS_CLIENTES.find(e => e.ruc === rucInput) && (
                  <div style={{ marginTop: 8, background: P.grn + "10", border: `1px solid ${P.grn}30`, borderRadius: 7, padding: "8px 10px", display: "flex", alignItems: "center", gap: 8 }}>
                    <div style={{ width: 28, height: 28, borderRadius: 6, background: P.grn + "20", display: "flex", alignItems: "center", justifyContent: "center", color: P.grn, fontSize: 11, fontWeight: 800 }}><I.Ck /></div>
                    <div><div style={{ fontSize: 11, fontWeight: 700, color: P.grn }}>{EMPRESAS_CLIENTES.find(e => e.ruc === rucInput)?.razon}</div><div style={{ fontSize: 8, color: P.s2 }}>RUC verificado · Plan {EMPRESAS_CLIENTES.find(e => e.ruc === rucInput)?.plan}</div></div>
                  </div>
                )}
              </div>
              <Btn p full onClick={handleRucLogin} dis={rucInput.length !== 11 || loading} style={{ padding: "9px", fontSize: 12, borderRadius: 7, marginTop: 6 }}>{loading ? "Ingresando..." : "Ingresar como Empresa"}</Btn>
              <div style={{ marginTop: 10, background: P.c2, borderRadius: 7, padding: 8, maxHeight: 180, overflowY: "auto", scrollbarWidth: "thin" }}>
                <div style={{ fontSize: 8, color: P.s2, fontWeight: 600, textTransform: "uppercase", letterSpacing: .5, marginBottom: 5 }}>Empresas Registradas</div>
                {EMPRESAS_CLIENTES.map(e => (
                  <div key={e.ruc} onClick={() => setRucInput(e.ruc)} style={{ display: "flex", alignItems: "center", gap: 6, padding: "4px 6px", borderRadius: 4, cursor: "pointer", fontSize: 9, marginBottom: 2, background: rucInput === e.ruc ? P.blue + "10" : "transparent" }}
                    onMouseEnter={ev => ev.currentTarget.style.background = P.hv} onMouseLeave={ev => ev.currentTarget.style.background = rucInput === e.ruc ? P.blue + "10" : "transparent"}>
                    <span style={{ fontFamily: "monospace", color: P.cyan, fontWeight: 600, minWidth: 80 }}>{e.ruc}</span>
                    <span style={{ flex: 1, color: P.tx }}>{e.razon}</span>
                    <span style={{ fontSize: 7, padding: "1px 4px", borderRadius: 3, background: e.color + "18", color: e.color, fontWeight: 600 }}>{e.plan}</span>
                  </div>
                ))}
              </div>
            </>)}
          </>) : (<>
            <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 14 }}><button onClick={() => setStep(1)} style={{ background: "none", border: "none", color: P.s2, cursor: "pointer", fontSize: 16 }}>←</button><div style={{ flex: 1 }}><div style={{ fontSize: 13, fontWeight: 700 }}>Selecciona Perfil</div><div style={{ display: "flex", alignItems: "center", gap: 5, marginTop: 4 }}><div style={{ width: 22, height: 22, borderRadius: "50%", background: "linear-gradient(135deg, #4285F4, #34A853)", display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 9, fontWeight: 700 }}>{email[0]?.toUpperCase()}</div><div><div style={{ fontSize: 10, fontWeight: 600 }}>{email.split("@")[0].replace(/[._]/g, " ").replace(/\b\w/g, c => c.toUpperCase())}</div><div style={{ fontSize: 8, color: P.s2 }}>{email}</div></div></div></div></div>
            <div style={{ display: "flex", flexDirection: "column", gap: 7, marginBottom: 14 }}>
              {roles.map(r => (<div key={r.id} onClick={() => setRole(r.id)} style={{ display: "flex", alignItems: "center", gap: 10, padding: "12px 14px", background: role === r.id ? r.color + "10" : P.c2, border: `1.5px solid ${role === r.id ? r.color + "50" : P.bd}`, borderRadius: 9, cursor: "pointer" }}><div style={{ width: 34, height: 34, borderRadius: 7, background: `${r.color}15`, border: `1px solid ${r.color}25`, display: "flex", alignItems: "center", justifyContent: "center", color: r.color, flexShrink: 0, fontSize: 13, fontWeight: 800 }}>{r.l[0]}</div><div style={{ flex: 1 }}><div style={{ fontSize: 12, fontWeight: 700, color: role === r.id ? r.color : P.tx }}>{r.l}</div><div style={{ fontSize: 9, color: P.s2 }}>{r.d}</div></div>{role === r.id && <div style={{ color: r.color }}><I.Ck /></div>}</div>))}
            </div>
            {role === "cliente" && (
              <div style={{ marginBottom: 10, background: P.c2, borderRadius: 7, padding: 8 }}>
                <div style={{ fontSize: 9, color: P.s2, marginBottom: 5, fontWeight: 600 }}>Selecciona tu empresa:</div>
                <select value={selectedEmpresa?.ruc || ""} onChange={e => setSelectedEmpresa(EMPRESAS_CLIENTES.find(x => x.ruc === e.target.value) || null)} style={{ width: "100%", background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 5, padding: "7px 9px", color: P.tx, fontSize: 10, outline: "none" }}>
                  <option value="">— Seleccionar empresa —</option>
                  {EMPRESAS_CLIENTES.map(e => <option key={e.ruc} value={e.ruc}>{e.ruc} - {e.razon}</option>)}
                </select>
              </div>
            )}
            <Btn p full onClick={() => { if (role) { setLoading(true); const namePart = email.split("@")[0].replace(/[._]/g, " ").replace(/\b\w/g, c => c.toUpperCase()); const userData = { email, role, displayName: namePart }; if (role === "cliente" && selectedEmpresa) { userData.empresa = selectedEmpresa; userData.empresaRuc = selectedEmpresa.ruc; userData.empresaRazon = selectedEmpresa.razon; } setTimeout(() => onLogin(userData), 600); } }} dis={!role || loading || (role === "cliente" && !selectedEmpresa)} style={{ padding: "9px", fontSize: 12, borderRadius: 7 }}>{loading ? "Ingresando..." : "Ingresar"}</Btn>
          </>)}
        </div>
      </div>
      <style>{`@keyframes spin{to{transform:rotate(360deg)}}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}`}</style>
    </div>
  );
}


// ========================================
// VERSION
// ========================================
const APP_VERSION = '2.0';

// ========================================
// CUSTOM HOOKS
// ========================================

// Hook para persistencia en localStorage
const useLocalStorage = (key, initialValue) => {
  const [storedValue, setStoredValue] = useState(initialValue);

  const setValue = useCallback((value) => {
    const valueToStore = value instanceof Function ? value(storedValue) : value;
    setStoredValue(valueToStore);
  }, [storedValue]);

  return [storedValue, setValue];
};

// Hook para debounce
const useDebounce = (value, delay) => {
  const [debouncedValue, setDebouncedValue] = useState(value);

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    return () => clearTimeout(handler);
  }, [value, delay]);

  return debouncedValue;
};

// ========================================
// TOAST CONTEXT
// ========================================

const CXToastContext = createContext(null);

const CXToastProvider = ({ children }) => {
  const [toasts, setToasts] = useState([]);

  const addToast = useCallback((message, type = 'info', duration = 4000) => {
    const id = Date.now() + Math.random();
    setToasts(prev => [...prev, { id, message, type }]);
    
    if (duration > 0) {
      setTimeout(() => {
        setToasts(prev => prev.filter(t => t.id !== id));
      }, duration);
    }
    
    return id;
  }, []);

  const removeToast = useCallback((id) => {
    setToasts(prev => prev.filter(t => t.id !== id));
  }, []);

  const success = useCallback((message) => addToast(message, 'success'), [addToast]);
  const error = useCallback((message) => addToast(message, 'error'), [addToast]);
  const warning = useCallback((message) => addToast(message, 'warning'), [addToast]);
  const info = useCallback((message) => addToast(message, 'info'), [addToast]);

  return (
    <CXToastContext.Provider value={{ toasts, addToast, removeToast, success, error, warning, info }}>
      {children}
      <CXToastContainer toasts={toasts} removeToast={removeToast} />
    </CXToastContext.Provider>
  );
};

const useCXToast = () => {
  const context = useContext(CXToastContext);
  if (!context) {
    throw new Error('useCXToast must be used within a CXToastProvider');
  }
  return context;
};

const CXToastContainer = ({ toasts, removeToast }) => (
  <div className="fixed top-4 right-4 z-50 space-y-2 max-w-sm">
    {toasts.map(toast => (
      <div
        key={toast.id}
        className={`flex items-center gap-3 p-4 rounded-xl border shadow-lg animate-slide-in ${
          toast.type === 'success' ? 'bg-black border-emerald-600 text-emerald-400' :
          toast.type === 'error' ? 'bg-black border-rose-600 text-rose-400' :
          toast.type === 'warning' ? 'bg-black border-amber-600 text-amber-400' :
          'bg-black border-cyan-600 text-cyan-400'
        }`}
      >
        {toast.type === 'success' && <CheckCircle className="w-5 h-5 flex-shrink-0" />}
        {toast.type === 'error' && <XCircle className="w-5 h-5 flex-shrink-0" />}
        {toast.type === 'warning' && <AlertTriangle className="w-5 h-5 flex-shrink-0" />}
        {toast.type === 'info' && <Info className="w-5 h-5 flex-shrink-0" />}
        <span className="text-sm flex-1">{toast.message}</span>
        <button onClick={() => removeToast(toast.id)} className="text-current opacity-60 hover:opacity-100">
          <X className="w-4 h-4" />
        </button>
      </div>
    ))}
  </div>
);

// ========================================
// ENUMS Y CONSTANTES
// ========================================

const AllocationDriver = {
  BY_FOB_VALUE: 'BY_FOB_VALUE',
  BY_WEIGHT: 'BY_WEIGHT',
  BY_VOLUME: 'BY_VOLUME',
  BY_QUANTITY: 'BY_QUANTITY',
  BY_CIF_VALUE: 'BY_CIF_VALUE',
  EQUAL_DISTRIBUTION: 'EQUAL_DISTRIBUTION',
  SPECIFIC_LINE: 'SPECIFIC_LINE'
};

const DriverLabels = {
  BY_FOB_VALUE: 'Valor FOB',
  BY_WEIGHT: 'Peso Bruto',
  BY_VOLUME: 'Volumen',
  BY_QUANTITY: 'Cantidad',
  BY_CIF_VALUE: 'Valor CIF',
  EQUAL_DISTRIBUTION: 'Distribución Equitativa',
  SPECIFIC_LINE: 'Línea Específica'
};

const ExpenseDriverDefaults = {
  'Flete Internacional': AllocationDriver.BY_WEIGHT,
  'Flete Local': AllocationDriver.BY_WEIGHT,
  'Seguro': AllocationDriver.BY_FOB_VALUE,
  'Agente Aduanas': AllocationDriver.BY_FOB_VALUE,
  'Almacenaje': AllocationDriver.BY_VOLUME,
  'Handling': AllocationDriver.BY_QUANTITY,
  'Inspección': AllocationDriver.SPECIFIC_LINE,
  'Otros': AllocationDriver.BY_FOB_VALUE
};

const FolderStatus = {
  DRAFT: { label: 'Borrador', color: 'bg-cyan-800' },
  IN_TRANSIT: { label: 'En Tránsito', color: 'bg-blue-600' },
  CUSTOMS: { label: 'En Aduana', color: 'bg-amber-600' },
  CLEARED: { label: 'Liberado', color: 'bg-emerald-600' },
  COSTED: { label: 'Costeado', color: 'bg-purple-600' },
  CLOSED: { label: 'Cerrado', color: 'bg-cyan-900' }
};

const IncoTerms = ['EXW', 'FCA', 'FAS', 'FOB', 'CFR', 'CIF', 'CPT', 'CIP', 'DAP', 'DPU', 'DDP'];

const LateExpenseScenario = {
  FULL_REVALUATION: 'FULL_REVALUATION',
  PARTIAL_REVALUATION: 'PARTIAL_REVALUATION',
  FULL_PERIOD_EXPENSE: 'FULL_PERIOD_EXPENSE',
  OUT_OF_THRESHOLD: 'OUT_OF_THRESHOLD'
};

// ========================================
// UTILIDADES Y HELPERS
// ========================================

const formatCurrency = (value, currency = 'PEN') => {
  const symbol = currency === 'USD' ? 'US$ ' : 'S/ ';
  return symbol + Number(value || 0).toLocaleString('es-PE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
};

const formatPercent = (value) => {
  return Number(value || 0).toFixed(2) + '%';
};

const formatDate = (date) => {
  if (!date) return '-';
  return new Date(date).toLocaleDateString('es-PE', { day: '2-digit', month: 'short', year: 'numeric' });
};

const formatDateTime = (date) => {
  if (!date) return '-';
  return new Date(date).toLocaleString('es-PE', { 
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit'
  });
};

const generateId = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

const generateFolderNumber = () => {
  const year = new Date().getFullYear();
  const seq = Math.floor(Math.random() * 900) + 100;
  return `IMP-${year}-${seq}`;
};

// Validaciones
const validateRequired = (value, fieldName) => {
  if (value === null || value === undefined || value === '' || (typeof value === 'string' && !value.trim())) {
    return `${fieldName} es requerido`;
  }
  return null;
};

const validatePositiveNumber = (value, fieldName) => {
  const num = parseFloat(value);
  if (isNaN(num) || num < 0) {
    return `${fieldName} debe ser un número positivo`;
  }
  return null;
};

const validateMinValue = (value, min, fieldName) => {
  const num = parseFloat(value);
  if (isNaN(num) || num < min) {
    return `${fieldName} debe ser mayor o igual a ${min}`;
  }
  return null;
};

// Exportación a CSV
const exportToCSV = (data, filename, headers) => {
  const rows = data.map(row => headers.map(h => row[h] ?? ""));
  const numCols = new Set();
  let tsv = headers.join("\t") + "\n";
  rows.forEach(r => { tsv += r.map(c => String(c ?? "").replace(/\t/g, " ").replace(/\n/g, " ")).join("\t") + "\n"; });
  if (_exportModalSetter) { _exportModalSetter({ content: tsv, filename: `${filename}_${new Date().toISOString().split('T')[0]}`, headers, rows, numCols }); }
};

// ========================================
// MOTOR DE CÁLCULO - LANDED COST
// ========================================

const calculateLandedCost = (folder) => {
  const { items, expenses, damTC } = folder;
  const result = {
    success: true,
    totalFobUsd: 0,
    totalCifUsd: 0,
    totalCifPen: 0,
    totalDuties: 0,
    totalExpenses: 0,
    totalLandedCostPen: 0,
    totalIgv: 0,
    itemsDetail: [],
    allocations: [],
    warnings: [],
    calculatedAt: new Date().toISOString()
  };

  if (!items || items.length === 0) {
    result.success = false;
    result.warnings.push('No hay ítems para calcular');
    return result;
  }

  const totals = items.reduce((acc, item) => ({
    fob: acc.fob + (item.fobUsd || 0),
    weight: acc.weight + (item.weightKg || 0),
    volume: acc.volume + (item.volumeM3 || 0),
    quantity: acc.quantity + (item.quantity || 0),
    cif: acc.cif + (item.cifUsd || 0)
  }), { fob: 0, weight: 0, volume: 0, quantity: 0, cif: 0 });

  items.forEach(item => {
    const itemDetail = {
      id: item.id,
      sku: item.sku,
      description: item.description,
      quantity: item.quantity || 0,
      fobUsd: item.fobUsd || 0,
      cifUsd: item.cifUsd || 0,
      cifPen: (item.cifUsd || 0) * damTC,
      dutiesPen: 0,
      expensesAllocatedPen: 0,
      igvPen: 0,
      totalLandedCostPen: 0,
      unitLandedCostPen: 0,
      allocations: []
    };

    const adValoremRate = item.adValoremRate || 0;
    const adValorem = (item.cifUsd || 0) * (adValoremRate / 100) * damTC;
    itemDetail.dutiesPen = adValorem;
    
    const baseIgv = itemDetail.cifPen + adValorem;
    itemDetail.igvPen = baseIgv * 0.18;

    expenses.forEach(expense => {
      if (!expense.isCapitalizable) return;
      
      const driver = expense.driver || ExpenseDriverDefaults[expense.type] || AllocationDriver.BY_FOB_VALUE;
      let ratio = 0;

      switch (driver) {
        case AllocationDriver.BY_FOB_VALUE:
          ratio = totals.fob > 0 ? (item.fobUsd || 0) / totals.fob : 1 / items.length;
          break;
        case AllocationDriver.BY_WEIGHT:
          ratio = totals.weight > 0 ? (item.weightKg || 0) / totals.weight : (item.fobUsd || 0) / totals.fob || 1 / items.length;
          if (totals.weight === 0) {
            result.warnings.push(`Fallback a FOB para "${expense.description}" (peso = 0)`);
          }
          break;
        case AllocationDriver.BY_VOLUME:
          ratio = totals.volume > 0 ? (item.volumeM3 || 0) / totals.volume : (item.fobUsd || 0) / totals.fob || 1 / items.length;
          if (totals.volume === 0) {
            result.warnings.push(`Fallback a FOB para "${expense.description}" (volumen = 0)`);
          }
          break;
        case AllocationDriver.BY_QUANTITY:
          ratio = totals.quantity > 0 ? (item.quantity || 0) / totals.quantity : 1 / items.length;
          break;
        case AllocationDriver.BY_CIF_VALUE:
          ratio = totals.cif > 0 ? (item.cifUsd || 0) / totals.cif : (item.fobUsd || 0) / totals.fob || 1 / items.length;
          break;
        case AllocationDriver.EQUAL_DISTRIBUTION:
          ratio = 1 / items.length;
          break;
        case AllocationDriver.SPECIFIC_LINE:
          ratio = expense.specificItemId === item.id ? 1 : 0;
          break;
        default:
          ratio = totals.fob > 0 ? (item.fobUsd || 0) / totals.fob : 1 / items.length;
      }

      const amountPen = expense.currency === 'USD' 
        ? (expense.amount || 0) * damTC * ratio 
        : (expense.amount || 0) * ratio;

      if (amountPen > 0) {
        itemDetail.expensesAllocatedPen += amountPen;
        itemDetail.allocations.push({
          expenseId: expense.id,
          expenseDescription: expense.description,
          driver,
          driverLabel: DriverLabels[driver],
          ratio: ratio * 100,
          amountPen
        });
        result.allocations.push({
          itemId: item.id,
          expenseId: expense.id,
          amountPen,
          driver,
          ratio
        });
      }
    });

    itemDetail.totalLandedCostPen = itemDetail.cifPen + itemDetail.dutiesPen + itemDetail.expensesAllocatedPen;
    itemDetail.unitLandedCostPen = item.quantity > 0 ? itemDetail.totalLandedCostPen / item.quantity : 0;

    result.totalFobUsd += item.fobUsd || 0;
    result.totalCifUsd += item.cifUsd || 0;
    result.totalCifPen += itemDetail.cifPen;
    result.totalDuties += itemDetail.dutiesPen;
    result.totalExpenses += itemDetail.expensesAllocatedPen;
    result.totalLandedCostPen += itemDetail.totalLandedCostPen;
    result.totalIgv += itemDetail.igvPen;
    result.itemsDetail.push(itemDetail);
  });

  const totalCapitalizableExpenses = expenses
    .filter(e => e.isCapitalizable)
    .reduce((sum, e) => sum + (e.currency === 'USD' ? (e.amount || 0) * damTC : (e.amount || 0)), 0);
  
  const totalAllocated = result.allocations.reduce((sum, a) => sum + a.amountPen, 0);
  const difference = Math.abs(totalCapitalizableExpenses - totalAllocated);
  
  if (difference > 0.10) {
    result.warnings.push(`Diferencia de redondeo: S/ ${difference.toFixed(2)}`);
  }

  return result;
};

// ========================================
// MOTOR DE GASTOS TARDÍOS
// ========================================

const processLateExpense = (params) => {
  const { originalQty, currentStockQty, daysSinceClose, thresholdDays, expenseAmount } = params;
  
  const result = {
    scenario: null,
    scenarioLabel: '',
    revalueAmount: 0,
    periodExpenseAmount: 0,
    journalEntries: [],
    explanation: ''
  };

  if (daysSinceClose > thresholdDays) {
    result.scenario = LateExpenseScenario.OUT_OF_THRESHOLD;
    result.scenarioLabel = 'Fuera de Plazo';
    result.periodExpenseAmount = expenseAmount;
    result.explanation = `Pasaron ${daysSinceClose} días desde el cierre (umbral: ${thresholdDays} días). 100% va a gasto del período.`;
    result.journalEntries.push({
      debit: '6591 - Otros Gastos de Gestión - Diversos',
      credit: '421 - Facturas por Pagar',
      amount: expenseAmount,
      glosa: `Gasto tardío importación - fuera de plazo (${daysSinceClose} días)`
    });
    return result;
  }

  if (currentStockQty <= 0) {
    result.scenario = LateExpenseScenario.FULL_PERIOD_EXPENSE;
    result.scenarioLabel = 'Todo a Gasto';
    result.periodExpenseAmount = expenseAmount;
    result.explanation = 'No hay stock disponible. 100% va a gasto del período.';
    result.journalEntries.push({
      debit: '6591 - Otros Gastos de Gestión - Diversos',
      credit: '421 - Facturas por Pagar',
      amount: expenseAmount,
      glosa: 'Gasto tardío importación - sin stock disponible'
    });
  } else if (currentStockQty >= originalQty) {
    result.scenario = LateExpenseScenario.FULL_REVALUATION;
    result.scenarioLabel = 'Revalorización Total';
    result.revalueAmount = expenseAmount;
    result.explanation = 'Stock completo disponible. 100% se revaloriza al inventario.';
    result.journalEntries.push({
      debit: '201 - Mercaderías',
      credit: '421 - Facturas por Pagar',
      amount: expenseAmount,
      glosa: 'Revalorización de inventario por gasto tardío'
    });
  } else {
    result.scenario = LateExpenseScenario.PARTIAL_REVALUATION;
    result.scenarioLabel = 'Revalorización Parcial';
    const stockRatio = currentStockQty / originalQty;
    result.revalueAmount = expenseAmount * stockRatio;
    result.periodExpenseAmount = expenseAmount - result.revalueAmount;
    result.explanation = `Stock parcial (${(stockRatio * 100).toFixed(1)}%). Se prorratea entre revalorización y gasto.`;
    
    result.journalEntries.push({
      debit: '201 - Mercaderías',
      credit: '421 - Facturas por Pagar',
      amount: result.revalueAmount,
      glosa: `Revalorización parcial (${(stockRatio * 100).toFixed(1)}% en stock)`
    });
    result.journalEntries.push({
      debit: '6591 - Otros Gastos de Gestión - Diversos',
      credit: '421 - Facturas por Pagar',
      amount: result.periodExpenseAmount,
      glosa: `Gasto tardío (${((1 - stockRatio) * 100).toFixed(1)}% ya vendido)`
    });
  }

  return result;
};

// ========================================
// MOTOR DE DRAWBACK
// ========================================

const allocateDrawbackMaterials = (params) => {
  const { exportItems, damLedger, bomService, exportDate, drawbackRate = 3 } = params;
  
  const result = {
    success: true,
    consumptions: [],
    totalFobUsd: 0,
    totalCifUsed: 0,
    cifFobRatio: 0,
    passesFiftyPercentRule: true,
    drawbackAmountUsd: 0,
    warnings: [],
    insufficientItems: [],
    calculatedAt: new Date().toISOString()
  };

  if (!exportItems || exportItems.length === 0) {
    result.success = false;
    result.warnings.push('No hay ítems de exportación');
    return result;
  }

  const cutoffDate = new Date(exportDate);
  cutoffDate.setMonth(cutoffDate.getMonth() - 36);

  exportItems.forEach(exportItem => {
    result.totalFobUsd += exportItem.fobUsd || 0;
    
    const bom = bomService.getBOM(exportItem.productId);
    if (!bom || bom.length === 0) {
      result.warnings.push(`Producto ${exportItem.sku} no tiene BOM definido`);
      return;
    }

    bom.forEach(component => {
      if (!component.isImported) return;

      const requiredQty = (exportItem.quantity || 0) * (component.quantityPer || 0) * (1 + (component.scrapRate || 0));

      const availableDams = damLedger
        .filter(d => 
          d.productId === component.productId &&
          d.status !== 'EXPIRED' &&
          (d.availableQuantity || 0) > 0 &&
          d.isEligibleDrawback &&
          new Date(d.expiryDate) > new Date(exportDate) &&
          new Date(d.damDate) >= cutoffDate
        )
        .sort((a, b) => new Date(a.damDate) - new Date(b.damDate));

      let remainingQty = requiredQty;
      let totalCifAllocated = 0;

      availableDams.forEach(dam => {
        if (remainingQty <= 0) return;

        const qtyToConsume = Math.min(remainingQty, dam.availableQuantity || 0);
        const cifPortion = qtyToConsume * (dam.unitCifUsd || 0);

        result.consumptions.push({
          exportItemId: exportItem.id,
          damId: dam.id,
          damNumber: dam.damNumber,
          damDate: dam.damDate,
          productId: component.productId,
          productSku: component.sku,
          quantityConsumed: qtyToConsume,
          cifUsdConsumed: cifPortion
        });

        totalCifAllocated += cifPortion;
        remainingQty -= qtyToConsume;
      });

      result.totalCifUsed += totalCifAllocated;

      if (remainingQty > 0) {
        const coverageRatio = requiredQty > 0 ? (requiredQty - remainingQty) / requiredQty : 0;
        result.insufficientItems.push({
          exportItemId: exportItem.id,
          productId: component.productId,
          productSku: component.sku,
          requiredQty,
          availableQty: requiredQty - remainingQty,
          shortage: remainingQty,
          coveragePercent: coverageRatio * 100
        });

        if (coverageRatio < 0.5) {
          result.warnings.push(`⚠️ Cobertura muy baja para ${component.sku}: ${(coverageRatio * 100).toFixed(1)}%`);
        }
      }
    });
  });

  result.cifFobRatio = result.totalFobUsd > 0 ? (result.totalCifUsed / result.totalFobUsd) * 100 : 0;
  result.passesFiftyPercentRule = result.cifFobRatio <= 50;

  if (!result.passesFiftyPercentRule) {
    result.drawbackAmountUsd = 0;
    result.warnings.push(`❌ CIF/FOB = ${result.cifFobRatio.toFixed(2)}% > 50%. No elegible para Drawback.`);
  } else {
    result.drawbackAmountUsd = result.totalFobUsd * (drawbackRate / 100);
  }

  return result;
};

// ========================================
// COMPONENTES UI BASE
// ========================================

const CXBadge = ({ children, variant = 'default', className = '' }) => {
  const variants = {
    default: 'bg-black text-cyan-400 border border-cyan-800',
    success: 'bg-black text-emerald-400 border border-emerald-700',
    warning: 'bg-black text-amber-400 border border-amber-700',
    danger: 'bg-black text-rose-400 border border-rose-700',
    info: 'bg-black text-cyan-400 border border-cyan-700',
    purple: 'bg-black text-violet-400 border border-violet-700'
  };
  return (
    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${variants[variant]} ${className}`}>
      {children}
    </span>
  );
};

const Card = ({ children, className = '', title, icon: Icon, actions }) => (
  <div className={`bg-black border border-cyan-900 rounded-xl overflow-hidden ${className}`}>
    {title && (
      <div className="flex items-center justify-between px-5 py-4 border-b border-cyan-900">
        <div className="flex items-center gap-3">
          {Icon && <Icon className="w-5 h-5 text-cyan-400" />}
          <h3 className="font-semibold text-white">{title}</h3>
        </div>
        {actions && <div className="flex items-center gap-2">{actions}</div>}
      </div>
    )}
    <div className="p-5">{children}</div>
  </div>
);

const Button = ({ children, variant = 'primary', size = 'md', icon: Icon, onClick, disabled, loading, className = '', type = 'button' }) => {
  const variants = {
    primary: 'bg-cyan-600 hover:bg-cyan-500 text-white disabled:bg-cyan-800',
    secondary: 'bg-black hover:bg-cyan-950 text-cyan-400 border border-cyan-800 disabled:opacity-50',
    danger: 'bg-black hover:bg-rose-950 text-rose-400 border border-rose-800 disabled:opacity-50',
    ghost: 'hover:bg-cyan-950 text-cyan-400 disabled:opacity-50',
    success: 'bg-emerald-600 hover:bg-emerald-500 text-white disabled:bg-emerald-800'
  };
  const sizes = {
    sm: 'px-3 py-1.5 text-sm',
    md: 'px-4 py-2',
    lg: 'px-6 py-3 text-lg'
  };
  return (
    <button
      type={type}
      onClick={onClick}
      disabled={disabled || loading}
      className={`inline-flex items-center justify-center gap-2 font-medium rounded-lg transition-all duration-200 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-offset-2 focus:ring-offset-black ${variants[variant]} ${sizes[size]} ${className}`}
    >
      {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : Icon && <Icon className="w-4 h-4" />}
      {children}
    </button>
  );
};

const Input = ({ label, value, onChange, type = 'text', placeholder, icon: Icon, suffix, className = '', error, required, disabled, id, min, max, step }) => {
  const inputId = id || `input-${Math.random().toString(36).substr(2, 9)}`;
  return (
    <div className={className}>
      {label && (
        <label htmlFor={inputId} className="block text-sm font-medium text-cyan-400 mb-1.5">
          {label} {required && <span className="text-rose-400">*</span>}
        </label>
      )}
      <div className="relative">
        {Icon && (
          <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <Icon className="h-4 w-4 text-cyan-600" />
          </div>
        )}
        <input
          id={inputId}
          type={type}
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder={placeholder}
          disabled={disabled}
          min={min}
          max={max}
          step={step}
          aria-invalid={!!error}
          aria-describedby={error ? `${inputId}-error` : undefined}
          className={`w-full bg-black border ${error ? 'border-rose-600 focus:ring-rose-500' : 'border-cyan-800 focus:ring-cyan-600'} rounded-lg px-3 py-2 text-white placeholder-cyan-800 focus:outline-none focus:ring-2 focus:border-transparent transition-all disabled:opacity-50 disabled:cursor-not-allowed ${Icon ? 'pl-10' : ''} ${suffix ? 'pr-12' : ''}`}
        />
        {suffix && (
          <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
            <span className="text-cyan-600 text-sm">{suffix}</span>
          </div>
        )}
      </div>
      {error && <p id={`${inputId}-error`} className="mt-1 text-sm text-rose-400" role="alert">{error}</p>}
    </div>
  );
};

const Select = ({ label, value, onChange, options, className = '', error, required, disabled, id }) => {
  const selectId = id || `select-${Math.random().toString(36).substr(2, 9)}`;
  return (
    <div className={className}>
      {label && (
        <label htmlFor={selectId} className="block text-sm font-medium text-cyan-400 mb-1.5">
          {label} {required && <span className="text-rose-400">*</span>}
        </label>
      )}
      <select
        id={selectId}
        value={value}
        onChange={(e) => onChange(e.target.value)}
        disabled={disabled}
        aria-invalid={!!error}
        className={`w-full bg-black border ${error ? 'border-rose-600' : 'border-cyan-800'} rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-600 focus:border-transparent transition-all appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed`}
      >
        {options.map(opt => (
          <option key={opt.value} value={opt.value}>{opt.label}</option>
        ))}
      </select>
      {error && <p className="mt-1 text-sm text-rose-400" role="alert">{error}</p>}
    </div>
  );
};

const Checkbox = ({ label, checked, onChange, disabled, className = '' }) => {
  const id = `checkbox-${Math.random().toString(36).substr(2, 9)}`;
  return (
    <div className={`flex items-center gap-3 ${className}`}>
      <input
        id={id}
        type="checkbox"
        checked={checked}
        onChange={(e) => onChange(e.target.checked)}
        disabled={disabled}
        className="w-4 h-4 rounded border-cyan-800 bg-black text-cyan-500 focus:ring-cyan-600 focus:ring-offset-black disabled:opacity-50"
      />
      <label htmlFor={id} className="text-sm text-cyan-300 cursor-pointer select-none">{label}</label>
    </div>
  );
};

const Table = ({ columns, data, onRowClick, emptyMessage = 'No hay datos disponibles', loading }) => (
  <div className="overflow-x-auto">
    {loading ? (
      <div className="flex items-center justify-center py-12">
        <Loader2 className="w-8 h-8 text-cyan-400 animate-spin" />
      </div>
    ) : (
      <table className="w-full">
        <thead>
          <tr className="border-b border-cyan-900">
            {columns.map((col, i) => (
              <th key={i} className={`px-4 py-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider ${col.align === 'right' ? 'text-right' : ''}`}>
                {col.header}
              </th>
            ))}
          </tr>
        </thead>
        <tbody className="divide-y divide-cyan-950">
          {data.map((row, i) => (
            <tr
              key={row.id || i}
              onClick={() => onRowClick?.(row)}
              className={`hover:bg-cyan-950 transition-colors ${onRowClick ? 'cursor-pointer' : ''}`}
            >
              {columns.map((col, j) => (
                <td key={j} className={`px-4 py-3 text-sm text-white ${col.align === 'right' ? 'text-right' : ''} ${col.className || ''}`}>
                  {col.render ? col.render(row[col.key], row) : row[col.key]}
                </td>
              ))}
            </tr>
          ))}
          {data.length === 0 && (
            <tr>
              <td colSpan={columns.length} className="px-4 py-12 text-center">
                <Package className="w-12 h-12 mx-auto text-cyan-800 mb-3" />
                <p className="text-cyan-600">{emptyMessage}</p>
              </td>
            </tr>
          )}
        </tbody>
      </table>
    )}
  </div>
);

const MetricCard = ({ label, value, icon: Icon, trend, trendValue, variant = 'default' }) => {
  const variants = {
    default: 'border-cyan-900',
    cyan: 'border-cyan-600',
    emerald: 'border-emerald-600',
    amber: 'border-amber-600',
    purple: 'border-violet-600'
  };
  const iconColors = {
    default: 'text-cyan-400',
    cyan: 'text-cyan-400',
    emerald: 'text-emerald-400',
    amber: 'text-amber-400',
    purple: 'text-violet-400'
  };
  return (
    <div className={`bg-black border ${variants[variant]} rounded-xl p-5`}>
      <div className="flex items-start justify-between">
        <div>
          <p className="text-sm text-cyan-600 mb-1">{label}</p>
          <p className="text-2xl font-bold text-white">{value}</p>
          {trend && (
            <div className={`flex items-center mt-2 text-sm ${trend === 'up' ? 'text-emerald-400' : 'text-rose-400'}`}>
              <TrendingUp className={`w-4 h-4 mr-1 ${trend === 'down' ? 'rotate-180' : ''}`} />
              {trendValue}
            </div>
          )}
        </div>
        {Icon && (
          <div className="p-3 bg-black border border-cyan-900 rounded-lg">
            <Icon className={`w-6 h-6 ${iconColors[variant]}`} />
          </div>
        )}
      </div>
    </div>
  );
};

const Alert = ({ type = 'info', title, children, onClose }) => {
  const types = {
    info: { border: 'border-cyan-700', icon: Info, iconColor: 'text-cyan-400' },
    success: { border: 'border-emerald-700', icon: CheckCircle, iconColor: 'text-emerald-400' },
    warning: { border: 'border-amber-700', icon: AlertTriangle, iconColor: 'text-amber-400' },
    danger: { border: 'border-rose-700', icon: XCircle, iconColor: 'text-rose-400' }
  };
  const { border, icon: Icon, iconColor } = types[type];
  return (
    <div className={`bg-black ${border} border rounded-xl p-4`} role="alert">
      <div className="flex gap-3">
        <Icon className={`w-5 h-5 ${iconColor} flex-shrink-0 mt-0.5`} />
        <div className="flex-1">
          {title && <h4 className="font-medium text-white mb-1">{title}</h4>}
          <div className="text-sm text-cyan-300">{children}</div>
        </div>
        {onClose && (
          <button onClick={onClose} className="text-cyan-600 hover:text-cyan-400" aria-label="Cerrar">
            <X className="w-4 h-4" />
          </button>
        )}
      </div>
    </div>
  );
};

const CXTabs = ({ tabs, activeTab, onChange }) => (
  <div className="flex gap-1 p-1 bg-black rounded-lg border border-cyan-900 overflow-x-auto" role="tablist">
    {tabs.map(tab => (
      <button
        key={tab.id}
        role="tab"
        aria-selected={activeTab === tab.id}
        onClick={() => onChange(tab.id)}
        className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all whitespace-nowrap focus:outline-none focus:ring-2 focus:ring-cyan-500 ${
          activeTab === tab.id
            ? 'bg-cyan-600 text-white'
            : 'text-cyan-500 hover:text-white hover:bg-cyan-950'
        }`}
      >
        {tab.icon && <tab.icon className="w-4 h-4" />}
        {tab.label}
      </button>
    ))}
  </div>
);

const CXModal = ({ isOpen, onClose, title, children, size = 'md' }) => {
  const modalRef = useRef(null);
  
  useEffect(() => {
    if (isOpen) {
      modalRef.current?.focus();
    }
  }, [isOpen]);

  useEffect(() => {
    const handleEscape = (e) => {
      if (e.key === 'Escape' && isOpen) {
        onClose();
      }
    };
    try { document.addEventListener('keydown', handleEscape); } catch(e) {}
    return () => { try { document.removeEventListener('keydown', handleEscape); } catch(e) {} };
  }, [isOpen, onClose]);

  if (!isOpen) return null;
  
  const sizes = {
    sm: 'max-w-md',
    md: 'max-w-2xl',
    lg: 'max-w-4xl',
    xl: 'max-w-6xl',
    full: 'max-w-[95vw]'
  };
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div className="absolute inset-0 bg-black/90" onClick={onClose} aria-hidden="true" />
      <div 
        ref={modalRef}
        tabIndex={-1}
        className={`relative bg-black border border-cyan-800 rounded-2xl shadow-2xl w-full ${sizes[size]} max-h-[90vh] overflow-hidden focus:outline-none`}
      >
        <div className="flex items-center justify-between px-6 py-4 border-b border-cyan-900">
          <h2 id="modal-title" className="text-xl font-semibold text-white">{title}</h2>
          <button 
            onClick={onClose} 
            className="p-2 hover:bg-cyan-950 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-cyan-500"
            aria-label="Cerrar modal"
          >
            <X className="w-5 h-5 text-cyan-500" />
          </button>
        </div>
        <div className="overflow-y-auto max-h-[calc(90vh-80px)]">{children}</div>
      </div>
    </div>
  );
};

const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message, confirmText = 'Confirmar', cancelText = 'Cancelar', variant = 'danger', loading }) => (
  <CXModal isOpen={isOpen} onClose={onClose} title={title} size="sm">
    <div className="p-6">
      <p className="text-cyan-300 mb-6">{message}</p>
      <div className="flex gap-3 justify-end">
        <Button variant="secondary" onClick={onClose} disabled={loading}>
          {cancelText}
        </Button>
        <Button variant={variant} onClick={onConfirm} loading={loading}>
          {confirmText}
        </Button>
      </div>
    </div>
  </CXModal>
);

const EmptyState = ({ icon: Icon, title, description, action }) => (
  <div className="text-center py-12">
    <Icon className="w-16 h-16 mx-auto text-cyan-800 mb-4" />
    <h3 className="text-lg font-medium text-white mb-2">{title}</h3>
    <p className="text-cyan-600 mb-6 max-w-md mx-auto">{description}</p>
    {action}
  </div>
);

const SearchInput = ({ value, onChange, placeholder = 'Buscar...' }) => (
  <div className="relative">
    <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-cyan-600" />
    <input
      type="text"
      value={value}
      onChange={(e) => onChange(e.target.value)}
      placeholder={placeholder}
      className="w-full bg-black border border-cyan-800 rounded-lg pl-10 pr-4 py-2 text-white placeholder-cyan-700 focus:outline-none focus:ring-2 focus:ring-cyan-600 focus:border-transparent"
    />
    {value && (
      <button 
        onClick={() => onChange('')}
        className="absolute right-3 top-1/2 -translate-y-1/2 text-cyan-600 hover:text-cyan-400"
      >
        <X className="w-4 h-4" />
      </button>
    )}
  </div>
);

// Agregar estilos CSS para animaciones
const GlobalStyles = () => (
  <style>{`
    @keyframes slide-in {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .animate-slide-in {
      animation: slide-in 0.3s ease-out;
    }
  `}</style>
);

// ========================================
// COMPONENTES VISUALES AVANZADOS
// ========================================

const AnimatedDonut = ({ data, size = 120, strokeWidth = 12 }) => {
  const [animated, setAnimated] = useState(false);
  useEffect(() => {
    const timer = setTimeout(() => setAnimated(true), 100);
    return () => clearTimeout(timer);
  }, []);
  
  const total = data.reduce((sum, d) => sum + d.value, 0);
  if (total === 0) {
    return (
      <div className="flex items-center justify-center" style={{ width: size, height: size }}>
        <p className="text-cyan-700 text-sm">Sin datos</p>
      </div>
    );
  }
  
  const radius = (size - strokeWidth) / 2;
  const circumference = 2 * Math.PI * radius;
  let accumulatedOffset = 0;
  
  return (
    <div className="relative" style={{ width: size, height: size }}>
      <svg width={size} height={size} className="transform -rotate-90">
        <circle
          cx={size / 2}
          cy={size / 2}
          r={radius}
          fill="none"
          stroke="#0e1a1f"
          strokeWidth={strokeWidth}
        />
        {data.map((item, index) => {
          const percentage = item.value / total;
          const strokeDasharray = circumference * percentage;
          const strokeDashoffset = -accumulatedOffset * circumference;
          accumulatedOffset += percentage;
          
          return (
            <circle
              key={index}
              cx={size / 2}
              cy={size / 2}
              r={radius}
              fill="none"
              stroke={item.color}
              strokeWidth={strokeWidth}
              strokeDasharray={`${animated ? strokeDasharray : 0} ${circumference}`}
              strokeDashoffset={strokeDashoffset}
              strokeLinecap="round"
              className="transition-all duration-1000 ease-out"
              style={{ filter: `drop-shadow(0 0 6px ${item.color}50)` }}
            />
          );
        })}
      </svg>
      <div className="absolute inset-0 flex items-center justify-center">
        <div className="text-center">
          <p className="text-2xl font-bold text-white">{total}</p>
          <p className="text-xs text-cyan-600">Total</p>
        </div>
      </div>
    </div>
  );
};

const AnimatedProgress = ({ value, max, color = 'cyan', label, showValue = true }) => {
  const [width, setWidth] = useState(0);
  const percentage = max > 0 ? (value / max) * 100 : 0;
  
  useEffect(() => {
    const timer = setTimeout(() => setWidth(percentage), 100);
    return () => clearTimeout(timer);
  }, [percentage]);
  
  const colors = {
    cyan: 'bg-cyan-500',
    emerald: 'bg-emerald-500',
    amber: 'bg-amber-500',
    rose: 'bg-rose-500',
    violet: 'bg-violet-500'
  };
  
  return (
    <div className="space-y-1">
      {label && (
        <div className="flex justify-between text-sm">
          <span className="text-cyan-400">{label}</span>
          {showValue && <span className="text-white font-medium">{value.toLocaleString()}</span>}
        </div>
      )}
      <div className="h-2 bg-cyan-950 rounded-full overflow-hidden">
        <div 
          className={`h-full ${colors[color]} rounded-full transition-all duration-1000 ease-out`}
          style={{ width: `${width}%` }}
        />
      </div>
    </div>
  );
};

const Sparkline = ({ data, color = '#22d3ee', height = 40 }) => {
  if (!data || data.length < 2) return null;
  
  const max = Math.max(...data);
  const min = Math.min(...data);
  const range = max - min || 1;
  const width = 100;
  const points = data.map((value, index) => {
    const x = (index / (data.length - 1)) * width;
    const y = height - ((value - min) / range) * (height - 4) - 2;
    return `${x},${y}`;
  }).join(' ');
  
  const gradientId = `gradient-${color.replace('#', '')}-${Math.random().toString(36).substr(2, 9)}`;
  
  return (
    <svg width="100%" height={height} viewBox={`0 0 ${width} ${height}`} preserveAspectRatio="none">
      <defs>
        <linearGradient id={gradientId} x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stopColor={color} stopOpacity="0.3" />
          <stop offset="100%" stopColor={color} stopOpacity="0" />
        </linearGradient>
      </defs>
      <polygon
        points={`0,${height} ${points} ${width},${height}`}
        fill={`url(#${gradientId})`}
      />
      <polyline
        points={points}
        fill="none"
        stroke={color}
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
        style={{ filter: `drop-shadow(0 0 4px ${color})` }}
      />
    </svg>
  );
};

const AdvancedMetricCard = ({ label, value, subValue, icon: Icon, color = 'cyan', sparkData, trend, onClick }) => {
  const [isHovered, setIsHovered] = useState(false);
  
  const colors = {
    cyan: { border: 'border-cyan-600', text: 'text-cyan-400', icon: 'text-cyan-400' },
    emerald: { border: 'border-emerald-600', text: 'text-emerald-400', icon: 'text-emerald-400' },
    amber: { border: 'border-amber-600', text: 'text-amber-400', icon: 'text-amber-400' },
    rose: { border: 'border-rose-600', text: 'text-rose-400', icon: 'text-rose-400' },
    violet: { border: 'border-violet-600', text: 'text-violet-400', icon: 'text-violet-400' }
  };
  
  const sparkColors = {
    cyan: '#22d3ee',
    emerald: '#34d399',
    amber: '#fbbf24',
    rose: '#fb7185',
    violet: '#a78bfa'
  };
  
  return (
    <div
      className={`relative bg-black border ${colors[color].border} rounded-xl p-5 cursor-pointer transition-all duration-300 hover:scale-105 overflow-hidden group`}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
      onClick={onClick}
      role="button"
      tabIndex={0}
      onKeyDown={(e) => e.key === 'Enter' && onClick?.()}
    >
      <div className={`absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-0 group-hover:opacity-5 transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-all duration-700`} />
      
      <div className="flex items-start justify-between relative z-10">
        <div className="flex-1">
          <p className={`text-sm ${colors[color].text} mb-1 font-medium`}>{label}</p>
          <p className="text-3xl font-bold text-white mb-1">{value}</p>
          {subValue && <p className="text-sm text-cyan-600">{subValue}</p>}
          {trend && (
            <div className={`flex items-center gap-1 mt-2 text-sm ${trend.direction === 'up' ? 'text-emerald-400' : 'text-rose-400'}`}>
              <TrendingUp className={`w-4 h-4 ${trend.direction === 'down' ? 'rotate-180' : ''}`} />
              <span>{trend.value}</span>
            </div>
          )}
        </div>
        <div className={`p-3 rounded-xl border ${colors[color].border} transition-all duration-300 ${isHovered ? 'scale-110' : ''}`}>
          <Icon className={`w-6 h-6 ${colors[color].icon}`} />
        </div>
      </div>
      
      {sparkData && sparkData.length > 1 && (
        <div className="mt-4 -mx-2 -mb-2">
          <Sparkline data={sparkData} color={sparkColors[color]} />
        </div>
      )}
    </div>
  );
};

const ActivityTimeline = ({ activities }) => (
  <div className="space-y-4">
    {activities.length === 0 ? (
      <p className="text-center text-cyan-600 py-6">No hay actividad reciente</p>
    ) : (
      activities.map((activity, index) => (
        <div key={index} className="flex gap-4 group">
          <div className="flex flex-col items-center">
            <div className={`w-10 h-10 rounded-full border-2 ${activity.borderColor} bg-black flex items-center justify-center transition-all duration-300 group-hover:scale-110`}>
              <activity.icon className={`w-5 h-5 ${activity.iconColor}`} />
            </div>
            {index < activities.length - 1 && (
              <div className="w-0.5 h-full bg-gradient-to-b from-cyan-800 to-transparent min-h-8" />
            )}
          </div>
          <div className="flex-1 pb-4">
            <div className="bg-black border border-cyan-900 rounded-lg p-4 transition-all duration-300 hover:border-cyan-700">
              <div className="flex items-start justify-between mb-1">
                <p className="font-medium text-white">{activity.title}</p>
                <span className="text-xs text-cyan-700">{activity.time}</span>
              </div>
              <p className="text-sm text-cyan-500">{activity.description}</p>
              {activity.value && (
                <p className={`text-lg font-bold mt-2 ${activity.valueColor || 'text-cyan-400'}`}>{activity.value}</p>
              )}
            </div>
          </div>
        </div>
      ))
    )}
  </div>
);

const StatusGrid = ({ items }) => (
  <div className="grid grid-cols-2 gap-3">
    {items.map((item, index) => (
      <div 
        key={index}
        className={`p-4 rounded-xl border ${item.borderColor} bg-black transition-all duration-300 hover:scale-105 cursor-pointer`}
      >
        <div className="flex items-center gap-3 mb-2">
          <div className={`w-3 h-3 rounded-full ${item.dotColor} animate-pulse`} />
          <span className="text-sm text-cyan-400">{item.label}</span>
        </div>
        <p className="text-2xl font-bold text-white">{item.value}</p>
        {item.subtext && <p className="text-xs text-cyan-700 mt-1">{item.subtext}</p>}
      </div>
    ))}
  </div>
);

// ========================================
// DASHBOARD PRINCIPAL
// ========================================

const Dashboard = ({ folders, damLedger, onNavigate }) => {
  const [selectedPeriod, setSelectedPeriod] = useState('month');
  const [animateCards, setAnimateCards] = useState(false);
  
  useEffect(() => {
    const timer = setTimeout(() => setAnimateCards(true), 100);
    return () => clearTimeout(timer);
  }, []);

  const stats = useMemo(() => {
    const totalFolders = folders.length;
    const activeFolders = folders.filter(f => !['CLOSED', 'COSTED'].includes(f.status)).length;
    const costedFolders = folders.filter(f => f.status === 'COSTED').length;
    const totalLandedCost = folders.reduce((sum, f) => sum + (f.calculatedCost?.totalLandedCostPen || 0), 0);
    const totalFob = folders.reduce((sum, f) => sum + f.items.reduce((s, i) => s + (i.fobUsd || 0), 0), 0);
    const totalCif = folders.reduce((sum, f) => sum + f.items.reduce((s, i) => s + (i.cifUsd || 0), 0), 0);
    const pendingExpenses = folders.reduce((sum, f) => 
      sum + f.expenses.filter(e => !e.isProcessed).length, 0
    );
    const expiringDams = damLedger.filter(d => {
      const daysToExpiry = (new Date(d.expiryDate) - new Date()) / (1000 * 60 * 60 * 24);
      return daysToExpiry > 0 && daysToExpiry <= 30;
    }).length;
    const availableDams = damLedger.filter(d => d.status === 'AVAILABLE').length;
    const partialDams = damLedger.filter(d => d.status === 'PARTIALLY_CONSUMED').length;
    const totalCifAvailable = damLedger
      .filter(d => ['AVAILABLE', 'PARTIALLY_CONSUMED'].includes(d.status))
      .reduce((sum, d) => sum + (d.availableCifUsd || 0), 0);
    
    const foldersByStatus = {
      draft: folders.filter(f => f.status === 'DRAFT').length,
      inTransit: folders.filter(f => f.status === 'IN_TRANSIT').length,
      customs: folders.filter(f => f.status === 'CUSTOMS').length,
      cleared: folders.filter(f => f.status === 'CLEARED').length,
      costed: folders.filter(f => f.status === 'COSTED').length
    };

    const overheadPercent = totalCif > 0 ? ((totalLandedCost / (totalCif * 3.75)) - 1) * 100 : 0;
    const closeRate = totalFolders > 0 ? (costedFolders / totalFolders) * 100 : 0;
    
    return { 
      totalFolders, activeFolders, costedFolders, totalLandedCost, pendingExpenses, expiringDams,
      availableDams, partialDams, totalCifAvailable, totalFob, totalCif, foldersByStatus,
      overheadPercent, closeRate
    };
  }, [folders, damLedger]);

  const donutData = useMemo(() => [
    { value: stats.foldersByStatus.draft, color: '#06b6d4', label: 'Borrador' },
    { value: stats.foldersByStatus.inTransit, color: '#3b82f6', label: 'En Tránsito' },
    { value: stats.foldersByStatus.customs, color: '#f59e0b', label: 'En Aduana' },
    { value: stats.foldersByStatus.cleared, color: '#10b981', label: 'Liberado' },
    { value: stats.foldersByStatus.costed, color: '#8b5cf6', label: 'Costeado' }
  ].filter(d => d.value > 0), [stats.foldersByStatus]);

  const damDonutData = useMemo(() => [
    { value: stats.availableDams, color: '#10b981', label: 'Disponible' },
    { value: stats.partialDams, color: '#f59e0b', label: 'Parcial' },
    { value: stats.expiringDams, color: '#ef4444', label: 'Por Vencer' }
  ].filter(d => d.value > 0), [stats]);

  const costTrend = useMemo(() => [45000, 52000, 48000, 61000, 55000, 67000, stats.totalLandedCost / 1000], [stats.totalLandedCost]);
  const folderTrend = useMemo(() => [2, 3, 2, 4, 3, 5, stats.activeFolders], [stats.activeFolders]);

  const activities = useMemo(() => {
    const acts = [];
    folders.slice(0, 4).forEach((folder, idx) => {
      acts.push({
        icon: folder.isCostLocked ? Calculator : Ship,
        title: folder.number,
        description: folder.isCostLocked ? 'Landed cost calculado' : `${FolderStatus[folder.status]?.label || folder.status}`,
        time: formatDate(folder.calculatedCost?.calculatedAt || folder.createdAt),
        value: folder.calculatedCost ? formatCurrency(folder.calculatedCost.totalLandedCostPen) : formatCurrency(folder.items.reduce((s, i) => s + (i.cifUsd || 0), 0), 'USD'),
        valueColor: folder.isCostLocked ? 'text-emerald-400' : 'text-cyan-400',
        borderColor: folder.isCostLocked ? 'border-emerald-600' : 'border-cyan-600',
        iconColor: folder.isCostLocked ? 'text-emerald-400' : 'text-cyan-400'
      });
    });
    return acts;
  }, [folders]);

  const statusItems = useMemo(() => [
    { label: 'En Tránsito', value: stats.foldersByStatus.inTransit, dotColor: 'bg-blue-500', borderColor: 'border-blue-800', subtext: 'Embarcadas' },
    { label: 'En Aduana', value: stats.foldersByStatus.customs, dotColor: 'bg-amber-500', borderColor: 'border-amber-800', subtext: 'Despacho' },
    { label: 'Liberadas', value: stats.foldersByStatus.cleared, dotColor: 'bg-emerald-500', borderColor: 'border-emerald-800', subtext: 'Por costear' },
    { label: 'Costeadas', value: stats.foldersByStatus.costed, dotColor: 'bg-violet-500', borderColor: 'border-violet-800', subtext: 'Cerradas' }
  ], [stats.foldersByStatus]);

  return (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-white">Dashboard</h2>
          <p className="text-cyan-600">Resumen de operaciones de comercio exterior</p>
        </div>
        <div className="flex gap-2">
          {['week', 'month', 'year'].map(period => (
            <button
              key={period}
              onClick={() => setSelectedPeriod(period)}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-cyan-500 ${
                selectedPeriod === period
                  ? 'bg-cyan-600 text-white'
                  : 'bg-black border border-cyan-800 text-cyan-400 hover:bg-cyan-950'
              }`}
            >
              {period === 'week' ? 'Semana' : period === 'month' ? 'Mes' : 'Año'}
            </button>
          ))}
        </div>
      </div>

      <div className={`grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 transition-all duration-500 ${animateCards ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'}`}>
        <AdvancedMetricCard
          label="Landed Cost Total"
          value={formatCurrency(stats.totalLandedCost)}
          subValue={`FOB: ${formatCurrency(stats.totalFob, 'USD')}`}
          icon={DollarSign}
          color="emerald"
          sparkData={costTrend}
          trend={{ direction: 'up', value: '+12.5% vs mes ant.' }}
        />
        <AdvancedMetricCard
          label="Carpetas Activas"
          value={stats.activeFolders}
          subValue={`de ${stats.totalFolders} totales`}
          icon={Ship}
          color="cyan"
          sparkData={folderTrend}
          onClick={() => onNavigate('folders')}
        />
        <AdvancedMetricCard
          label="CIF Disponible"
          value={formatCurrency(stats.totalCifAvailable, 'USD')}
          subValue="Para Drawback"
          icon={Warehouse}
          color="violet"
          onClick={() => onNavigate('dam-ledger')}
        />
        <AdvancedMetricCard
          label="DAMs por Vencer"
          value={stats.expiringDams}
          subValue="Próximos 30 días"
          icon={AlertTriangle}
          color={stats.expiringDams > 0 ? 'rose' : 'emerald'}
          onClick={() => onNavigate('dam-ledger')}
        />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <Card title="Estado de Carpetas" icon={Package}>
          <div className="flex flex-col items-center mb-6">
            <AnimatedDonut data={donutData} size={160} strokeWidth={16} />
          </div>
          <div className="space-y-3">
            {donutData.map((item, index) => (
              <div key={index} className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className="w-3 h-3 rounded-full" style={{ backgroundColor: item.color }} />
                  <span className="text-cyan-400 text-sm">{item.label}</span>
                </div>
                <span className="text-white font-medium">{item.value}</span>
              </div>
            ))}
          </div>
          <div className="mt-6 pt-4 border-t border-cyan-900">
            <StatusGrid items={statusItems} />
          </div>
        </Card>

        <Card title="Actividad Reciente" icon={Clock}>
          <ActivityTimeline activities={activities} />
        </Card>

        <Card title="DAM Ledger" icon={FileSpreadsheet}>
          <div className="flex flex-col items-center mb-6">
            <AnimatedDonut data={damDonutData} size={140} strokeWidth={14} />
          </div>
          
          <div className="space-y-4">
            <AnimatedProgress 
              value={stats.availableDams} 
              max={damLedger.length || 1} 
              color="emerald" 
              label="Disponibles" 
            />
            <AnimatedProgress 
              value={stats.partialDams} 
              max={damLedger.length || 1} 
              color="amber" 
              label="Parcialmente Consumidas" 
            />
            <AnimatedProgress 
              value={stats.expiringDams} 
              max={damLedger.length || 1} 
              color="rose" 
              label="Por Vencer (30 días)" 
            />
          </div>

          <div className="mt-6 pt-4 border-t border-cyan-900 space-y-3">
            <h4 className="text-sm font-medium text-cyan-400">Próximos Vencimientos</h4>
            {damLedger
              .filter(d => {
                const daysToExpiry = (new Date(d.expiryDate) - new Date()) / (1000 * 60 * 60 * 24);
                return daysToExpiry > 0 && daysToExpiry <= 30;
              })
              .slice(0, 3)
              .map(dam => {
                const daysToExpiry = Math.floor((new Date(dam.expiryDate) - new Date()) / (1000 * 60 * 60 * 24));
                return (
                  <div key={dam.id} className="flex items-center justify-between p-3 bg-black border border-cyan-950 rounded-lg hover:border-cyan-800 transition-all duration-300 cursor-pointer">
                    <div>
                      <p className="font-mono text-cyan-400 text-sm">{dam.damNumber}</p>
                      <p className="text-xs text-cyan-700">{dam.productSku}</p>
                    </div>
                    <div className="text-right">
                      <CXBadge variant={daysToExpiry <= 7 ? 'danger' : 'warning'}>
                        {daysToExpiry}d
                      </CXBadge>
                      <p className="text-xs text-cyan-600 mt-1">{dam.availableQuantity} {dam.unitOfMeasure}</p>
                    </div>
                  </div>
                );
              })}
            {stats.expiringDams === 0 && (
              <div className="text-center py-4">
                <CheckCircle className="w-8 h-8 mx-auto mb-2 text-emerald-400" />
                <p className="text-sm text-cyan-600">Sin vencimientos próximos</p>
              </div>
            )}
          </div>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <Card title="Carpetas Recientes" icon={Ship} actions={
          <Button variant="ghost" size="sm" onClick={() => onNavigate('folders')}>Ver todas</Button>
        }>
          {folders.length === 0 ? (
            <EmptyState
              icon={Ship}
              title="Sin carpetas"
              description="Crea tu primera carpeta de importación para comenzar"
              action={<Button icon={Plus} onClick={() => onNavigate('folders', 'new')}>Nueva Carpeta</Button>}
            />
          ) : (
            <div className="space-y-3">
              {folders.slice(0, 4).map((folder, index) => {
                const totalValue = folder.items.reduce((sum, item) => sum + (item.cifUsd || 0), 0);
                const progress = folder.isCostLocked ? 100 : folder.status === 'CLEARED' ? 75 : folder.status === 'CUSTOMS' ? 50 : 25;
                
                return (
                  <div 
                    key={folder.id} 
                    className="p-4 bg-black border border-cyan-900 rounded-xl hover:border-cyan-700 transition-all duration-300 cursor-pointer"
                    onClick={() => onNavigate('folders', folder.id)}
                  >
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-lg ${FolderStatus[folder.status]?.color || 'bg-cyan-800'} flex items-center justify-center`}>
                          <Ship className="w-5 h-5 text-white" />
                        </div>
                        <div>
                          <p className="font-medium text-white">{folder.number}</p>
                          <p className="text-sm text-cyan-600">{folder.supplier}</p>
                        </div>
                      </div>
                      <CXBadge variant={folder.status === 'COSTED' ? 'success' : folder.status === 'CLEARED' ? 'info' : 'warning'}>
                        {FolderStatus[folder.status]?.label || folder.status}
                      </CXBadge>
                    </div>
                    
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm text-cyan-500">Progreso</span>
                      <span className="text-sm text-cyan-400">{progress}%</span>
                    </div>
                    <div className="h-1.5 bg-cyan-950 rounded-full overflow-hidden mb-3">
                      <div 
                        className={`h-full rounded-full transition-all duration-1000 ${folder.isCostLocked ? 'bg-emerald-500' : 'bg-cyan-500'}`}
                        style={{ width: `${progress}%` }}
                      />
                    </div>
                    
                    <div className="flex items-center justify-between text-sm">
                      <span className="text-cyan-600">{folder.items.length} ítems • {folder.expenses.length} gastos</span>
                      <span className="font-medium text-white">{formatCurrency(totalValue, 'USD')}</span>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </Card>

        <Card title="Métricas de Rendimiento" icon={BarChart3}>
          <div className="space-y-6">
            <div className="grid grid-cols-2 gap-4">
              <div className="p-4 border border-cyan-900 rounded-xl text-center">
                <p className="text-3xl font-bold text-emerald-400">{stats.overheadPercent.toFixed(1)}%</p>
                <p className="text-sm text-cyan-600 mt-1">Overhead Promedio</p>
              </div>
              <div className="p-4 border border-cyan-900 rounded-xl text-center">
                <p className="text-3xl font-bold text-cyan-400">{stats.closeRate.toFixed(0)}%</p>
                <p className="text-sm text-cyan-600 mt-1">Tasa de Cierre</p>
              </div>
            </div>

            <div>
              <h4 className="text-sm font-medium text-cyan-400 mb-4">Distribución de Costos</h4>
              <div className="space-y-3">
                <div className="flex items-center justify-between">
                  <span className="text-cyan-500">CIF Base</span>
                  <span className="text-white font-medium">{formatCurrency(stats.totalCif * 3.75)}</span>
                </div>
                <AnimatedProgress value={75} max={100} color="cyan" showValue={false} />
                
                <div className="flex items-center justify-between">
                  <span className="text-cyan-500">Derechos</span>
                  <span className="text-white font-medium">{formatCurrency(stats.totalLandedCost * 0.15)}</span>
                </div>
                <AnimatedProgress value={15} max={100} color="amber" showValue={false} />
                
                <div className="flex items-center justify-between">
                  <span className="text-cyan-500">Gastos</span>
                  <span className="text-white font-medium">{formatCurrency(stats.totalLandedCost * 0.10)}</span>
                </div>
                <AnimatedProgress value={10} max={100} color="violet" showValue={false} />
              </div>
            </div>

            <div className="pt-4 border-t border-cyan-900">
              <h4 className="text-sm font-medium text-cyan-400 mb-3">Acciones Rápidas</h4>
              <div className="grid grid-cols-2 gap-3">
                <Button variant="secondary" icon={Plus} className="w-full justify-center" onClick={() => onNavigate('folders', 'new')}>
                  Nueva Carpeta
                </Button>
                <Button variant="secondary" icon={Calculator} className="w-full justify-center" onClick={() => onNavigate('drawback')}>
                  Calcular Drawback
                </Button>
              </div>
            </div>
          </div>
        </Card>
      </div>
    </div>
  );
};

// ========================================
// FORMULARIO DE ITEM
// ========================================

const ItemForm = ({ item, onSave, onCancel, existingItems = [] }) => {
  const [formData, setFormData] = useState({
    sku: item?.sku || '',
    description: item?.description || '',
    quantity: item?.quantity || '',
    fobUsd: item?.fobUsd || '',
    cifUsd: item?.cifUsd || '',
    weightKg: item?.weightKg || '',
    volumeM3: item?.volumeM3 || '',
    adValoremRate: item?.adValoremRate || '0'
  });
  const [errors, setErrors] = useState({});

  const validate = useCallback(() => {
    const newErrors = {};
    
    if (!formData.sku.trim()) newErrors.sku = 'SKU es requerido';
    if (!formData.description.trim()) newErrors.description = 'Descripción es requerida';
    if (!formData.quantity || parseFloat(formData.quantity) <= 0) newErrors.quantity = 'Cantidad debe ser mayor a 0';
    if (!formData.fobUsd || parseFloat(formData.fobUsd) < 0) newErrors.fobUsd = 'FOB USD debe ser válido';
    if (!formData.cifUsd || parseFloat(formData.cifUsd) < 0) newErrors.cifUsd = 'CIF USD debe ser válido';
    if (formData.weightKg && parseFloat(formData.weightKg) < 0) newErrors.weightKg = 'Peso debe ser positivo';
    if (formData.volumeM3 && parseFloat(formData.volumeM3) < 0) newErrors.volumeM3 = 'Volumen debe ser positivo';
    if (parseFloat(formData.adValoremRate) < 0 || parseFloat(formData.adValoremRate) > 100) newErrors.adValoremRate = 'Arancel debe estar entre 0 y 100';

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  }, [formData]);

  const handleSubmit = useCallback((e) => {
    e.preventDefault();
    if (validate()) {
      onSave({
        id: item?.id || generateId(),
        sku: formData.sku.trim(),
        description: formData.description.trim(),
        quantity: parseFloat(formData.quantity) || 0,
        fobUsd: parseFloat(formData.fobUsd) || 0,
        cifUsd: parseFloat(formData.cifUsd) || 0,
        weightKg: parseFloat(formData.weightKg) || 0,
        volumeM3: parseFloat(formData.volumeM3) || 0,
        adValoremRate: parseFloat(formData.adValoremRate) || 0
      });
    }
  }, [formData, item, onSave, validate]);

  return (
    <form onSubmit={handleSubmit} className="p-6 space-y-4">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <Input
          label="SKU"
          value={formData.sku}
          onChange={(v) => setFormData(prev => ({ ...prev, sku: v }))}
          placeholder="Ej: LAPTOP-15"
          error={errors.sku}
          required
        />
        <Input
          label="Descripción"
          value={formData.description}
          onChange={(v) => setFormData(prev => ({ ...prev, description: v }))}
          placeholder="Descripción del producto"
          error={errors.description}
          required
        />
      </div>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <Input
          label="Cantidad"
          type="number"
          value={formData.quantity}
          onChange={(v) => setFormData(prev => ({ ...prev, quantity: v }))}
          placeholder="0"
          min="0"
          step="1"
          error={errors.quantity}
          required
        />
        <Input
          label="FOB USD"
          type="number"
          value={formData.fobUsd}
          onChange={(v) => setFormData(prev => ({ ...prev, fobUsd: v }))}
          placeholder="0.00"
          min="0"
          step="0.01"
          error={errors.fobUsd}
          required
        />
        <Input
          label="CIF USD"
          type="number"
          value={formData.cifUsd}
          onChange={(v) => setFormData(prev => ({ ...prev, cifUsd: v }))}
          placeholder="0.00"
          min="0"
          step="0.01"
          error={errors.cifUsd}
          required
        />
      </div>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <Input
          label="Peso (kg)"
          type="number"
          value={formData.weightKg}
          onChange={(v) => setFormData(prev => ({ ...prev, weightKg: v }))}
          placeholder="0.00"
          min="0"
          step="0.01"
          error={errors.weightKg}
        />
        <Input
          label="Volumen (m³)"
          type="number"
          value={formData.volumeM3}
          onChange={(v) => setFormData(prev => ({ ...prev, volumeM3: v }))}
          placeholder="0.00"
          min="0"
          step="0.001"
          error={errors.volumeM3}
        />
        <Input
          label="Arancel Ad Valorem (%)"
          type="number"
          value={formData.adValoremRate}
          onChange={(v) => setFormData(prev => ({ ...prev, adValoremRate: v }))}
          placeholder="0"
          min="0"
          max="100"
          step="0.1"
          suffix="%"
          error={errors.adValoremRate}
        />
      </div>
      <div className="flex gap-3 pt-4 justify-end">
        <Button type="button" variant="secondary" onClick={onCancel}>Cancelar</Button>
        <Button type="submit" icon={Save}>Guardar Ítem</Button>
      </div>
    </form>
  );
};

// ========================================
// FORMULARIO DE GASTO
// ========================================

const ExpenseForm = ({ expense, onSave, onCancel, items = [] }) => {
  const [formData, setFormData] = useState({
    type: expense?.type || 'Flete Internacional',
    description: expense?.description || '',
    amount: expense?.amount || '',
    currency: expense?.currency || 'USD',
    isCapitalizable: expense?.isCapitalizable !== false,
    driver: expense?.driver || '',
    specificItemId: expense?.specificItemId || ''
  });
  const [errors, setErrors] = useState({});

  useEffect(() => {
    if (!formData.driver) {
      setFormData(prev => ({ ...prev, driver: ExpenseDriverDefaults[prev.type] || AllocationDriver.BY_FOB_VALUE }));
    }
  }, [formData.type]);

  const validate = useCallback(() => {
    const newErrors = {};
    
    if (!formData.description.trim()) newErrors.description = 'Descripción es requerida';
    if (!formData.amount || parseFloat(formData.amount) <= 0) newErrors.amount = 'Monto debe ser mayor a 0';
    if (formData.driver === AllocationDriver.SPECIFIC_LINE && !formData.specificItemId) {
      newErrors.specificItemId = 'Debe seleccionar un ítem';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  }, [formData]);

  const handleSubmit = useCallback((e) => {
    e.preventDefault();
    if (validate()) {
      onSave({
        id: expense?.id || generateId(),
        type: formData.type,
        description: formData.description.trim(),
        amount: parseFloat(formData.amount) || 0,
        currency: formData.currency,
        isCapitalizable: formData.isCapitalizable,
        driver: formData.driver,
        specificItemId: formData.driver === AllocationDriver.SPECIFIC_LINE ? formData.specificItemId : null,
        isProcessed: expense?.isProcessed || false,
        createdAt: expense?.createdAt || new Date().toISOString()
      });
    }
  }, [formData, expense, onSave, validate]);

  return (
    <form onSubmit={handleSubmit} className="p-6 space-y-4">
      <Select
        label="Tipo de Gasto"
        value={formData.type}
        onChange={(v) => setFormData(prev => ({ ...prev, type: v, driver: ExpenseDriverDefaults[v] }))}
        options={Object.keys(ExpenseDriverDefaults).map(k => ({ value: k, label: k }))}
        required
      />
      <Input
        label="Descripción"
        value={formData.description}
        onChange={(v) => setFormData(prev => ({ ...prev, description: v }))}
        placeholder="Ej: Factura de flete marítimo"
        error={errors.description}
        required
      />
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <Input
          label="Monto"
          type="number"
          value={formData.amount}
          onChange={(v) => setFormData(prev => ({ ...prev, amount: v }))}
          placeholder="0.00"
          min="0"
          step="0.01"
          error={errors.amount}
          required
        />
        <Select
          label="Moneda"
          value={formData.currency}
          onChange={(v) => setFormData(prev => ({ ...prev, currency: v }))}
          options={[
            { value: 'USD', label: 'Dólares (USD)' },
            { value: 'PEN', label: 'Soles (PEN)' }
          ]}
        />
      </div>
      <Select
        label="Driver de Prorrateo"
        value={formData.driver}
        onChange={(v) => setFormData(prev => ({ ...prev, driver: v }))}
        options={Object.entries(DriverLabels).map(([k, v]) => ({ value: k, label: v }))}
      />
      {formData.driver === AllocationDriver.SPECIFIC_LINE && (
        <Select
          label="Ítem Específico"
          value={formData.specificItemId}
          onChange={(v) => setFormData(prev => ({ ...prev, specificItemId: v }))}
          options={[
            { value: '', label: 'Seleccionar ítem...' },
            ...items.map(i => ({ value: i.id, label: `${i.sku} - ${i.description}` }))
          ]}
          error={errors.specificItemId}
          required
        />
      )}
      <Checkbox
        label="Capitalizable (incluir en costo de inventario)"
        checked={formData.isCapitalizable}
        onChange={(v) => setFormData(prev => ({ ...prev, isCapitalizable: v }))}
      />
      <div className="flex gap-3 pt-4 justify-end">
        <Button type="button" variant="secondary" onClick={onCancel}>Cancelar</Button>
        <Button type="submit" icon={Save}>Guardar Gasto</Button>
      </div>
    </form>
  );
};

// ========================================
// FORMULARIO DE CARPETA
// ========================================

const FolderForm = ({ folder, onSave, onCancel }) => {
  const [formData, setFormData] = useState({
    number: folder?.number || generateFolderNumber(),
    supplier: folder?.supplier || '',
    incoterm: folder?.incoterm || 'CIF',
    damTC: folder?.damTC || '3.75',
    status: folder?.status || 'DRAFT'
  });
  const [errors, setErrors] = useState({});

  const validate = useCallback(() => {
    const newErrors = {};
    
    if (!formData.number.trim()) newErrors.number = 'Número de carpeta es requerido';
    if (!formData.supplier.trim()) newErrors.supplier = 'Proveedor es requerido';
    if (!formData.damTC || parseFloat(formData.damTC) <= 0) newErrors.damTC = 'Tipo de cambio debe ser mayor a 0';

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  }, [formData]);

  const handleSubmit = useCallback((e) => {
    e.preventDefault();
    if (validate()) {
      onSave({
        id: folder?.id || generateId(),
        number: formData.number.trim(),
        supplier: formData.supplier.trim(),
        incoterm: formData.incoterm,
        damTC: parseFloat(formData.damTC) || 3.75,
        status: formData.status,
        isCostLocked: folder?.isCostLocked || false,
        items: folder?.items || [],
        expenses: folder?.expenses || [],
        calculatedCost: folder?.calculatedCost || null,
        snapshots: folder?.snapshots || [],
        createdAt: folder?.createdAt || new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
    }
  }, [formData, folder, onSave, validate]);

  return (
    <form onSubmit={handleSubmit} className="p-6 space-y-4">
      <Input
        label="Número de Carpeta"
        value={formData.number}
        onChange={(v) => setFormData(prev => ({ ...prev, number: v }))}
        placeholder="IMP-2025-001"
        error={errors.number}
        required
      />
      <Input
        label="Proveedor"
        value={formData.supplier}
        onChange={(v) => setFormData(prev => ({ ...prev, supplier: v }))}
        placeholder="Nombre del proveedor"
        error={errors.supplier}
        required
      />
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <Select
          label="Incoterm"
          value={formData.incoterm}
          onChange={(v) => setFormData(prev => ({ ...prev, incoterm: v }))}
          options={IncoTerms.map(t => ({ value: t, label: t }))}
        />
        <Input
          label="Tipo de Cambio DAM"
          type="number"
          value={formData.damTC}
          onChange={(v) => setFormData(prev => ({ ...prev, damTC: v }))}
          placeholder="3.75"
          min="0.01"
          step="0.01"
          error={errors.damTC}
          required
        />
      </div>
      <Select
        label="Estado"
        value={formData.status}
        onChange={(v) => setFormData(prev => ({ ...prev, status: v }))}
        options={Object.entries(FolderStatus).map(([k, v]) => ({ value: k, label: v.label }))}
      />
      <div className="flex gap-3 pt-4 justify-end">
        <Button type="button" variant="secondary" onClick={onCancel}>Cancelar</Button>
        <Button type="submit" icon={Save}>{folder ? 'Actualizar' : 'Crear'} Carpeta</Button>
      </div>
    </form>
  );
};

// ========================================
// DETALLE DE CARPETA DE IMPORTACIÓN
// ========================================

const ImportFolderDetail = ({ folder, onUpdate, onCalculate, onClose, onDelete }) => {
  const toast = useCXToast();
  const [activeTab, setActiveTab] = useState('items');
  const [showItemModal, setShowItemModal] = useState(false);
  const [showExpenseModal, setShowExpenseModal] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const [editingExpense, setEditingExpense] = useState(null);
  const [showDeleteItemConfirm, setShowDeleteItemConfirm] = useState(null);
  const [showDeleteExpenseConfirm, setShowDeleteExpenseConfirm] = useState(null);
  const [showLockConfirm, setShowLockConfirm] = useState(false);
  const [showUnlockConfirm, setShowUnlockConfirm] = useState(false);
  const [calculating, setCalculating] = useState(false);

  const tabs = useMemo(() => [
    { id: 'items', label: 'Ítems', icon: Package },
    { id: 'expenses', label: 'Gastos', icon: FileText },
    { id: 'calculation', label: 'Costeo', icon: Calculator },
    { id: 'snapshots', label: 'Historial', icon: History }
  ], []);

  const handleSaveItem = useCallback((item) => {
    const isEditing = folder.items.some(i => i.id === item.id);
    const updatedItems = isEditing
      ? folder.items.map(i => i.id === item.id ? item : i)
      : [...folder.items, item];
    
    onUpdate({ ...folder, items: updatedItems, updatedAt: new Date().toISOString() });
    setShowItemModal(false);
    setEditingItem(null);
    toast.success(isEditing ? 'Ítem actualizado correctamente' : 'Ítem agregado correctamente');
  }, [folder, onUpdate, toast]);

  const handleDeleteItem = useCallback((itemId) => {
    onUpdate({ 
      ...folder, 
      items: folder.items.filter(i => i.id !== itemId),
      updatedAt: new Date().toISOString()
    });
    setShowDeleteItemConfirm(null);
    toast.success('Ítem eliminado correctamente');
  }, [folder, onUpdate, toast]);

  const handleSaveExpense = useCallback((expense) => {
    const isEditing = folder.expenses.some(e => e.id === expense.id);
    const updatedExpenses = isEditing
      ? folder.expenses.map(e => e.id === expense.id ? expense : e)
      : [...folder.expenses, expense];
    
    onUpdate({ ...folder, expenses: updatedExpenses, updatedAt: new Date().toISOString() });
    setShowExpenseModal(false);
    setEditingExpense(null);
    toast.success(isEditing ? 'Gasto actualizado correctamente' : 'Gasto agregado correctamente');
  }, [folder, onUpdate, toast]);

  const handleDeleteExpense = useCallback((expenseId) => {
    onUpdate({ 
      ...folder, 
      expenses: folder.expenses.filter(e => e.id !== expenseId),
      updatedAt: new Date().toISOString()
    });
    setShowDeleteExpenseConfirm(null);
    toast.success('Gasto eliminado correctamente');
  }, [folder, onUpdate, toast]);

  const handleCalculate = useCallback(async () => {
    setCalculating(true);
    try {
      await new Promise(resolve => setTimeout(resolve, 500));
      const result = calculateLandedCost(folder);
      if (result.success) {
        const newSnapshot = {
          version: (folder.snapshots?.length || 0) + 1,
          timestamp: new Date().toISOString(),
          reason: folder.calculatedCost ? 'RECALCULATION' : 'INITIAL',
          totalLandedCost: result.totalLandedCostPen
        };
        onUpdate({ 
          ...folder, 
          calculatedCost: result,
          snapshots: [...(folder.snapshots || []), newSnapshot],
          updatedAt: new Date().toISOString()
        });
        toast.success('Landed cost calculado correctamente');
        setActiveTab('calculation');
      } else {
        toast.error(result.warnings[0] || 'Error al calcular');
      }
    } finally {
      setCalculating(false);
    }
  }, [folder, onUpdate, toast]);

  const handleLockCosts = useCallback(() => {
    if (!folder.calculatedCost) {
      toast.warning('Debe calcular el landed cost antes de bloquear');
      return;
    }
    const newSnapshot = {
      version: (folder.snapshots?.length || 0) + 1,
      timestamp: new Date().toISOString(),
      reason: 'COST_LOCKED',
      totalLandedCost: folder.calculatedCost.totalLandedCostPen
    };
    onUpdate({ 
      ...folder, 
      isCostLocked: true, 
      status: 'COSTED',
      snapshots: [...(folder.snapshots || []), newSnapshot],
      updatedAt: new Date().toISOString()
    });
    setShowLockConfirm(false);
    toast.success('Costos bloqueados. La carpeta ha sido cerrada.');
  }, [folder, onUpdate, toast]);

  const handleUnlockCosts = useCallback(() => {
    const newSnapshot = {
      version: (folder.snapshots?.length || 0) + 1,
      timestamp: new Date().toISOString(),
      reason: 'COST_UNLOCKED',
      totalLandedCost: folder.calculatedCost?.totalLandedCostPen || 0
    };
    onUpdate({ 
      ...folder, 
      isCostLocked: false, 
      status: 'CLEARED',
      snapshots: [...(folder.snapshots || []), newSnapshot],
      updatedAt: new Date().toISOString()
    });
    setShowUnlockConfirm(false);
    toast.warning('Costos desbloqueados. La carpeta puede ser modificada.');
  }, [folder, onUpdate, toast]);

  const handleExportCosteo = useCallback(() => {
    if (!folder.calculatedCost) {
      toast.warning('No hay costeo para exportar');
      return;
    }
    const data = folder.calculatedCost.itemsDetail.map(item => ({
      SKU: item.sku,
      Descripcion: item.description,
      Cantidad: item.quantity,
      'CIF PEN': item.cifPen.toFixed(2),
      'Derechos PEN': item.dutiesPen.toFixed(2),
      'Gastos PEN': item.expensesAllocatedPen.toFixed(2),
      'Landed Cost Total': item.totalLandedCostPen.toFixed(2),
      'Costo Unitario': item.unitLandedCostPen.toFixed(2),
      'IGV': item.igvPen.toFixed(2)
    }));
    exportToCSV(data, `costeo_${folder.number}`, Object.keys(data[0]));
    toast.success('Costeo exportado a CSV');
  }, [folder, toast]);

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div>
          <button 
            onClick={onClose}
            className="flex items-center gap-2 text-cyan-400 hover:text-cyan-300 mb-2 focus:outline-none"
          >
            <ChevronLeft className="w-4 h-4" />
            Volver a lista
          </button>
          <div className="flex items-center gap-3 mb-2">
            <h2 className="text-xl font-bold text-white">{folder.number}</h2>
            <CXBadge variant={folder.isCostLocked ? 'success' : 'info'}>
              {folder.isCostLocked ? <><Lock className="w-3 h-3 mr-1" /> Bloqueado</> : FolderStatus[folder.status]?.label}
            </CXBadge>
          </div>
          <p className="text-cyan-500">{folder.supplier} • {folder.incoterm} • TC DAM: {folder.damTC}</p>
        </div>
        <div className="flex flex-wrap gap-2">
          {!folder.isCostLocked ? (
            <>
              <Button variant="secondary" icon={Calculator} onClick={handleCalculate} loading={calculating}>
                Calcular Landed Cost
              </Button>
              {folder.calculatedCost && (
                <Button variant="success" icon={Lock} onClick={() => setShowLockConfirm(true)}>
                  Bloquear Costos
                </Button>
              )}
            </>
          ) : (
            <>
              <Button variant="secondary" icon={FileDown} onClick={handleExportCosteo}>
                Exportar Costeo
              </Button>
              <Button variant="warning" icon={Unlock} onClick={() => setShowUnlockConfirm(true)}>
                Desbloquear
              </Button>
            </>
          )}
        </div>
      </div>

      <CXTabs tabs={tabs} activeTab={activeTab} onChange={setActiveTab} />

      {/* Tab: Items */}
      {activeTab === 'items' && (
        <>
          {!folder.isCostLocked && (
            <div className="flex justify-end">
              <Button icon={Plus} onClick={() => { setEditingItem(null); setShowItemModal(true); }}>
                Agregar Ítem
              </Button>
            </div>
          )}
          <Card>
            {folder.items.length === 0 ? (
              <EmptyState
                icon={Package}
                title="Sin ítems"
                description="Agrega los productos de esta importación"
                action={!folder.isCostLocked && <Button icon={Plus} onClick={() => setShowItemModal(true)}>Agregar Ítem</Button>}
              />
            ) : (
              <Table
                columns={[
                  { key: 'sku', header: 'SKU', render: v => <span className="font-mono text-cyan-400">{v}</span> },
                  { key: 'description', header: 'Descripción' },
                  { key: 'quantity', header: 'Cantidad', align: 'right' },
                  { key: 'fobUsd', header: 'FOB USD', align: 'right', render: v => formatCurrency(v, 'USD') },
                  { key: 'cifUsd', header: 'CIF USD', align: 'right', render: v => formatCurrency(v, 'USD') },
                  { key: 'weightKg', header: 'Peso (kg)', align: 'right', render: v => v?.toFixed(2) || '-' },
                  { key: 'adValoremRate', header: 'Arancel', align: 'right', render: v => formatPercent(v) },
                  ...(!folder.isCostLocked ? [{
                    key: 'actions',
                    header: '',
                    render: (_, row) => (
                      <div className="flex gap-1">
                        <button 
                          onClick={() => { setEditingItem(row); setShowItemModal(true); }}
                          className="p-1.5 hover:bg-cyan-950 rounded text-cyan-400"
                          title="Editar"
                        >
                          <Edit3 className="w-4 h-4" />
                        </button>
                        <button 
                          onClick={() => setShowDeleteItemConfirm(row.id)}
                          className="p-1.5 hover:bg-rose-950 rounded text-rose-400"
                          title="Eliminar"
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    )
                  }] : [])
                ]}
                data={folder.items}
              />
            )}
          </Card>
        </>
      )}

      {/* Tab: Expenses */}
      {activeTab === 'expenses' && (
        <>
          {!folder.isCostLocked && (
            <div className="flex justify-end">
              <Button icon={Plus} onClick={() => { setEditingExpense(null); setShowExpenseModal(true); }}>
                Agregar Gasto
              </Button>
            </div>
          )}
          <Card>
            {folder.expenses.length === 0 ? (
              <EmptyState
                icon={FileText}
                title="Sin gastos"
                description="Agrega los gastos asociados a esta importación"
                action={!folder.isCostLocked && <Button icon={Plus} onClick={() => setShowExpenseModal(true)}>Agregar Gasto</Button>}
              />
            ) : (
              <Table
                columns={[
                  { key: 'type', header: 'Tipo' },
                  { key: 'description', header: 'Descripción' },
                  { key: 'amount', header: 'Monto', align: 'right', render: (v, row) => formatCurrency(v, row.currency) },
                  { key: 'driver', header: 'Driver', render: v => DriverLabels[v] || v },
                  { key: 'isCapitalizable', header: 'Capitalizable', render: v => v ? <Check className="w-4 h-4 text-emerald-400" /> : <X className="w-4 h-4 text-cyan-700" /> },
                  ...(!folder.isCostLocked ? [{
                    key: 'actions',
                    header: '',
                    render: (_, row) => (
                      <div className="flex gap-1">
                        <button 
                          onClick={() => { setEditingExpense(row); setShowExpenseModal(true); }}
                          className="p-1.5 hover:bg-cyan-950 rounded text-cyan-400"
                          title="Editar"
                        >
                          <Edit3 className="w-4 h-4" />
                        </button>
                        <button 
                          onClick={() => setShowDeleteExpenseConfirm(row.id)}
                          className="p-1.5 hover:bg-rose-950 rounded text-rose-400"
                          title="Eliminar"
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    )
                  }] : [])
                ]}
                data={folder.expenses}
              />
            )}
          </Card>
        </>
      )}

      {/* Tab: Calculation */}
      {activeTab === 'calculation' && (
        folder.calculatedCost ? (
          <div className="space-y-6">
            {folder.calculatedCost.warnings?.length > 0 && (
              <Alert type="warning" title="Advertencias del Cálculo">
                <ul className="list-disc list-inside">
                  {folder.calculatedCost.warnings.map((w, i) => <li key={i}>{w}</li>)}
                </ul>
              </Alert>
            )}

            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <MetricCard label="Total FOB" value={formatCurrency(folder.calculatedCost.totalFobUsd, 'USD')} variant="cyan" icon={Globe} />
              <MetricCard label="Total CIF PEN" value={formatCurrency(folder.calculatedCost.totalCifPen)} variant="emerald" icon={Ship} />
              <MetricCard label="Total Derechos" value={formatCurrency(folder.calculatedCost.totalDuties)} variant="amber" icon={FileText} />
              <MetricCard label="Landed Cost Total" value={formatCurrency(folder.calculatedCost.totalLandedCostPen)} variant="purple" icon={Calculator} />
            </div>

            <Card title="Detalle por Ítem" icon={Layers} actions={
              <Button variant="ghost" size="sm" icon={FileDown} onClick={handleExportCosteo}>Exportar</Button>
            }>
              <Table
                columns={[
                  { key: 'sku', header: 'SKU', render: v => <span className="font-mono text-cyan-400">{v}</span> },
                  { key: 'quantity', header: 'Cant.', align: 'right' },
                  { key: 'cifPen', header: 'CIF S/', align: 'right', render: v => formatCurrency(v) },
                  { key: 'dutiesPen', header: 'Derechos', align: 'right', render: v => formatCurrency(v) },
                  { key: 'expensesAllocatedPen', header: 'Gastos', align: 'right', render: v => formatCurrency(v) },
                  { key: 'totalLandedCostPen', header: 'Landed Cost', align: 'right', render: v => formatCurrency(v), className: 'font-semibold text-cyan-400' },
                  { key: 'unitLandedCostPen', header: 'Costo Unit.', align: 'right', render: v => formatCurrency(v), className: 'text-emerald-400' },
                  { key: 'igvPen', header: 'IGV', align: 'right', render: v => formatCurrency(v), className: 'text-cyan-700' }
                ]}
                data={folder.calculatedCost.itemsDetail}
              />
            </Card>

            <Card title="Prorrateo de Gastos" icon={PieChartIcon}>
              <div className="space-y-4">
                {folder.calculatedCost.itemsDetail.map(item => (
                  <div key={item.id} className="p-4 bg-black border border-cyan-950 rounded-lg">
                    <div className="flex justify-between items-center mb-3">
                      <span className="font-medium text-white">{item.sku}</span>
                      <span className="text-cyan-400">{formatCurrency(item.expensesAllocatedPen)}</span>
                    </div>
                    {item.allocations.length > 0 ? (
                      <div className="space-y-2">
                        {item.allocations.map((alloc, i) => (
                          <div key={i} className="flex justify-between text-sm">
                            <span className="text-cyan-500">
                              {alloc.expenseDescription} 
                              <span className="text-cyan-800 ml-2">({alloc.driverLabel}: {alloc.ratio.toFixed(2)}%)</span>
                            </span>
                            <span className="text-cyan-300">{formatCurrency(alloc.amountPen)}</span>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-sm text-cyan-700">Sin gastos asignados</p>
                    )}
                  </div>
                ))}
              </div>
            </Card>
          </div>
        ) : (
          <Card>
            <EmptyState
              icon={Calculator}
              title="Sin cálculo"
              description="Calcula el landed cost para ver el detalle del costeo"
              action={!folder.isCostLocked && <Button icon={Calculator} onClick={handleCalculate} loading={calculating}>Calcular Landed Cost</Button>}
            />
          </Card>
        )
      )}

      {/* Tab: Snapshots */}
      {activeTab === 'snapshots' && (
        <Card title="Historial de Cambios" icon={History}>
          {folder.snapshots?.length > 0 ? (
            <div className="space-y-3">
              {folder.snapshots.slice().reverse().map((snap, i) => (
                <div key={i} className="flex items-start gap-4 p-4 bg-black border border-cyan-950 rounded-lg">
                  <div className="p-2 bg-black border border-cyan-900 rounded-lg">
                    <History className="w-5 h-5 text-cyan-400" />
                  </div>
                  <div className="flex-1">
                    <div className="flex items-center justify-between mb-1">
                      <span className="font-medium text-white">Versión {snap.version}</span>
                      <span className="text-sm text-cyan-600">{formatDateTime(snap.timestamp)}</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <CXBadge variant={
                        snap.reason === 'INITIAL' ? 'info' : 
                        snap.reason === 'COST_LOCKED' ? 'success' :
                        snap.reason === 'COST_UNLOCKED' ? 'warning' :
                        'purple'
                      }>
                        {snap.reason === 'INITIAL' ? 'Cálculo Inicial' :
                         snap.reason === 'RECALCULATION' ? 'Recálculo' :
                         snap.reason === 'COST_LOCKED' ? 'Costos Bloqueados' :
                         snap.reason === 'COST_UNLOCKED' ? 'Costos Desbloqueados' :
                         snap.reason}
                      </CXBadge>
                      {snap.totalLandedCost && (
                        <span className="text-sm text-cyan-400">{formatCurrency(snap.totalLandedCost)}</span>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <EmptyState
              icon={History}
              title="Sin historial"
              description="El historial de cambios aparecerá cuando se realicen cálculos o cambios de estado"
            />
          )}
        </Card>
      )}

      {/* Modals */}
      <CXModal isOpen={showItemModal} onClose={() => { setShowItemModal(false); setEditingItem(null); }} title={editingItem ? 'Editar Ítem' : 'Agregar Ítem'} size="lg">
        <ItemForm 
          item={editingItem}
          onSave={handleSaveItem}
          onCancel={() => { setShowItemModal(false); setEditingItem(null); }}
          existingItems={folder.items}
        />
      </CXModal>

      <CXModal isOpen={showExpenseModal} onClose={() => { setShowExpenseModal(false); setEditingExpense(null); }} title={editingExpense ? 'Editar Gasto' : 'Agregar Gasto'} size="md">
        <ExpenseForm 
          expense={editingExpense}
          onSave={handleSaveExpense}
          onCancel={() => { setShowExpenseModal(false); setEditingExpense(null); }}
          items={folder.items}
        />
      </CXModal>

      <ConfirmModal
        isOpen={!!showDeleteItemConfirm}
        onClose={() => setShowDeleteItemConfirm(null)}
        onConfirm={() => handleDeleteItem(showDeleteItemConfirm)}
        title="Eliminar Ítem"
        message="¿Está seguro que desea eliminar este ítem? Esta acción no se puede deshacer."
        confirmText="Eliminar"
        variant="danger"
      />

      <ConfirmModal
        isOpen={!!showDeleteExpenseConfirm}
        onClose={() => setShowDeleteExpenseConfirm(null)}
        onConfirm={() => handleDeleteExpense(showDeleteExpenseConfirm)}
        title="Eliminar Gasto"
        message="¿Está seguro que desea eliminar este gasto? Esta acción no se puede deshacer."
        confirmText="Eliminar"
        variant="danger"
      />

      <ConfirmModal
        isOpen={showLockConfirm}
        onClose={() => setShowLockConfirm(false)}
        onConfirm={handleLockCosts}
        title="Bloquear Costos"
        message="Al bloquear los costos, la carpeta pasará a estado COSTEADO y no podrá ser modificada. ¿Desea continuar?"
        confirmText="Bloquear"
        variant="success"
      />

      <ConfirmModal
        isOpen={showUnlockConfirm}
        onClose={() => setShowUnlockConfirm(false)}
        onConfirm={handleUnlockCosts}
        title="Desbloquear Costos"
        message="Al desbloquear los costos, podrá modificar la carpeta pero se perderá el estado COSTEADO. ¿Desea continuar?"
        confirmText="Desbloquear"
        variant="warning"
      />
    </div>
  );
};

// ========================================
// LISTA DE CARPETAS
// ========================================

const FoldersList = ({ folders, onSelect, onCreate, onUpdate, onDelete }) => {
  const toast = useCXToast();
  const [search, setSearch] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [showEditModal, setShowEditModal] = useState(null);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(null);

  const debouncedSearch = useDebounce(search, 300);

  const filteredFolders = useMemo(() => {
    return folders.filter(folder => {
      const matchesSearch = !debouncedSearch || 
        folder.number.toLowerCase().includes(debouncedSearch.toLowerCase()) ||
        folder.supplier.toLowerCase().includes(debouncedSearch.toLowerCase());
      const matchesStatus = statusFilter === 'all' || folder.status === statusFilter;
      return matchesSearch && matchesStatus;
    });
  }, [folders, debouncedSearch, statusFilter]);

  const handleCreateFolder = useCallback((folderData) => {
    onCreate(folderData);
    setShowCreateModal(false);
    toast.success('Carpeta creada correctamente');
  }, [onCreate, toast]);

  const handleEditFolder = useCallback((folderData) => {
    onUpdate(folderData);
    setShowEditModal(null);
    toast.success('Carpeta actualizada correctamente');
  }, [onUpdate, toast]);

  const handleDeleteFolder = useCallback((folderId) => {
    onDelete(folderId);
    setShowDeleteConfirm(null);
    toast.success('Carpeta eliminada correctamente');
  }, [onDelete, toast]);

  const handleExportFolders = useCallback(() => {
    const data = filteredFolders.map(f => ({
      Numero: f.number,
      Proveedor: f.supplier,
      Incoterm: f.incoterm,
      'TC DAM': f.damTC,
      Estado: FolderStatus[f.status]?.label || f.status,
      'Total Items': f.items.length,
      'Total Gastos': f.expenses.length,
      'Landed Cost': f.calculatedCost?.totalLandedCostPen?.toFixed(2) || '0',
      Bloqueado: f.isCostLocked ? 'Sí' : 'No',
      Creado: formatDate(f.createdAt)
    }));
    exportToCSV(data, 'carpetas_importacion', Object.keys(data[0] || {}));
    toast.success('Carpetas exportadas a CSV');
  }, [filteredFolders, toast]);

  return (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <h2 className="text-2xl font-bold text-white">Carpetas de Importación</h2>
        <div className="flex gap-2">
          <Button variant="secondary" icon={FileDown} onClick={handleExportFolders}>
            Exportar
          </Button>
          <Button icon={Plus} onClick={() => setShowCreateModal(true)}>
            Nueva Carpeta
          </Button>
        </div>
      </div>

      <div className="flex flex-col sm:flex-row gap-4">
        <div className="flex-1">
          <SearchInput 
            value={search}
            onChange={setSearch}
            placeholder="Buscar por número o proveedor..."
          />
        </div>
        <Select
          value={statusFilter}
          onChange={setStatusFilter}
          options={[
            { value: 'all', label: 'Todos los estados' },
            ...Object.entries(FolderStatus).map(([k, v]) => ({ value: k, label: v.label }))
          ]}
          className="w-full sm:w-48"
        />
      </div>

      <Card>
        {filteredFolders.length === 0 ? (
          <EmptyState
            icon={Ship}
            title={folders.length === 0 ? 'Sin carpetas' : 'Sin resultados'}
            description={folders.length === 0 
              ? 'Crea tu primera carpeta de importación para comenzar'
              : 'No se encontraron carpetas con los filtros aplicados'}
            action={folders.length === 0 && <Button icon={Plus} onClick={() => setShowCreateModal(true)}>Nueva Carpeta</Button>}
          />
        ) : (
          <Table
            columns={[
              { key: 'number', header: 'N° Carpeta', render: v => <span className="font-mono text-cyan-400">{v}</span> },
              { key: 'supplier', header: 'Proveedor' },
              { key: 'incoterm', header: 'Incoterm' },
              { key: 'damTC', header: 'TC DAM', align: 'right' },
              { key: 'status', header: 'Estado', render: v => (
                <CXBadge variant={v === 'COSTED' ? 'success' : v === 'CLEARED' ? 'info' : v === 'CUSTOMS' ? 'warning' : 'default'}>
                  {FolderStatus[v]?.label || v}
                </CXBadge>
              )},
              { key: 'items', header: 'Ítems', align: 'right', render: (_, row) => row.items.length },
              { key: 'landedCost', header: 'Landed Cost', align: 'right', render: (_, row) => 
                row.calculatedCost ? formatCurrency(row.calculatedCost.totalLandedCostPen) : '-'
              },
              { key: 'isCostLocked', header: '', render: v => v ? <Lock className="w-4 h-4 text-emerald-400" /> : <Unlock className="w-4 h-4 text-cyan-700" /> },
              { key: 'actions', header: '', render: (_, row) => (
                <div className="flex gap-1">
                  <button 
                    onClick={(e) => { e.stopPropagation(); onSelect(row); }}
                    className="p-1.5 hover:bg-cyan-950 rounded text-cyan-400"
                    title="Ver detalle"
                  >
                    <Eye className="w-4 h-4" />
                  </button>
                  {!row.isCostLocked && (
                    <>
                      <button 
                        onClick={(e) => { e.stopPropagation(); setShowEditModal(row); }}
                        className="p-1.5 hover:bg-cyan-950 rounded text-cyan-400"
                        title="Editar"
                      >
                        <Edit3 className="w-4 h-4" />
                      </button>
                      <button 
                        onClick={(e) => { e.stopPropagation(); setShowDeleteConfirm(row.id); }}
                        className="p-1.5 hover:bg-rose-950 rounded text-rose-400"
                        title="Eliminar"
                      >
                        <Trash2 className="w-4 h-4" />
                      </button>
                    </>
                  )}
                </div>
              )}
            ]}
            data={filteredFolders}
            onRowClick={onSelect}
          />
        )}
      </Card>

      <CXModal isOpen={showCreateModal} onClose={() => setShowCreateModal(false)} title="Nueva Carpeta" size="md">
        <FolderForm onSave={handleCreateFolder} onCancel={() => setShowCreateModal(false)} />
      </CXModal>

      <CXModal isOpen={!!showEditModal} onClose={() => setShowEditModal(null)} title="Editar Carpeta" size="md">
        <FolderForm folder={showEditModal} onSave={handleEditFolder} onCancel={() => setShowEditModal(null)} />
      </CXModal>

      <ConfirmModal
        isOpen={!!showDeleteConfirm}
        onClose={() => setShowDeleteConfirm(null)}
        onConfirm={() => handleDeleteFolder(showDeleteConfirm)}
        title="Eliminar Carpeta"
        message="¿Está seguro que desea eliminar esta carpeta? Se eliminarán todos los ítems y gastos asociados. Esta acción no se puede deshacer."
        confirmText="Eliminar"
        variant="danger"
      />
    </div>
  );
};

// ========================================
// DAM LEDGER
// ========================================

const DAMLedger = ({ damLedger, onUpdate }) => {
  const toast = useCXToast();
  const [filter, setFilter] = useState({ status: 'all', product: '' });
  const debouncedProduct = useDebounce(filter.product, 300);
  
  const filteredLedger = useMemo(() => {
    return damLedger.filter(d => {
      if (filter.status !== 'all' && d.status !== filter.status) return false;
      if (debouncedProduct && !d.productSku.toLowerCase().includes(debouncedProduct.toLowerCase())) return false;
      return true;
    });
  }, [damLedger, filter.status, debouncedProduct]);

  const stats = useMemo(() => {
    const total = damLedger.length;
    const available = damLedger.filter(d => d.status === 'AVAILABLE').length;
    const partial = damLedger.filter(d => d.status === 'PARTIALLY_CONSUMED').length;
    const consumed = damLedger.filter(d => d.status === 'CONSUMED').length;
    const expired = damLedger.filter(d => d.status === 'EXPIRED').length;
    const expiring = damLedger.filter(d => {
      const days = (new Date(d.expiryDate) - new Date()) / (1000 * 60 * 60 * 24);
      return days > 0 && days <= 30 && d.status !== 'EXPIRED';
    }).length;
    const totalCifAvailable = damLedger
      .filter(d => ['AVAILABLE', 'PARTIALLY_CONSUMED'].includes(d.status))
      .reduce((sum, d) => sum + (d.availableCifUsd || 0), 0);
    return { total, available, partial, consumed, expired, expiring, totalCifAvailable };
  }, [damLedger]);

  const donutData = useMemo(() => [
    { value: stats.available, color: '#10b981', label: 'Disponible' },
    { value: stats.partial, color: '#f59e0b', label: 'Parcial' },
    { value: stats.consumed, color: '#6b7280', label: 'Consumido' },
    { value: stats.expired, color: '#ef4444', label: 'Vencido' }
  ].filter(d => d.value > 0), [stats]);

  const handleExportDAMs = useCallback(() => {
    const data = filteredLedger.map(d => ({
      'N° DAM': d.damNumber,
      'Fecha DAM': formatDate(d.damDate),
      Producto: d.productSku,
      'Cant. Original': d.originalQuantity,
      'Cant. Disponible': d.availableQuantity,
      UM: d.unitOfMeasure,
      'CIF Original USD': d.originalCifUsd?.toFixed(2),
      'CIF Disponible USD': d.availableCifUsd?.toFixed(2),
      'CIF Unitario USD': d.unitCifUsd?.toFixed(2),
      'Fecha Vencimiento': formatDate(d.expiryDate),
      Estado: d.status,
      'Elegible Drawback': d.isEligibleDrawback ? 'Sí' : 'No'
    }));
    exportToCSV(data, 'dam_ledger', Object.keys(data[0] || {}));
    toast.success('DAM Ledger exportado a CSV');
  }, [filteredLedger, toast]);

  return (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <h2 className="text-2xl font-bold text-white">DAM Ledger</h2>
        <Button variant="secondary" icon={FileDown} onClick={handleExportDAMs}>
          Exportar DAMs
        </Button>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
        <MetricCard label="Total DAMs" value={stats.total} icon={FileSpreadsheet} />
        <MetricCard label="Disponibles" value={stats.available} icon={Check} variant="emerald" />
        <MetricCard label="Parciales" value={stats.partial} icon={PieChartIcon} variant="amber" />
        <MetricCard label="Por Vencer" value={stats.expiring} icon={AlertTriangle} variant="purple" />
        <MetricCard label="CIF Disponible" value={formatCurrency(stats.totalCifAvailable, 'USD')} icon={DollarSign} variant="cyan" />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <Card title="Distribución de DAMs" icon={PieChartIcon}>
          <div className="flex flex-col items-center">
            <AnimatedDonut data={donutData} size={180} strokeWidth={20} />
            <div className="mt-6 space-y-2 w-full">
              {donutData.map((item, index) => (
                <div key={index} className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full" style={{ backgroundColor: item.color }} />
                    <span className="text-cyan-400 text-sm">{item.label}</span>
                  </div>
                  <span className="text-white font-medium">{item.value}</span>
                </div>
              ))}
            </div>
          </div>
        </Card>

        <div className="lg:col-span-2">
          <Card title="Registro de DAMs para Drawback" icon={FileSpreadsheet} actions={
            <div className="flex gap-2">
              <SearchInput
                value={filter.product}
                onChange={(v) => setFilter(prev => ({ ...prev, product: v }))}
                placeholder="Buscar producto..."
              />
              <Select
                value={filter.status}
                onChange={(v) => setFilter(prev => ({ ...prev, status: v }))}
                options={[
                  { value: 'all', label: 'Todos' },
                  { value: 'AVAILABLE', label: 'Disponible' },
                  { value: 'PARTIALLY_CONSUMED', label: 'Parcial' },
                  { value: 'CONSUMED', label: 'Consumido' },
                  { value: 'EXPIRED', label: 'Vencido' }
                ]}
              />
            </div>
          }>
            {filteredLedger.length === 0 ? (
              <EmptyState
                icon={FileSpreadsheet}
                title="Sin DAMs"
                description="No se encontraron DAMs con los filtros aplicados"
              />
            ) : (
              <Table
                columns={[
                  { key: 'damNumber', header: 'N° DAM', render: v => <span className="font-mono text-cyan-400">{v}</span> },
                  { key: 'damDate', header: 'Fecha', render: v => formatDate(v) },
                  { key: 'productSku', header: 'Producto' },
                  { key: 'originalQuantity', header: 'Original', align: 'right' },
                  { key: 'availableQuantity', header: 'Disponible', align: 'right', render: v => <span className="text-emerald-400">{v}</span> },
                  { key: 'availableCifUsd', header: 'CIF Disp.', align: 'right', render: v => formatCurrency(v, 'USD') },
                  { key: 'expiryDate', header: 'Vence', render: v => {
                    const days = Math.floor((new Date(v) - new Date()) / (1000 * 60 * 60 * 24));
                    return (
                      <div className="flex items-center gap-2">
                        <span className="text-sm">{formatDate(v)}</span>
                        {days <= 30 && days > 0 && <CXBadge variant="warning">{days}d</CXBadge>}
                        {days <= 0 && <CXBadge variant="danger">Vencido</CXBadge>}
                      </div>
                    );
                  }},
                  { key: 'status', header: 'Estado', render: v => {
                    const variants = {
                      AVAILABLE: 'success',
                      PARTIALLY_CONSUMED: 'warning',
                      CONSUMED: 'info',
                      EXPIRED: 'danger'
                    };
                    const labels = {
                      AVAILABLE: 'Disponible',
                      PARTIALLY_CONSUMED: 'Parcial',
                      CONSUMED: 'Consumido',
                      EXPIRED: 'Vencido'
                    };
                    return <CXBadge variant={variants[v] || 'default'}>{labels[v] || v}</CXBadge>;
                  }}
                ]}
                data={filteredLedger}
              />
            )}
          </Card>
        </div>
      </div>
    </div>
  );
};

// ========================================
// PROCESADOR DE GASTOS TARDÍOS
// ========================================

const LateExpenseProcessor = ({ folders }) => {
  const toast = useCXToast();
  const [selectedFolderId, setSelectedFolderId] = useState('');
  const [params, setParams] = useState({
    originalQty: '',
    currentStockQty: '',
    daysSinceClose: '',
    thresholdDays: '30',
    expenseAmount: ''
  });
  const [errors, setErrors] = useState({});
  const [result, setResult] = useState(null);
  const [calculating, setCalculating] = useState(false);

  const closedFolders = useMemo(() => folders.filter(f => f.isCostLocked), [folders]);

  const validate = useCallback(() => {
    const newErrors = {};
    if (!selectedFolderId) newErrors.folder = 'Seleccione una carpeta';
    if (!params.originalQty || parseFloat(params.originalQty) <= 0) newErrors.originalQty = 'Cantidad original debe ser mayor a 0';
    if (params.currentStockQty === '' || parseFloat(params.currentStockQty) < 0) newErrors.currentStockQty = 'Stock actual debe ser válido';
    if (!params.daysSinceClose || parseInt(params.daysSinceClose) < 0) newErrors.daysSinceClose = 'Días desde cierre debe ser válido';
    if (!params.thresholdDays || parseInt(params.thresholdDays) <= 0) newErrors.thresholdDays = 'Umbral debe ser mayor a 0';
    if (!params.expenseAmount || parseFloat(params.expenseAmount) <= 0) newErrors.expenseAmount = 'Monto debe ser mayor a 0';
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  }, [selectedFolderId, params]);

  const handleCalculate = useCallback(async () => {
    if (!validate()) return;
    
    setCalculating(true);
    try {
      await new Promise(resolve => setTimeout(resolve, 300));
      const processed = processLateExpense({
        originalQty: parseFloat(params.originalQty),
        currentStockQty: parseFloat(params.currentStockQty),
        daysSinceClose: parseInt(params.daysSinceClose),
        thresholdDays: parseInt(params.thresholdDays),
        expenseAmount: parseFloat(params.expenseAmount)
      });
      setResult(processed);
      toast.success('Tratamiento calculado correctamente');
    } catch (error) {
      toast.error('Error al calcular el tratamiento');
    } finally {
      setCalculating(false);
    }
  }, [params, validate, toast]);

  const handleExportResult = useCallback(() => {
    if (!result) return;
    const data = result.journalEntries.map(entry => ({
      Cuenta_Debe: entry.debit,
      Cuenta_Haber: entry.credit,
      Monto: entry.amount.toFixed(2),
      Glosa: entry.glosa
    }));
    exportToCSV(data, 'asientos_gasto_tardio', Object.keys(data[0] || {}));
    toast.success('Asientos exportados a CSV');
  }, [result, toast]);

  const handleReset = useCallback(() => {
    setSelectedFolderId('');
    setParams({
      originalQty: '',
      currentStockQty: '',
      daysSinceClose: '',
      thresholdDays: '30',
      expenseAmount: ''
    });
    setErrors({});
    setResult(null);
  }, []);

  return (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-white">Procesador de Gastos Tardíos</h2>
          <p className="text-cyan-600">Determina el tratamiento contable de gastos recibidos después del cierre</p>
        </div>
        {result && (
          <Button variant="secondary" icon={FileDown} onClick={handleExportResult}>
            Exportar Asientos
          </Button>
        )}
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <Card title="Parámetros del Gasto Tardío" icon={Clock}>
          <div className="space-y-4">
            <Select
              label="Carpeta de Importación"
              value={selectedFolderId}
              onChange={setSelectedFolderId}
              options={[
                { value: '', label: 'Seleccionar carpeta...' },
                ...closedFolders.map(f => ({ value: f.id, label: `${f.number} - ${f.supplier}` }))
              ]}
              error={errors.folder}
              required
            />
            {closedFolders.length === 0 && (
              <Alert type="info">
                No hay carpetas cerradas disponibles. Primero debe bloquear los costos de una carpeta.
              </Alert>
            )}
            <div className="grid grid-cols-2 gap-4">
              <Input
                label="Cantidad Original"
                type="number"
                value={params.originalQty}
                onChange={(v) => setParams(prev => ({ ...prev, originalQty: v }))}
                placeholder="100"
                min="1"
                error={errors.originalQty}
                required
              />
              <Input
                label="Stock Actual"
                type="number"
                value={params.currentStockQty}
                onChange={(v) => setParams(prev => ({ ...prev, currentStockQty: v }))}
                placeholder="60"
                min="0"
                error={errors.currentStockQty}
                required
              />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <Input
                label="Días desde Cierre"
                type="number"
                value={params.daysSinceClose}
                onChange={(v) => setParams(prev => ({ ...prev, daysSinceClose: v }))}
                placeholder="15"
                min="0"
                error={errors.daysSinceClose}
                required
              />
              <Input
                label="Umbral de Días"
                type="number"
                value={params.thresholdDays}
                onChange={(v) => setParams(prev => ({ ...prev, thresholdDays: v }))}
                placeholder="30"
                min="1"
                error={errors.thresholdDays}
                required
              />
            </div>
            <Input
              label="Monto del Gasto (S/)"
              type="number"
              value={params.expenseAmount}
              onChange={(v) => setParams(prev => ({ ...prev, expenseAmount: v }))}
              placeholder="500.00"
              min="0.01"
              step="0.01"
              icon={DollarSign}
              error={errors.expenseAmount}
              required
            />
            <div className="flex gap-3 pt-2">
              <Button onClick={handleCalculate} loading={calculating} className="flex-1">
                Calcular Tratamiento
              </Button>
              <Button variant="secondary" onClick={handleReset}>
                Limpiar
              </Button>
            </div>
          </div>
        </Card>

        <Card title="Resultado del Análisis" icon={Calculator}>
          {result ? (
            <div className="space-y-4">
              <div className="p-4 bg-black border border-cyan-800 rounded-xl">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-cyan-500">Escenario</span>
                  <CXBadge variant={
                    result.scenario === LateExpenseScenario.FULL_REVALUATION ? 'success' :
                    result.scenario === LateExpenseScenario.PARTIAL_REVALUATION ? 'warning' : 'danger'
                  }>
                    {result.scenarioLabel}
                  </CXBadge>
                </div>
                <p className="text-sm text-cyan-300">{result.explanation}</p>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="p-4 bg-black border border-emerald-800 rounded-lg">
                  <p className="text-sm text-cyan-500 mb-1">A Revalorizar</p>
                  <p className="text-xl font-bold text-emerald-400">{formatCurrency(result.revalueAmount)}</p>
                </div>
                <div className="p-4 bg-black border border-rose-800 rounded-lg">
                  <p className="text-sm text-cyan-500 mb-1">A Gasto del Período</p>
                  <p className="text-xl font-bold text-rose-400">{formatCurrency(result.periodExpenseAmount)}</p>
                </div>
              </div>

              <div className="space-y-2">
                <h4 className="font-medium text-white">Asientos Contables</h4>
                {result.journalEntries.map((entry, i) => (
                  <div key={i} className="p-3 bg-black border border-cyan-950 rounded-lg text-sm">
                    <div className="flex justify-between mb-1">
                      <span className="text-emerald-400">D: {entry.debit}</span>
                      <span className="font-medium text-white">{formatCurrency(entry.amount)}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-rose-400">C: {entry.credit}</span>
                      <span className="text-cyan-600">{formatCurrency(entry.amount)}</span>
                    </div>
                    <p className="text-cyan-700 mt-1 text-xs">{entry.glosa}</p>
                  </div>
                ))}
              </div>
            </div>
          ) : (
            <EmptyState
              icon={Calculator}
              title="Sin cálculo"
              description="Ingrese los parámetros y calcule el tratamiento contable"
            />
          )}
        </Card>
      </div>

      <Card title="Diagrama de Decisión" icon={Layers}>
        <div className="p-6 bg-black border border-cyan-950 rounded-lg font-mono text-sm text-cyan-500 overflow-x-auto">
          <pre className="whitespace-pre">{`
┌─────────────────────────────────────────────────────────────────┐
│                    GASTO TARDÍO RECIBIDO                        │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
                 ┌───────────────────────┐
                 │ ¿Días > Umbral (${params.thresholdDays || 30})?  │
                 └───────────┬───────────┘
                             │
           ┌─────────────────┼─────────────────┐
           │ SÍ              │                 │ NO
           ▼                 │                 ▼
    ┌──────────────┐         │      ┌───────────────────────┐
    │  100% GASTO  │         │      │ ¿Stock = Original?    │
    │  DEL PERÍODO │         │      └───────────┬───────────┘
    └──────────────┘         │                  │
                             │    ┌─────────────┼─────────────┐
                             │    │ SÍ          │             │ NO
                             │    ▼             │             ▼
                             │ ┌─────────────┐  │  ┌────────────────────┐
                             │ │    100%     │  │  │ ¿Stock = 0?        │
                             │ │ REVALORIZAR │  │  └─────────┬──────────┘
                             │ └─────────────┘  │            │
                             │                  │  ┌─────────┼─────────┐
                             │                  │  │ SÍ      │         │ NO
                             │                  │  ▼         │         ▼
                             │           ┌──────────────┐  ┌───────────────┐
                             │           │  100% GASTO  │  │   PRORRATEO   │
                             │           │  DEL PERÍODO │  │ Stock:Revalor │
                             │           └──────────────┘  │ Vendido:Gasto │
                             │                             └───────────────┘
          `}</pre>
        </div>
      </Card>
    </div>
  );
};

// ========================================
// CALCULADORA DE DRAWBACK
// ========================================

const DrawbackAllocator = ({ damLedger, folders }) => {
  const toast = useCXToast();
  const [exportItems, setExportItems] = useState([
    { id: generateId(), productId: 'PROD-001', sku: '', quantity: '', fobUsd: '' }
  ]);
  const [result, setResult] = useState(null);
  const [drawbackRate, setDrawbackRate] = useState('3');
  const [calculating, setCalculating] = useState(false);
  const [errors, setErrors] = useState({});

  const bomService = useMemo(() => ({
    getBOM: (productId) => {
      const boms = {
        'PROD-001': [
          { productId: 'PROD-001', sku: 'MATERIA-A', quantityPer: 2.5, scrapRate: 0.05, isImported: true },
          { productId: 'PROD-002', sku: 'MATERIA-B', quantityPer: 1, scrapRate: 0, isImported: true }
        ],
        'PROD-002': [
          { productId: 'PROD-001', sku: 'MATERIA-A', quantityPer: 1.5, scrapRate: 0.03, isImported: true }
        ]
      };
      return boms[productId] || boms['PROD-001'];
    }
  }), []);

  const validate = useCallback(() => {
    const newErrors = {};
    let hasValidItem = false;

    exportItems.forEach((item, index) => {
      if (item.sku && item.quantity && item.fobUsd) {
        hasValidItem = true;
        if (parseFloat(item.quantity) <= 0) {
          newErrors[`quantity_${index}`] = 'Debe ser mayor a 0';
        }
        if (parseFloat(item.fobUsd) <= 0) {
          newErrors[`fobUsd_${index}`] = 'Debe ser mayor a 0';
        }
      }
    });

    if (!hasValidItem) {
      newErrors.general = 'Debe ingresar al menos un ítem de exportación válido';
    }

    if (parseFloat(drawbackRate) <= 0 || parseFloat(drawbackRate) > 10) {
      newErrors.drawbackRate = 'La tasa debe estar entre 0.1% y 10%';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  }, [exportItems, drawbackRate]);

  const handleCalculate = useCallback(async () => {
    if (!validate()) {
      toast.warning('Por favor corrija los errores antes de calcular');
      return;
    }

    setCalculating(true);
    try {
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const validItems = exportItems
        .filter(item => item.sku && item.quantity && item.fobUsd)
        .map(item => ({
          ...item,
          quantity: parseFloat(item.quantity) || 0,
          fobUsd: parseFloat(item.fobUsd) || 0
        }));

      const allocation = allocateDrawbackMaterials({
        exportItems: validItems,
        damLedger,
        bomService,
        exportDate: new Date().toISOString(),
        drawbackRate: parseFloat(drawbackRate)
      });
      
      setResult(allocation);
      
      if (allocation.passesFiftyPercentRule) {
        toast.success(`Drawback calculado: ${formatCurrency(allocation.drawbackAmountUsd, 'USD')}`);
      } else {
        toast.warning('No elegible para Drawback - CIF/FOB > 50%');
      }
    } catch (error) {
      toast.error('Error al calcular el drawback');
    } finally {
      setCalculating(false);
    }
  }, [exportItems, damLedger, bomService, drawbackRate, validate, toast]);

  const addExportItem = useCallback(() => {
    setExportItems(prev => [
      ...prev,
      { id: generateId(), productId: 'PROD-001', sku: '', quantity: '', fobUsd: '' }
    ]);
  }, []);

  const updateExportItem = useCallback((id, field, value) => {
    setExportItems(prev => prev.map(item => 
      item.id === id ? { ...item, [field]: value } : item
    ));
  }, []);

  const removeExportItem = useCallback((id) => {
    if (exportItems.length === 1) {
      toast.warning('Debe mantener al menos un ítem de exportación');
      return;
    }
    setExportItems(prev => prev.filter(item => item.id !== id));
  }, [exportItems.length, toast]);

  const handleExportResult = useCallback(() => {
    if (!result) return;
    
    const consumptionsData = result.consumptions.map(c => ({
      'DAM': c.damNumber,
      'Fecha DAM': formatDate(c.damDate),
      'Insumo': c.productSku,
      'Cantidad': c.quantityConsumed.toFixed(4),
      'CIF USD': c.cifUsdConsumed.toFixed(2)
    }));
    
    exportToCSV(consumptionsData, 'drawback_consumos', Object.keys(consumptionsData[0] || {}));
    toast.success('Resultado de Drawback exportado a CSV');
  }, [result, toast]);

  const handleReset = useCallback(() => {
    setExportItems([{ id: generateId(), productId: 'PROD-001', sku: '', quantity: '', fobUsd: '' }]);
    setResult(null);
    setErrors({});
    setDrawbackRate('3');
  }, []);

  return (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-white">Calculadora de Drawback</h2>
          <p className="text-cyan-600">Asignación FIFO de DAMs para exportaciones con reintegro</p>
        </div>
        {result && (
          <Button variant="secondary" icon={FileDown} onClick={handleExportResult}>
            Exportar Resultado
          </Button>
        )}
      </div>

      <Card title="Ítems de Exportación" icon={Globe} actions={
        <Button icon={Plus} variant="secondary" size="sm" onClick={addExportItem}>
          Agregar Ítem
        </Button>
      }>
        {errors.general && (
          <Alert type="danger" className="mb-4">{errors.general}</Alert>
        )}
        <div className="space-y-4">
          {exportItems.map((item, index) => (
            <div key={item.id} className="flex flex-col sm:flex-row gap-4 items-start sm:items-end p-4 bg-black border border-cyan-950 rounded-lg">
              <div className="flex-1 w-full sm:w-auto">
                <Input
                  label="SKU Producto"
                  value={item.sku}
                  onChange={v => updateExportItem(item.id, 'sku', v)}
                  placeholder="WIDGET-A"
                />
              </div>
              <div className="w-full sm:w-32">
                <Input
                  label="Cantidad"
                  type="number"
                  value={item.quantity}
                  onChange={v => updateExportItem(item.id, 'quantity', v)}
                  min="0"
                  step="1"
                  error={errors[`quantity_${index}`]}
                />
              </div>
              <div className="w-full sm:w-40">
                <Input
                  label="FOB USD"
                  type="number"
                  value={item.fobUsd}
                  onChange={v => updateExportItem(item.id, 'fobUsd', v)}
                  min="0"
                  step="0.01"
                  error={errors[`fobUsd_${index}`]}
                />
              </div>
              <Button 
                variant="danger" 
                icon={Trash2} 
                onClick={() => removeExportItem(item.id)}
                disabled={exportItems.length === 1}
              />
            </div>
          ))}
        </div>
        <div className="flex flex-col sm:flex-row gap-4 items-end mt-4 pt-4 border-t border-cyan-900">
          <div className="w-full sm:w-40">
            <Input
              label="Tasa Drawback %"
              type="number"
              value={drawbackRate}
              onChange={setDrawbackRate}
              min="0.1"
              max="10"
              step="0.1"
              suffix="%"
              error={errors.drawbackRate}
            />
          </div>
          <div className="flex gap-2">
            <Button icon={Calculator} onClick={handleCalculate} loading={calculating}>
              Calcular Drawback
            </Button>
            <Button variant="secondary" onClick={handleReset}>
              Limpiar
            </Button>
          </div>
        </div>
      </Card>

      {result && (
        <div className="space-y-6">
          {result.warnings.length > 0 && (
            <Alert type={result.passesFiftyPercentRule ? 'warning' : 'danger'} title="Alertas">
              <ul className="list-disc list-inside">
                {result.warnings.map((w, i) => <li key={i}>{w}</li>)}
              </ul>
            </Alert>
          )}

          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <MetricCard label="Total FOB Exportación" value={formatCurrency(result.totalFobUsd, 'USD')} variant="cyan" icon={Globe} />
            <MetricCard label="Total CIF Insumos" value={formatCurrency(result.totalCifUsed, 'USD')} variant="amber" icon={Warehouse} />
            <MetricCard 
              label="Ratio CIF/FOB" 
              value={formatPercent(result.cifFobRatio)} 
              variant={result.passesFiftyPercentRule ? 'emerald' : 'default'} 
              icon={PieChartIcon}
            />
            <MetricCard 
              label="Drawback a Recibir" 
              value={formatCurrency(result.drawbackAmountUsd, 'USD')} 
              variant={result.passesFiftyPercentRule ? 'purple' : 'default'} 
              icon={TrendingUp}
            />
          </div>

          {result.passesFiftyPercentRule ? (
            <Alert type="success" title="Elegible para Drawback">
              El ratio CIF/FOB es {result.cifFobRatio.toFixed(2)}%, cumple con la regla del 50%.
              <br />
              <strong>Drawback estimado: {formatCurrency(result.drawbackAmountUsd, 'USD')}</strong>
            </Alert>
          ) : (
            <Alert type="danger" title="No Elegible para Drawback">
              El ratio CIF/FOB ({result.cifFobRatio.toFixed(2)}%) excede el límite del 50%.
              No es posible solicitar Drawback para esta exportación.
            </Alert>
          )}

          {result.consumptions.length > 0 && (
            <Card title="Consumos de DAM (FIFO)" icon={Layers}>
              <Table
                columns={[
                  { key: 'damNumber', header: 'N° DAM', render: v => <span className="font-mono text-cyan-400">{v}</span> },
                  { key: 'damDate', header: 'Fecha DAM', render: v => formatDate(v) },
                  { key: 'productSku', header: 'Insumo' },
                  { key: 'quantityConsumed', header: 'Cantidad', align: 'right', render: v => v.toFixed(4) },
                  { key: 'cifUsdConsumed', header: 'CIF Consumido', align: 'right', render: v => formatCurrency(v, 'USD') }
                ]}
                data={result.consumptions}
              />
            </Card>
          )}

          {result.insufficientItems.length > 0 && (
            <Card title="Insumos con Cobertura Insuficiente" icon={AlertTriangle}>
              <Table
                columns={[
                  { key: 'productSku', header: 'Insumo' },
                  { key: 'requiredQty', header: 'Requerido', align: 'right', render: v => v.toFixed(4) },
                  { key: 'availableQty', header: 'Disponible', align: 'right', render: v => v.toFixed(4) },
                  { key: 'shortage', header: 'Faltante', align: 'right', render: v => <span className="text-rose-400">{v.toFixed(4)}</span> },
                  { key: 'coveragePercent', header: 'Cobertura', align: 'right', render: v => (
                    <CXBadge variant={v >= 80 ? 'success' : v >= 50 ? 'warning' : 'danger'}>
                      {v.toFixed(1)}%
                    </CXBadge>
                  )}
                ]}
                data={result.insufficientItems}
              />
            </Card>
          )}
        </div>
      )}
    </div>
  );
};

// ========================================
// MÓDULO DE REPORTES
// ========================================

const Reports = ({ folders, damLedger }) => {
  const toast = useCXToast();
  const [generating, setGenerating] = useState({});

  const reports = useMemo(() => [
    {
      id: 'folders',
      title: 'Carpetas de Importación',
      description: 'Listado completo de carpetas con estado, valores y fechas',
      icon: Ship,
      color: 'cyan'
    },
    {
      id: 'costeo',
      title: 'Costeo Detallado',
      description: 'Detalle del landed cost por carpeta e ítem',
      icon: Calculator,
      color: 'emerald'
    },
    {
      id: 'dams',
      title: 'DAM Ledger',
      description: 'Registro completo de DAMs para Drawback',
      icon: FileSpreadsheet,
      color: 'amber'
    },
    {
      id: 'expenses',
      title: 'Gastos por Carpeta',
      description: 'Detalle de gastos de importación y su distribución',
      icon: FileText,
      color: 'violet'
    }
  ], []);

  const handleGenerateReport = useCallback(async (reportId) => {
    setGenerating(prev => ({ ...prev, [reportId]: true }));
    
    try {
      await new Promise(resolve => setTimeout(resolve, 500));
      
      switch (reportId) {
        case 'folders': {
          const data = folders.map(f => ({
            'N° Carpeta': f.number,
            'Proveedor': f.supplier,
            'Incoterm': f.incoterm,
            'TC DAM': f.damTC,
            'Estado': FolderStatus[f.status]?.label || f.status,
            'Items': f.items.length,
            'Gastos': f.expenses.length,
            'Total FOB USD': f.items.reduce((s, i) => s + (i.fobUsd || 0), 0).toFixed(2),
            'Total CIF USD': f.items.reduce((s, i) => s + (i.cifUsd || 0), 0).toFixed(2),
            'Landed Cost PEN': f.calculatedCost?.totalLandedCostPen?.toFixed(2) || '0',
            'Bloqueado': f.isCostLocked ? 'Sí' : 'No',
            'Fecha Creación': formatDate(f.createdAt)
          }));
          exportToCSV(data, 'reporte_carpetas', Object.keys(data[0] || {}));
          break;
        }
        case 'costeo': {
          const data = [];
          folders.filter(f => f.calculatedCost).forEach(f => {
            f.calculatedCost.itemsDetail.forEach(item => {
              data.push({
                'Carpeta': f.number,
                'Proveedor': f.supplier,
                'SKU': item.sku,
                'Descripción': item.description,
                'Cantidad': item.quantity,
                'CIF PEN': item.cifPen.toFixed(2),
                'Derechos PEN': item.dutiesPen.toFixed(2),
                'Gastos PEN': item.expensesAllocatedPen.toFixed(2),
                'Landed Cost Total': item.totalLandedCostPen.toFixed(2),
                'Costo Unitario': item.unitLandedCostPen.toFixed(2),
                'IGV': item.igvPen.toFixed(2)
              });
            });
          });
          if (data.length === 0) {
            toast.warning('No hay carpetas con costeo calculado');
            return;
          }
          exportToCSV(data, 'reporte_costeo', Object.keys(data[0]));
          break;
        }
        case 'dams': {
          const data = damLedger.map(d => ({
            'N° DAM': d.damNumber,
            'Fecha DAM': formatDate(d.damDate),
            'Producto': d.productSku,
            'Cant. Original': d.originalQuantity,
            'Cant. Disponible': d.availableQuantity,
            'UM': d.unitOfMeasure,
            'CIF Original USD': d.originalCifUsd?.toFixed(2),
            'CIF Disponible USD': d.availableCifUsd?.toFixed(2),
            'CIF Unitario USD': d.unitCifUsd?.toFixed(2),
            'Fecha Vencimiento': formatDate(d.expiryDate),
            'Estado': d.status,
            'Elegible Drawback': d.isEligibleDrawback ? 'Sí' : 'No'
          }));
          exportToCSV(data, 'reporte_dam_ledger', Object.keys(data[0] || {}));
          break;
        }
        case 'expenses': {
          const data = [];
          folders.forEach(f => {
            f.expenses.forEach(e => {
              data.push({
                'Carpeta': f.number,
                'Proveedor': f.supplier,
                'Tipo': e.type,
                'Descripción': e.description,
                'Monto': e.amount.toFixed(2),
                'Moneda': e.currency,
                'Driver': DriverLabels[e.driver] || e.driver,
                'Capitalizable': e.isCapitalizable ? 'Sí' : 'No',
                'Fecha': formatDate(e.createdAt)
              });
            });
          });
          if (data.length === 0) {
            toast.warning('No hay gastos registrados');
            return;
          }
          exportToCSV(data, 'reporte_gastos', Object.keys(data[0]));
          break;
        }
        default:
          break;
      }
      
      toast.success('Reporte generado correctamente');
    } catch (error) {
      toast.error('Error al generar el reporte');
    } finally {
      setGenerating(prev => ({ ...prev, [reportId]: false }));
    }
  }, [folders, damLedger, toast]);

  const stats = useMemo(() => ({
    totalFolders: folders.length,
    costedFolders: folders.filter(f => f.calculatedCost).length,
    totalDAMs: damLedger.length,
    totalExpenses: folders.reduce((sum, f) => sum + f.expenses.length, 0)
  }), [folders, damLedger]);

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold text-white">Reportes y Exportación</h2>
        <p className="text-cyan-600">Genera reportes en CSV de todas las operaciones</p>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <MetricCard label="Total Carpetas" value={stats.totalFolders} icon={Ship} variant="cyan" />
        <MetricCard label="Con Costeo" value={stats.costedFolders} icon={Calculator} variant="emerald" />
        <MetricCard label="Total DAMs" value={stats.totalDAMs} icon={FileSpreadsheet} variant="amber" />
        <MetricCard label="Total Gastos" value={stats.totalExpenses} icon={FileText} variant="purple" />
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {reports.map(report => {
          const Icon = report.icon;
          const borderColors = {
            cyan: 'border-cyan-600 hover:border-cyan-500',
            emerald: 'border-emerald-600 hover:border-emerald-500',
            amber: 'border-amber-600 hover:border-amber-500',
            violet: 'border-violet-600 hover:border-violet-500'
          };
          const iconColors = {
            cyan: 'text-cyan-400',
            emerald: 'text-emerald-400',
            amber: 'text-amber-400',
            violet: 'text-violet-400'
          };

          return (
            <div 
              key={report.id}
              className={`bg-black border ${borderColors[report.color]} rounded-xl p-6 transition-all duration-300 hover:scale-[1.02]`}
            >
              <div className="flex items-start gap-4">
                <div className={`p-3 rounded-xl border ${borderColors[report.color]}`}>
                  <Icon className={`w-8 h-8 ${iconColors[report.color]}`} />
                </div>
                <div className="flex-1">
                  <h3 className="text-lg font-semibold text-white mb-1">{report.title}</h3>
                  <p className="text-sm text-cyan-500 mb-4">{report.description}</p>
                  <Button 
                    icon={FileDown} 
                    variant="secondary" 
                    onClick={() => handleGenerateReport(report.id)}
                    loading={generating[report.id]}
                  >
                    Generar CSV
                  </Button>
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
};

// ========================================
// DATOS INICIALES
// ========================================

const INITIAL_FOLDERS = [
  {
    id: 'folder-1',
    number: 'IMP-2025-001',
    supplier: 'Shanghai Electronics Co.',
    incoterm: 'CIF',
    damTC: 3.75,
    status: 'COSTED',
    isCostLocked: true,
    items: [
      { id: 'i1', sku: 'LAPTOP-15', description: 'Laptop 15" Core i5', quantity: 50, fobUsd: 25000, cifUsd: 27500, weightKg: 150, volumeM3: 0.5, adValoremRate: 6 },
      { id: 'i2', sku: 'LAPTOP-17', description: 'Laptop 17" Core i7', quantity: 30, fobUsd: 24000, cifUsd: 26400, weightKg: 120, volumeM3: 0.4, adValoremRate: 6 }
    ],
    expenses: [
      { id: 'e1', type: 'Flete Internacional', description: 'Naviera MSC', amount: 2500, currency: 'USD', isCapitalizable: true, driver: 'BY_WEIGHT', isProcessed: false, createdAt: '2025-01-15T10:00:00Z' },
      { id: 'e2', type: 'Seguro', description: 'Póliza de carga', amount: 350, currency: 'USD', isCapitalizable: true, driver: 'BY_FOB_VALUE', isProcessed: false, createdAt: '2025-01-15T10:00:00Z' },
      { id: 'e3', type: 'Agente Aduanas', description: 'Despacho aduanero', amount: 1200, currency: 'PEN', isCapitalizable: true, driver: 'BY_FOB_VALUE', isProcessed: false, createdAt: '2025-01-15T10:00:00Z' }
    ],
    calculatedCost: null,
    snapshots: [
      { version: 1, timestamp: '2025-01-20T14:30:00Z', reason: 'INITIAL', totalLandedCost: 215000 },
      { version: 2, timestamp: '2025-01-20T15:00:00Z', reason: 'COST_LOCKED', totalLandedCost: 215000 }
    ],
    createdAt: '2025-01-10T08:00:00Z',
    updatedAt: '2025-01-20T15:00:00Z'
  },
  {
    id: 'folder-2',
    number: 'IMP-2025-002',
    supplier: 'Taiwan Components Ltd.',
    incoterm: 'FOB',
    damTC: 3.72,
    status: 'CLEARED',
    isCostLocked: false,
    items: [
      { id: 'i3', sku: 'PCB-001', description: 'Placa base ATX', quantity: 200, fobUsd: 8000, cifUsd: 9200, weightKg: 80, volumeM3: 0.2, adValoremRate: 0 },
      { id: 'i4', sku: 'RAM-16GB', description: 'Memoria RAM 16GB DDR5', quantity: 500, fobUsd: 15000, cifUsd: 17250, weightKg: 25, volumeM3: 0.05, adValoremRate: 0 }
    ],
    expenses: [
      { id: 'e4', type: 'Flete Internacional', description: 'Aéreo DHL', amount: 1800, currency: 'USD', isCapitalizable: true, driver: 'BY_WEIGHT', isProcessed: false, createdAt: '2025-01-18T10:00:00Z' }
    ],
    calculatedCost: null,
    snapshots: [],
    createdAt: '2025-01-15T09:00:00Z',
    updatedAt: '2025-01-18T10:00:00Z'
  }
];

const INITIAL_DAM_LEDGER = [
  {
    id: 'dam1',
    damNumber: '118-2024-10-123456',
    damDate: '2024-06-15',
    expiryDate: '2027-06-15',
    productId: 'PROD-001',
    productSku: 'MATERIA-A',
    originalQuantity: 1000,
    availableQuantity: 750,
    originalCifUsd: 45000,
    availableCifUsd: 33750,
    unitCifUsd: 45,
    unitOfMeasure: 'KG',
    status: 'PARTIALLY_CONSUMED',
    isEligibleDrawback: true
  },
  {
    id: 'dam2',
    damNumber: '118-2024-08-654321',
    damDate: '2024-08-20',
    expiryDate: '2027-08-20',
    productId: 'PROD-002',
    productSku: 'MATERIA-B',
    originalQuantity: 500,
    availableQuantity: 500,
    originalCifUsd: 12500,
    availableCifUsd: 12500,
    unitCifUsd: 25,
    unitOfMeasure: 'UND',
    status: 'AVAILABLE',
    isEligibleDrawback: true
  },
  {
    id: 'dam3',
    damNumber: '118-2025-01-111111',
    damDate: '2025-01-10',
    expiryDate: '2028-01-10',
    productId: 'PROD-001',
    productSku: 'MATERIA-A',
    originalQuantity: 2000,
    availableQuantity: 2000,
    originalCifUsd: 80000,
    availableCifUsd: 80000,
    unitCifUsd: 40,
    unitOfMeasure: 'KG',
    status: 'AVAILABLE',
    isEligibleDrawback: true
  },
  {
    id: 'dam4',
    damNumber: '118-2022-03-999999',
    damDate: '2022-03-01',
    expiryDate: '2025-03-01',
    productId: 'PROD-003',
    productSku: 'MATERIA-C',
    originalQuantity: 300,
    availableQuantity: 50,
    originalCifUsd: 6000,
    availableCifUsd: 1000,
    unitCifUsd: 20,
    unitOfMeasure: 'LT',
    status: 'PARTIALLY_CONSUMED',
    isEligibleDrawback: true
  }
];

// ========================================
// APLICACIÓN PRINCIPAL
// ========================================

const CXAppContent = () => {
  const toast = useCXToast();
  const [activeSection, setActiveSection] = useState('dashboard');
  const [selectedFolder, setSelectedFolder] = useState(null);
  
  // Persistencia con localStorage
  const [folders, setFolders] = useLocalStorage('comex_folders', INITIAL_FOLDERS);
  const [damLedger, setDamLedger] = useLocalStorage('comex_dam_ledger', INITIAL_DAM_LEDGER);

  // Calcular landed cost para carpetas que lo necesitan
  useEffect(() => {
    const foldersNeedingCalculation = folders.filter(f => f.isCostLocked && !f.calculatedCost);
    if (foldersNeedingCalculation.length > 0) {
      const updatedFolders = folders.map(folder => {
        if (folder.isCostLocked && !folder.calculatedCost) {
          return { ...folder, calculatedCost: calculateLandedCost(folder) };
        }
        return folder;
      });
      setFolders(updatedFolders);
    }
  }, []);

  const handleNavigate = useCallback((section, param) => {
    setActiveSection(section);
    if (section === 'folders' && param === 'new') {
      setSelectedFolder(null);
    } else if (section === 'folders' && param) {
      const folder = folders.find(f => f.id === param);
      if (folder) setSelectedFolder(folder);
    } else {
      setSelectedFolder(null);
    }
  }, [folders]);

  const handleCreateFolder = useCallback((folderData) => {
    setFolders(prev => [...prev, folderData]);
  }, [setFolders]);

  const handleUpdateFolder = useCallback((updatedFolder) => {
    setFolders(prev => prev.map(f => f.id === updatedFolder.id ? updatedFolder : f));
    if (selectedFolder?.id === updatedFolder.id) {
      setSelectedFolder(updatedFolder);
    }
  }, [setFolders, selectedFolder]);

  const handleDeleteFolder = useCallback((folderId) => {
    setFolders(prev => prev.filter(f => f.id !== folderId));
    if (selectedFolder?.id === folderId) {
      setSelectedFolder(null);
    }
  }, [setFolders, selectedFolder]);

  const sections = useMemo(() => [
    { id: 'dashboard', label: 'Dashboard', icon: BarChart3 },
    { id: 'folders', label: 'Carpetas', icon: Ship },
    { id: 'late-expense', label: 'Gastos Tardíos', icon: Clock },
    { id: 'dam-ledger', label: 'DAM Ledger', icon: FileSpreadsheet },
    { id: 'drawback', label: 'Drawback', icon: TrendingUp },
    { id: 'reports', label: 'Reportes', icon: FileDown }
  ], []);

  return (
    <div>
      <GlobalStyles />
      
      {/* Navigation */}
      <nav className="mb-4 overflow-x-auto">
        <CXTabs 
          tabs={sections} 
          activeTab={activeSection} 
          onChange={(id) => { setActiveSection(id); setSelectedFolder(null); }} 
        />
      </nav>

      {/* Content */}
      {activeSection === 'dashboard' && (
        <Dashboard folders={folders} damLedger={damLedger} onNavigate={handleNavigate} />
      )}

      {activeSection === 'folders' && !selectedFolder && (
        <FoldersList
          folders={folders}
          onSelect={setSelectedFolder}
          onCreate={handleCreateFolder}
          onUpdate={handleUpdateFolder}
          onDelete={handleDeleteFolder}
        />
      )}

      {activeSection === 'folders' && selectedFolder && (
        <ImportFolderDetail
          folder={selectedFolder}
          onUpdate={handleUpdateFolder}
          onCalculate={() => {}}
          onClose={() => setSelectedFolder(null)}
          onDelete={handleDeleteFolder}
        />
      )}

      {activeSection === 'late-expense' && (
        <LateExpenseProcessor folders={folders} />
      )}

      {activeSection === 'dam-ledger' && (
        <DAMLedger damLedger={damLedger} onUpdate={setDamLedger} />
      )}

      {activeSection === 'drawback' && (
        <DrawbackAllocator damLedger={damLedger} folders={folders} />
      )}

      {activeSection === 'reports' && (
        <Reports folders={folders} damLedger={damLedger} />
      )}
    </div>
  );
};

// ========================================
// TRADE VIEW WRAPPER FOR SUMA ERP
// ========================================
function TradeView() {
  return (
    <CXToastProvider>
      <CXAppContent />
    </CXToastProvider>
  );
}
/* ===== MAIN APP ===== */
function SumaERP() {
  const [user, setUser] = useState(null);
  const [D, setD] = useState(initData);
  const [mod, setMod] = useState("dash");
  const [ml, setMl] = useState(null);
  const [fd, setFd] = useState({});
  const [cfm, setCfm] = useState(null);
  const [toast, setToast] = useState(null);
  const [search, setSearch] = useState("");
  const [scanModal, setScanModal] = useState(null);
  const [planModal, setPlanModal] = useState(null);
  const [cart, setCart] = useState(null);
  const [payMethod, setPayMethod] = useState(null);
  const [invoiceModal, setInvoiceModal] = useState(null);
  const [exportModal, setExportModal] = useState(null);
  _exportModalSetter = setExportModal;
  const [subscription, setSub] = useState({ plan: "free", start: today(), daysLeft: 7 });
  const [HR, setHR] = useState(initHR);
  const [hrTab, setHrTab] = useState("dashboard");
  const [invTab, setInvTab] = useState("dashboard");
  const [acctTab, setAcctTab] = useState("dashboard");
  const [scannedDocs, setScannedDocs] = useState(initScannedDocs);
  const [docFilterEmpresa, setDocFilterEmpresa] = useState("all");
  const [docFilterTipo, setDocFilterTipo] = useState("all");
  const [docFilterFechaDesde, setDocFilterFechaDesde] = useState("");
  const [docFilterFechaHasta, setDocFilterFechaHasta] = useState("");
  const dashRef = useRef(null);
  const notify = useCallback((m, t = "ok") => setToast({ msg: m, type: t }), []);

  const filteredDocs = useMemo(() => {
    let docs = scannedDocs;
    if (user?.role === "cliente" && user?.empresaRuc) {
      docs = docs.filter(d => d.empresaRuc === user.empresaRuc);
    }
    if (docFilterEmpresa !== "all") docs = docs.filter(d => d.empresaRuc === docFilterEmpresa);
    if (docFilterTipo !== "all") docs = docs.filter(d => d.tipo === docFilterTipo);
    if (docFilterFechaDesde) docs = docs.filter(d => d.fecha >= docFilterFechaDesde);
    if (docFilterFechaHasta) docs = docs.filter(d => d.fecha <= docFilterFechaHasta);
    return docs;
  }, [scannedDocs, user, docFilterEmpresa, docFilterTipo, docFilterFechaDesde, docFilterFechaHasta]);

  const filteredComprasDocs = useMemo(() => filteredDocs.filter(d => d.modulo === "compras"), [filteredDocs]);
  const filteredVentasDocs = useMemo(() => filteredDocs.filter(d => d.modulo === "ventas"), [filteredDocs]);

  const empresaBreakdown = useMemo(() => {
    const map = {};
    scannedDocs.forEach(d => { if (!map[d.empresaRuc]) map[d.empresaRuc] = { ruc: d.empresaRuc, razon: d.empresaRazon, docs: 0, total: 0, procesados: 0 }; map[d.empresaRuc].docs++; map[d.empresaRuc].total += nn(d.total); if (d.estado === "Procesado") map[d.empresaRuc].procesados++; });
    return Object.values(map).sort((a, b) => b.total - a.total);
  }, [scannedDocs]);

  const sf = (k, v) => setFd(p => ({ ...p, [k]: v }));
  const fv = (k, d = "") => fd[k] ?? d;
  const canDB = user?.role === "admin" || user?.role === "contador";

  if (!user) return <LoginScreen onLogin={setUser} />;

  const add = (t, i) => { setD(p => ({ ...p, [t]: [{ id: uid(), ...i }, ...p[t]] })); notify("Registro creado"); };
  const upd = (t, id, i) => { setD(p => ({ ...p, [t]: p[t].map(r => r.id === id ? { ...r, ...i } : r) })); notify("Actualizado"); };
  const del = (t, id) => { setD(p => ({ ...p, [t]: p[t].filter(r => r.id !== id) })); notify("Eliminado"); setCfm(null); };
  const closeMl = () => { setMl(null); setFd({}); };
  const saveMl = () => { if (!ml) return; if (ml.editing) upd(ml.type, ml.id, fd); else add(ml.type, fd); closeMl(); };
  const setSub2 = (v) => { const s = nn(v); sf("subtotal", v); sf("igv", (s * .18).toFixed(2)); sf("total", (s * 1.18).toFixed(2)); };

  /* TOTALS */
  const tv = D.facturas.reduce((a, f) => a + nn(f.total), 0);
  const tc2 = D.compras.reduce((a, c) => a + nn(c.total), 0);
  const ti = D.imports.reduce((a, e) => a + nn(e.cif), 0);
  const te = D.exports.reduce((a, e) => a + nn(e.fob), 0);
  const tp = HR.empleados.filter(e => e.estado === "Activo" || e.estado === "Periodo Prueba").reduce((a, e) => a + nn(e.sueldo), 0);
  const tb = D.bancos.reduce((a, b) => a + nn(b.saldo), 0);
  const tt = 0;
  const lowS = D.productos.filter(p => nn(p.stock) < nn(p.stockMin));
  const igvD = D.facturas.reduce((a, f) => a + nn(f.igv), 0);
  const igvC = D.compras.reduce((a, c) => a + nn(c.igv), 0);

  const filt = (a, ks) => { if (!search) return a; const s = search.toLowerCase(); return a.filter(r => ks.some(k => String(r[k] || "").toLowerCase().includes(s))); };

  /* SIRE GEN */
  const genSV = () => D.facturas.map((f, i) => ({ periodo: f.fecha?.slice(0, 7)?.replace("-", ""), cuo: `M${String(i + 1).padStart(8, "0")}`, correlativo: "M-1", fechaEmision: f.fecha, tipoCdp: TCPD[f.tipo] || "01", serie: f.serie, numero: f.numero, tipoDocCli: f.tipoDoc, numDocCli: f.ruc, razonSocial: f.cliente, baseImponible: nn(f.subtotal).toFixed(2), igv: nn(f.igv).toFixed(2), total: nn(f.total).toFixed(2), moneda: f.moneda === "PEN" ? "1" : "2", tipoCambio: f.tc, estado: f.estado === "Anulada" ? "2" : "1" }));
  const genSC = () => D.compras.map((c, i) => ({ periodo: c.fecha?.slice(0, 7)?.replace("-", ""), cuo: `M${String(i + 1).padStart(8, "0")}`, correlativo: "M-1", fechaEmision: c.fecha, tipoCdp: TCPD[c.tipo] || "01", serie: c.serie, numero: c.numero, tipoDocProv: c.tipoDoc, numDocProv: c.ruc, razonSocial: c.proveedor, baseImponible: nn(c.subtotal).toFixed(2), igv: nn(c.igv).toFixed(2), total: nn(c.total).toFixed(2), moneda: c.moneda === "PEN" ? "1" : "2", tipoCambio: c.tc, dua: c.dua || "", estado: c.estado === "Anulada" ? "2" : "1" }));

  /* SCAN */
  /* ===== UNIFIED AI DOCUMENT SCANNER ===== */
  const scanDocumentAI = async (file, contextType, isClientScan = false) => {
    const toBase64 = (f) => new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result.split(",")[1]); r.onerror = rej; r.readAsDataURL(f); });
    const base64Data = await toBase64(file);

    /* Detect media type - PDFs must be sent as document type */
    const isPDF = file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf");
    const contentBlock = isPDF
      ? { type: "document", source: { type: "base64", media_type: "application/pdf", data: base64Data } }
      : { type: "image", source: { type: "base64", media_type: file.type || "image/png", data: base64Data } };

    const systemPrompt = `Eres un contador publico colegiado y auditor financiero peruano con 30 años de experiencia en SUNAT, tributacion y contabilidad empresarial. Tu especialidad es analizar comprobantes de pago electronicos y fisicos del Peru.

REGLAS DE ANALISIS:
1. IDENTIFICA el tipo de documento: Factura Electronica (serie E o F), Boleta (serie B), Nota de Credito (serie FC, BC), Nota de Debito (serie FD, BD)
2. DETERMINA la naturaleza: Si el documento fue EMITIDO por la empresa = VENTA. Si fue RECIBIDO de un proveedor = COMPRA.
3. EXTRAE TODOS los montos exactos como aparecen: Op. Gravadas (base imponible), IGV 18%, Total. Si ves "OP. GRAVADAS", "SUBTOTAL", "VALOR VENTA" = base imponible sin IGV.
4. El RUC tiene 11 digitos y empieza con 10 (persona natural) o 20 (persona juridica). El DNI tiene 8 digitos.
5. La serie de factura electronica empieza con F (SUNAT) o E (OSE). Boleta con B. 
6. IDENTIFICA emisor (quien emite/vende) y receptor (quien recibe/compra) claramente.
7. Si ves "SEÑOR(ES):" o "CLIENTE:" eso es el comprador/receptor.
8. Si ves "RUC:" al inicio del documento, eso es del EMISOR.
9. ASIGNA la cuenta contable PCGE Peru segun el tipo:
   - Compra mercaderia: 6011 Mercaderias manufacturadas
   - Compra suministros: 6032 Suministros
   - Compra servicios: 6321 Asesoria y consultoria
   - Compra activos: 3361 Equipos
   - Venta mercaderia: 7011 Mercaderias manufacturadas  
   - Venta servicios: 7041 Terceros
   - IGV compras: 40111 IGV Cuenta propia
   - IGV ventas: 40111 IGV Cuenta propia
10. Si no puedes leer un campo, analiza el contexto del documento para inferirlo.`;

    const userPrompt = `Analiza este comprobante de pago peruano. El usuario lo subio desde el modulo de "${contextType}".

EXTRAE TODA la informacion y responde UNICAMENTE con un JSON valido (sin backticks, sin texto adicional, sin markdown):
{
  "naturaleza": "VENTA o COMPRA (segun quien emitio el documento)",
  "tipo_cdp": "Factura o Boleta o Nota Credito o Nota Debito",
  "serie": "serie exacta del comprobante",
  "numero": "numero correlativo exacto",
  "fecha_emision": "YYYY-MM-DD",
  "fecha_vencimiento": "YYYY-MM-DD o vacio",
  "emisor_ruc": "RUC de 11 digitos del emisor",
  "emisor_razon_social": "razon social completa del emisor",
  "emisor_direccion": "direccion del emisor si es visible",
  "receptor_ruc": "RUC o DNI del receptor/cliente",
  "receptor_razon_social": "razon social del receptor",
  "receptor_direccion": "direccion del receptor si es visible",
  "moneda": "PEN o USD",
  "op_gravadas": numero base imponible (operaciones gravadas),
  "op_inafectas": numero operaciones inafectas (0 si no hay),
  "op_exoneradas": numero operaciones exoneradas (0 si no hay),
  "igv": numero monto IGV 18%,
  "total": numero importe total,
  "detraccion": numero monto detraccion si aplica (0 si no),
  "retencion": numero monto retencion si aplica (0 si no),
  "neto_pagar": numero neto a pagar despues de detracciones/retenciones,
  "tipo_cambio": "tipo de cambio si es USD (ej: 3.742), si es PEN pon 1.000",
  "forma_pago": "Contado o Credito",
  "observaciones": "cualquier nota relevante como numero de guia, orden de compra, condiciones",
  "cuenta_pcge": "codigo de cuenta contable PCGE segun las reglas",
  "contrapartida_pcge": "cuenta contrapartida PCGE",
  "descripcion_items": "resumen breve de los items/servicios del documento",
  "dua": "numero DUA si es importacion, vacio si no aplica",
  "hash_cpe": "codigo hash o firma digital si es visible"
}

IMPORTANTE: Los campos numericos deben ser numeros puros (ej: 1500.00), NO strings. Si un monto no esta claro, calculalo: total = op_gravadas + igv. Si ves S/ es PEN, si ves $ o US$ es USD.`;

    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 2000,
        system: systemPrompt,
        messages: [{ role: "user", content: [contentBlock, { type: "text", text: userPrompt }] }]
      })
    });

    const result = await response.json();
    const text = result.content?.map(c => c.text || "").join("") || "";
    if (!text) throw new Error("API returned empty response: " + JSON.stringify(result));
    const clean = text.replace(/```json|```/g, "").trim();
    return JSON.parse(clean);
  };

  /* Build structured record from AI-parsed data */
  const buildRecordFromAI = (parsed, contextType, fileName) => {
    const isVenta = (parsed.naturaleza || "").toUpperCase().includes("VENTA") || contextType === "ventas";
    const sub = Number(parsed.op_gravadas) || 0;
    const inaf = Number(parsed.op_inafectas) || 0;
    const exon = Number(parsed.op_exoneradas) || 0;
    const igvVal = Number(parsed.igv) || +(sub * 0.18).toFixed(2);
    const totalVal = Number(parsed.total) || +(sub + inaf + exon + igvVal).toFixed(2);
    const netoVal = Number(parsed.neto_pagar) || totalVal;
    const detraccion = Number(parsed.detraccion) || 0;
    const retencion = Number(parsed.retencion) || 0;

    if (isVenta) {
      return {
        serie: parsed.serie || "FE01",
        numero: parsed.numero || "000000",
        fecha: parsed.fecha_emision || today(),
        tipo: parsed.tipo_cdp || "Factura",
        cliente: parsed.receptor_razon_social || parsed.emisor_razon_social || "",
        ruc: parsed.receptor_ruc || parsed.emisor_ruc || "",
        tipoDoc: (parsed.receptor_ruc || "").length === 11 ? "6" : "1",
        moneda: parsed.moneda || "PEN",
        subtotal: sub, igv: igvVal, total: totalVal,
        estado: "Emitida", tc: parsed.tipo_cambio || "1.000",
        _ai: { emisor: parsed.emisor_razon_social, emisorRuc: parsed.emisor_ruc, receptor: parsed.receptor_razon_social, receptorRuc: parsed.receptor_ruc, cuenta: parsed.cuenta_pcge, contrapartida: parsed.contrapartida_pcge, formaPago: parsed.forma_pago, items: parsed.descripcion_items, obs: parsed.observaciones, detraccion, retencion, neto: netoVal, hash: parsed.hash_cpe, inaf, exon, fechaVenc: parsed.fecha_vencimiento, naturaleza: parsed.naturaleza }
      };
    } else {
      return {
        serie: parsed.serie || "E001",
        numero: parsed.numero || "000000",
        fecha: parsed.fecha_emision || today(),
        tipo: parsed.tipo_cdp || "Factura",
        proveedor: parsed.emisor_razon_social || "",
        ruc: parsed.emisor_ruc || "",
        tipoDoc: (parsed.emisor_ruc || "").length === 11 ? "6" : "1",
        moneda: parsed.moneda || "PEN",
        subtotal: sub, igv: igvVal, total: totalVal,
        estado: "Pendiente", tc: parsed.tipo_cambio || "1.000",
        dua: parsed.dua || "", fechaRegistro: today(),
        _ai: { emisor: parsed.emisor_razon_social, emisorRuc: parsed.emisor_ruc, receptor: parsed.receptor_razon_social, receptorRuc: parsed.receptor_ruc, cuenta: parsed.cuenta_pcge, contrapartida: parsed.contrapartida_pcge, formaPago: parsed.forma_pago, items: parsed.descripcion_items, obs: parsed.observaciones, detraccion, retencion, neto: netoVal, hash: parsed.hash_cpe, inaf, exon, fechaVenc: parsed.fecha_vencimiento, naturaleza: parsed.naturaleza }
      };
    }
  };

  const doScan = (type) => {
    const fi = document.createElement("input"); fi.type = "file"; fi.accept = "image/*,.pdf";
    fi.onchange = async (e) => { const f = e.target.files?.[0]; if (!f) return;
      setScanModal({ type, file: f.name, processing: true });
      try {
        const parsed = await scanDocumentAI(f, type);
        const d = buildRecordFromAI(parsed, type, f.name);
        setScanModal({ type, file: f.name, processing: false, data: d, aiSource: true, aiRaw: parsed });
      } catch (err) {
        console.error("Scan error:", err);
        notify("Error procesando documento: " + (err.message || "intenta con otra imagen"), "err");
        setScanModal(null);
      }
    }; fi.click();
  };

  /* SUBSCRIPTION & PAYMENT */
  const selectPlan = (plan) => { setCart(plan); setPlanModal("cart"); };
  const processPayment = () => {
    setPlanModal("processing");
    setTimeout(() => {
      setSub({ plan: cart.id, start: today(), daysLeft: cart.id === "free" ? 7 : 30 });
      setPlanModal("done");
    }, 2000);
  };
  const genInvoice = (tipo) => {
    if (!cart) return;
    const inv = { tipo, serie: tipo === "Factura" ? "F001" : "B001", numero: String(Math.floor(Math.random() * 9e5 + 1e5)), fecha: today(), plan: cart.name, monto: cart.price, igv: +(cart.price * .18).toFixed(2), total: +(cart.price * 1.18).toFixed(2), moneda: "PEN" };
    setInvoiceModal(inv);
  };

  /* ===== DOCUMENT FILTERING & EXPORT FUNCTIONS ===== */
  const exportXLS = (data, filename, customCols) => {
    let headers, rows, numCols;
    if (customCols) {
      headers = customCols.map(c => c.l);
      numCols = new Set(customCols.map((c, i) => c.num ? i : -1).filter(i => i >= 0));
      rows = data.map(d => customCols.map(c => d[c.k] ?? ""));
    } else {
      headers = ["Empresa RUC", "Empresa", "Serie", "Numero", "Fecha", "Tipo", "Proveedor", "RUC Prov.", "Moneda", "Subtotal", "IGV", "Total", "Estado", "Fecha Escaneo", "IA Resultado", "Confianza IA %", "Cuenta Contable", "Modulo", "Archivo"];
      numCols = new Set([9, 10, 11, 15]);
      rows = data.map(d => [d.empresaRuc, d.empresaRazon, d.serie, d.numero, d.fecha, d.tipo, d.proveedor, d.rucProv, d.moneda, d.subtotal, d.igv, d.total, d.estado, d.scanDate, d.scanIA, d.confianzaIA, d.cuentaContable, d.modulo, d.archivo]);
    }
    const esc = (v) => String(v ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    let tsv = headers.join("\t") + "\n";
    rows.forEach(r => { tsv += r.map(c => String(c ?? "").replace(/\t/g, " ").replace(/\n/g, " ")).join("\t") + "\n"; });
    setExportModal({ content: tsv, filename, headers, rows, numCols });
  };

  const handleClientScan = (modulo) => {
    const fi = document.createElement("input"); fi.type = "file"; fi.accept = "image/*,.pdf";
    fi.onchange = async (e) => { const f = e.target.files?.[0]; if (!f) return;
      setScanModal({ type: modulo, file: f.name, processing: true, clientScan: true });
      try {
        const parsed = await scanDocumentAI(f, modulo);
        const rec = buildRecordFromAI(parsed, modulo, f.name);
        const newDoc = {
          id: uid(),
          empresaRuc: user.empresaRuc,
          empresaRazon: user.empresaRazon || user.empresa?.razon,
          serie: rec.serie, numero: rec.numero, fecha: rec.fecha, tipo: rec.tipo,
          proveedor: rec.proveedor || rec.cliente || "",
          rucProv: rec.ruc || "",
          moneda: rec.moneda, subtotal: rec.subtotal, igv: rec.igv, total: rec.total,
          estado: "En Proceso", scanDate: today(), scanIA: "En Proceso",
          cuentaContable: rec._ai?.cuenta || "",
          modulo, archivo: f.name, confianzaIA: 0, _ai: rec._ai,
        };
        setScanModal({ type: modulo, file: f.name, processing: false, data: newDoc, clientScan: true, aiSource: true, aiRaw: parsed });
      } catch (err) {
        console.error("Client scan error:", err);
        notify("Error procesando documento: " + (err.message || "intenta con otra imagen"), "err");
        setScanModal(null);
      }
    }; fi.click();
  };

  const confirmClientScan = (doc) => {
    const aiCuenta = doc._ai?.cuenta || doc.cuentaContable || "6011";
    const finalDoc = { ...doc, estado: "Procesado", scanIA: "Aprobado IA", confianzaIA: 95, cuentaContable: aiCuenta };
    delete finalDoc._ai;
    setScannedDocs(prev => [finalDoc, ...prev]);

    /* Also add to D.facturas or D.compras so it appears in Libro Diario for contador */
    if (doc.modulo === "ventas") {
      add("facturas", {
        serie: doc.serie, numero: doc.numero, fecha: doc.fecha, tipo: doc.tipo,
        cliente: doc.proveedor || doc.cliente || "", ruc: doc.rucProv || "",
        tipoDoc: (doc.rucProv || "").length === 11 ? "6" : "1",
        moneda: doc.moneda || "PEN", subtotal: doc.subtotal, igv: doc.igv, total: doc.total,
        estado: "Emitida", tc: "1.000", _fromClient: doc.empresaRuc
      });
    } else {
      add("compras", {
        serie: doc.serie, numero: doc.numero, fecha: doc.fecha, tipo: doc.tipo,
        proveedor: doc.proveedor || "", ruc: doc.rucProv || "",
        tipoDoc: (doc.rucProv || "").length === 11 ? "6" : "1",
        moneda: doc.moneda || "PEN", subtotal: doc.subtotal, igv: doc.igv, total: doc.total,
        estado: "Pendiente", tc: "1.000", dua: "", fechaRegistro: today(), _fromClient: doc.empresaRuc
      });
    }

    setScanModal(null);
    notify("Registrado en contabilidad · Cuenta PCGE: " + aiCuenta);
  };

  /* CHART DATA */
  const monthData = tv > 0 || tc2 > 0 ? [{ m: "Feb", v: tv, c: tc2, g: tv - tc2 }] : [];
  const catData = D.productos.reduce((a, p) => { const e = a.find(x => x.name === p.categoria); if (e) { e.value += nn(p.stock) * nn(p.landed); } else a.push({ name: p.categoria, value: nn(p.stock) * nn(p.landed) }); return a; }, []);
  const pieColors = [P.blue, P.grn, P.org, P.pur, P.cyan, P.red];
  const estadoVentas = [{ name: "Pagada", value: D.facturas.filter(f => f.estado === "Pagada").length, color: P.grn }, { name: "Emitida", value: D.facturas.filter(f => f.estado === "Emitida").length, color: P.blue }, { name: "Pendiente", value: D.facturas.filter(f => f.estado === "Pendiente").length, color: P.org }].filter(x => x.value > 0);
  const radarData = [{ s: "Ventas", v: D.facturas.length > 0 ? Math.min(100, D.facturas.length * 20) : 0 }, { s: "Compras", v: D.compras.length > 0 ? Math.min(100, D.compras.length * 20) : 0 }, { s: "Inventario", v: D.productos.length > 0 ? Math.min(100, D.productos.length * 25) : 0 }, { s: "Finanzas", v: D.bancos.length > 0 ? Math.min(100, D.bancos.length * 50) : 0 }, { s: "RRHH", v: D.empleados.length > 0 ? Math.min(100, D.empleados.length * 30) : 0 }];

  /* ===== HR MODULE ===== */
  const E = HR.empleados;
  const hrActivos = E.filter(e => e.estado === "Activo" || e.estado === "Periodo Prueba");
  const hrTotalPlanilla = hrActivos.reduce((a, e) => a + calcNomina(e).bruto, 0);
  const hrTotalNeto = hrActivos.reduce((a, e) => a + calcNomina(e).neto, 0);
  const hrTotalCosto = hrActivos.reduce((a, e) => a + calcNomina(e).costoEmpresa, 0);
  const hrDeptos = [...new Set(E.map(e => e.depto))];
  const hrFilt = (a, ks) => { if (!search) return a; const s2 = search.toLowerCase(); return a.filter(r => ks.some(k => String(r[k] || "").toLowerCase().includes(s2))); };
  const hrAdd = (t, i) => { setHR(p => ({ ...p, [t]: [{ id: uid(), ...i }, ...p[t]] })); notify("Creado"); };
  const hrUpd = (t, id, i) => { setHR(p => ({ ...p, [t]: p[t].map(r => r.id === id ? { ...r, ...i } : r) })); notify("Actualizado"); };
  const hrDel = (t, id) => { setHR(p => ({ ...p, [t]: p[t].filter(r => r.id !== id) })); notify("Eliminado"); setCfm(null); };
  const hrCloseMl = () => { setMl(null); setFd({}); };
  const hrSaveMl = () => { if (!ml) return; if (ml.editing) hrUpd(ml.type, ml.id, fd); else hrAdd(ml.type, fd); hrCloseMl(); };
  const nineBoxData = E.filter(e => e.desempeno > 0).map(e => ({ x: nn(e.desempeno), y: nn(e.potencial), z: 200, name: e.nombre.split(" ").slice(0, 2).join(" "), fuga: nn(e.fugaRiesgo), nineBox: e.nineBox }));

  const HR_TABS = [
    { id: "dashboard", l: "Dashboard", icon: <I.Da /> },
    { id: "expedientes", l: "Expedientes", icon: <I.Pp /> },
    { id: "ats", l: "Reclutamiento", icon: <I.Us /> },
    { id: "nomina", l: "Nomina", icon: <I.Dl /> },
    { id: "asistencia", l: "Asistencia", icon: <I.Cr /> },
    { id: "talento", l: "Talento", icon: <I.Aw /> },
    { id: "ess", l: "Portal ESS", icon: <I.Ky /> },
  ];

  function HRDash() {
    const rotacion = 2;
    const costoPorDepto = hrDeptos.map(d => ({ name: d, value: E.filter(e => e.depto === d).reduce((a, e) => a + calcNomina(e).costoEmpresa, 0) }));
    const antigData = [{ r: "< 1 año", v: E.filter(e => (new Date() - new Date(e.ingreso)) / 365.25 / 86400000 < 1).length }, { r: "1-3 años", v: E.filter(e => { const y = (new Date() - new Date(e.ingreso)) / 365.25 / 86400000; return y >= 1 && y < 3; }).length }, { r: "3-5 años", v: 2 }, { r: "5+ años", v: 2 }];
    const pieC = [P.blue, P.grn, P.org, P.pur, P.cyan, P.red];
    return (<div style={{ display: "flex", flexDirection: "column", gap: 9 }}>
      <div style={{ fontSize: 15, fontWeight: 800 }}>Dashboard RRHH — People Analytics</div>
      <G c={5}>
        <K l="Headcount" v={hrActivos.length} icon={<I.Pp />} color={P.blue} sub={`Total: ${E.length}`} glow />
        <K l="Planilla Bruta" v={$(hrTotalPlanilla)} icon={<I.Dl />} color={P.org} sub={`Neto: ${$(hrTotalNeto)}`} />
        <K l="Costo Empresa" v={$(hrTotalCosto)} icon={<I.Cd />} color={P.red} sub="Incluye provisiones" />
        <K l="Rotacion" v={`${rotacion}%`} icon={<I.Tg />} color={rotacion > 5 ? P.red : P.grn} sub="Anualizada" />
        <K l="Clima Laboral" v="78%" icon={<I.Ht />} color={P.tl} sub="IA: Sentimiento positivo" />
      </G>
      <G c={3}>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
          <div style={{ fontSize: 10, fontWeight: 700, marginBottom: 6 }}>Costo por Departamento</div>
          <ResponsiveContainer width="100%" height={150}><BarChart data={costoPorDepto} layout="vertical"><XAxis type="number" hide /><YAxis type="category" dataKey="name" tick={{ fill: P.s2, fontSize: 8 }} width={70} /><Tooltip contentStyle={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 5, fontSize: 9 }} formatter={v => $(v)} /><Bar dataKey="value" radius={[0, 3, 3, 0]}>{costoPorDepto.map((_, i) => <Cell key={i} fill={pieC[i % pieC.length]} />)}</Bar></BarChart></ResponsiveContainer>
        </div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
          <div style={{ fontSize: 10, fontWeight: 700, marginBottom: 6 }}>Distribucion por Area</div>
          <ResponsiveContainer width="100%" height={150}><PieChart><Pie data={hrDeptos.map(d => ({ name: d, value: E.filter(e => e.depto === d).length }))} cx="50%" cy="50%" innerRadius={28} outerRadius={52} dataKey="value" label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}>{hrDeptos.map((_, i) => <Cell key={i} fill={pieC[i % pieC.length]} />)}</Pie></PieChart></ResponsiveContainer>
        </div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
          <div style={{ fontSize: 10, fontWeight: 700, marginBottom: 6 }}>Antiguedad</div>
          <ResponsiveContainer width="100%" height={150}><BarChart data={antigData}><XAxis dataKey="r" tick={{ fill: P.s2, fontSize: 8 }} axisLine={false} /><YAxis hide /><Bar dataKey="v" radius={[3, 3, 0, 0]}>{antigData.map((_, i) => <Cell key={i} fill={pieC[i]} />)}</Bar></BarChart></ResponsiveContainer>
        </div>
      </G>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}><div style={{ fontSize: 11, fontWeight: 700 }}>Matriz 9-Box — Talento & Potencial</div><div style={{ display: "flex", gap: 8 }}>{[{ l: "Alto Potencial", c: P.grn }, { l: "Medio", c: P.org }, { l: "Desarrollo", c: P.red }].map(x => (<span key={x.l} style={{ fontSize: 8, color: x.c, display: "flex", alignItems: "center", gap: 3 }}><span style={{ width: 6, height: 6, borderRadius: 3, background: x.c }} />{x.l}</span>))}</div></div>
        <div style={{ position: "relative" }}>
          <ResponsiveContainer width="100%" height={200}>
            <ScatterChart margin={{ top: 10, right: 10, bottom: 5, left: 5 }}><CartesianGrid strokeDasharray="3 3" stroke={P.bd} /><XAxis type="number" dataKey="x" name="Desempeño" domain={[30, 100]} tick={{ fill: P.s2, fontSize: 8 }} label={{ value: "Desempeño →", position: "bottom", fill: P.s2, fontSize: 9 }} /><YAxis type="number" dataKey="y" name="Potencial" domain={[30, 100]} tick={{ fill: P.s2, fontSize: 8 }} label={{ value: "Potencial →", angle: -90, position: "left", fill: P.s2, fontSize: 9 }} /><ZAxis range={[120, 120]} /><Tooltip content={({ active, payload }) => active && payload?.[0] ? (<div style={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 6, padding: 8, fontSize: 9 }}><div style={{ fontWeight: 700 }}>{payload[0].payload.name}</div><div>Desempeño: {payload[0].payload.x} · Potencial: {payload[0].payload.y}</div><div style={{ color: payload[0].payload.fuga > 30 ? P.red : P.grn }}>Riesgo Fuga: {payload[0].payload.fuga}%</div></div>) : null} /><Scatter data={nineBoxData.filter(d => d.x >= 75 && d.y >= 75)} fill={P.grn} /><Scatter data={nineBoxData.filter(d => (d.x < 75 || d.y < 75) && d.x >= 60 && d.y >= 60)} fill={P.org} /><Scatter data={nineBoxData.filter(d => d.x < 60 || d.y < 60)} fill={P.red} /></ScatterChart>
          </ResponsiveContainer>
          <div style={{ position: "absolute", top: 10, left: 50, right: 10, bottom: 25, pointerEvents: "none" }}><div style={{ position: "absolute", left: "33%", top: 0, bottom: 0, borderLeft: `1px dashed ${P.bd}` }} /><div style={{ position: "absolute", left: "66%", top: 0, bottom: 0, borderLeft: `1px dashed ${P.bd}` }} /><div style={{ position: "absolute", top: "33%", left: 0, right: 0, borderTop: `1px dashed ${P.bd}` }} /><div style={{ position: "absolute", top: "66%", left: 0, right: 0, borderTop: `1px dashed ${P.bd}` }} /></div>
        </div>
      </div>
      <div style={{ background: "linear-gradient(135deg,#0A84FF08,#BF5AF208)", border: `1px solid ${P.blue}20`, borderRadius: 8, padding: 12 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 5, marginBottom: 8 }}><I.Ai /><span style={{ fontSize: 11, fontWeight: 800, background: "linear-gradient(90deg,#0A84FF,#BF5AF2)", WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent" }}>Insights IA — People Analytics</span></div>
        <G c={3}>
          {[{ t: "Prediccion Fuga", d: `${E.filter(e => nn(e.fugaRiesgo) > 30).length} colaboradores con riesgo alto de rotacion.`, c: P.red, ic: <I.Tg /> },
            { t: "Analisis Clima", d: "Sentimiento general positivo (78%). Logistica muestra stress elevado. Recomendacion: redistribuir turnos.", c: P.tl, ic: <I.Ht /> },
            { t: "Filtrado CVs", d: `${HR.postulantes.length} postulantes analizados. Ricardo Vargas tiene 91% match IA para Analista de Costos.`, c: P.pur, ic: <I.Se /> },
          ].map((x, i) => (<div key={i} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 7, padding: 10 }}><div style={{ display: "flex", alignItems: "center", gap: 4, marginBottom: 4 }}><span style={{ color: x.c }}>{x.ic}</span><span style={{ fontSize: 10, fontWeight: 700, color: x.c }}>{x.t}</span></div><div style={{ fontSize: 9, color: P.s1, lineHeight: 1.4 }}>{x.d}</div></div>))}
        </G>
      </div>
      <G c={2}>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10 }}><div style={{ fontSize: 10, fontWeight: 700, marginBottom: 6, color: P.org }}>⚠ Contratos por Vencer (90d)</div>{E.filter(e => e.vctoContrato && new Date(e.vctoContrato) <= new Date(Date.now() + 90 * 864e5)).map(e => (<div key={e.id} style={{ display: "flex", justifyContent: "space-between", padding: "3px 0", fontSize: 9, borderBottom: `1px solid ${P.bd}10` }}><span style={{ color: P.tx }}>{e.nombre}</span><span style={{ color: P.red, fontWeight: 700 }}>{e.vctoContrato}</span></div>))}</div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10 }}><div style={{ fontSize: 10, fontWeight: 700, marginBottom: 6, color: P.blue }}>📊 KPIs Criticos</div>{[{ l: "Tasa Rotacion", v: "2%", c: P.grn }, { l: "Ausentismo", v: "3.2%", c: P.org }, { l: "Hrs Extra/Prom", v: "12h", c: P.blue }, { l: "Costo/Empleado", v: $(hrTotalCosto / Math.max(hrActivos.length, 1)), c: P.pur }, { l: "Cobertura Capacitacion", v: pct(E.filter(e => nn(e.capacitaciones) > 0).length, E.length), c: P.tl }].map((x, i) => (<div key={i} style={{ display: "flex", justifyContent: "space-between", padding: "3px 0", fontSize: 9.5, borderBottom: `1px solid ${P.bd}10` }}><span style={{ color: P.s1 }}>{x.l}</span><span style={{ color: x.c, fontWeight: 700 }}>{x.v}</span></div>))}</div>
      </G>
    </div>);
  }

  function HRExpedientes() {
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <G c={4}><K l="Activos" v={hrActivos.length} icon={<I.Pp />} color={P.grn} mini /><K l="Planilla Bruta" v={$(hrTotalPlanilla)} icon={<I.Dl />} color={P.org} mini /><K l="Contratos x Vencer" v={E.filter(e => e.vctoContrato && new Date(e.vctoContrato) <= new Date(Date.now() + 90 * 864e5)).length} icon={<I.Wn />} color={P.red} mini /><K l="Riesgo Fuga Alto" v={E.filter(e => nn(e.fugaRiesgo) > 30).length} icon={<I.Tg />} color={P.pk} mini /></G>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}><span style={{ fontSize: 13, fontWeight: 700 }}>Expedientes Digitales ({E.length})</span><div style={{ display: "flex", gap: 4 }}><div style={{ display: "flex", alignItems: "center", gap: 3, background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 5, padding: "3px 7px" }}><I.Se /><input value={search} onChange={e => setSearch(e.target.value)} placeholder="Buscar..." style={{ background: "transparent", border: "none", color: P.tx, fontSize: 10, outline: "none", width: 100 }} /></div><Btn p onClick={() => { setFd({}); setMl({ type: "empleados", editing: false }); }}><I.Pl /> Nuevo</Btn></div></div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(2,1fr)", gap: 7 }}>{hrFilt(E, ["nombre", "codigo", "cargo", "depto"]).map(e => { const n = calcNomina(e); return (<div key={e.id} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12, cursor: "pointer" }} onClick={() => { setFd({ ...e }); setMl({ type: "empleados", editing: true, id: e.id }); }} onMouseEnter={ev => ev.currentTarget.style.borderColor = P.blue + "40"} onMouseLeave={ev => ev.currentTarget.style.borderColor = P.bd}>
        <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 6 }}><div style={{ display: "flex", alignItems: "center", gap: 7 }}><div style={{ width: 32, height: 32, borderRadius: 7, background: `linear-gradient(135deg,${P.blue}30,${P.pur}30)`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 11, fontWeight: 800, color: P.tx }}>{e.nombre.split(" ").map(w => w[0]).slice(0, 2).join("")}</div><div><div style={{ fontSize: 11, fontWeight: 700 }}>{e.nombre}</div><div style={{ fontSize: 8.5, color: P.s2 }}>{e.codigo} · {e.cargo}</div></div></div><Badge s={e.estado} /></div>
        <div style={{ display: "flex", justifyContent: "space-between", fontSize: 9, color: P.s1, marginBottom: 5 }}><span>{e.depto}</span><span>{e.contrato}{e.vctoContrato ? ` → ${e.vctoContrato}` : ""}</span></div>
        <div style={{ display: "flex", gap: 8, fontSize: 8.5 }}><span style={{ color: P.org }}>Bruto: {$(n.bruto)}</span><span style={{ color: P.grn }}>Neto: {$(n.neto)}</span><span style={{ color: nn(e.fugaRiesgo) > 30 ? P.red : P.s2 }}>Fuga: {e.fugaRiesgo}%</span><span style={{ color: P.blue }}>9Box: {e.nineBox}</span></div>
        <div style={{ marginTop: 5 }}><ProgressBar value={nn(e.desempeno)} max={100} color={nn(e.desempeno) > 75 ? P.grn : nn(e.desempeno) > 60 ? P.org : P.red} label="Desempeño" /></div>
      </div>); })}</div>
    </div>);
  }

  function HRATS() {
    const R = HR.requisiciones, Pos = HR.postulantes;
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <G c={4}><K l="Requisiciones" v={R.length} icon={<I.Us />} color={P.blue} mini /><K l="Abiertas" v={R.filter(r => r.estado === "Abierta").length} icon={<I.Gd />} color={P.org} mini /><K l="Postulantes" v={Pos.length} icon={<I.Pp />} color={P.pur} mini /><K l="Finalistas" v={Pos.filter(p => p.estado === "Finalista").length} icon={<I.St />} color={P.grn} mini /></G>
      <div style={{ fontSize: 12, fontWeight: 700 }}>Pipeline Reclutamiento</div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(5,1fr)", gap: 6 }}>{[{ s: "Postulante", c: P.s2 }, { s: "Entrevista", c: P.blue }, { s: "Finalista", c: P.pur }, { s: "Contratado", c: P.grn }, { s: "Descartado", c: P.red }].map(st => (<div key={st.s} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 7, overflow: "hidden" }}><div style={{ padding: "6px 8px", borderBottom: `2px solid ${st.c}`, display: "flex", justifyContent: "space-between" }}><span style={{ fontSize: 9, fontWeight: 700, color: st.c }}>{st.s}</span><Badge s={String(Pos.filter(p => p.estado === st.s).length)} c={st.c} /></div><div style={{ padding: 6, display: "flex", flexDirection: "column", gap: 4, minHeight: 80 }}>{Pos.filter(p => p.estado === st.s).map(p => (<div key={p.id} style={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 5, padding: 7 }}><div style={{ fontSize: 10, fontWeight: 600 }}>{p.nombre}</div><div style={{ fontSize: 8, color: P.s2 }}>{p.puesto}</div><div style={{ display: "flex", gap: 4, marginTop: 3 }}><Badge s={`CV:${p.cv}`} c={p.cv > 80 ? P.grn : P.org} /><Badge s={`IA:${p.iaMatch}%`} c={p.iaMatch > 80 ? P.grn : P.org} /></div></div>))}</div></div>))}</div>
      <div style={{ fontSize: 12, fontWeight: 700, marginTop: 4 }}>Requisiciones</div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Codigo", "Puesto", "Depto", "Presupuesto", "Prioridad", "Postulantes", "Estado"].map(h => (<th key={h} style={{ padding: "5px 7px", color: P.s2, fontSize: 8, fontWeight: 700, borderBottom: `1px solid ${P.bd}`, textAlign: "left", textTransform: "uppercase" }}>{h}</th>))}</tr></thead><tbody>{R.map(r => (<tr key={r.id} style={{ borderBottom: "1px solid #0c1320" }}><td style={{ padding: "5px 7px", color: P.cyan, fontSize: 10, fontFamily: "monospace", fontWeight: 600 }}>{r.codigo}</td><td style={{ padding: "5px 7px", fontSize: 10, fontWeight: 600 }}>{r.puesto}</td><td style={{ padding: "5px 7px", fontSize: 10, color: P.s1 }}>{r.depto}</td><td style={{ padding: "5px 7px", fontSize: 10, fontWeight: 600 }}>{$(r.presupuesto)}</td><td style={{ padding: "5px 7px" }}><Badge s={r.prioridad} /></td><td style={{ padding: "5px 7px", fontSize: 10 }}>{r.postulantes} <span style={{ color: P.pur }}>({r.finalistas} fin.)</span></td><td style={{ padding: "5px 7px" }}><Badge s={r.estado} /></td></tr>))}</tbody></table></div>
    </div>);
  }

  function HRNomina() {
    const rows = hrActivos.map(e => ({ ...e, ...calcNomina(e) }));
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <G c={4}><K l="Planilla Bruta" v={$(hrTotalPlanilla)} icon={<I.Dl />} color={P.org} mini /><K l="Neto a Pagar" v={$(hrTotalNeto)} icon={<I.Bk />} color={P.grn} mini /><K l="Costo Total Empresa" v={$(hrTotalCosto)} icon={<I.Cd />} color={P.red} mini /><K l="EsSalud 9%" v={$(hrActivos.reduce((a, e) => a + nn(e.sueldo) * .09, 0))} icon={<I.Ht />} color={P.blue} mini /></G>
      <div style={{ fontSize: 12, fontWeight: 700 }}>Motor de Nomina — Feb 2026</div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}><div style={{ overflowX: "auto" }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Codigo", "Nombre", "Basico", "Asignac.", "Bonos", "Bruto", "AFP/ONP", "5ta Cat", "Deducciones", "Neto", "EsSalud", "CTS Prov"].map(h => (<th key={h} style={{ padding: "5px 6px", color: P.s2, fontSize: 7.5, fontWeight: 700, borderBottom: `1px solid ${P.bd}`, textAlign: h === "Codigo" || h === "Nombre" ? "left" : "right", textTransform: "uppercase", whiteSpace: "nowrap" }}>{h}</th>))}</tr></thead>
      <tbody>{rows.map(r => (<tr key={r.id} style={{ borderBottom: "1px solid #0c1320" }} onMouseEnter={e => e.currentTarget.style.background = P.hv} onMouseLeave={e => e.currentTarget.style.background = "transparent"}><td style={{ padding: "4px 6px", color: P.cyan, fontSize: 9.5, fontFamily: "monospace", fontWeight: 600 }}>{r.codigo}</td><td style={{ padding: "4px 6px", fontSize: 9.5, fontWeight: 600, maxWidth: 130, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{r.nombre}</td><td style={{ padding: "4px 6px", fontSize: 9.5, textAlign: "right" }}>{$(r.sueldo)}</td><td style={{ padding: "4px 6px", fontSize: 9.5, textAlign: "right" }}>{$(r.asignacion)}</td><td style={{ padding: "4px 6px", fontSize: 9.5, textAlign: "right" }}>{$(r.bonos)}</td><td style={{ padding: "4px 6px", fontSize: 9.5, textAlign: "right", fontWeight: 700, color: P.org }}>{$(r.bruto)}</td><td style={{ padding: "4px 6px", fontSize: 9.5, textAlign: "right", color: P.red }}>{$(r.cuspp ? r.afp : r.onp)}</td><td style={{ padding: "4px 6px", fontSize: 9.5, textAlign: "right", color: P.red }}>{$(r.retQuinta)}</td><td style={{ padding: "4px 6px", fontSize: 9.5, textAlign: "right", color: P.red, fontWeight: 600 }}>{$(r.totalDeducciones)}</td><td style={{ padding: "4px 6px", fontSize: 10, textAlign: "right", fontWeight: 800, color: P.grn }}>{$(r.neto)}</td><td style={{ padding: "4px 6px", fontSize: 9.5, textAlign: "right", color: P.blue }}>{$(r.essalud)}</td><td style={{ padding: "4px 6px", fontSize: 9.5, textAlign: "right", color: P.pur }}>{$(r.cts)}</td></tr>))}</tbody>
      <tfoot><tr style={{ borderTop: `2px solid ${P.bd}` }}><td colSpan={5} style={{ padding: "5px 6px", fontSize: 10, fontWeight: 800 }}>TOTALES</td><td style={{ padding: "5px 6px", fontSize: 10, textAlign: "right", fontWeight: 800, color: P.org }}>{$(rows.reduce((a, r) => a + r.bruto, 0))}</td><td colSpan={2}></td><td style={{ padding: "5px 6px", fontSize: 10, textAlign: "right", fontWeight: 800, color: P.red }}>{$(rows.reduce((a, r) => a + r.totalDeducciones, 0))}</td><td style={{ padding: "5px 6px", fontSize: 10, textAlign: "right", fontWeight: 800, color: P.grn }}>{$(rows.reduce((a, r) => a + r.neto, 0))}</td><td style={{ padding: "5px 6px", fontSize: 10, textAlign: "right", fontWeight: 800, color: P.blue }}>{$(rows.reduce((a, r) => a + r.essalud, 0))}</td><td style={{ padding: "5px 6px", fontSize: 10, textAlign: "right", fontWeight: 800, color: P.pur }}>{$(rows.reduce((a, r) => a + r.cts, 0))}</td></tr></tfoot></table></div></div>
      <div style={{ fontSize: 12, fontWeight: 700, marginTop: 4 }}>Prestamos Activos</div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(2,1fr)", gap: 6 }}>{HR.prestamos.map(p => (<div key={p.id} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 7, padding: 10 }}><div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}><span style={{ fontSize: 10, fontWeight: 700 }}>{p.nombre}</span><Badge s={p.estado} /></div><div style={{ fontSize: 9, color: P.s2 }}>Monto: {$(p.monto)} · Cuota: {$(p.cuotaMes)} · Saldo: {$(p.saldo)}</div><ProgressBar value={p.pagadas} max={p.cuotas} color={P.blue} label={`${p.pagadas}/${p.cuotas}`} /></div>))}</div>
    </div>);
  }

  function HRAsistencia() {
    const A = HR.asistencia;
    const presentes = A.filter(a => a.estado === "Presente").length;
    const totalHE = A.reduce((a, r) => a + nn(r.extra), 0);
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <G c={4}><K l="Presentes Hoy" v={`${presentes}/${A.length}`} icon={<I.Cr />} color={P.grn} mini /><K l="Tardanzas" v={A.filter(a => a.estado === "Tardanza").length} icon={<I.Wn />} color={P.org} mini /><K l="Ausencias" v={A.filter(a => a.estado === "Ausente" || a.estado === "Permiso" || a.estado === "Falta").length} icon={<I.Tg />} color={P.red} mini /><K l="Hrs Extra" v={`${totalHE.toFixed(1)}h`} icon={<I.Cr />} color={P.blue} mini /></G>
      <div style={{ fontSize: 12, fontWeight: 700 }}>Control de Asistencia — {today()}</div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Codigo", "Nombre", "Turno", "Entrada", "Salida", "Horas", "H.Extra", "Estado"].map(h => (<th key={h} style={{ padding: "5px 7px", color: P.s2, fontSize: 8, fontWeight: 700, borderBottom: `1px solid ${P.bd}`, textAlign: "left", textTransform: "uppercase" }}>{h}</th>))}</tr></thead><tbody>{A.map(r => (<tr key={r.id} style={{ borderBottom: "1px solid #0c1320" }}><td style={{ padding: "5px 7px", color: P.cyan, fontSize: 10, fontFamily: "monospace" }}>{r.emp}</td><td style={{ padding: "5px 7px", fontSize: 10, fontWeight: 600 }}>{r.nombre}</td><td style={{ padding: "5px 7px" }}><Badge s={r.turno} c={r.turno === "Rotativo" ? P.pur : P.blue} /></td><td style={{ padding: "5px 7px", fontSize: 10, fontFamily: "monospace", color: r.entrada ? P.grn : P.s2 }}>{r.entrada || "—"}</td><td style={{ padding: "5px 7px", fontSize: 10, fontFamily: "monospace", color: r.salida ? P.tx : P.s2 }}>{r.salida || "—"}</td><td style={{ padding: "5px 7px", fontSize: 10, fontWeight: 600 }}>{r.horas > 0 ? `${r.horas}h` : "—"}</td><td style={{ padding: "5px 7px", fontSize: 10, color: r.extra > 0 ? P.org : P.s2, fontWeight: 600 }}>{r.extra > 0 ? `+${r.extra}h` : "—"}</td><td style={{ padding: "5px 7px" }}><Badge s={r.estado} /></td></tr>))}</tbody></table></div>
      <div style={{ fontSize: 12, fontWeight: 700, marginTop: 4 }}>Vacaciones & Permisos</div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(2,1fr)", gap: 6 }}>{HR.vacaciones.map(v => (<div key={v.id} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 7, padding: 10, display: "flex", justifyContent: "space-between", alignItems: "center" }}><div><div style={{ fontSize: 10, fontWeight: 700 }}>{v.nombre}</div><div style={{ fontSize: 9, color: P.s2 }}>{v.desde} → {v.hasta} · {v.dias} dias</div></div><Badge s={v.estado} /></div>))}</div>
    </div>);
  }

  function HRTalento() {
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <G c={4}><K l="Capacitaciones" v={HR.capacitaciones.length} icon={<I.Aw />} color={P.pur} mini /><K l="Horas LMS" v={`${HR.capacitaciones.reduce((a, c) => a + nn(c.horas), 0)}h`} icon={<I.Cr />} color={P.blue} mini /><K l="Inversion" v={$(HR.capacitaciones.reduce((a, c) => a + nn(c.costo), 0))} icon={<I.Dl />} color={P.org} mini /><K l="Eval. Promedio" v={(E.reduce((a, e) => a + nn(e.evalScore), 0) / E.length).toFixed(1)} icon={<I.St />} color={P.grn} mini /></G>
      <div style={{ fontSize: 12, fontWeight: 700 }}>Evaluacion 360° — Competencias</div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}><ResponsiveContainer width="100%" height={180}><RadarChart data={[{ s: "Liderazgo", a: 85, b: 70 }, { s: "Tecnico", a: 78, b: 82 }, { s: "Comunicacion", a: 72, b: 75 }, { s: "Trabajo Equipo", a: 88, b: 68 }, { s: "Innovacion", a: 65, b: 72 }, { s: "Orientacion Resultado", a: 90, b: 78 }]}><PolarGrid stroke={P.bd} /><PolarAngleAxis dataKey="s" tick={{ fill: P.s2, fontSize: 8 }} /><PolarRadiusAxis tick={false} domain={[0, 100]} /><Radar dataKey="a" stroke={P.blue} fill={P.blue} fillOpacity={.2} strokeWidth={2} name="Promedio Empresa" /><Radar dataKey="b" stroke={P.pur} fill={P.pur} fillOpacity={.1} strokeWidth={2} name="Benchmark" /><Legend wrapperStyle={{ fontSize: 9 }} /></RadarChart></ResponsiveContainer></div>
      <div style={{ fontSize: 12, fontWeight: 700 }}>Programa de Capacitacion (LMS)</div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(2,1fr)", gap: 6 }}>{HR.capacitaciones.map(c => (<div key={c.id} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 7, padding: 10 }}><div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}><span style={{ fontSize: 10, fontWeight: 700 }}>{c.nombre}</span><Badge s={c.estado} /></div><div style={{ fontSize: 9, color: P.s2 }}>{c.instructor} · {c.horas}h · {c.participantes} part.</div><div style={{ fontSize: 9, color: P.s1, marginTop: 2 }}>{c.inicio} → {c.fin}{c.costo > 0 ? ` · ${$(c.costo)}` : " · Gratis"}</div><Badge s={c.tipo} c={c.tipo === "Interna" ? P.tl : P.pur} /></div>))}</div>
      <div style={{ fontSize: 12, fontWeight: 700, marginTop: 4 }}>Plan de Sucesion — Puestos Criticos</div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(3,1fr)", gap: 6 }}>{[{ puesto: "Gerente General", titular: "Carlos Mendoza", sucesor1: "Maria Torres (85%)", sucesor2: "Luis Paredes (72%)", riesgo: "Bajo" }, { puesto: "Jefe Importaciones", titular: "Maria Torres", sucesor1: "Pedro Rios (62%)", sucesor2: "Sin candidato", riesgo: "Alto" }, { puesto: "Contador General", titular: "Luis Paredes", sucesor1: "Carmen Vargas (58%)", sucesor2: "Ext: Diana Lopez", riesgo: "Medio" }].map((s, i) => (<div key={i} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 7, padding: 10 }}><div style={{ fontSize: 10, fontWeight: 700, marginBottom: 3 }}>{s.puesto}</div><div style={{ fontSize: 9, color: P.blue }}>Titular: {s.titular}</div><div style={{ fontSize: 9, color: P.grn }}>1ro: {s.sucesor1}</div><div style={{ fontSize: 9, color: P.org }}>2do: {s.sucesor2}</div><Badge s={`Riesgo: ${s.riesgo}`} c={s.riesgo === "Alto" ? P.red : s.riesgo === "Medio" ? P.org : P.grn} /></div>))}</div>
    </div>);
  }

  function HRESS() {
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div style={{ fontSize: 13, fontWeight: 800 }}>Portal de Autoservicio (ESS/MSS)</div>
      <G c={3}>{[{ l: "Mis Boletas", d: "Descarga boletas de pago", ic: <I.Gd />, c: P.blue, n: "12 disponibles" }, { l: "Solicitar Vacaciones", d: "Enviar solicitud de descanso", ic: <I.Cr />, c: P.grn, n: "15 dias disponibles" }, { l: "Constancias", d: "Trabajo, ingreso, CTS", ic: <I.Cl />, c: P.pur, n: "Auto-generacion" }, { l: "Actualizar Datos", d: "Direccion, banco, emergencia", ic: <I.Ed />, c: P.org, n: "Ultima act: hace 30d" }, { l: "Mis Capacitaciones", d: "Cursos asignados y certificados", ic: <I.Aw />, c: P.tl, n: "2 pendientes" }, { l: "Evaluacion", d: "360° y objetivos", ic: <I.St />, c: P.pk, n: "Periodo abierto" }].map((x, i) => (<div key={i} onClick={() => notify(`${x.l}: Funcionalidad ESS activa`)} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 14, cursor: "pointer" }} onMouseEnter={e => e.currentTarget.style.borderColor = x.c + "40"} onMouseLeave={e => e.currentTarget.style.borderColor = P.bd}><div style={{ display: "flex", alignItems: "center", gap: 7, marginBottom: 5 }}><span style={{ color: x.c }}>{x.ic}</span><span style={{ fontSize: 12, fontWeight: 700 }}>{x.l}</span></div><div style={{ fontSize: 9, color: P.s2 }}>{x.d}</div><div style={{ fontSize: 9, color: x.c, fontWeight: 600, marginTop: 3 }}>{x.n}</div></div>))}</G>
      <div style={{ fontSize: 12, fontWeight: 700, marginTop: 4 }}>Solicitudes Recientes</div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Empleado", "Tipo Solicitud", "Fecha", "Estado"].map(h => (<th key={h} style={{ padding: "5px 7px", color: P.s2, fontSize: 8, fontWeight: 700, borderBottom: `1px solid ${P.bd}`, textAlign: "left" }}>{h}</th>))}</tr></thead><tbody>{HR.solicitudesESS.map(s => (<tr key={s.id} style={{ borderBottom: "1px solid #0c1320" }}><td style={{ padding: "5px 7px", fontSize: 10, fontWeight: 600 }}>{s.nombre}</td><td style={{ padding: "5px 7px", fontSize: 10, color: P.s1 }}>{s.tipo}</td><td style={{ padding: "5px 7px", fontSize: 10, color: P.s2 }}>{s.fecha}</td><td style={{ padding: "5px 7px" }}><Badge s={s.estado} /></td></tr>))}</tbody></table></div>
    </div>);
  }

  function HRView() {
    const hrContent = () => { switch (hrTab) { case "dashboard": return <HRDash />; case "expedientes": return <HRExpedientes />; case "ats": return <HRATS />; case "nomina": return <HRNomina />; case "asistencia": return <HRAsistencia />; case "talento": return <HRTalento />; case "ess": return <HRESS />; default: return <HRDash />; } };
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}><span style={{ fontSize: 14, fontWeight: 800 }}>RRHH Integral</span><Tabs tabs={HR_TABS} active={hrTab} onChange={setHrTab} /></div>
      </div>
      {hrContent()}
      <Modal open={!!ml && ml.type === "empleados"} onClose={hrCloseMl} title={ml ? `${ml.editing ? "Editar" : "Nuevo"} Colaborador` : ""} xwide>
        {ml && ml.type === "empleados" && (<div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
          <div style={{ fontSize: 10, fontWeight: 700, color: P.blue }}>DATOS PERSONALES</div>
          <G c={3}><Inp l="Codigo" v={fv("codigo")} onChange={v => sf("codigo", v)} req /><Inp l="Nombre Completo" v={fv("nombre")} onChange={v => sf("nombre", v)} req /><Inp l="Tipo Doc" v={fv("tipoDoc", "DNI")} onChange={v => sf("tipoDoc", v)} opts={["DNI", "CE", "Pasaporte"]} /></G>
          <G c={3}><Inp l="Num Doc" v={fv("numDoc")} onChange={v => sf("numDoc", v)} /><Inp l="Email" v={fv("email")} onChange={v => sf("email", v)} /><Inp l="Telefono" v={fv("telefono")} onChange={v => sf("telefono", v)} /></G>
          <div style={{ fontSize: 10, fontWeight: 700, color: P.pur }}>ORGANIZACION</div>
          <G c={3}><Inp l="Cargo" v={fv("cargo")} onChange={v => sf("cargo", v)} /><Inp l="Departamento" v={fv("depto")} onChange={v => sf("depto", v)} opts={["Direccion", "Contabilidad", "Logistica", "Ventas", "RRHH", "TI", "Operaciones"]} /><Inp l="Centro Costo" v={fv("cc")} onChange={v => sf("cc", v)} opts={["CC-100", "CC-200", "CC-300", "CC-400", "CC-500", "CC-600"]} /></G>
          <G c={3}><Inp l="Supervisor" v={fv("supervisor")} onChange={v => sf("supervisor", v)} /><Inp l="Turno" v={fv("turno", "Administrativo")} onChange={v => sf("turno", v)} opts={["Administrativo", "Rotativo", "Nocturno"]} /><Inp l="Estado" v={fv("estado", "Activo")} onChange={v => sf("estado", v)} opts={["Activo", "Periodo Prueba", "Vacaciones", "Licencia", "Cesado"]} /></G>
          <div style={{ fontSize: 10, fontWeight: 700, color: P.org }}>CONTRATO & COMPENSACION</div>
          <G c={3}><Inp l="Tipo Contrato" v={fv("contrato", "Plazo Fijo")} onChange={v => sf("contrato", v)} opts={["Indefinido", "Plazo Fijo", "Tiempo Parcial", "Practicas"]} /><Inp l="F. Ingreso" v={fv("ingreso")} onChange={v => sf("ingreso", v)} type="date" /><Inp l="Vcto Contrato" v={fv("vctoContrato")} onChange={v => sf("vctoContrato", v)} type="date" /></G>
          <G c={4}><Inp l="Sueldo Basico" v={fv("sueldo")} onChange={v => sf("sueldo", v)} type="number" req /><Inp l="Asignacion Fam." v={fv("asignacion")} onChange={v => sf("asignacion", v)} type="number" /><Inp l="Bonos" v={fv("bonos")} onChange={v => sf("bonos", v)} type="number" /><Inp l="Riesgo SCTR" v={fv("riesgo", "0")} onChange={v => sf("riesgo", v)} opts={["0", "1", "2"]} /></G>
          <div style={{ fontSize: 10, fontWeight: 700, color: P.grn }}>DATOS BANCARIOS & PREVISION</div>
          <G c={3}><Inp l="Banco" v={fv("banco")} onChange={v => sf("banco", v)} opts={["BCP", "BBVA", "Interbank", "Scotiabank"]} /><Inp l="N° Cuenta" v={fv("cuentaBanco")} onChange={v => sf("cuentaBanco", v)} /><Inp l="CUSPP (AFP)" v={fv("cuspp")} onChange={v => sf("cuspp", v)} /></G>
          <div style={{ fontSize: 10, fontWeight: 700, color: P.tl }}>DESARROLLO & EVALUACION</div>
          <G c={3}><Inp l="Competencias" v={fv("competencias")} onChange={v => sf("competencias", v)} ph="Liderazgo,Excel..." /><Inp l="Desempeño (0-100)" v={fv("desempeno")} onChange={v => sf("desempeno", v)} type="number" /><Inp l="Potencial (0-100)" v={fv("potencial")} onChange={v => sf("potencial", v)} type="number" /></G>
          <G c={3}><Inp l="Riesgo Fuga %" v={fv("fugaRiesgo")} onChange={v => sf("fugaRiesgo", v)} type="number" /><Inp l="9-Box" v={fv("nineBox")} onChange={v => sf("nineBox", v)} opts={["HH", "HM", "HL", "MH", "MM", "ML", "LH", "LM", "LL"]} /><Inp l="Score Eval" v={fv("evalScore")} onChange={v => sf("evalScore", v)} type="number" /></G>
        </div>)}
        <div style={{ display: "flex", gap: 6, justifyContent: "flex-end", marginTop: 12, paddingTop: 8, borderTop: `1px solid ${P.bd}` }}>
          {ml?.editing && <Btn d onClick={() => { hrDel("empleados", ml.id); hrCloseMl(); }}><I.Tr /> Eliminar</Btn>}
          <Btn onClick={hrCloseMl}>Cancelar</Btn>
          <Btn p onClick={hrSaveMl}><I.Ck /> Guardar</Btn>
        </div>
      </Modal>
    </div>);
  }

  /* ===== ALMACEN MRPII MODULE ===== */
  const INV_TABS = [
    { id: "dashboard", l: "Dashboard", icon: <I.Da /> },
    { id: "mrp", l: "Explosion MRP", icon: <I.Br /> },
    { id: "mps", l: "Plan Maestro", icon: <I.Cr /> },
    { id: "stock", l: "Inventario", icon: <I.Bx /> },
    { id: "kardex", l: "Kardex SUNAT", icon: <I.Gd /> },
    { id: "recepciones", l: "Recepciones/PPI", icon: <I.Cl /> },
    { id: "requisiciones", l: "Requisiciones", icon: <I.Sa /> },
    { id: "equipos", l: "Equipos/Mto", icon: <I.Ed /> },
    { id: "panol", l: "Pañol", icon: <I.Ky /> },
    { id: "mermas", l: "Mermas", icon: <I.Wn /> },
  ];
  const tS = { padding: "5px 7px", fontSize: 10, borderBottom: `1px solid ${P.bd}10` };
  const thS = { ...tS, color: P.s2, fontSize: 8, fontWeight: 700, textAlign: "left", textTransform: "uppercase" };
  const MBadge = ({ s }) => <span style={{ display: "inline-flex", padding: "1px 6px", borderRadius: 4, fontSize: 9, fontWeight: 600, background: mrpColor(s) + "15", color: mrpColor(s), border: `1px solid ${mrpColor(s)}30` }}>{mrpBadge(s)}</span>;
  const MKpi = ({ l, v, u = "%", meta, inv, icon }) => { const ok = inv ? v <= meta : v >= meta; const pc = Math.min(100, inv ? (meta / v) * 100 : (v / meta) * 100); return (<div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10 }}><div style={{ display: "flex", justifyContent: "space-between", marginBottom: 5 }}><span style={{ fontSize: 8, color: P.s2, textTransform: "uppercase", letterSpacing: .5 }}>{l}</span>{icon}</div><div style={{ display: "flex", alignItems: "baseline", gap: 4, marginBottom: 5 }}><span style={{ fontSize: 18, fontWeight: 800, color: ok ? P.grn : P.org }}>{typeof v === "number" ? fmtN(v, v % 1 === 0 ? 0 : 1) : v}</span><span style={{ fontSize: 9, color: P.s2 }}>{u}</span></div><div style={{ width: "100%", height: 4, background: P.bd, borderRadius: 2, overflow: "hidden" }}><div style={{ height: "100%", borderRadius: 2, background: ok ? P.grn : P.org, width: `${pc}%`, transition: "width .5s" }} /></div><div style={{ display: "flex", justifyContent: "space-between", marginTop: 3 }}><span style={{ fontSize: 8, color: P.s2 }}>Meta: {meta}{u}</span><span style={{ fontSize: 8, fontWeight: 600, color: ok ? P.grn : P.org }}>{ok ? "✓ Cumple" : "⚠ Pendiente"}</span></div></div>); };

  const selectedObra = OBRAS_MRP[0];

  function INVDash() {
    return (<div style={{ display: "flex", flexDirection: "column", gap: 9 }}>
      <div style={{ fontSize: 13, fontWeight: 800 }}>Dashboard Almacen MRPII — {selectedObra.nombre}</div>
      <div style={{ display: "flex", gap: 6, fontSize: 9, color: P.s1, flexWrap: "wrap" }}>
        <span>Obra: <b style={{ color: P.tx }}>{selectedObra.codigo}</b></span><span>Ubicacion: {selectedObra.ubicacion}</span><span>Presupuesto: <b style={{ color: P.org }}>{$(selectedObra.presupuesto_base)}</b></span>
        <span style={{ display: "flex", alignItems: "center", gap: 4 }}>Avance: <span style={{ width: 50, height: 4, background: P.bd, borderRadius: 2, overflow: "hidden", display: "inline-block" }}><span style={{ display: "block", height: "100%", background: P.blue, borderRadius: 2, width: `${selectedObra.avance_pct}%` }} /></span><b style={{ color: P.blue }}>{selectedObra.avance_pct}%</b></span>
      </div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(5,1fr)", gap: 5 }}>
        <MKpi l="Rotacion Inventario" v={KPI_MRP.rotacion} meta={KPI_MRP.meta_rotacion} u=" rot/mes" />
        <MKpi l="Quiebre Stock" v={KPI_MRP.quiebre} meta={KPI_MRP.meta_quiebre} u="%" inv />
        <MKpi l="Exactitud Inventario" v={KPI_MRP.exactitud} meta={KPI_MRP.meta_exactitud} u="%" />
        <MKpi l="Cumpl. PPI" v={KPI_MRP.ppi_cumpl} meta={KPI_MRP.meta_ppi} u="%" />
        <MKpi l="Merma Global" v={KPI_MRP.merma_global} meta={KPI_MRP.meta_merma} u="%" inv />
        <MKpi l="Tasa Rechazo" v={KPI_MRP.tasa_rechazo} meta={KPI_MRP.meta_rechazo} u="%" inv />
        <MKpi l="Dispon. Equipos" v={KPI_MRP.disponib_equip} meta={KPI_MRP.meta_disp} u="%" />
        <MKpi l="Retorno Herram." v={KPI_MRP.retorno_herr} meta={KPI_MRP.meta_retorno} u="%" />
        <MKpi l="Dias Stock" v={KPI_MRP.dias_stock} meta={11} u=" dias" />
        <MKpi l="Valorizacion" v={fmtN(mrpVal, 0)} meta="" u="" />
      </div>
      <G c={3}>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10 }}>
          <div style={{ display: "flex", alignItems: "center", gap: 5, marginBottom: 6 }}><span style={{ width: 24, height: 24, borderRadius: 6, background: P.red + "15", display: "flex", alignItems: "center", justifyContent: "center", color: P.red }}><I.Wn /></span><span style={{ fontSize: 11, fontWeight: 600 }}>Alertas Activas</span></div>
          <div style={{ display: "flex", flexDirection: "column", gap: 4, fontSize: 9 }}>
            {[{ m: "Mixer #3 — Mantenimiento VENCIDO (-10 HM)", c: P.red }, { m: "2 herramientas sin devolucion (+24h)", c: P.org }, { m: "Merma anormal: Acero ø3/8\" en 06.01.01", c: P.org }, { m: "MRP: 4 requisiciones automaticas generadas", c: P.blue }].map((a, i) => (<div key={i} style={{ display: "flex", alignItems: "center", gap: 5, padding: "4px 7px", borderRadius: 5, background: a.c + "08", border: `1px solid ${a.c}15` }}><span style={{ width: 5, height: 5, borderRadius: 3, background: a.c }} /><span style={{ color: a.c }}>{a.m}</span></div>))}
          </div>
        </div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10 }}>
          <div style={{ display: "flex", alignItems: "center", gap: 5, marginBottom: 6 }}><span style={{ width: 24, height: 24, borderRadius: 6, background: P.blue + "15", display: "flex", alignItems: "center", justifyContent: "center", color: P.blue }}><I.Sa /></span><span style={{ fontSize: 11, fontWeight: 600 }}>Recepciones Recientes</span></div>
          <div style={{ display: "flex", flexDirection: "column", gap: 4, fontSize: 9 }}>{RECEPCIONES_MRP.filter(r => r.fecha >= "2026-02-10").map((r, i) => (<div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "4px 7px", borderRadius: 5, background: P.c2, border: `1px solid ${P.bd}` }}><span>{r.insumo} <span style={{ color: P.s2 }}>({fmtI(r.cantidad)} {r.unidad})</span></span><MBadge s={r.estado_ppi} /></div>))}</div>
        </div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10 }}>
          <div style={{ display: "flex", alignItems: "center", gap: 5, marginBottom: 6 }}><span style={{ width: 24, height: 24, borderRadius: 6, background: P.grn + "15", display: "flex", alignItems: "center", justifyContent: "center", color: P.grn }}><I.Cd /></span><span style={{ fontSize: 11, fontWeight: 600 }}>Valorizacion Almacen</span></div>
          <div style={{ fontSize: 17, fontWeight: 800, marginBottom: 6 }}>{$(mrpVal)}</div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6, fontSize: 9 }}><div><div style={{ color: P.s2, textTransform: "uppercase", fontSize: 8 }}>Materiales</div><div style={{ fontWeight: 700 }}>S/ 132,450</div></div><div><div style={{ color: P.s2, textTransform: "uppercase", fontSize: 8 }}>Herramientas</div><div style={{ fontWeight: 700 }}>S/ 15,786</div></div></div>
          <div style={{ height: 5, background: P.bd, borderRadius: 3, overflow: "hidden", display: "flex", marginTop: 6 }}><div style={{ width: "89.3%", background: P.blue + "70", height: "100%" }} /><div style={{ width: "10.7%", background: P.pur + "70", height: "100%" }} /></div>
          <div style={{ display: "flex", gap: 10, fontSize: 8, marginTop: 4 }}><span style={{ display: "flex", alignItems: "center", gap: 3 }}><span style={{ width: 6, height: 6, borderRadius: 2, background: P.blue + "70" }} />Materiales 89.3%</span><span style={{ display: "flex", alignItems: "center", gap: 3 }}><span style={{ width: 6, height: 6, borderRadius: 2, background: P.pur + "70" }} />Herramientas 10.7%</span></div>
        </div>
      </G>
    </div>);
  }

  function INVMrp() {
    const compras = EXPLOSION_MRP.filter(e => e.accion === "COMPRA");
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div><div style={{ fontSize: 12, fontWeight: 700 }}>Explosion MRP — Plan de Necesidades de Materiales</div><div style={{ fontSize: 9, color: P.s2, marginTop: 2 }}>Demanda bruta = APU × Metrado Programado × Factor Desperdicio</div></div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Periodo", "Insumo", "Und", "Dem.Bruta", "Stock", "En Transito", "Nec.Neta", "Accion"].map(h => <th key={h} style={{ ...thS, textAlign: h === "Dem.Bruta" || h === "Stock" || h === "En Transito" || h === "Nec.Neta" ? "right" : "left" }}>{h}</th>)}</tr></thead>
      <tbody>{EXPLOSION_MRP.map((r, i) => (<tr key={i} style={{ borderBottom: `1px solid ${P.bd}10` }} onMouseEnter={e => e.currentTarget.style.background = P.hv} onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
        <td style={{ ...tS, color: P.cyan, fontFamily: "monospace", fontSize: 9, fontWeight: 600 }}>{r.periodo}</td>
        <td style={tS}>{r.insumo}</td>
        <td style={{ ...tS, color: P.s2 }}>{r.unidad}</td>
        <td style={{ ...tS, textAlign: "right", fontWeight: 600 }}>{fmtN(r.demanda_bruta)}</td>
        <td style={{ ...tS, textAlign: "right" }}>{fmtN(r.stock)}</td>
        <td style={{ ...tS, textAlign: "right", color: r.en_transito > 0 ? P.blue : P.s2 }}>{r.en_transito > 0 ? fmtN(r.en_transito) : "—"}</td>
        <td style={{ ...tS, textAlign: "right", fontWeight: 700, color: r.necesidad_neta > 0 ? P.red : P.grn }}>{r.necesidad_neta > 0 ? fmtN(r.necesidad_neta) : "0"}</td>
        <td style={tS}><MBadge s={r.accion} /></td>
      </tr>))}</tbody></table></div>
      <div style={{ background: P.c1, border: `1px solid ${P.org}20`, borderRadius: 8, padding: 10, display: "flex", gap: 8, alignItems: "flex-start" }}>
        <span style={{ color: P.org, marginTop: 2 }}><I.Wn /></span>
        <div style={{ fontSize: 9, color: P.s1 }}><span style={{ color: P.org, fontWeight: 700 }}>Resumen MRP:</span> Se requieren <span style={{ color: P.red, fontWeight: 700 }}>{compras.length} compras</span> para cubrir necesidades netas. Horizonte: 4 semanas. Lead time promedio: 5 dias habiles.</div>
      </div>
    </div>);
  }

  function INVMps() {
    const colors = [P.blue, P.grn, P.org, P.pur, P.pk, P.tl];
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div><div style={{ fontSize: 12, fontWeight: 700 }}>Plan Maestro de Produccion (MPS)</div><div style={{ fontSize: 9, color: P.s2, marginTop: 2 }}>Cronograma de obra → Requerimientos de recursos por periodo semanal</div></div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Periodo", "Partida", "Metrado Prog.", "Inicio", "Fin", "Estado"].map(h => <th key={h} style={{ ...thS, textAlign: h === "Metrado Prog." ? "right" : "left" }}>{h}</th>)}</tr></thead>
      <tbody>{MPS_PERIODOS.map((r, i) => (<tr key={i} style={{ borderBottom: `1px solid ${P.bd}10` }}><td style={{ ...tS, color: P.cyan, fontFamily: "monospace", fontSize: 9, fontWeight: 600 }}>{r.periodo}</td><td style={tS}>{r.partida_desc}</td><td style={{ ...tS, textAlign: "right", fontWeight: 600 }}>{fmtN(r.metrado_prog)}</td><td style={{ ...tS, fontSize: 9, color: P.s1 }}>{r.fecha_inicio}</td><td style={{ ...tS, fontSize: 9, color: P.s1 }}>{r.fecha_fin}</td><td style={tS}><MBadge s={r.estado} /></td></tr>))}</tbody></table></div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
        <div style={{ fontSize: 9, color: P.s2, textTransform: "uppercase", letterSpacing: .5, marginBottom: 8 }}>Vista Temporal — Semanas 7 a 16</div>
        {MPS_PERIODOS.map((m, i) => { const sem = parseInt(m.periodo.split("-")[1]); const off = ((sem - 7) / 10) * 100; const w = Math.max(8, 20); return (<div key={i} style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4 }}><span style={{ fontSize: 8, color: P.s2, width: 120, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{m.partida_desc}</span><div style={{ flex: 1, height: 18, background: P.c2, borderRadius: 4, position: "relative" }}><div style={{ position: "absolute", height: "100%", borderRadius: 4, background: colors[i % 6] + "50", left: `${off}%`, width: `${w}%`, display: "flex", alignItems: "center", justifyContent: "center" }}><span style={{ fontSize: 7, color: "#ffffffCC", fontWeight: 600 }}>{m.periodo}</span></div></div></div>); })}
        <div style={{ display: "flex", justifyContent: "space-between", fontSize: 7, color: P.s2, marginTop: 4, paddingLeft: 128 }}>{["S07", "S08", "S09", "S10", "S11", "S12", "S13", "S14", "S15", "S16"].map(s => <span key={s}>{s}</span>)}</div>
      </div>
    </div>);
  }

  function INVStock() {
    const fil = INSUMOS_MRP.filter(i => !search || i.descripcion.toLowerCase().includes(search.toLowerCase()) || i.codigo.toLowerCase().includes(search.toLowerCase()));
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}><span style={{ fontSize: 12, fontWeight: 700 }}>Stock de Materiales — Almacen Central</span><div style={{ display: "flex", alignItems: "center", gap: 3, background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 5, padding: "3px 7px" }}><I.Se /><input value={search} onChange={e => setSearch(e.target.value)} placeholder="Buscar insumo..." style={{ background: "transparent", border: "none", color: P.tx, fontSize: 10, outline: "none", width: 140 }} /></div></div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Codigo", "Descripcion", "Und", "Stock", "Cuarentena", "Minimo", "P.U.", "Valor Stock", "Estado"].map(h => <th key={h} style={{ ...thS, textAlign: ["Stock", "Cuarentena", "Minimo", "P.U.", "Valor Stock"].includes(h) ? "right" : "left" }}>{h}</th>)}</tr></thead>
      <tbody>{fil.map((r, i) => { const low = r.stock_actual <= r.stock_minimo; const crit = r.stock_actual <= r.stock_minimo * 0.5; return (<tr key={i} style={{ borderBottom: `1px solid ${P.bd}10` }} onMouseEnter={e => e.currentTarget.style.background = P.hv} onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
        <td style={{ ...tS, color: P.cyan, fontFamily: "monospace", fontSize: 9 }}>{r.codigo}</td>
        <td style={{ ...tS, fontWeight: 600 }}>{r.descripcion}</td>
        <td style={{ ...tS, color: P.s2 }}>{r.unidad}</td>
        <td style={{ ...tS, textAlign: "right", fontWeight: 600, color: low ? P.red : P.tx }}>{fmtI(r.stock_actual)}</td>
        <td style={{ ...tS, textAlign: "right", color: r.stock_cuarentena > 0 ? P.org : P.s2 }}>{r.stock_cuarentena > 0 ? fmtI(r.stock_cuarentena) : "—"}</td>
        <td style={{ ...tS, textAlign: "right", color: P.s2 }}>{fmtI(r.stock_minimo)}</td>
        <td style={{ ...tS, textAlign: "right", color: P.s1 }}>{$(r.precio_unit)}</td>
        <td style={{ ...tS, textAlign: "right", fontWeight: 600 }}>{$(r.stock_actual * r.precio_unit)}</td>
        <td style={tS}><Badge s={crit ? "Rechazado" : low ? "Por Vencer" : "Vigente"} /></td>
      </tr>); })}</tbody></table></div>
    </div>);
  }

  function INVKardex() {
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}><div><div style={{ fontSize: 12, fontWeight: 700 }}>Kardex Valorizado — Formato 13.1 SUNAT</div><div style={{ fontSize: 9, color: P.s2 }}>Metodo: Promedio Ponderado (PP) | Periodo: 2026-02</div></div><Badge s="Vigente" /></div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}><div style={{ overflowX: "auto" }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Fecha", "TipoOp", "Operacion", "Documento", "Ent.Qty", "Ent.C.U.", "Ent.Total", "Sal.Qty", "Sal.Total", "Saldo Qty", "Saldo Total"].map(h => <th key={h} style={{ ...thS, textAlign: ["Ent.Qty", "Ent.C.U.", "Ent.Total", "Sal.Qty", "Sal.Total", "Saldo Qty", "Saldo Total"].includes(h) ? "right" : "left", whiteSpace: "nowrap", padding: "4px 5px" }}>{h}</th>)}</tr></thead>
      <tbody>{KARDEX_MRP.map((r, i) => (<tr key={i} style={{ borderBottom: `1px solid ${P.bd}10` }}>
        <td style={{ ...tS, color: P.s1, fontFamily: "monospace", fontSize: 9 }}>{r.fecha}</td>
        <td style={{ ...tS, fontFamily: "monospace", fontSize: 8, color: P.s2 }}>{r.tipo_op}</td>
        <td style={{ ...tS, fontSize: 9 }}>{r.desc_op}</td>
        <td style={{ ...tS, fontFamily: "monospace", fontSize: 9, color: P.cyan + "CC" }}>{r.documento}</td>
        <td style={{ ...tS, textAlign: "right", color: r.entrada_qty > 0 ? P.grn : P.s2 }}>{r.entrada_qty > 0 ? fmtI(r.entrada_qty) : "—"}</td>
        <td style={{ ...tS, textAlign: "right" }}>{r.entrada_cu > 0 ? fmtN(r.entrada_cu) : <span style={{ color: P.s2 }}>—</span>}</td>
        <td style={{ ...tS, textAlign: "right", color: r.entrada_total > 0 ? P.grn : P.s2 }}>{r.entrada_total > 0 ? $(r.entrada_total) : "—"}</td>
        <td style={{ ...tS, textAlign: "right", color: r.salida_qty > 0 ? P.red : P.s2 }}>{r.salida_qty > 0 ? fmtI(r.salida_qty) : "—"}</td>
        <td style={{ ...tS, textAlign: "right", color: r.salida_total > 0 ? P.red : P.s2 }}>{r.salida_total > 0 ? $(r.salida_total) : "—"}</td>
        <td style={{ ...tS, textAlign: "right", fontWeight: 700 }}>{fmtI(r.saldo_qty)}</td>
        <td style={{ ...tS, textAlign: "right", fontWeight: 700 }}>{$(r.saldo_total)}</td>
      </tr>))}</tbody></table></div></div>
    </div>);
  }

  function INVRecepciones() {
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div style={{ fontSize: 12, fontWeight: 700 }}>Recepciones — Plan de Puntos de Inspeccion (PPI)</div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Recep.ID", "O/C", "Proveedor", "Fecha", "Insumo", "Cantidad", "PPI", "Resultado", "Inspector"].map(h => <th key={h} style={thS}>{h}</th>)}</tr></thead>
      <tbody>{RECEPCIONES_MRP.map((r, i) => (<tr key={i} style={{ borderBottom: `1px solid ${P.bd}10` }}>
        <td style={{ ...tS, color: P.cyan, fontFamily: "monospace", fontSize: 9 }}>REC-{String(r.recepcion_id).padStart(4, "0")}</td>
        <td style={{ ...tS, fontFamily: "monospace", fontSize: 9 }}>{r.oc}</td>
        <td style={tS}>{r.proveedor}</td>
        <td style={{ ...tS, color: P.s1, fontSize: 9 }}>{r.fecha}</td>
        <td style={tS}>{r.insumo}</td>
        <td style={{ ...tS, fontWeight: 600 }}>{fmtI(r.cantidad)} <span style={{ color: P.s2, fontWeight: 400 }}>{r.unidad}</span></td>
        <td style={tS}><MBadge s={r.estado_ppi} /></td>
        <td style={{ ...tS, color: r.ppi_resultado === "CONFORME" ? P.grn : r.ppi_resultado === "EN_INSPECCION" ? P.org : P.red, fontSize: 9 }}>{r.ppi_resultado === "CONFORME" ? "✓ Conforme" : r.ppi_resultado === "EN_INSPECCION" ? "En inspeccion..." : "✗ " + r.ppi_resultado}</td>
        <td style={{ ...tS, color: P.s1, fontSize: 9 }}>{r.inspector}</td>
      </tr>))}</tbody></table></div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 8 }}><MBadge s="CUARENTENA" /><span style={{ fontSize: 11, fontWeight: 600 }}>Acero Corrugado ø 3/8\" — Lote SIDE-2026-0891</span></div>
        <G c={3}>{[{ p: "Diametro nominal", cr: "ASTM A615 Grado 60, ±2%", r: "Pendiente medicion", ok: false }, { p: "Corrugacion", cr: "ASTM A615 patron estandar", r: "Pendiente inspeccion visual", ok: false }, { p: "Certificado calidad", cr: "Adjunto y vigente por colada", r: "Cert. N° CC-SIDE-2026-0891", ok: true }].map((x, i) => (<div key={i} style={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 6, padding: 8 }}><div style={{ fontSize: 10, fontWeight: 600, marginBottom: 3 }}>{x.p}</div><div style={{ fontSize: 8, color: P.s2, marginBottom: 4 }}>Criterio: {x.cr}</div><div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}><span style={{ fontSize: 9, color: P.s1 }}>{x.r}</span><Badge s={x.ok ? "Aprobado" : "Pendiente"} /></div></div>))}</G>
      </div>
    </div>);
  }

  function INVRequisiciones() {
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}><span style={{ fontSize: 12, fontWeight: 700 }}>Requisiciones de Obra</span><div style={{ display: "flex", gap: 4 }}><Badge s={`Total: ${REQUISICIONES_MRP.length}`} /><Badge s={`Aprob: ${REQUISICIONES_MRP.filter(r => r.estado === "APROBADA").length}`} /><Badge s={`Env: ${REQUISICIONES_MRP.filter(r => r.estado === "ENVIADA").length}`} /></div></div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Requisicion", "Fecha", "Solicitante", "Partida", "Insumo", "Cantidad", "Monto Est.", "Prioridad", "Estado"].map(h => <th key={h} style={{ ...thS, textAlign: h === "Cantidad" || h === "Monto Est." ? "right" : "left" }}>{h}</th>)}</tr></thead>
      <tbody>{REQUISICIONES_MRP.map((r, i) => (<tr key={i} style={{ borderBottom: `1px solid ${P.bd}10` }}>
        <td style={{ ...tS, color: P.cyan, fontFamily: "monospace", fontSize: 9 }}>{r.req_id}</td>
        <td style={{ ...tS, color: P.s1, fontSize: 9 }}>{r.fecha}</td>
        <td style={{ ...tS, color: r.solicitante === "MRP Automatico" ? P.pur : P.tx }}>{r.solicitante}</td>
        <td style={{ ...tS, fontFamily: "monospace", fontSize: 9 }}>{r.partida}</td>
        <td style={tS}>{r.insumo}</td>
        <td style={{ ...tS, textAlign: "right", fontWeight: 600 }}>{fmtI(r.cantidad)} <span style={{ color: P.s2, fontWeight: 400 }}>{r.unidad}</span></td>
        <td style={{ ...tS, textAlign: "right" }}>{$(r.monto_est)}</td>
        <td style={tS}><MBadge s={r.prioridad} /></td>
        <td style={tS}><MBadge s={r.estado} /></td>
      </tr>))}</tbody></table></div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10 }}>
        <div style={{ fontSize: 9, color: P.s2, textTransform: "uppercase", letterSpacing: .5, marginBottom: 6 }}>Flujo de Aprobacion</div>
        <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 5, flexWrap: "wrap" }}>{["BORRADOR", "ENVIADA", "APROBADA", "→ O/C", "RECEPCION", "CONSUMO"].map((s, i) => (<div key={i} style={{ display: "flex", alignItems: "center", gap: 5 }}><span style={{ padding: "4px 10px", borderRadius: 5, fontSize: 9, fontWeight: 600, background: i < 3 ? P.blue + "10" : P.c2, border: `1px solid ${i < 3 ? P.blue + "30" : P.bd}`, color: i < 3 ? P.blue : P.s2 }}>{s}</span>{i < 5 && <span style={{ color: P.s2 }}>→</span>}</div>))}</div>
        <div style={{ fontSize: 8, color: P.s2, textAlign: "center", marginTop: 6 }}>Aprobacion: Residente (&lt; S/ 5K) → Gerente Obra (&lt; S/ 50K) → Gerencia General (&gt; S/ 50K)</div>
      </div>
    </div>);
  }

  function INVEquipos() {
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div style={{ fontSize: 12, fontWeight: 700 }}>Flota de Equipos — Horometros y Mantenimiento Preventivo</div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Equipo", "Placa", "Horometro", "Prox.Mto", "Tipo Mto.", "Hrs.Rest", "Estado"].map(h => <th key={h} style={{ ...thS, textAlign: ["Horometro", "Prox.Mto", "Hrs.Rest"].includes(h) ? "right" : "left" }}>{h}</th>)}</tr></thead>
      <tbody>{EQUIPOS_MRP.map((r, i) => (<tr key={i} style={{ borderBottom: `1px solid ${P.bd}10` }}>
        <td style={{ ...tS, fontWeight: 600 }}>{r.descripcion}</td>
        <td style={{ ...tS, fontFamily: "monospace", fontSize: 9, color: P.s2 }}>{r.placa}</td>
        <td style={{ ...tS, textAlign: "right", fontWeight: 600 }}>{fmtI(r.horometro)} <span style={{ fontSize: 8, color: P.s2 }}>HM</span></td>
        <td style={{ ...tS, textAlign: "right", color: P.s1 }}>{fmtI(r.prox_mto)} HM</td>
        <td style={tS}>{r.tipo_mto}</td>
        <td style={{ ...tS, textAlign: "right", fontWeight: 700, color: r.hrs_rest < 0 ? P.red : r.hrs_rest <= 50 ? P.org : P.grn }}>{r.hrs_rest} HM</td>
        <td style={tS}><MBadge s={r.estado} /></td>
      </tr>))}</tbody></table></div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(6,1fr)", gap: 5 }}>{EQUIPOS_MRP.map((eq, i) => { const pc = (eq.horometro / eq.prox_mto) * 100; const c = eq.estado === "VENCIDO" ? P.red : eq.estado === "PROXIMO" ? P.org : P.grn; return (<div key={i} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 8, textAlign: "center" }}><div style={{ fontSize: 9, fontWeight: 600, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap", marginBottom: 3 }}>{eq.descripcion}</div><div style={{ fontSize: 16, fontWeight: 800, color: c }}>{eq.hrs_rest}h</div><div style={{ width: "100%", height: 4, background: P.bd, borderRadius: 2, overflow: "hidden", marginTop: 4 }}><div style={{ height: "100%", borderRadius: 2, background: c, width: `${Math.min(pc, 100)}%` }} /></div><div style={{ fontSize: 7, color: P.s2, marginTop: 3 }}>{fmtI(eq.horometro)} / {fmtI(eq.prox_mto)} HM</div></div>); })}</div>
    </div>);
  }

  function INVPanol() {
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}><span style={{ fontSize: 12, fontWeight: 700 }}>Pañol — Control de Herramientas</span><div style={{ display: "flex", gap: 4 }}><Badge s={`Vigentes: ${HERRAMIENTAS_MRP.filter(h => h.estado === "VIGENTE").length}`} /><Badge s={`Vencidas: ${HERRAMIENTAS_MRP.filter(h => h.estado === "VENCIDA").length}`} /></div></div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Herramienta", "Cod.QR", "Operario", "DNI", "Frente", "Despacho", "Limite", "Val.Repos.", "Estado"].map(h => <th key={h} style={{ ...thS, textAlign: h === "Val.Repos." ? "right" : "left" }}>{h}</th>)}</tr></thead>
      <tbody>{HERRAMIENTAS_MRP.map((r, i) => (<tr key={i} style={{ borderBottom: `1px solid ${P.bd}10` }}>
        <td style={{ ...tS, fontWeight: 600 }}>{r.herramienta}</td>
        <td style={{ ...tS, color: P.cyan, fontFamily: "monospace", fontSize: 9 }}>{r.codigo_qr}</td>
        <td style={tS}>{r.operario}</td>
        <td style={{ ...tS, fontFamily: "monospace", fontSize: 9, color: P.s2 }}>{r.dni}</td>
        <td style={{ ...tS, color: P.s1, fontSize: 9 }}>{r.frente}</td>
        <td style={{ ...tS, fontSize: 9 }}>{r.despacho}</td>
        <td style={{ ...tS, fontSize: 9 }}>{r.limite}</td>
        <td style={{ ...tS, textAlign: "right" }}>{$(r.valor_rep)}</td>
        <td style={tS}><MBadge s={r.estado} /></td>
      </tr>))}</tbody></table></div>
      <div style={{ background: P.red + "08", border: `1px solid ${P.red}20`, borderRadius: 8, padding: 10 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 5, marginBottom: 6 }}><I.Wn /><span style={{ fontSize: 11, fontWeight: 700, color: P.red }}>Bloqueo de Liquidacion</span></div>
        <div style={{ fontSize: 9, color: P.s1, display: "flex", flexDirection: "column", gap: 3 }}>
          <div>• <span style={{ color: P.red, fontWeight: 600 }}>Miguel Soto (DNI: 32165498)</span> — Rotomartillo Hilti TE50 sin devolver (+24h). Valor: <span style={{ color: P.red }}>S/ 2,800</span></div>
          <div>• <span style={{ color: P.red, fontWeight: 600 }}>Luis Ramos (DNI: 98765432)</span> — Nivel Laser Bosch sin devolver (+48h). Valor: <span style={{ color: P.red }}>S/ 1,450</span></div>
          <div style={{ color: P.s2, fontStyle: "italic", marginTop: 3 }}>Estos operarios NO pueden ser liquidados hasta regularizar la devolucion o asumir costo de reposicion.</div>
        </div>
      </div>
    </div>);
  }

  function INVMermas() {
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div style={{ fontSize: 12, fontWeight: 700 }}>Control de Mermas por Partida</div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Partida / Insumo", "C.Teorico", "C.Real", "Merma", "Merma %", "Clasificacion"].map(h => <th key={h} style={{ ...thS, textAlign: ["C.Teorico", "C.Real", "Merma", "Merma %"].includes(h) ? "right" : "left" }}>{h}</th>)}</tr></thead>
      <tbody>{MERMAS_MRP.map((r, i) => { const c = r.merma < 0 ? P.grn : r.clasificacion === "MERMA_ANORMAL" ? P.red : P.org; return (<tr key={i} style={{ borderBottom: `1px solid ${P.bd}10` }}>
        <td style={tS}><div style={{ fontSize: 8, color: P.s2 }}>{r.partida}</div><div style={{ fontWeight: 600 }}>{r.insumo}</div></td>
        <td style={{ ...tS, textAlign: "right" }}>{fmtN(r.consumo_teorico)}</td>
        <td style={{ ...tS, textAlign: "right", fontWeight: 600 }}>{fmtN(r.consumo_real)}</td>
        <td style={{ ...tS, textAlign: "right", fontWeight: 700, color: c }}>{r.merma > 0 ? "+" : ""}{fmtN(r.merma)}</td>
        <td style={{ ...tS, textAlign: "right", fontWeight: 600, color: c }}>{r.merma_pct > 0 ? "+" : ""}{fmtN(r.merma_pct, 1)}%</td>
        <td style={tS}><MBadge s={r.clasificacion} /></td>
      </tr>); })}</tbody></table></div>
      <G c={3}>{[{ t: "Merma Normal", d: "Dentro del factor APU. Costo absorbido por la partida.", c: P.org }, { t: "Merma Anormal", d: "Excede factor APU. Gasto del periodo, requiere investigacion.", c: P.red }, { t: "Eficiente", d: "Consumo real menor al teorico. Indica buena gestion.", c: P.grn }].map((x, i) => (<div key={i} style={{ background: x.c + "08", border: `1px solid ${x.c}15`, borderRadius: 7, padding: 8 }}><div style={{ fontSize: 10, fontWeight: 700, color: x.c, marginBottom: 3 }}>{x.t}</div><div style={{ fontSize: 8, color: P.s2 }}>{x.d}</div></div>))}</G>
    </div>);
  }

  function INVView() {
    const invContent = () => { switch (invTab) { case "dashboard": return <INVDash />; case "mrp": return <INVMrp />; case "mps": return <INVMps />; case "stock": return <INVStock />; case "kardex": return <INVKardex />; case "recepciones": return <INVRecepciones />; case "requisiciones": return <INVRequisiciones />; case "equipos": return <INVEquipos />; case "panol": return <INVPanol />; case "mermas": return <INVMermas />; default: return <INVDash />; } };
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}><span style={{ fontSize: 14, fontWeight: 800 }}>Almacen MRPII</span><Tabs tabs={INV_TABS} active={invTab} onChange={setInvTab} /></div>
      </div>
      {invContent()}
    </div>);
  }

  /* ===== MODULO CONTABLE ===== */
  const ACCT_TABS = [
    { id: "dashboard", l: "Dashboard", icon: <I.Da /> },
    { id: "pcge", l: "Plan Cuentas", icon: <I.Bo /> },
    { id: "sire", l: "SIRE Concil.", icon: <I.Cd /> },
    { id: "shadow", l: "Auditor Shadow", icon: <I.Wn /> },
    { id: "cashflow", l: "Cashflow 360", icon: <I.Bk /> },
    { id: "costs", l: "Costos", icon: <I.St /> },
    { id: "portal", l: "Portal Prov.", icon: <I.Pp /> },
  ];
  const cS = { padding: "6px 8px", fontSize: 10, borderBottom: `1px solid ${P.bd}10` };
  const cH = { ...cS, color: P.s2, fontSize: 8, fontWeight: 700, textAlign: "left", textTransform: "uppercase" };
  const CStat = ({ l, v, sub, color = P.blue, trend }) => (<div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12, position: "relative", overflow: "hidden" }}><div style={{ position: "absolute", top: -15, right: -15, width: 60, height: 60, borderRadius: "50%", background: color, opacity: .05 }} /><div style={{ fontSize: 10, color: P.s2, marginBottom: 4 }}>{l}</div><div style={{ fontSize: 20, fontWeight: 800, color, letterSpacing: "-.03em" }}>{v}</div>{sub && <div style={{ fontSize: 9, color: P.s1, marginTop: 3, display: "flex", alignItems: "center", gap: 3 }}>{trend && <span style={{ color: trend > 0 ? P.grn : P.red, fontWeight: 700 }}>{trend > 0 ? "↑" : "↓"} {Math.abs(trend)}%</span>}{sub}</div>}</div>);
  const CBadge = ({ s, c }) => <span style={{ display: "inline-flex", padding: "2px 8px", borderRadius: 12, fontSize: 9, fontWeight: 600, background: (c || P.blue) + "15", color: c || P.blue, border: `1px solid ${(c || P.blue)}30` }}>{s}</span>;

  function ACCTDash() {
    const filtDocs = filteredDocs;
    const totalDocs = filtDocs.length;
    const procesados = filtDocs.filter(d => d.estado === "Procesado").length;
    const enProceso = filtDocs.filter(d => d.estado === "En Proceso").length;
    const pendientes = filtDocs.filter(d => d.estado === "Pendiente").length;
    const observados = filtDocs.filter(d => d.estado === "Observado").length;
    const totalMonto = filtDocs.reduce((a, d) => a + nn(d.total), 0);
    const totalIGV = filtDocs.reduce((a, d) => a + nn(d.igv), 0);
    const iaAprobados = filtDocs.filter(d => d.scanIA === "Aprobado IA").length;
    const iaRate = totalDocs > 0 ? ((iaAprobados / totalDocs) * 100).toFixed(1) : 0;

    const pieData = [{ name: "Procesado", value: procesados, fill: P.grn }, { name: "En Proceso", value: enProceso, fill: P.org }, { name: "Pendiente", value: pendientes, fill: P.blue }, { name: "Observado", value: observados, fill: P.red }].filter(x => x.value > 0);

    /* REAL-TIME integration from D.facturas & D.compras */
    const ventasTotal = D.facturas.reduce((a, f) => a + nn(f.total), 0);
    const ventasIGV = D.facturas.reduce((a, f) => a + nn(f.igv), 0);
    const comprasTotal = D.compras.reduce((a, c) => a + nn(c.total), 0);
    const comprasIGV = D.compras.reduce((a, c) => a + nn(c.igv), 0);
    const igvNeto = ventasIGV - comprasIGV;
    const utilidadBruta = ventasTotal - comprasTotal;
    const margen = ventasTotal > 0 ? ((utilidadBruta / ventasTotal) * 100).toFixed(1) : 0;

    /* Unified ledger: merge facturas + compras + scannedDocs into single timeline */
    const scannedLedger = scannedDocs.filter(sd => sd.estado === "Procesado" && !D.facturas.some(f => f.serie === sd.serie && f.numero === sd.numero) && !D.compras.some(c => c.serie === sd.serie && c.numero === sd.numero)).map(sd => ({
      ...sd, modulo: sd.modulo || "compras", tercero: sd.proveedor || sd.cliente || "", rucTercero: sd.rucProv || sd.ruc || "",
      cuenta: sd.cuentaContable || (sd.modulo === "ventas" ? "1212" : "6011"),
      contrapartida: sd.modulo === "ventas" ? "7011" : "4212",
      naturaleza: sd.modulo === "ventas" ? "DEBE" : "HABER",
      _fromScan: true,
    }));
    const ledger = [
      ...D.facturas.map(f => ({ ...f, modulo: "ventas", tercero: f.cliente, rucTercero: f.ruc, cuenta: f.tipo === "Factura" ? "1212" : "1213", contrapartida: "7011", naturaleza: "DEBE" })),
      ...D.compras.map(c => ({ ...c, modulo: "compras", tercero: c.proveedor, rucTercero: c.ruc, cuenta: "6011", contrapartida: c.tipo === "Factura" ? "4212" : "4213", naturaleza: "HABER" })),
      ...scannedLedger,
    ].sort((a, b) => b.fecha.localeCompare(a.fecha));

    /* Monthly chart data from real D */
    const monthChart = ventasTotal > 0 || comprasTotal > 0 ? [{ mes: "Feb", v: ventasTotal, c: comprasTotal }] : [];

    const isCliente = user?.role === "cliente";

    return (<div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
      <div><div style={{ fontSize: 16, fontWeight: 800 }}>Dashboard Contable {isCliente && user?.empresaRazon ? `· ${user.empresaRazon}` : ""}</div><div style={{ fontSize: 10, color: P.s2 }}>Periodo: Enero-Febrero 2026 {isCliente ? `· RUC: ${user.empresaRuc}` : "· Todas las empresas"} · <span style={{ color: P.grn }}>Datos en tiempo real</span></div></div>

      {/* REAL-TIME KPIs from ventas + compras */}
      {!isCliente && (
        <div style={{ background: `linear-gradient(135deg, ${P.c1}, ${P.c2})`, border: `1px solid ${P.bd}`, borderRadius: 10, padding: 14 }}>
          <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 10 }}>
            <span style={{ width: 8, height: 8, borderRadius: "50%", background: P.grn, boxShadow: `0 0 8px ${P.grn}`, animation: "pulse 2s infinite" }} />
            <span style={{ fontSize: 11, fontWeight: 700 }}>Registro de Ventas y Compras — Tiempo Real</span>
            <span style={{ fontSize: 9, color: P.s2, marginLeft: "auto" }}>{D.facturas.length + D.compras.length} CDP activos</span>
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(6,1fr)", gap: 6 }}>
            <div style={{ background: P.bg, borderRadius: 7, padding: 8, border: `1px solid ${P.grn}20` }}>
              <div style={{ fontSize: 8, color: P.s2, textTransform: "uppercase", fontWeight: 600 }}>Ventas</div>
              <div style={{ fontSize: 16, fontWeight: 800, color: P.grn }}>S/ {fmtK(ventasTotal)}</div>
              <div style={{ fontSize: 8, color: P.s2 }}>{D.facturas.length} facturas · IGV: S/ {fmtK(ventasIGV)}</div>
            </div>
            <div style={{ background: P.bg, borderRadius: 7, padding: 8, border: `1px solid ${P.org}20` }}>
              <div style={{ fontSize: 8, color: P.s2, textTransform: "uppercase", fontWeight: 600 }}>Compras</div>
              <div style={{ fontSize: 16, fontWeight: 800, color: P.org }}>S/ {fmtK(comprasTotal)}</div>
              <div style={{ fontSize: 8, color: P.s2 }}>{D.compras.length} docs · IGV: S/ {fmtK(comprasIGV)}</div>
            </div>
            <div style={{ background: P.bg, borderRadius: 7, padding: 8, border: `1px solid ${utilidadBruta >= 0 ? P.grn : P.red}20` }}>
              <div style={{ fontSize: 8, color: P.s2, textTransform: "uppercase", fontWeight: 600 }}>Utilidad Bruta</div>
              <div style={{ fontSize: 16, fontWeight: 800, color: utilidadBruta >= 0 ? P.grn : P.red }}>S/ {fmtK(utilidadBruta)}</div>
              <div style={{ fontSize: 8, color: P.s2 }}>Margen: {margen}%</div>
            </div>
            <div style={{ background: P.bg, borderRadius: 7, padding: 8, border: `1px solid ${igvNeto > 0 ? P.red : P.grn}20` }}>
              <div style={{ fontSize: 8, color: P.s2, textTransform: "uppercase", fontWeight: 600 }}>IGV Neto</div>
              <div style={{ fontSize: 16, fontWeight: 800, color: igvNeto > 0 ? P.red : P.grn }}>S/ {fmtK(Math.abs(igvNeto))}</div>
              <div style={{ fontSize: 8, color: igvNeto > 0 ? P.red : P.grn }}>{igvNeto > 0 ? "A pagar SUNAT" : "Credito fiscal"}</div>
            </div>
            <div style={{ background: P.bg, borderRadius: 7, padding: 8, border: `1px solid ${P.blue}20` }}>
              <div style={{ fontSize: 8, color: P.s2, textTransform: "uppercase", fontWeight: 600 }}>Docs Escaneados</div>
              <div style={{ fontSize: 16, fontWeight: 800, color: P.blue }}>{totalDocs}</div>
              <div style={{ fontSize: 8, color: P.s2 }}>{procesados} procesados IA</div>
            </div>
            <div style={{ background: P.bg, borderRadius: 7, padding: 8, border: `1px solid ${P.pur}20` }}>
              <div style={{ fontSize: 8, color: P.s2, textTransform: "uppercase", fontWeight: 600 }}>Tasa IA</div>
              <div style={{ fontSize: 16, fontWeight: 800, color: P.pur }}>{iaRate}%</div>
              <div style={{ fontSize: 8, color: P.s2 }}>{iaAprobados} aprobados auto</div>
            </div>
          </div>
        </div>
      )}

      {/* Client KPIs simplified */}
      {isCliente && (
        <div style={{ display: "grid", gridTemplateColumns: "repeat(4,1fr)", gap: 8 }}>
          <CStat l="Total Documentos" v={totalDocs} sub={`${procesados} procesados`} color={P.blue} trend={8.2} />
          <CStat l="Monto Total" v={`S/ ${fmtK(totalMonto)}`} sub={`IGV: S/ ${fmtK(totalIGV)}`} color={P.grn} />
          <CStat l="Tasa IA Aprobacion" v={`${iaRate}%`} sub={`${iaAprobados} de ${totalDocs} docs`} color={P.pur} />
          <CStat l="Pendientes/Observados" v={pendientes + observados} sub={`${pendientes} pend · ${observados} obs`} color={P.org} />
        </div>
      )}

      {/* Filters for contador/admin */}
      {!isCliente && (
        <div style={{ display: "flex", gap: 6, flexWrap: "wrap", alignItems: "flex-end" }}>
          <div style={{ minWidth: 160 }}>
            <label style={{ fontSize: 8, color: P.s1, fontWeight: 600, textTransform: "uppercase", display: "block", marginBottom: 2 }}>Empresa</label>
            <select value={docFilterEmpresa} onChange={e => setDocFilterEmpresa(e.target.value)} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 5, padding: "5px 7px", color: P.tx, fontSize: 10, outline: "none", width: "100%" }}>
              <option value="all">Todas las empresas</option>
              {EMPRESAS_CLIENTES.map(e => <option key={e.ruc} value={e.ruc}>{e.ruc} - {e.razon}</option>)}
            </select>
          </div>
          <div style={{ minWidth: 100 }}>
            <label style={{ fontSize: 8, color: P.s1, fontWeight: 600, textTransform: "uppercase", display: "block", marginBottom: 2 }}>Tipo Doc</label>
            <select value={docFilterTipo} onChange={e => setDocFilterTipo(e.target.value)} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 5, padding: "5px 7px", color: P.tx, fontSize: 10, outline: "none", width: "100%" }}>
              <option value="all">Todos</option>
              {DOC_TIPOS.map(t => <option key={t} value={t}>{t}</option>)}
            </select>
          </div>
          <Inp l="Fecha Desde" v={docFilterFechaDesde} onChange={setDocFilterFechaDesde} type="date" w="120px" />
          <Inp l="Fecha Hasta" v={docFilterFechaHasta} onChange={setDocFilterFechaHasta} type="date" w="120px" />
          <Btn s onClick={() => { setDocFilterEmpresa("all"); setDocFilterTipo("all"); setDocFilterFechaDesde(""); setDocFilterFechaHasta(""); }} style={{ marginBottom: 1 }}><I.Tr /> Limpiar</Btn>
          <Btn s onClick={() => exportXLS(filtDocs, `Contable_Docs_${today()}`)} style={{ background: P.grn + "15", color: P.grn, border: `1px solid ${P.grn}30`, marginBottom: 1 }}><I.Dw /> Exportar</Btn>
        </div>
      )}

      {/* LIBRO DIARIO - Real-time ledger from ventas + compras */}
      {!isCliente && (
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <span style={{ width: 6, height: 6, borderRadius: "50%", background: P.grn, boxShadow: `0 0 6px ${P.grn}` }} />
              <span style={{ fontSize: 12, fontWeight: 700 }}>Libro Diario — Asientos Automaticos</span>
              <span style={{ fontSize: 9, color: P.s2 }}>({ledger.length} movimientos)</span>
            </div>
            <div style={{ display: "flex", gap: 4 }}>
              <Btn s onClick={() => { setCfm({ msg: "¿Limpiar todos los asientos del Libro Diario? Se eliminarán las facturas y compras registradas. Esta acción no se puede deshacer.", fn: () => { setD(p => ({ ...p, facturas: [], compras: [] })); setScannedDocs([]); setCfm(null); notify("Libro Diario limpiado · Dashboard actualizado"); } }); }} style={{ background: P.red + "15", color: P.red, border: `1px solid ${P.red}30` }}><I.Tr /> Limpiar</Btn>
              <Btn s onClick={() => { const lc = [{ k: "fecha", l: "Fecha" }, { k: "modulo", l: "Origen" }, { k: "serie", l: "Serie" }, { k: "numero", l: "Numero" }, { k: "tipo", l: "Tipo CDP" }, { k: "tercero", l: "Tercero" }, { k: "rucTercero", l: "RUC" }, { k: "cuenta", l: "Cuenta" }, { k: "contrapartida", l: "Contrapartida" }, { k: "naturaleza", l: "D/H" }, { k: "moneda", l: "Mon" }, { k: "subtotal", l: "Base", num: 1 }, { k: "igv", l: "IGV", num: 1 }, { k: "total", l: "Total", num: 1 }, { k: "estado", l: "Estado" }]; exportXLS(ledger, `LibroDiario_${today()}`, lc); }} style={{ background: P.grn + "15", color: P.grn, border: `1px solid ${P.grn}30` }}><I.Dw /> Exportar</Btn>
            </div>
          </div>
          <div style={{ overflowX: "auto", maxHeight: 280, overflowY: "auto", scrollbarWidth: "thin" }}>
            <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 10 }}>
              <thead><tr style={{ position: "sticky", top: 0, background: P.c1, zIndex: 1 }}>
                <th style={cH}>Fecha</th><th style={cH}>Origen</th><th style={cH}>Serie-Num</th><th style={cH}>Tipo</th><th style={cH}>Tercero</th><th style={cH}>RUC</th><th style={cH}>Cuenta</th><th style={cH}>Contrap.</th><th style={cH}>D/H</th><th style={cH}>Mon</th><th style={{ ...cH, textAlign: "right" }}>Base</th><th style={{ ...cH, textAlign: "right" }}>IGV</th><th style={{ ...cH, textAlign: "right" }}>Total</th><th style={cH}>Estado</th>
              </tr></thead>
              <tbody>{ledger.map((r, i) => (
                <tr key={r.id || i} style={{ borderBottom: `1px solid ${P.bd}10` }} onMouseEnter={e => e.currentTarget.style.background = P.hv} onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
                  <td style={cS}>{r.fecha}</td>
                  <td style={cS}><CBadge s={r.modulo === "ventas" ? "Venta" : "Compra"} c={r.modulo === "ventas" ? P.grn : P.org} /></td>
                  <td style={{ ...cS, fontFamily: "monospace", color: P.blue, fontWeight: 600 }}>{r.serie}-{r.numero}</td>
                  <td style={cS}>{r.tipo}</td>
                  <td style={{ ...cS, maxWidth: 140, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{r.tercero}</td>
                  <td style={{ ...cS, fontFamily: "monospace", fontSize: 9 }}>{r.rucTercero}</td>
                  <td style={{ ...cS, fontFamily: "monospace", color: P.cyan, fontWeight: 600 }}>{r.cuenta}</td>
                  <td style={{ ...cS, fontFamily: "monospace", color: P.pur }}>{r.contrapartida}</td>
                  <td style={cS}><CBadge s={r.naturaleza} c={r.naturaleza === "DEBE" ? P.blue : P.org} /></td>
                  <td style={{ ...cS, color: r.moneda === "USD" ? P.yel : P.s1 }}>{r.moneda}</td>
                  <td style={{ ...cS, textAlign: "right", fontFamily: "monospace" }}>S/ {fmtN(r.subtotal)}</td>
                  <td style={{ ...cS, textAlign: "right", fontFamily: "monospace" }}>S/ {fmtN(r.igv)}</td>
                  <td style={{ ...cS, textAlign: "right", fontWeight: 700, fontFamily: "monospace" }}>S/ {fmtN(r.total)}</td>
                  <td style={cS}><CBadge s={r.estado} c={r.estado === "Pagada" || r.estado === "Pagado" ? P.grn : r.estado === "Emitida" ? P.blue : P.org} /></td>
                </tr>
              ))}</tbody>
            </table>
          </div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "8px 4px 0", borderTop: `1px solid ${P.bd}`, marginTop: 6, fontSize: 10 }}>
            <div style={{ display: "flex", gap: 12 }}>
              <span><span style={{ color: P.s2 }}>Total DEBE:</span> <strong style={{ color: P.grn }}>S/ {fmtN(ledger.filter(r => r.naturaleza === "DEBE").reduce((a, r) => a + nn(r.total), 0))}</strong></span>
              <span><span style={{ color: P.s2 }}>Total HABER:</span> <strong style={{ color: P.org }}>S/ {fmtN(ledger.filter(r => r.naturaleza === "HABER").reduce((a, r) => a + nn(r.total), 0))}</strong></span>
            </div>
            <span style={{ fontSize: 9, color: P.s2 }}>Cuadre: <strong style={{ color: Math.abs(ledger.filter(r => r.naturaleza === "DEBE").reduce((a, r) => a + nn(r.total), 0) - ledger.filter(r => r.naturaleza === "HABER").reduce((a, r) => a + nn(r.total), 0)) < 1 ? P.grn : P.org }}>S/ {fmtN(Math.abs(ledger.filter(r => r.naturaleza === "DEBE").reduce((a, r) => a + nn(r.total), 0) - ledger.filter(r => r.naturaleza === "HABER").reduce((a, r) => a + nn(r.total), 0)))}</strong></span>
          </div>
        </div>
      )}

      <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr", gap: 8 }}>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
          <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 10 }}>Ventas vs Compras — Tiempo Real (S/)</div>
          <ResponsiveContainer width="100%" height={180}><BarChart data={monthChart} barGap={4}><CartesianGrid strokeDasharray="3 3" stroke={P.bd} /><XAxis dataKey="mes" tick={{ fill: P.s2, fontSize: 10 }} axisLine={false} tickLine={false} /><YAxis tick={{ fill: P.s2, fontSize: 10 }} axisLine={false} tickLine={false} tickFormatter={v => `${(v/1000).toFixed(0)}K`} /><Tooltip contentStyle={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 6, fontSize: 10, color: P.tx }} formatter={(v) => `S/ ${fmtN(v)}`} /><Bar dataKey="v" fill={P.grn} radius={[3, 3, 0, 0]} name="Ventas" /><Bar dataKey="c" fill={P.org} radius={[3, 3, 0, 0]} name="Compras" /></BarChart></ResponsiveContainer>
        </div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
          <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 10 }}>Estado Documentos Escaneados</div>
          <ResponsiveContainer width="100%" height={140}><PieChart><Pie data={pieData} cx="50%" cy="50%" innerRadius={35} outerRadius={55} paddingAngle={3} dataKey="value">{pieData.map((e, i) => <Cell key={i} fill={e.fill} />)}</Pie><Tooltip contentStyle={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 6, fontSize: 10, color: P.tx }} /></PieChart></ResponsiveContainer>
          <div style={{ display: "flex", flexWrap: "wrap", gap: 5, justifyContent: "center" }}>{pieData.map(p => (<span key={p.name} style={{ fontSize: 8, color: P.s1, display: "flex", alignItems: "center", gap: 3 }}><span style={{ width: 6, height: 6, borderRadius: 2, background: p.fill, display: "inline-block" }} />{p.name} ({p.value})</span>))}</div>
        </div>
      </div>

      {/* Documents table */}
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
          <div style={{ fontSize: 12, fontWeight: 700 }}>Documentos Escaneados — Procesamiento IA {filtDocs.length > 0 && <span style={{ fontSize: 9, color: P.s2 }}>({filtDocs.length} docs)</span>}</div>
          <div style={{ display: "flex", gap: 4 }}>
            {isCliente && <Btn s onClick={() => exportXLS(filtDocs, `MisDocs_${user.empresaRuc}_${today()}`)} style={{ background: P.grn + "15", color: P.grn, border: `1px solid ${P.grn}30` }}><I.Dw /> XLS</Btn>}
            {!isCliente && (<>
              <Btn s onClick={() => exportXLS(filtDocs, `Contable_${docFilterEmpresa !== "all" ? docFilterEmpresa + "_" : "Todas_"}${today()}`)} style={{ background: P.grn + "15", color: P.grn, border: `1px solid ${P.grn}30` }}><I.Dw /> XLS</Btn>
              <Btn s onClick={() => { const cols = [{ k: "empresaRuc", l: "RUC Empresa" }, { k: "empresaRazon", l: "Empresa" }, { k: "serie", l: "Serie" }, { k: "numero", l: "Numero" }, { k: "fecha", l: "Fecha" }, { k: "tipo", l: "Tipo" }, { k: "proveedor", l: "Proveedor" }, { k: "rucProv", l: "RUC Prov" }, { k: "moneda", l: "Moneda" }, { k: "subtotal", l: "Subtotal" }, { k: "igv", l: "IGV" }, { k: "total", l: "Total" }, { k: "estado", l: "Estado" }, { k: "scanDate", l: "Fecha Escaneo" }, { k: "scanIA", l: "IA Resultado" }, { k: "confianzaIA", l: "Confianza %" }, { k: "cuentaContable", l: "Cuenta" }, { k: "modulo", l: "Modulo" }]; exportCSV(filtDocs, cols, `Contable_${today()}`); notify("CSV exportado"); }} style={{ background: P.blue + "15", color: P.blue, border: `1px solid ${P.blue}30` }}><I.Dw /> CSV</Btn>
            </>)}
          </div>
        </div>
        <div style={{ overflowX: "auto", maxHeight: 350, overflowY: "auto", scrollbarWidth: "thin" }}>
          <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 10 }}>
            <thead><tr style={{ borderBottom: `1px solid ${P.bd}`, position: "sticky", top: 0, background: P.c1, zIndex: 1 }}>
              {!isCliente && <th style={{ ...cH }}>Empresa</th>}
              <th style={cH}>Serie-Num</th><th style={cH}>Fecha</th><th style={cH}>Tipo</th><th style={cH}>Proveedor</th><th style={{ ...cH, textAlign: "right" }}>Total</th><th style={cH}>Estado</th><th style={cH}>IA</th><th style={cH}>Confianza</th>
            </tr></thead>
            <tbody>{filtDocs.slice(0, 50).map((d, i) => (
              <tr key={d.id} style={{ borderBottom: `1px solid ${P.bd}10` }} onMouseEnter={e => e.currentTarget.style.background = P.hv} onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
                {!isCliente && <td style={{ ...cS, maxWidth: 120, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}><span style={{ fontSize: 8, color: P.cyan, fontFamily: "monospace" }}>{d.empresaRuc}</span><br/><span style={{ fontSize: 8, color: P.s2 }}>{d.empresaRazon?.substring(0, 20)}</span></td>}
                <td style={{ ...cS, fontFamily: "monospace", color: P.blue, fontWeight: 600 }}>{d.serie}-{d.numero}</td>
                <td style={cS}>{d.fecha}</td>
                <td style={cS}>{d.tipo}</td>
                <td style={{ ...cS, maxWidth: 120, overflow: "hidden", textOverflow: "ellipsis" }}>{d.proveedor}</td>
                <td style={{ ...cS, textAlign: "right", fontWeight: 700 }}>S/ {fmtN(d.total)}</td>
                <td style={cS}><CBadge s={d.estado} c={d.estado === "Procesado" ? P.grn : d.estado === "En Proceso" ? P.org : d.estado === "Observado" ? P.red : P.blue} /></td>
                <td style={cS}><CBadge s={d.scanIA} c={d.scanIA === "Aprobado IA" ? P.grn : d.scanIA === "Revision Manual" ? P.org : P.blue} /></td>
                <td style={{ ...cS, textAlign: "center" }}><span style={{ fontSize: 9, color: d.confianzaIA >= 90 ? P.grn : d.confianzaIA >= 75 ? P.org : P.red, fontWeight: 700 }}>{d.confianzaIA}%</span></td>
              </tr>
            ))}</tbody>
          </table>
          {filtDocs.length > 50 && <div style={{ textAlign: "center", padding: 8, fontSize: 9, color: P.s2 }}>Mostrando 50 de {filtDocs.length} documentos</div>}
        </div>
      </div>

      {/* Company breakdown for contador/admin */}
      {!isCliente && (
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
            <div style={{ fontSize: 12, fontWeight: 700 }}>Resumen por Empresa Cliente</div>
            <Btn s onClick={() => {
              exportXLS(scannedDocs, `Todas_Empresas_${today()}`);
            }} style={{ background: P.pur + "15", color: P.pur, border: `1px solid ${P.pur}30` }}><I.Dw /> Exportar Todas</Btn>
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(3,1fr)", gap: 6 }}>
            {empresaBreakdown.map(e => (
              <div key={e.ruc} style={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 7, padding: 8 }} onMouseEnter={ev => ev.currentTarget.style.borderColor = P.blue + "50"} onMouseLeave={ev => ev.currentTarget.style.borderColor = P.bd}>
                <div onClick={() => setDocFilterEmpresa(e.ruc)} style={{ cursor: "pointer" }}>
                  <div style={{ fontSize: 9, fontWeight: 700, marginBottom: 2, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{e.razon}</div>
                  <div style={{ fontSize: 7, fontFamily: "monospace", color: P.cyan, marginBottom: 4 }}>{e.ruc}</div>
                  <div style={{ display: "flex", justifyContent: "space-between", fontSize: 8 }}>
                    <span style={{ color: P.s2 }}>{e.docs} docs</span>
                    <span style={{ fontWeight: 700, color: P.grn }}>S/ {fmtK(e.total)}</span>
                  </div>
                  <ProgressBar value={e.procesados} max={e.docs} color={P.grn} />
                </div>
                <div style={{ display: "flex", gap: 3, marginTop: 4 }}>
                  <Btn s onClick={(ev) => { ev.stopPropagation(); exportXLS(scannedDocs.filter(d => d.empresaRuc === e.ruc), `${e.ruc}_${today()}`); notify(`XLS ${e.razon} exportado`); }} style={{ flex: 1, fontSize: 7, padding: "2px 4px", background: P.grn + "10", color: P.grn, border: `1px solid ${P.grn}20` }}><I.Dw /> XLS</Btn>
                  <Btn s onClick={(ev) => { ev.stopPropagation(); const cols = [{ k: "serie", l: "Serie" }, { k: "numero", l: "Numero" }, { k: "fecha", l: "Fecha" }, { k: "tipo", l: "Tipo" }, { k: "proveedor", l: "Proveedor" }, { k: "rucProv", l: "RUC Prov" }, { k: "subtotal", l: "Subtotal" }, { k: "igv", l: "IGV" }, { k: "total", l: "Total" }, { k: "estado", l: "Estado" }, { k: "scanIA", l: "IA" }, { k: "cuentaContable", l: "Cuenta" }]; exportCSV(scannedDocs.filter(d => d.empresaRuc === e.ruc), cols, `${e.ruc}_${today()}`); notify(`CSV ${e.razon} exportado`); }} style={{ flex: 1, fontSize: 7, padding: "2px 4px", background: P.blue + "10", color: P.blue, border: `1px solid ${P.blue}20` }}><I.Dw /> CSV</Btn>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
          <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 8 }}>Calendario Tributario - Febrero 2026</div>
          {[{ date: "13 Feb", desc: "PDT 621 - IGV/Renta Mensual", amount: "S/ 79,747", pending: true }, { date: "17 Feb", desc: "Deposito Detracciones", amount: "S/ 4,230", pending: true }, { date: "17 Feb", desc: "AFP/ONP", amount: "S/ 12,450", pending: true }, { date: "28 Feb", desc: "PLAME", amount: "S/ 8,900", pending: false }].map((t, i) => (<div key={i} style={{ display: "flex", alignItems: "center", gap: 8, padding: "6px 0", borderBottom: i < 3 ? `1px solid ${P.bd}40` : "none" }}><span style={{ width: 36, fontSize: 9, fontWeight: 700, color: t.pending ? P.org : P.s2, textAlign: "center" }}>{t.date}</span><span style={{ flex: 1, fontSize: 11 }}>{t.desc}</span><span style={{ fontSize: 11, fontWeight: 700, color: t.pending ? P.org : P.s1 }}>{t.amount}</span></div>))}
        </div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
          <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 8 }}>Alertas Recientes — Auditor Shadow</div>
          {SHADOW_ALERTS.slice(0, 4).map((a, i) => (<div key={a.id} style={{ display: "flex", gap: 6, padding: "6px 0", borderBottom: i < 3 ? `1px solid ${P.bd}40` : "none" }}><span style={{ fontSize: 12 }}>{sevCfg[a.severity].icon}</span><div style={{ flex: 1 }}><div style={{ fontSize: 10, fontWeight: 600 }}>{a.type}</div><div style={{ fontSize: 9, color: P.s2, lineHeight: 1.3 }}>{a.desc.substring(0, 80)}...</div></div><span style={{ fontSize: 8, color: P.s2, whiteSpace: "nowrap" }}>{a.time}</span></div>))}
        </div>
      </div>
    </div>);
  }

  function TreeNode({ node, depth = 0 }) {
    const [open, setOpen] = useState(depth < 2);
    const hc = node.children && node.children.length > 0;
    return (<div>
      <div onClick={() => hc && setOpen(!open)} style={{ display: "flex", alignItems: "center", gap: 6, padding: "5px 8px", paddingLeft: 8 + depth * 18, cursor: hc ? "pointer" : "default", borderRadius: 5, fontSize: 11 }} onMouseEnter={e => e.currentTarget.style.background = P.hv} onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
        <span style={{ width: 12, display: "flex", transform: open ? "rotate(90deg)" : "rotate(0deg)", transition: "transform .15s", opacity: hc ? 1 : 0, fontSize: 8, color: P.s2 }}>▶</span>
        <span style={{ fontFamily: "monospace", fontSize: 10, color: P.cyan, fontWeight: 600, minWidth: 55 }}>{node.code}</span>
        <span style={{ flex: 1, fontWeight: node.isDetail ? 400 : 600, fontSize: 11 }}>{node.name}</span>
        <span style={{ padding: "1px 6px", borderRadius: 3, fontSize: 8, fontWeight: 600, background: typeColors[node.type] + "18", color: typeColors[node.type] }}>{typeLabels[node.type]}</span>
        <span style={{ fontFamily: "monospace", fontSize: 11, fontWeight: 600, minWidth: 90, textAlign: "right" }}>S/ {fmtN(node.balance)}</span>
      </div>
      {open && hc && node.children.map(c => <TreeNode key={c.id} node={c} depth={depth + 1} />)}
    </div>);
  }

  function ACCTPcge() {
    const [pcgeFilter, setPcgeFilter] = useState("ALL");
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div><div style={{ fontSize: 14, fontWeight: 800 }}>Plan Contable General Empresarial</div><div style={{ fontSize: 10, color: P.s2 }}>Estructura jerarquica N-niveles · PCGE Adaptado</div></div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}>
        <div style={{ display: "flex", gap: 4, padding: "8px 10px", borderBottom: `1px solid ${P.bd}`, flexWrap: "wrap" }}>
          {["ALL", "ASSET", "LIABILITY", "EQUITY", "REVENUE", "EXPENSE"].map(f => (<button key={f} onClick={() => setPcgeFilter(f)} style={{ padding: "3px 8px", borderRadius: 4, fontSize: 9, fontWeight: 600, border: `1px solid ${pcgeFilter === f ? P.blue + "40" : P.bd}`, background: pcgeFilter === f ? P.blue + "15" : "transparent", color: pcgeFilter === f ? P.cyan : P.s2, cursor: "pointer" }}>{f === "ALL" ? "Todas" : typeLabels[f]}</button>))}
        </div>
        <div style={{ padding: "4px 0" }}>{PCGE_DATA.filter(n => pcgeFilter === "ALL" || n.type === pcgeFilter).map(node => <TreeNode key={node.id} node={node} />)}</div>
      </div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(3,1fr)", gap: 6 }}>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10 }}><div style={{ fontSize: 9, color: P.s2 }}>Total Cuentas Activas</div><div style={{ fontSize: 22, fontWeight: 800, color: P.blue }}>247</div><div style={{ fontSize: 9, color: P.s2 }}>15 de detalle · 5 niveles max</div></div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10 }}><div style={{ fontSize: 9, color: P.s2 }}>Mapeo NIIF</div><div style={{ fontSize: 22, fontWeight: 800, color: P.grn }}>92%</div><div style={{ fontSize: 9, color: P.s2 }}>228 de 247 cuentas mapeadas</div></div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10 }}><div style={{ fontSize: 9, color: P.s2 }}>Ultima Modificacion</div><div style={{ fontSize: 22, fontWeight: 800, color: P.pur }}>Hoy</div><div style={{ fontSize: 9, color: P.s2 }}>13 Feb 2026 · 14:30</div></div>
      </div>
    </div>);
  }

  function ACCTSire() {
    const [sireFilter, setSireFilter] = useState("ALL");
    const fil = sireFilter === "ALL" ? SIRE_CONC : SIRE_CONC.filter(r => r.status === sireFilter);
    const sm = { total: SIRE_CONC.length, matched: SIRE_CONC.filter(r => r.status === "MATCHED").length, diff: SIRE_CONC.filter(r => r.status === "AMOUNT_DIFF").length, missingErp: SIRE_CONC.filter(r => r.status === "MISSING_ERP").length, missingSunat: SIRE_CONC.filter(r => r.status === "MISSING_SUNAT").length, dup: SIRE_CONC.filter(r => r.status === "DUPLICATE").length };
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div><div style={{ fontSize: 14, fontWeight: 800 }}>Integracion SIRE</div><div style={{ fontSize: 10, color: P.s2 }}>Conciliacion ERP vs SUNAT · Periodo 202601 · RCE Compras</div></div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(5,1fr)", gap: 6 }}>{[{ l: "Total", v: sm.total, c: P.tx }, { l: "Coinciden", v: sm.matched, c: P.grn }, { l: "Dif.Monto", v: sm.diff, c: P.org }, { l: "Falta ERP", v: sm.missingErp, c: P.red }, { l: "Falta SUNAT", v: sm.missingSunat, c: P.pur }].map((s, i) => (<div key={i} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10, textAlign: "center" }}><div style={{ fontSize: 9, color: P.s2 }}>{s.l}</div><div style={{ fontSize: 22, fontWeight: 800, color: s.c }}>{s.v}</div></div>))}</div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}>
        <div style={{ display: "flex", gap: 4, padding: "8px 10px", borderBottom: `1px solid ${P.bd}`, flexWrap: "wrap" }}>
          {[{ k: "ALL", l: `Todos (${sm.total})` }, { k: "MATCHED", l: `Coincide (${sm.matched})` }, { k: "AMOUNT_DIFF", l: `Dif.Monto (${sm.diff})` }, { k: "MISSING_ERP", l: `Falta ERP (${sm.missingErp})` }, { k: "MISSING_SUNAT", l: `Falta SUNAT (${sm.missingSunat})` }, { k: "DUPLICATE", l: `Duplicado (${sm.dup})` }].map(f => (<button key={f.k} onClick={() => setSireFilter(f.k)} style={{ padding: "3px 8px", borderRadius: 4, fontSize: 9, fontWeight: 600, border: `1px solid ${sireFilter === f.k ? (sireStatusC[f.k] || P.blue) + "40" : P.bd}`, background: sireFilter === f.k ? (sireStatusC[f.k] || P.blue) + "15" : "transparent", color: sireFilter === f.k ? (sireStatusC[f.k] || P.cyan) : P.s2, cursor: "pointer" }}>{f.l}</button>))}
        </div>
        <div style={{ overflowX: "auto" }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["RUC", "Razon Social", "Serie-Corr.", "Fecha", "Base Imp.", "IGV", "Total", "Estado"].map(h => <th key={h} style={{ ...cH, textAlign: ["Base Imp.", "IGV", "Total"].includes(h) ? "right" : "left" }}>{h}</th>)}</tr></thead>
        <tbody>{fil.map(r => (<tr key={r.id} style={{ borderBottom: `1px solid ${P.bd}10` }} onMouseEnter={e => e.currentTarget.style.background = P.hv} onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
          <td style={{ ...cS, fontFamily: "monospace", fontSize: 9, color: P.s1 }}>{r.ruc}</td>
          <td style={{ ...cS, fontWeight: 500 }}>{r.razon}</td>
          <td style={{ ...cS, fontFamily: "monospace", fontSize: 9 }}>{r.serie}-{r.correlativo}</td>
          <td style={{ ...cS, color: P.s1 }}>{r.fecha}</td>
          <td style={{ ...cS, fontFamily: "monospace", textAlign: "right" }}>{fmtN(r.base)}</td>
          <td style={{ ...cS, fontFamily: "monospace", textAlign: "right" }}>{fmtN(r.igv)}</td>
          <td style={{ ...cS, fontFamily: "monospace", textAlign: "right", fontWeight: 600 }}>{fmtN(r.total)}</td>
          <td style={cS}><CBadge s={sireStatusL[r.status] + (r.diff ? ` (${r.diff > 0 ? "+" : ""}${fmtN(r.diff)})` : "")} c={sireStatusC[r.status]} /></td>
        </tr>))}</tbody></table></div>
      </div>
    </div>);
  }

  function ACCTTax() {
    const [txType, setTxType] = useState("PURCHASE");
    const [txSub, setTxSub] = useState("10000");
    const [detrCode, setDetrCode] = useState("022");
    const [isRet, setIsRet] = useState(false);
    const base = parseFloat(txSub) || 0; const igv = base * 0.18; const tot = base + igv;
    const detr = DETR_CODES.find(d => d.code === detrCode); const detrR = detr ? detr.rate / 100 : 0;
    const detrApp = txType === "PURCHASE" && tot > 700; const detrAmt = detrApp ? tot * detrR : 0;
    const retApp = txType === "PURCHASE" && isRet && tot > 700; const retAmt = retApp ? tot * 0.03 : 0;
    const netPay = tot - detrAmt - retAmt;
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div><div style={{ fontSize: 14, fontWeight: 800 }}>Motor de Impuestos y Retenciones</div><div style={{ fontSize: 10, color: P.s2 }}>Calculo en tiempo real · IGV, Detracciones, Retenciones, Percepciones</div></div>
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
          <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 10 }}>Simulador de Impuestos</div>
          <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
            <div><div style={{ fontSize: 9, color: P.s2, fontWeight: 600, marginBottom: 3 }}>TIPO DE OPERACION</div><div style={{ display: "flex", gap: 4 }}>{["PURCHASE", "SALE", "IMPORT", "EXPORT"].map(t => (<button key={t} onClick={() => setTxType(t)} style={{ flex: 1, padding: "5px 6px", borderRadius: 4, fontSize: 9, fontWeight: 600, border: `1px solid ${txType === t ? P.blue + "50" : P.bd}`, background: txType === t ? P.blue : "transparent", color: txType === t ? "#fff" : P.s1, cursor: "pointer" }}>{t === "PURCHASE" ? "Compra" : t === "SALE" ? "Venta" : t === "IMPORT" ? "Importacion" : "Exportacion"}</button>))}</div></div>
            <div><div style={{ fontSize: 9, color: P.s2, fontWeight: 600, marginBottom: 3 }}>BASE IMPONIBLE (S/)</div><input value={txSub} onChange={e => setTxSub(e.target.value)} type="number" style={{ background: P.c3, border: `1px solid ${P.bd}`, borderRadius: 5, color: P.tx, padding: "8px 10px", fontSize: 16, fontWeight: 700, outline: "none", width: "100%" }} /></div>
            <div><div style={{ fontSize: 9, color: P.s2, fontWeight: 600, marginBottom: 3 }}>CODIGO DETRACCION</div><select value={detrCode} onChange={e => setDetrCode(e.target.value)} style={{ background: P.c3, border: `1px solid ${P.bd}`, borderRadius: 5, color: P.tx, padding: "6px 8px", fontSize: 10, outline: "none", width: "100%" }}>{DETR_CODES.map(d => <option key={d.code} value={d.code}>{d.code} - {d.name} ({d.rate}%)</option>)}</select></div>
            <div style={{ display: "flex", alignItems: "center", gap: 5 }}><input type="checkbox" checked={isRet} onChange={e => setIsRet(e.target.checked)} style={{ accentColor: P.blue }} /><span style={{ fontSize: 10, color: P.s1 }}>Emisor es Agente de Retencion</span></div>
          </div>
        </div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
          <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 10 }}>Resultado del Calculo</div>
          <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
            {[{ l: "Base Imponible", v: base, c: P.tx }, { l: "IGV (18%)", v: igv, c: P.blue }, { l: "Total Comprobante", v: tot, c: P.tx, b: true }].map((r, i) => (<div key={i} style={{ display: "flex", justifyContent: "space-between", padding: "7px 0", borderBottom: `1px solid ${P.bd}` }}><span style={{ fontSize: 11, color: P.s1 }}>{r.l}</span><span style={{ fontSize: r.b ? 14 : 12, fontWeight: r.b ? 800 : 600, fontFamily: "monospace", color: r.c }}>S/ {fmtN(r.v)}</span></div>))}
            <div style={{ background: detrApp ? P.org + "0A" : "transparent", borderRadius: 6, padding: 8, border: `1px solid ${detrApp ? P.org + "25" : P.bd}` }}><div style={{ fontSize: 9, fontWeight: 700, color: detrApp ? P.org : P.s2, marginBottom: 3 }}>DETRACCION {detrApp ? `— APLICA (${detr?.rate}%)` : "— NO APLICA"}</div>{detrApp && <><div style={{ fontSize: 9, color: P.s1 }}>{detr?.name}</div><div style={{ fontSize: 16, fontWeight: 800, color: P.org }}>- S/ {fmtN(detrAmt)}</div></>}{!detrApp && <div style={{ fontSize: 9, color: P.s2 }}>Monto no supera umbral de S/ 700</div>}</div>
            <div style={{ background: retApp ? P.pur + "0A" : "transparent", borderRadius: 6, padding: 8, border: `1px solid ${retApp ? P.pur + "25" : P.bd}` }}><div style={{ fontSize: 9, fontWeight: 700, color: retApp ? P.pur : P.s2, marginBottom: 3 }}>RETENCION {retApp ? "— APLICA (3%)" : "— NO APLICA"}</div>{retApp && <div style={{ fontSize: 16, fontWeight: 800, color: P.pur }}>- S/ {fmtN(retAmt)}</div>}</div>
            <div style={{ background: P.grn + "0A", borderRadius: 6, padding: 10, border: `1px solid ${P.grn}25` }}><div style={{ fontSize: 9, fontWeight: 700, color: P.grn, marginBottom: 3 }}>NETO A PAGAR</div><div style={{ fontSize: 22, fontWeight: 800, color: P.grn }}>S/ {fmtN(netPay)}</div></div>
          </div>
        </div>
      </div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
        <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 8 }}>Dashboard Tributario — Enero 2026</div>
        <div style={{ display: "grid", gridTemplateColumns: "repeat(4,1fr)", gap: 6 }}>{[{ l: "IGV Debito Fiscal", v: 160614, c: P.red }, { l: "IGV Credito Fiscal", v: 94212, c: P.grn }, { l: "IGV Neto por Pagar", v: 66402, c: P.org }, { l: "Pago a Cuenta IR (1.5%)", v: 13385, c: P.pur }].map((it, i) => (<div key={i} style={{ textAlign: "center", padding: 10, background: P.c2, borderRadius: 6 }}><div style={{ fontSize: 9, color: P.s2, marginBottom: 4 }}>{it.l}</div><div style={{ fontSize: 18, fontWeight: 800, color: it.c }}>S/ {fmtK(it.v)}</div></div>))}</div>
      </div>
    </div>);
  }

  function ACCTShadow() {
    const [shFilter, setShFilter] = useState("ALL");
    const [shEmpresa, setShEmpresa] = useState("all");
    const [aiAuditing, setAiAuditing] = useState(false);
    const [aiFindings, setAiFindings] = useState([]);

    /* Generate REAL alerts from D.facturas + D.compras + scannedDocs */
    const dynamicAlerts = useMemo(() => {
      const alerts = [];
      let aid = 100;

      /* Ventas analysis */
      D.facturas.forEach(f => {
        if (f.estado === "Pendiente" && nn(f.total) > 10000) {
          alerts.push({ id: aid++, type: "Factura Pendiente Alto Monto", severity: "WARNING", entity: `${f.serie}-${f.numero} · ${f.cliente || ""}`, empresa: f.cliente, ruc: f.ruc, desc: `Factura de venta por ${f.moneda === "USD" ? "$" : "S/"} ${fmtN(f.total)} en estado Pendiente. Verificar cobranza y provision por cobranza dudosa.`, recommendation: "Gestionar cobranza inmediata. Si supera 30 dias, provisionar cuenta 6841 Estimacion de cuentas de cobranza dudosa.", time: f.fecha, resolved: false, modulo: "ventas" });
        }
        if (f.moneda === "USD" && (!f.tc || f.tc === "1.000")) {
          alerts.push({ id: aid++, type: "Tipo Cambio No Aplicado", severity: "CRITICAL", entity: `${f.serie}-${f.numero} · ${f.cliente || ""}`, empresa: f.cliente, ruc: f.ruc, desc: `Factura en USD sin tipo de cambio aplicado. Monto: $ ${fmtN(f.total)}. Puede generar diferencia de cambio no reconocida.`, recommendation: "Aplicar TC venta SUNAT del dia de emision. Registrar diferencia en cuenta 776/676.", time: f.fecha, resolved: false, modulo: "ventas" });
        }
        if ((f.ruc || "").length !== 11 && (f.ruc || "").length !== 8 && f.ruc) {
          alerts.push({ id: aid++, type: "RUC/DNI Invalido", severity: "CRITICAL", entity: `${f.serie}-${f.numero} · ${f.cliente || ""}`, empresa: f.cliente, ruc: f.ruc, desc: `RUC/DNI "${f.ruc}" no tiene formato valido (${(f.ruc || "").length} digitos). RUC=11 digitos, DNI=8 digitos.`, recommendation: "Corregir dato del cliente. Factura puede ser rechazada por SUNAT en validacion SIRE.", time: f.fecha, resolved: false, modulo: "ventas" });
        }
      });

      /* Compras analysis */
      D.compras.forEach(c => {
        if (nn(c.total) >= 2000 && !c.detraccion) {
          alerts.push({ id: aid++, type: "Detraccion No Aplicada", severity: "WARNING", entity: `${c.serie}-${c.numero} · ${c.proveedor || ""}`, empresa: c.proveedor, ruc: c.ruc, desc: `Compra por ${c.moneda === "USD" ? "$" : "S/"} ${fmtN(c.total)} supera S/ 700 (UIT 2026). Verificar si aplica detraccion SPOT.`, recommendation: "Revisar codigo de bien/servicio. Si aplica, depositar detraccion en Banco de la Nacion antes del 5to dia habil del mes siguiente.", time: c.fecha, resolved: false, modulo: "compras" });
        }
        if ((c.ruc || "").startsWith("10") && nn(c.total) > 1500) {
          alerts.push({ id: aid++, type: "Retencion No Aplicada", severity: "INFO", entity: `${c.serie}-${c.numero} · ${c.proveedor || ""}`, empresa: c.proveedor, ruc: c.ruc, desc: `Proveedor persona natural (RUC 10) con factura > S/ 700. Verificar si aplica retencion IGV 3%.`, recommendation: "Si la empresa es agente de retencion, aplicar 3% de retencion. Emitir Comprobante de Retencion.", time: c.fecha, resolved: false, modulo: "compras" });
        }
        if (c.moneda === "USD" && nn(c.total) > 5000 && !c.dua) {
          alerts.push({ id: aid++, type: "Posible Importacion sin DUA", severity: "WARNING", entity: `${c.serie}-${c.numero} · ${c.proveedor || ""}`, empresa: c.proveedor, ruc: c.ruc, desc: `Compra en USD por $ ${fmtN(c.total)} sin DUA asociada. Si es importacion, falta registro de DAM.`, recommendation: "Si es compra de importacion, asociar DUA/DAM. El costo de importacion (landed cost) afecta la base del IGV.", time: c.fecha, resolved: false, modulo: "compras" });
        }
        if (c.estado === "Pendiente") {
          const dias = Math.floor((new Date() - new Date(c.fecha)) / 86400000);
          if (dias > 15) {
            alerts.push({ id: aid++, type: "Compra Vencida " + dias + "d", severity: dias > 30 ? "CRITICAL" : "WARNING", entity: `${c.serie}-${c.numero} · ${c.proveedor || ""}`, empresa: c.proveedor, ruc: c.ruc, desc: `Factura de compra pendiente de pago hace ${dias} dias. Monto: ${c.moneda === "USD" ? "$" : "S/"} ${fmtN(c.total)}.`, recommendation: dias > 30 ? "URGENTE: Pagar antes de perder credito fiscal IGV. Provision intereses moratorios." : "Programar pago. Verificar condiciones con proveedor.", time: c.fecha, resolved: false, modulo: "compras" });
          }
        }
      });

      /* Scanned docs alerts */
      scannedDocs.filter(sd => sd.estado !== "Procesado").forEach(sd => {
        alerts.push({ id: aid++, type: "Documento Sin Procesar", severity: "INFO", entity: `${sd.serie}-${sd.numero} · ${sd.proveedor || sd.empresaRazon || ""}`, empresa: sd.empresaRazon, ruc: sd.empresaRuc, desc: `Documento escaneado "${sd.archivo}" en estado "${sd.estado}". No contabilizado.`, recommendation: "Revisar y aprobar documento para integracion contable.", time: sd.scanDate || sd.fecha, resolved: false, modulo: sd.modulo || "compras" });
      });

      /* Cross-check ventas vs compras IGV */
      const igvDeb = D.facturas.reduce((a, f) => a + nn(f.igv), 0);
      const igvCred = D.compras.reduce((a, c) => a + nn(c.igv), 0);
      if (igvDeb > 0 && igvCred > igvDeb * 1.5) {
        alerts.push({ id: aid++, type: "Ratio IGV Anomalo", severity: "WARNING", entity: "Cruce IGV Ventas vs Compras", empresa: "Todas", ruc: "", desc: `IGV Credito Fiscal (S/ ${fmtN(igvCred)}) supera 150% del IGV Debito (S/ ${fmtN(igvDeb)}). Ratio: ${(igvCred/igvDeb*100).toFixed(0)}%.`, recommendation: "Revisar si todas las compras son deducibles. SUNAT puede fiscalizar operaciones con credito fiscal excesivo.", time: today(), resolved: false, modulo: "cruce" });
      }

      /* Add static alerts too */
      return [...alerts, ...SHADOW_ALERTS.map(a => ({ ...a, modulo: "sistema", empresa: "" }))];
    }, [D.facturas, D.compras, scannedDocs]);

    const [resolvedIds, setResolvedIds] = useState(new Set());
    const allAlerts = dynamicAlerts.map(a => ({ ...a, resolved: a.resolved || resolvedIds.has(a.id) }));

    /* Filter */
    const empresas = useMemo(() => {
      const set = new Set();
      allAlerts.forEach(a => { if (a.empresa) set.add(a.empresa); });
      return [...set].sort();
    }, [allAlerts]);

    const fil = allAlerts.filter(a => {
      if (shEmpresa !== "all" && a.empresa !== shEmpresa && !a.entity?.includes(shEmpresa)) return false;
      if (shFilter === "ALL") return true;
      if (shFilter === "RESOLVED") return a.resolved;
      if (shFilter === "ventas" || shFilter === "compras") return a.modulo === shFilter;
      return a.severity === shFilter && !a.resolved;
    });

    const uC = allAlerts.filter(a => a.severity === "CRITICAL" && !a.resolved).length;
    const uW = allAlerts.filter(a => a.severity === "WARNING" && !a.resolved).length;
    const uI = allAlerts.filter(a => a.severity === "INFO" && !a.resolved).length;
    const ventasAlerts = allAlerts.filter(a => a.modulo === "ventas" && !a.resolved).length;
    const comprasAlerts = allAlerts.filter(a => a.modulo === "compras" && !a.resolved).length;

    /* IA Audit function */
    const runAIAudit = async () => {
      setAiAuditing(true);
      try {
        const resumen = {
          facturas: D.facturas.map(f => ({ serie: f.serie, numero: f.numero, fecha: f.fecha, cliente: f.cliente, ruc: f.ruc, moneda: f.moneda, subtotal: f.subtotal, igv: f.igv, total: f.total, estado: f.estado, tc: f.tc })),
          compras: D.compras.map(c => ({ serie: c.serie, numero: c.numero, fecha: c.fecha, proveedor: c.proveedor, ruc: c.ruc, moneda: c.moneda, subtotal: c.subtotal, igv: c.igv, total: c.total, estado: c.estado, dua: c.dua, tc: c.tc })),
        };

        let parsed = null;
        try {
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514", max_tokens: 2000,
              system: "Eres un auditor tributario peruano senior con 30 años de experiencia en SUNAT. Analiza registros de ventas y compras para hallazgos de auditoria.",
              messages: [{ role: "user", content: `Analiza estos registros y genera hallazgos. Responde UNICAMENTE con un array JSON valido, sin backticks, sin texto adicional:\n${JSON.stringify(resumen)}\n\nFormato:\n[{"tipo":"texto corto","severidad":"CRITICAL o WARNING o INFO","entidad":"serie-num o nombre","descripcion":"detalle","recomendacion":"accion","modulo":"ventas o compras o cruce"}]` }]
            })
          });

          if (!response.ok) throw new Error("API status " + response.status);
          const result = await response.json();
          if (result.error) throw new Error(result.error.message || "API error");
          const text = (result.content || []).filter(c => c.type === "text").map(c => c.text).join("") || "";
          if (!text) throw new Error("Respuesta vacia");
          const clean = text.replace(/```json|```/g, "").trim();
          parsed = JSON.parse(clean);
          if (!Array.isArray(parsed)) throw new Error("No es array");
        } catch (apiErr) {
          console.warn("API fallback, generando auditoria local:", apiErr.message);
          /* FALLBACK: generate audit findings locally with accounting rules */
          parsed = [];
          const igvD = D.facturas.reduce((a, f) => a + nn(f.igv), 0);
          const igvC = D.compras.reduce((a, c) => a + nn(c.igv), 0);
          const totalV = D.facturas.reduce((a, f) => a + nn(f.total), 0);
          const totalC = D.compras.reduce((a, c) => a + nn(c.total), 0);

          if (igvD > 0) parsed.push({ tipo: "Analisis IGV Periodo", severidad: "INFO", entidad: "Cruce IGV Global", descripcion: `IGV Debito Fiscal: S/ ${fmtN(igvD)} (${D.facturas.length} ventas). IGV Credito Fiscal: S/ ${fmtN(igvC)} (${D.compras.length} compras). IGV neto a ${igvD > igvC ? "pagar" : "favor"}: S/ ${fmtN(Math.abs(igvD - igvC))}.`, recomendacion: igvD > igvC ? "Provisionar pago de IGV en PDT 621. Vencimiento segun cronograma SUNAT por ultimo digito de RUC." : "Arrastrar credito fiscal al siguiente periodo. Verificar que todos los comprobantes cumplan requisitos formales.", modulo: "cruce" });

          D.facturas.filter(f => f.moneda === "USD").forEach(f => {
            parsed.push({ tipo: "Diferencia de Cambio Potencial", severidad: "WARNING", entidad: `${f.serie}-${f.numero} · ${f.cliente}`, descripcion: `Factura en USD por $ ${fmtN(f.total)} con TC ${f.tc || "no registrado"}. Verificar TC SUNAT vigente al dia de emision para reconocer diferencia de cambio.`, recomendacion: "Aplicar NIC 21. Registrar diferencia en cuenta 776 (ganancia) o 676 (perdida). Usar TC venta publicado por SBS.", modulo: "ventas" });
          });

          D.compras.filter(c => nn(c.total) > 3500 && c.estado === "Pendiente").forEach(c => {
            parsed.push({ tipo: "Bancarizacion Requerida", severidad: "CRITICAL", entidad: `${c.serie}-${c.numero} · ${c.proveedor}`, descripcion: `Compra por S/ ${fmtN(c.total)} supera el limite de bancarizacion (S/ 2,000 desde 2022). Sin registro de medio de pago bancarizado.`, recomendacion: "OBLIGATORIO: Pagar mediante transferencia, cheque no negociable u otro medio bancarizado. Sin bancarizacion se pierde costo/gasto y credito fiscal (Art. 8 Ley 28194).", modulo: "compras" });
          });

          const boletas = D.compras.filter(c => c.tipo === "Boleta");
          if (boletas.length > 0) {
            const totBol = boletas.reduce((a, b) => a + nn(b.total), 0);
            parsed.push({ tipo: "Control Boletas RCE", severidad: "INFO", entidad: `${boletas.length} boletas en Registro de Compras`, descripcion: `Total boletas: S/ ${fmtN(totBol)}. Limite deducible: 6% del total de compras con comprobantes de pago que otorgan derecho a deducir.`, recomendacion: "Monitorear que las boletas no superen el 6% de las compras del periodo. Exceso no sera deducible para IR.", modulo: "compras" });
          }

          if (totalV > 0 && totalC > totalV * 0.95) {
            parsed.push({ tipo: "Margen Operativo Bajo", severidad: "WARNING", entidad: "Analisis Ventas vs Compras", descripcion: `Compras (S/ ${fmtN(totalC)}) representan ${(totalC/totalV*100).toFixed(1)}% de las ventas (S/ ${fmtN(totalV)}). Margen bruto: ${((1 - totalC/totalV)*100).toFixed(1)}%.`, recomendacion: "Margen bajo puede activar fiscalizacion por precios de transferencia. Documentar razones comerciales.", modulo: "cruce" });
          }

          D.facturas.filter(f => f.estado === "Pendiente").forEach(f => {
            const dias = Math.floor((new Date() - new Date(f.fecha)) / 86400000);
            if (dias > 7) parsed.push({ tipo: "Cobranza Pendiente " + dias + "d", severidad: dias > 30 ? "CRITICAL" : "WARNING", entidad: `${f.serie}-${f.numero} · ${f.cliente}`, descripcion: `Factura de venta por S/ ${fmtN(f.total)} emitida hace ${dias} dias sin cobrar. Verificar gestion de cobranza.`, recomendacion: dias > 30 ? "Evaluar provision por estimacion de cobranza dudosa (cuenta 6841). Iniciar gestion de cobranza formal." : "Dar seguimiento al cliente. Verificar si hay disputa o condiciones de credito.", modulo: "ventas" });
          });

          notify("Auditoria generada con motor local (sin API)");
        }

        setAiFindings((parsed || []).map((f, i) => ({
          id: 9000 + i, type: f.tipo || "Hallazgo", severity: f.severidad || "INFO",
          entity: f.entidad || "", empresa: f.entidad || "", ruc: "",
          desc: f.descripcion || "", recommendation: f.recomendacion || "",
          time: "IA Audit " + today(), resolved: false, modulo: f.modulo || "cruce", _aiGenerated: true
        })));
        if (!parsed?.length) notify("Auditoria completada: sin hallazgos adicionales");
      } catch (err) {
        console.error("AI Audit error:", err);
        notify("Error inesperado: " + (err.message || ""), "err");
      }
      setAiAuditing(false);
    };

    const combinedAlerts = [...fil, ...aiFindings.filter(f => {
      if (shEmpresa !== "all" && !f.entity?.includes(shEmpresa)) return false;
      if (shFilter === "ALL") return true;
      if (shFilter === "ventas" || shFilter === "compras") return f.modulo === shFilter;
      return f.severity === shFilter;
    })];

    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
        <div><div style={{ fontSize: 14, fontWeight: 800 }}>Auditor Shadow con IA</div><div style={{ fontSize: 10, color: P.s2 }}>Analisis en tiempo real de Ventas y Compras · {allAlerts.length} hallazgos detectados</div></div>
        <Btn p onClick={runAIAudit} disabled={aiAuditing} style={{ background: aiAuditing ? P.s2 : `linear-gradient(135deg, ${P.pur}, ${P.blue})`, color: "#fff", border: "none" }}>
          {aiAuditing ? "Auditando..." : "🤖 Auditar con IA"}
        </Btn>
      </div>

      {/* KPIs */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(6,1fr)", gap: 6 }}>
        <CStat l="Criticas" v={uC} color={P.red} sub="No resueltas" />
        <CStat l="Advertencias" v={uW} color={P.org} sub="No resueltas" />
        <CStat l="Informativas" v={uI} color={P.blue} sub="Pendientes" />
        <CStat l="Hallazgos Ventas" v={ventasAlerts} color={P.grn} sub={`${D.facturas.length} facturas`} />
        <CStat l="Hallazgos Compras" v={comprasAlerts} color={P.org} sub={`${D.compras.length} docs`} />
        <CStat l="Score Compliance" v={allAlerts.length > 0 ? `${Math.max(0, 100 - uC * 10 - uW * 3).toFixed(0)}%` : "100%"} color={uC > 0 ? P.red : P.grn} sub={uC > 0 ? "Requiere atencion" : "Optimo"} />
      </div>

      {/* AI Findings banner */}
      {aiFindings.length > 0 && (
        <div style={{ background: P.pur + "10", border: `1px solid ${P.pur}30`, borderRadius: 8, padding: "8px 12px", display: "flex", alignItems: "center", gap: 8 }}>
          <span style={{ fontSize: 16 }}>🤖</span>
          <div style={{ flex: 1 }}><span style={{ fontSize: 11, fontWeight: 700, color: P.pur }}>Claude IA encontro {aiFindings.length} hallazgos adicionales</span><span style={{ fontSize: 9, color: P.s2, marginLeft: 8 }}>Analisis profundo de registros contables</span></div>
          <Btn s onClick={() => setAiFindings([])} style={{ fontSize: 8 }}>Limpiar IA</Btn>
        </div>
      )}

      {/* Filters */}
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10 }}>
        <div style={{ display: "flex", gap: 6, flexWrap: "wrap", alignItems: "center", marginBottom: 8 }}>
          <div style={{ minWidth: 180 }}>
            <label style={{ fontSize: 8, color: P.s1, fontWeight: 600, textTransform: "uppercase", display: "block", marginBottom: 2 }}>Filtrar por Empresa</label>
            <select value={shEmpresa} onChange={e => setShEmpresa(e.target.value)} style={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 5, padding: "4px 7px", color: P.tx, fontSize: 10, outline: "none", width: "100%" }}>
              <option value="all">Todas las empresas</option>
              {empresas.map(e => <option key={e} value={e}>{e}</option>)}
            </select>
          </div>
          <div style={{ display: "flex", gap: 3, flexWrap: "wrap" }}>
            {[{ k: "ALL", l: `Todas (${allAlerts.length})` }, { k: "CRITICAL", l: `🔴 Criticas (${uC})` }, { k: "WARNING", l: `🟡 Advertencias (${uW})` }, { k: "INFO", l: `🔵 Info (${uI})` }, { k: "ventas", l: `📤 Ventas (${ventasAlerts})` }, { k: "compras", l: `📥 Compras (${comprasAlerts})` }, { k: "RESOLVED", l: "✅ Resueltas" }].map(f => (
              <button key={f.k} onClick={() => setShFilter(f.k)} style={{ padding: "3px 8px", borderRadius: 4, fontSize: 9, fontWeight: 600, border: `1px solid ${shFilter === f.k ? P.blue + "40" : P.bd}`, background: shFilter === f.k ? P.blue + "15" : "transparent", color: shFilter === f.k ? P.cyan : P.s2, cursor: "pointer" }}>{f.l}</button>
            ))}
          </div>
          <Btn s onClick={() => { const lc = [{ k: "type", l: "Tipo" }, { k: "severity", l: "Severidad" }, { k: "entity", l: "Entidad" }, { k: "modulo", l: "Modulo" }, { k: "desc", l: "Descripcion" }, { k: "recommendation", l: "Recomendacion" }, { k: "time", l: "Fecha" }]; exportXLS(combinedAlerts, `AuditorShadow_${today()}`, lc); }} style={{ background: P.grn + "15", color: P.grn, border: `1px solid ${P.grn}30`, marginLeft: "auto" }}><I.Dw /> Exportar</Btn>
        </div>

        {combinedAlerts.length === 0 ? (
          <div style={{ textAlign: "center", padding: 24, color: P.s2, fontSize: 11 }}>Sin hallazgos para los filtros seleccionados</div>
        ) : (
          <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>{combinedAlerts.map(a => (<div key={a.id} style={{ background: a.resolved ? P.c2 : (a._aiGenerated ? P.pur : sevCfg[a.severity]?.c || P.blue) + "0A", border: `1px solid ${a.resolved ? P.bd : (a._aiGenerated ? P.pur : sevCfg[a.severity]?.c || P.blue) + "25"}`, borderRadius: 8, padding: 10, opacity: a.resolved ? .6 : 1, borderLeft: `3px solid ${a.resolved ? P.s2 : a._aiGenerated ? P.pur : sevCfg[a.severity]?.c || P.blue}` }}>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 5 }}>
              <div style={{ display: "flex", alignItems: "center", gap: 5 }}>
                <span style={{ fontSize: 12 }}>{a._aiGenerated ? "🤖" : sevCfg[a.severity]?.icon || "🔵"}</span>
                <span style={{ fontWeight: 700, fontSize: 12 }}>{a.type}</span>
                <span style={{ fontSize: 8, color: P.s2, background: P.c2, padding: "1px 6px", borderRadius: 3 }}>{a.severity}</span>
                <span style={{ fontSize: 8, padding: "1px 6px", borderRadius: 3, background: a.modulo === "ventas" ? P.grn + "15" : a.modulo === "compras" ? P.org + "15" : P.blue + "15", color: a.modulo === "ventas" ? P.grn : a.modulo === "compras" ? P.org : P.blue }}>{a.modulo === "ventas" ? "📤 Ventas" : a.modulo === "compras" ? "📥 Compras" : a.modulo === "cruce" ? "🔄 Cruce" : "⚙️ Sistema"}</span>
              </div>
              <span style={{ fontSize: 9, color: P.s2 }}>{a.time}</span>
            </div>
            <div style={{ fontSize: 10, color: P.cyan, marginBottom: 3, fontWeight: 600 }}>{a.entity}</div>
            <div style={{ fontSize: 11, lineHeight: 1.4, marginBottom: 6 }}>{a.desc}</div>
            <div style={{ background: P.blue + "08", borderRadius: 5, padding: "6px 8px", border: `1px solid ${P.blue}15` }}>
              <div style={{ fontSize: 8, fontWeight: 700, color: P.blue, marginBottom: 2 }}>💡 RECOMENDACION {a._aiGenerated ? "IA" : "AUDITOR"}</div>
              <div style={{ fontSize: 10, color: P.s1, lineHeight: 1.4 }}>{a.recommendation}</div>
            </div>
            {!a.resolved && <div style={{ display: "flex", gap: 4, marginTop: 6 }}>
              <Btn p onClick={() => setResolvedIds(prev => new Set([...prev, a.id]))}><I.Ck /> Resolver</Btn>
              <Btn>Asignar</Btn>
            </div>}
          </div>))}</div>
        )}
      </div>
    </div>);
  }

  function ACCTCashflow() {
    const [cfRange, setCfRange] = useState(30);
    const cfData = CASHFLOW_D.slice(0, cfRange);
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}><div><div style={{ fontSize: 14, fontWeight: 800 }}>Tesoreria Predictiva — Cashflow 360</div><div style={{ fontSize: 10, color: P.s2 }}>Proyeccion inteligente de flujo de caja</div></div><div style={{ display: "flex", gap: 4 }}>{[30, 60, 90].map(d => (<button key={d} onClick={() => setCfRange(d)} style={{ padding: "3px 10px", borderRadius: 4, fontSize: 9, fontWeight: 600, border: `1px solid ${cfRange === d ? P.blue + "50" : P.bd}`, background: cfRange === d ? P.blue : "transparent", color: cfRange === d ? "#fff" : P.s1, cursor: "pointer" }}>{d} dias</button>))}</div></div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(4,1fr)", gap: 6 }}>
        <CStat l="Saldo Actual" v={`S/ ${fmtK(245680)}`} color={P.blue} sub="Efectivo y equivalentes" />
        <CStat l="CxC Pendientes" v={`S/ ${fmtK(389500)}`} color={P.grn} sub="142 facturas" />
        <CStat l="CxP Pendientes" v={`S/ ${fmtK(287300)}`} color={P.red} sub="89 facturas" />
        <CStat l="Flujo Neto Proy." v={`S/ ${fmtK(102200)}`} color={P.org} sub={`Proximos ${cfRange} dias`} trend={5.3} />
      </div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
        <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 10 }}>Proyeccion Flujo de Caja — {cfRange} dias</div>
        <ResponsiveContainer width="100%" height={200}><AreaChart data={cfData}><defs><linearGradient id="gCfIn" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={P.grn} stopOpacity={.3}/><stop offset="100%" stopColor={P.grn} stopOpacity={0}/></linearGradient><linearGradient id="gCfOut" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={P.red} stopOpacity={.3}/><stop offset="100%" stopColor={P.red} stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" stroke={P.bd} /><XAxis dataKey="date" tick={{ fill: P.s2, fontSize: 9 }} axisLine={false} tickLine={false} interval={Math.floor(cfRange / 10)} /><YAxis tick={{ fill: P.s2, fontSize: 9 }} axisLine={false} tickLine={false} tickFormatter={v => `${(v/1000).toFixed(0)}K`} /><Tooltip contentStyle={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 6, fontSize: 9, color: P.tx }} formatter={v => [`S/ ${fmtN(v)}`, ""]} /><Area type="monotone" dataKey="inflows" stroke={P.grn} fill="url(#gCfIn)" strokeWidth={2} name="Ingresos" /><Area type="monotone" dataKey="outflows" stroke={P.red} fill="url(#gCfOut)" strokeWidth={2} name="Egresos" /><Legend wrapperStyle={{ fontSize: 9, color: P.s1 }} /></AreaChart></ResponsiveContainer>
      </div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
        <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 10 }}>Bandas de Confianza — Escenarios</div>
        <ResponsiveContainer width="100%" height={180}><AreaChart data={cfData}><defs><linearGradient id="gOpt2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={P.grn} stopOpacity={.15}/><stop offset="100%" stopColor={P.grn} stopOpacity={0}/></linearGradient><linearGradient id="gProb2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={P.blue} stopOpacity={.2}/><stop offset="100%" stopColor={P.blue} stopOpacity={0}/></linearGradient><linearGradient id="gPes2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={P.red} stopOpacity={.15}/><stop offset="100%" stopColor={P.red} stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" stroke={P.bd} /><XAxis dataKey="date" tick={{ fill: P.s2, fontSize: 9 }} axisLine={false} tickLine={false} interval={Math.floor(cfRange / 10)} /><YAxis tick={{ fill: P.s2, fontSize: 9 }} axisLine={false} tickLine={false} tickFormatter={v => `${(v/1000).toFixed(0)}K`} /><Tooltip contentStyle={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 6, fontSize: 9, color: P.tx }} formatter={v => [`S/ ${fmtN(v)}`, ""]} /><Area type="monotone" dataKey="optimista" stroke={P.grn} fill="url(#gOpt2)" strokeWidth={1.5} strokeDasharray="4 2" name="Optimista" /><Area type="monotone" dataKey="probable" stroke={P.blue} fill="url(#gProb2)" strokeWidth={2} name="Probable" /><Area type="monotone" dataKey="pesimista" stroke={P.red} fill="url(#gPes2)" strokeWidth={1.5} strokeDasharray="4 2" name="Pesimista" /><Legend wrapperStyle={{ fontSize: 9, color: P.s1 }} /></AreaChart></ResponsiveContainer>
      </div>
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
          <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 8 }}>Scoring Clientes — Probabilidad de Cobro</div>
          {[{ cat: "A", prob: "95%", count: 42, amount: 185000, c: P.grn }, { cat: "B", prob: "80%", count: 58, amount: 124500, c: P.blue }, { cat: "C", prob: "60%", count: 31, amount: 56000, c: P.org }, { cat: "D", prob: "30%", count: 11, amount: 24000, c: P.red }].map((s, i) => (<div key={i} style={{ display: "flex", alignItems: "center", gap: 8, padding: "6px 0", borderBottom: i < 3 ? `1px solid ${P.bd}40` : "none" }}><div style={{ width: 24, height: 24, borderRadius: 5, background: s.c + "20", display: "flex", alignItems: "center", justifyContent: "center", fontWeight: 800, fontSize: 12, color: s.c }}>{s.cat}</div><div style={{ flex: 1 }}><div style={{ fontSize: 10, fontWeight: 600 }}>{s.count} clientes · Prob. {s.prob}</div><div style={{ height: 3, background: P.c2, borderRadius: 2, marginTop: 3 }}><div style={{ height: "100%", borderRadius: 2, background: s.c, width: `${parseInt(s.prob)}%` }} /></div></div><span style={{ fontFamily: "monospace", fontSize: 11, fontWeight: 600 }}>S/ {fmtK(s.amount)}</span></div>))}
        </div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
          <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 8 }}>Compromisos Fijos Mensuales</div>
          {[{ d: "Nomina + ESSALUD", a: 85000, p: 45 }, { d: "Alquiler local", a: 15000, p: 8 }, { d: "Servicios", a: 8500, p: 4 }, { d: "Cuota financiamiento", a: 25000, p: 13 }, { d: "Seguros", a: 4200, p: 2 }, { d: "Impuestos (IGV+IR)", a: 79787, p: 28 }].map((c, i) => (<div key={i} style={{ display: "flex", alignItems: "center", gap: 6, padding: "4px 0", borderBottom: i < 5 ? `1px solid ${P.bd}40` : "none" }}><span style={{ flex: 1, fontSize: 10 }}>{c.d}</span><span style={{ fontSize: 8, color: P.s2 }}>{c.p}%</span><span style={{ fontFamily: "monospace", fontSize: 10, fontWeight: 600, minWidth: 60, textAlign: "right" }}>S/ {fmtK(c.a)}</span></div>))}
          <div style={{ display: "flex", justifyContent: "space-between", marginTop: 8, paddingTop: 8, borderTop: `2px solid ${P.bd}` }}><span style={{ fontWeight: 700, fontSize: 11 }}>Total Compromisos</span><span style={{ fontFamily: "monospace", fontSize: 14, fontWeight: 800, color: P.red }}>S/ {fmtK(217487)}</span></div>
        </div>
      </div>
    </div>);
  }

  function ACCTCosts() {
    const [costView, setCostView] = useState("centers");
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}><div><div style={{ fontSize: 14, fontWeight: 800 }}>Contabilidad de Costos Analitica</div><div style={{ fontSize: 10, color: P.s2 }}>Distribucion por centros de costo, proyectos y lineas de negocio</div></div><div style={{ display: "flex", gap: 4 }}>{[{ k: "centers", l: "Centros Costo" }, { k: "projects", l: "Proyectos" }, { k: "prorate", l: "Prorrateo" }].map(t => (<button key={t.k} onClick={() => setCostView(t.k)} style={{ padding: "3px 10px", borderRadius: 4, fontSize: 9, fontWeight: 600, border: `1px solid ${costView === t.k ? P.blue + "50" : P.bd}`, background: costView === t.k ? P.blue : "transparent", color: costView === t.k ? "#fff" : P.s1, cursor: "pointer" }}>{t.l}</button>))}</div></div>
      {costView === "centers" && <><div style={{ display: "grid", gridTemplateColumns: "repeat(4,1fr)", gap: 6 }}>{COST_CENTERS.map(cc => { const pc = (cc.spent / cc.budget) * 100; return (<div key={cc.id} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10 }}><div style={{ fontSize: 9, color: P.s2 }}>{cc.code} · {cc.name}</div><div style={{ fontSize: 18, fontWeight: 800 }}>S/ {fmtK(cc.spent)}</div><div style={{ fontSize: 9, color: P.s2, marginBottom: 5 }}>de S/ {fmtK(cc.budget)}</div><div style={{ height: 4, background: P.c2, borderRadius: 2 }}><div style={{ height: "100%", borderRadius: 2, width: `${Math.min(100, pc)}%`, background: pc > 90 ? P.red : pc > 70 ? P.org : P.grn }} /></div><div style={{ fontSize: 8, color: P.s2, marginTop: 3, textAlign: "right" }}>{pc.toFixed(1)}%</div></div>); })}</div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, overflow: "hidden" }}><div style={{ padding: "8px 10px", fontSize: 12, fontWeight: 700, borderBottom: `1px solid ${P.bd}` }}>Detalle por Sub-centro</div><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Codigo", "Centro / Sub-centro", "Presupuesto", "Ejecutado", "Disponible", "% Ejec.", "Estado"].map(h => <th key={h} style={{ ...cH, textAlign: ["Presupuesto", "Ejecutado", "Disponible"].includes(h) ? "right" : "left" }}>{h}</th>)}</tr></thead>
        <tbody>{COST_CENTERS.flatMap(cc => [{ ...cc, isP: true }, ...(cc.children || []).map(c => ({ ...c, isP: false }))]).map((r, i) => { const pc = (r.spent / r.budget) * 100; const av = r.budget - r.spent; return (<tr key={i} style={{ borderBottom: `1px solid ${P.bd}10`, background: r.isP ? P.blue + "04" : "transparent" }}><td style={{ ...cS, fontFamily: "monospace", fontSize: 9, color: P.cyan, paddingLeft: r.isP ? 8 : 24 }}>{r.code}</td><td style={{ ...cS, fontWeight: r.isP ? 700 : 400 }}>{r.name}</td><td style={{ ...cS, fontFamily: "monospace", textAlign: "right" }}>S/ {fmtK(r.budget)}</td><td style={{ ...cS, fontFamily: "monospace", textAlign: "right" }}>S/ {fmtK(r.spent)}</td><td style={{ ...cS, fontFamily: "monospace", textAlign: "right", color: av < 0 ? P.red : P.grn }}>S/ {fmtK(av)}</td><td style={cS}><div style={{ display: "flex", alignItems: "center", gap: 4 }}><div style={{ flex: 1, height: 3, background: P.c2, borderRadius: 2 }}><div style={{ height: "100%", borderRadius: 2, width: `${Math.min(100, pc)}%`, background: pc > 90 ? P.red : pc > 70 ? P.org : P.grn }} /></div><span style={{ fontSize: 8, color: P.s2 }}>{pc.toFixed(1)}%</span></div></td><td style={cS}><CBadge s={pc > 90 ? "Critico" : pc > 70 ? "Alerta" : "Normal"} c={pc > 90 ? P.red : pc > 70 ? P.org : P.grn} /></td></tr>); })}</tbody></table></div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}><div style={{ fontSize: 12, fontWeight: 700, marginBottom: 10 }}>Distribucion de Costos por Centro</div><ResponsiveContainer width="100%" height={200}><BarChart data={COST_CENTERS.map(c => ({ name: c.name, presupuesto: c.budget / 1000, ejecutado: c.spent / 1000 }))} layout="vertical"><CartesianGrid strokeDasharray="3 3" stroke={P.bd} /><XAxis type="number" tick={{ fill: P.s2, fontSize: 9 }} axisLine={false} tickLine={false} tickFormatter={v => `${v}K`} /><YAxis type="category" dataKey="name" tick={{ fill: P.s1, fontSize: 9 }} axisLine={false} tickLine={false} width={80} /><Tooltip contentStyle={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 6, fontSize: 9, color: P.tx }} formatter={v => [`S/ ${v}K`, ""]} /><Bar dataKey="presupuesto" fill={P.blue + "40"} radius={[0, 3, 3, 0]} name="Presupuesto" /><Bar dataKey="ejecutado" fill={P.blue} radius={[0, 3, 3, 0]} name="Ejecutado" /><Legend wrapperStyle={{ fontSize: 9, color: P.s1 }} /></BarChart></ResponsiveContainer></div>
      </>}
      {costView === "projects" && <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}><div style={{ fontSize: 12, fontWeight: 700, marginBottom: 10 }}>Proyectos Activos</div><div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>{[{ code: "PRY-001", name: "Migracion ERP", budget: 150000, spent: 98000, start: "2025-09-01", end: "2026-06-30", status: "En curso" }, { code: "PRY-002", name: "Apertura Sucursal Norte", budget: 280000, spent: 210000, start: "2025-11-15", end: "2026-04-30", status: "En curso" }, { code: "PRY-003", name: "Campaña Verano 2026", budget: 45000, spent: 42000, start: "2026-01-01", end: "2026-02-28", status: "Por cerrar" }, { code: "PRY-004", name: "Automatizacion Almacen", budget: 95000, spent: 12000, start: "2026-01-15", end: "2026-08-31", status: "Inicio" }].map((p, i) => { const pc = (p.spent / p.budget) * 100; return (<div key={i} style={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}><div style={{ display: "flex", justifyContent: "space-between", marginBottom: 6 }}><div><span style={{ fontFamily: "monospace", fontSize: 9, color: P.cyan }}>{p.code}</span><div style={{ fontWeight: 700, fontSize: 12, marginTop: 2 }}>{p.name}</div></div><CBadge s={p.status} c={p.status === "En curso" ? P.grn : p.status === "Por cerrar" ? P.org : P.pur} /></div><div style={{ fontSize: 10, color: P.s2, marginBottom: 5 }}>{p.start} → {p.end}</div><div style={{ display: "flex", justifyContent: "space-between", fontSize: 10, marginBottom: 4 }}><span>Ejecutado: <b>S/ {fmtK(p.spent)}</b></span><span>Presupuesto: <b>S/ {fmtK(p.budget)}</b></span></div><div style={{ height: 4, background: P.c3, borderRadius: 2 }}><div style={{ height: "100%", borderRadius: 2, width: `${Math.min(100, pc)}%`, background: pc > 90 ? P.red : pc > 70 ? P.org : P.blue }} /></div><div style={{ fontSize: 8, color: P.s2, marginTop: 3, textAlign: "right" }}>{pc.toFixed(1)}% ejecutado · S/ {fmtK(p.budget - p.spent)} disponible</div></div>); })}</div></div>}
      {costView === "prorate" && <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}><div style={{ fontSize: 12, fontWeight: 700, marginBottom: 10 }}>Motor de Prorrateo</div><div style={{ display: "grid", gridTemplateColumns: "repeat(3,1fr)", gap: 8 }}>{[{ type: "Directo", desc: "Asignacion 100% a un centro/proyecto especifico", icon: "🎯", ex: "Salario Gerente Ventas → 100% COM-VEN" }, { type: "Proporcional", desc: "Distribucion segun drivers configurables", icon: "⚖️", ex: "Alquiler → 40% OPE, 30% COM, 20% ADM, 10% TEC" }, { type: "Escalonado", desc: "Distribucion jerarquica de costos indirectos", icon: "🏗️", ex: "IT → 40% Operaciones → 30% Ventas → 30% Admin" }].map((p, i) => (<div key={i} style={{ background: P.c2, borderRadius: 8, padding: 12, border: `1px solid ${P.bd}` }}><div style={{ fontSize: 22, marginBottom: 5 }}>{p.icon}</div><div style={{ fontWeight: 700, fontSize: 12, marginBottom: 4 }}>Prorrateo {p.type}</div><div style={{ fontSize: 10, color: P.s1, lineHeight: 1.4, marginBottom: 8 }}>{p.desc}</div><div style={{ background: P.c3, borderRadius: 5, padding: 7, fontSize: 9, color: P.s2, lineHeight: 1.3 }}><b style={{ color: P.cyan }}>Ejemplo:</b> {p.ex}</div></div>))}</div>
        <div style={{ marginTop: 12 }}><div style={{ fontSize: 12, fontWeight: 700, marginBottom: 8 }}>Drivers de Distribucion Configurados</div><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{["Driver", "Tipo", "ADM", "COM", "OPE", "TEC", "Total"].map((h, i) => <th key={h} style={{ ...cH, textAlign: i > 1 ? "center" : "left" }}>{h}</th>)}</tr></thead><tbody>{[{ d: "Metros Cuadrados", t: "Proporcional", adm: 15, com: 25, ope: 45, tec: 15 }, { d: "Headcount", t: "Proporcional", adm: 20, com: 30, ope: 35, tec: 15 }, { d: "Ingresos por Linea", t: "Proporcional", adm: 0, com: 60, ope: 30, tec: 10 }, { d: "Horas-Hombre TI", t: "Escalonado", adm: 10, com: 20, ope: 50, tec: 20 }].map((d, i) => (<tr key={i} style={{ borderBottom: `1px solid ${P.bd}10` }}><td style={{ ...cS, fontWeight: 600 }}>{d.d}</td><td style={cS}><CBadge s={d.t} c={P.pur} /></td>{[d.adm, d.com, d.ope, d.tec].map((v, j) => <td key={j} style={{ ...cS, textAlign: "center", fontFamily: "monospace" }}>{v}%</td>)}<td style={{ ...cS, textAlign: "center", fontFamily: "monospace", fontWeight: 700, color: P.grn }}>100%</td></tr>))}</tbody></table></div>
      </div>}
    </div>);
  }

  function ACCTPortal() {
    const wfSteps = ["Carga XML", "Valid. UBL", "Valid. SUNAT", "Pre-Asiento", "Aprobacion"];
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div><div style={{ fontSize: 14, fontWeight: 800 }}>Portal de Proveedores Self-Service</div><div style={{ fontSize: 10, color: P.s2 }}>Recepcion automatizada de comprobantes electronicos</div></div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(4,1fr)", gap: 6 }}>
        <CStat l="Recibidos Hoy" v="12" color={P.blue} />
        <CStat l="Validados OK" v="9" color={P.grn} />
        <CStat l="Pendientes Aprob." v="2" color={P.org} />
        <CStat l="Rechazados" v="1" color={P.red} />
      </div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
        <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 10 }}>Workflow de Comprobantes Recientes</div>
        {PORTAL_SUBS.map((s, idx) => (<div key={s.id} style={{ padding: "10px 0", borderBottom: idx < PORTAL_SUBS.length - 1 ? `1px solid ${P.bd}` : "none" }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}><div><span style={{ fontWeight: 700, fontSize: 12 }}>{s.provider}</span><span style={{ fontSize: 9, color: P.s2, marginLeft: 6 }}>RUC: {s.ruc} · {s.doc}</span></div><div style={{ display: "flex", alignItems: "center", gap: 5 }}><span style={{ fontFamily: "monospace", fontSize: 12, fontWeight: 700 }}>S/ {fmtN(s.amount)}</span><CBadge s={s.entryStatus === "APPROVED" ? "Aprobado" : s.entryStatus === "REJECTED" ? "Rechazado" : "Pendiente"} c={s.entryStatus === "APPROVED" ? P.grn : s.entryStatus === "REJECTED" ? P.red : P.org} /></div></div>
          <div style={{ display: "flex", alignItems: "center", gap: 3 }}>{wfSteps.map((step, i) => { const done = i < s.step; const cur = i === s.step - 1; const fail = s.entryStatus === "REJECTED" && i >= s.step - 1; return (<div key={i} style={{ display: "flex", alignItems: "center", flex: 1 }}><div style={{ display: "flex", alignItems: "center", gap: 4, padding: "3px 6px", borderRadius: 4, flex: 1, background: fail ? P.red + "0A" : done ? P.grn + "0A" : cur ? P.blue + "0A" : P.c2, border: `1px solid ${fail ? P.red + "20" : done ? P.grn + "20" : cur ? P.blue + "20" : P.bd}` }}><div style={{ width: 14, height: 14, borderRadius: "50%", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 8, fontWeight: 700, background: fail ? P.red : done ? P.grn : cur ? P.blue : P.c3, color: "#fff" }}>{fail ? "✕" : done ? "✓" : i + 1}</div><span style={{ fontSize: 8, color: fail ? P.red : done ? P.grn : cur ? P.cyan : P.s2, fontWeight: cur ? 600 : 400 }}>{step}</span></div>{i < wfSteps.length - 1 && <div style={{ width: 10, height: 2, background: done && i < s.step - 1 ? P.grn : P.bd, flexShrink: 0 }} />}</div>); })}</div>
        </div>))}
      </div>
      <div style={{ background: P.c1, border: `2px dashed ${P.bd}`, borderRadius: 8, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", padding: 30, cursor: "pointer" }} onMouseEnter={e => e.currentTarget.style.borderColor = P.blue} onMouseLeave={e => e.currentTarget.style.borderColor = P.bd}>
        <div style={{ fontSize: 28, marginBottom: 5, opacity: .4 }}>📄</div>
        <div style={{ fontWeight: 700, fontSize: 12 }}>Subir Comprobante Electronico</div>
        <div style={{ fontSize: 10, color: P.s2, marginTop: 3 }}>Arrastra XML (UBL 2.1) o haz clic · Max: 5MB</div>
      </div>
    </div>);
  }

  function ACCTView() {
    const acctContent = () => { switch (acctTab) { case "dashboard": return <ACCTDash />; case "pcge": return <ACCTPcge />; case "sire": return <ACCTSire />; case "shadow": return <ACCTShadow />; case "cashflow": return <ACCTCashflow />; case "costs": return <ACCTCosts />; case "portal": return <ACCTPortal />; default: return <ACCTDash />; } };
    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <div style={{ display: "flex", alignItems: "center", gap: 8 }}><span style={{ fontSize: 14, fontWeight: 800 }}>Modulo Contable</span><Tabs tabs={ACCT_TABS} active={acctTab} onChange={setAcctTab} /></div>
      {acctContent()}
    </div>);
  }

  /* ═══════════════════════════════════════════════════════════ */
  /* FINANZAS MODULE — FinCore CFO Cockpit                      */
  /* ═══════════════════════════════════════════════════════════ */

  function FinView() {
    const FT = { bg: "#0a0e17", surface: "#111827", surfaceAlt: "#151d2e", border: "#1e293b", borderLight: "#293548", text: "#e2e8f0", textMuted: "#8896ab", textDim: "#4a5568", accent: "#22d3ee", accentDim: "#0e7490", green: "#10b981", greenDim: "#064e3b", red: "#ef4444", redDim: "#7f1d1d", amber: "#f59e0b", amberDim: "#78350f", blue: "#3b82f6", purple: "#a78bfa", pink: "#ec4899" };
    const fcard = { background: FT.surface, border: `1px solid ${FT.border}`, borderRadius: 8, padding: 16, position: "relative", overflow: "hidden" };
    const fcardGlow = (color) => ({ position: "absolute", top: 0, left: 0, right: 0, height: 2, background: `linear-gradient(90deg, transparent, ${color}, transparent)` });
    const formatPEN = (v) => `S/ ${(v / 1e6).toFixed(2)}M`;
    const formatPENK = (v) => `S/ ${(v / 1e3).toFixed(0)}K`;

    const [finTab, setFinTab] = useState("dashboard");
    const [currentTime, setCurrentTime] = useState(new Date());
    useEffect(() => { const t = setInterval(() => setCurrentTime(new Date()), 1000); return () => clearInterval(t); }, []);

    /* DATA GENERATORS */
    const cashForecast = useMemo(() => {
      const data = []; let val = 4200000;
      for (let i = -30; i <= 30; i++) {
        const date = new Date(2026, 1, 14 + i);
        const noise = (Math.random() - 0.5) * 300000;
        val = val + noise * 0.3 + (i > 0 ? -20000 : 0);
        const opt = i > 0 ? val * 1.12 : val;
        const pes = i > 0 ? val * 0.88 : val;
        data.push({ date: date.toISOString().split("T")[0], day: i, label: `${date.getDate()}/${date.getMonth() + 1}`, actual: i <= 0 ? Math.round(val) : null, expected: Math.round(val), optimistic: i > 0 ? Math.round(opt) : null, pessimistic: i > 0 ? Math.round(pes) : null });
      }
      return data;
    }, []);

    const trialBalance = [
      { account: "Revenue", budget: 12500000, actual: 14037500, variance: 12.3, type: "RE" },
      { account: "COGS", budget: 7800000, actual: 7963800, variance: 2.1, type: "EX" },
      { account: "OpEx", budget: 3200000, actual: 3155200, variance: -1.4, type: "EX" },
      { account: "SG&A", budget: 980000, actual: 1019200, variance: 4.0, type: "EX" },
      { account: "R&D", budget: 540000, actual: 510300, variance: -5.5, type: "EX" },
      { account: "Depreciation", budget: 320000, actual: 316800, variance: -1.0, type: "EX" },
    ];

    const ANOMALY_FEED = [
      { id: "INV-4521", severity: "high", message: "Monto S/ 89,000 es 4.2σ del promedio del proveedor. Registrado a las 11:42 PM por usuario que normalmente opera en horario laboral.", time: "hace 3m", score: 0.89, flags: 6, status: "FLAGGED" },
      { id: "AP-BATCH-0214", severity: "medium", message: "Lote de 47 facturas AP con distribución de primer dígito anómala (p=0.003). Posible violación de Ley de Benford.", time: "hace 12m", score: 0.72, flags: 1, status: "FLAGGED" },
      { id: "JE-RECLASS-88", severity: "low", message: "Auto-reclasificación: S/ 12,400 de 'Varios' a 'Licencias de Software' basado en historial de proveedor.", time: "hace 25m", score: 0.31, flags: 0, status: "AUTO" },
      { id: "RECON-BCP-214", severity: "info", message: "47 líneas de estado de cuenta BCP conciliadas automáticamente (98.2% confianza). 1 requiere revisión.", time: "hace 41m", score: 0.15, flags: 0, status: "AUTO" },
    ];

    const BOT_ACTIONS = [
      { id: 1, action: "Auto-conciliación", detail: "47 líneas de estado de cuenta BCP conciliadas (98.2% confianza). 1 requiere revisión.", confidence: 98.2, type: "recon", time: "14:23" },
      { id: 2, action: "Reclasificación", detail: "S/ 12,400 de 'Varios' → 'Licencias de Software' basado en historial de TechCorp SAC.", confidence: 94.7, type: "reclass", time: "14:11" },
      { id: 3, action: "Detección de anomalía", detail: "INV-4521 (S/ 89,000): monto 4.2σ del promedio, hora inusual de registro.", confidence: 89.0, type: "anomaly", time: "14:08" },
      { id: 4, action: "Proyección de flujo", detail: "Modelo LSTM actualizado. Posición de caja a 14 días: S/ 3.8M (p50).", confidence: 91.3, type: "forecast", time: "13:55" },
      { id: 5, action: "Acumulación automática", detail: "Gasto de servicio de limpieza acumulado por S/ 4,200 — fecha de entrega detectada.", confidence: 96.1, type: "accrual", time: "13:42" },
    ];

    const INTERCOMPANY_NODES = [
      { id: "PE-HQ", label: "FinCorp Perú HQ", revenue: 14, x: 300, y: 200 },
      { id: "PE-MFG", label: "FinCorp Manufacturing", revenue: 8, x: 150, y: 350 },
      { id: "CL-OPS", label: "FinCorp Chile", revenue: 6, x: 500, y: 120 },
      { id: "CO-DIST", label: "FinCorp Colombia", revenue: 4, x: 520, y: 340 },
      { id: "US-HOLD", label: "FinCorp US Holdings", revenue: 22, x: 350, y: 50 },
    ];

    const INTERCOMPANY_EDGES = [
      { source: "PE-HQ", target: "PE-MFG", volume: 3200000, reconciled: true, net: "outflow" },
      { source: "PE-HQ", target: "CL-OPS", volume: 1800000, reconciled: true, net: "outflow" },
      { source: "CL-OPS", target: "CO-DIST", volume: 950000, reconciled: false, net: "outflow" },
      { source: "CO-DIST", target: "PE-HQ", volume: 780000, reconciled: true, net: "outflow" },
      { source: "US-HOLD", target: "PE-HQ", volume: 5400000, reconciled: true, net: "inflow" },
      { source: "US-HOLD", target: "CL-OPS", volume: 2100000, reconciled: false, net: "inflow" },
      { source: "PE-MFG", target: "CO-DIST", volume: 420000, reconciled: true, net: "outflow" },
    ];

    const CLOSE_TASKS = [
      { name: "Registros de materiales", done: true, auto: true },
      { name: "Depreciación", done: true, auto: true },
      { name: "Revaluación FX", done: true, auto: true },
      { name: "Acumulaciones", done: true, auto: true },
      { name: "Conciliación bancaria", done: true, auto: true },
      { name: "Conciliación intercompañía", done: false, auto: false },
      { name: "Revisión de anomalías (6)", done: false, auto: false },
      { name: "Aprobación final CFO", done: false, auto: false },
    ];

    /* MICRO COMPONENTS */
    const FPulse = ({ color = FT.green, size = 8 }) => (
      <span style={{ position: "relative", display: "inline-flex", width: size, height: size }}>
        <span style={{ position: "absolute", inset: 0, borderRadius: "50%", background: color, opacity: 0.6, animation: "fin-pulse 1.5s ease-in-out infinite" }} />
        <span style={{ width: size, height: size, borderRadius: "50%", background: color, position: "relative" }} />
      </span>
    );

    const FBadge = ({ children, color = FT.accent, bg }) => (
      <span style={{ display: "inline-flex", alignItems: "center", gap: 4, padding: "2px 8px", borderRadius: 4, fontSize: 11, fontWeight: 600, color, background: bg || `${color}18`, letterSpacing: "0.03em", textTransform: "uppercase" }}>{children}</span>
    );

    const FMiniStat = ({ label, value, sub, trend, color = FT.accent }) => (
      <div>
        <div style={{ fontSize: 10, color: FT.textMuted, marginBottom: 2, letterSpacing: "0.04em", textTransform: "uppercase" }}>{label}</div>
        <div style={{ fontSize: 18, fontWeight: 700, color: FT.text, fontFamily: "monospace" }}>{value}</div>
        {sub && <div style={{ fontSize: 10, color: trend === "up" ? FT.green : trend === "down" ? FT.red : FT.textMuted, marginTop: 2 }}>{sub}</div>}
      </div>
    );

    const FProgress = ({ value, max = 100, color = FT.accent, height = 6 }) => {
      const pc = Math.min((value / max) * 100, 100);
      return (<div style={{ width: "100%", height, background: FT.border, borderRadius: height / 2, overflow: "hidden" }}>
        <div style={{ width: `${pc}%`, height: "100%", borderRadius: height / 2, background: `linear-gradient(90deg, ${color}, ${color}cc)`, transition: "width 1s ease" }} />
      </div>);
    };

    const FSeverityDot = ({ severity }) => {
      const colors = { high: FT.red, medium: FT.amber, low: FT.blue, info: FT.green };
      return <FPulse color={colors[severity] || FT.textMuted} size={8} />;
    };

    /* CARD: CASH POSITION */
    function FCashPosition() {
      return (<div style={fcard}>
        <div style={fcardGlow(FT.accent)} />
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
          <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
            <span style={{ fontSize: 12, color: FT.textMuted, letterSpacing: "0.06em", textTransform: "uppercase", fontWeight: 600 }}>💰 Posición de Caja</span>
          </div>
          <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
            <FPulse color={FT.green} />
            <span style={{ fontSize: 10, color: FT.green, fontWeight: 500 }}>EN VIVO</span>
          </div>
        </div>
        <div style={{ fontSize: 28, fontWeight: 800, color: FT.text, fontFamily: "monospace", letterSpacing: "-0.02em" }}>
          S/ 4,217,843<span style={{ fontSize: 18, color: FT.textMuted }}>.52</span>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 6, marginTop: 6 }}>
          <span style={{ fontSize: 13, color: FT.green, fontWeight: 600 }}>▲ +S/ 127K</span>
          <span style={{ fontSize: 12, color: FT.textMuted }}>vs. ayer</span>
        </div>
        <div style={{ marginTop: 14 }}>
          <FProgress value={82} color={FT.accent} />
          <div style={{ display: "flex", justifyContent: "space-between", marginTop: 4 }}>
            <span style={{ fontSize: 10, color: FT.textMuted }}>82% del target mensual</span>
            <span style={{ fontSize: 10, color: FT.textMuted }}>Meta: S/ 5.1M</span>
          </div>
        </div>
      </div>);
    }

    /* CARD: CLOSE READINESS */
    function FCloseReadiness() {
      const total = CLOSE_TASKS.length;
      const done = CLOSE_TASKS.filter(t => t.done).length;
      const pcDone = Math.round((done / total) * 100);
      const autoDone = CLOSE_TASKS.filter(t => t.done && t.auto).length;
      return (<div style={fcard}>
        <div style={fcardGlow(FT.green)} />
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
          <span style={{ fontSize: 12, color: FT.textMuted, letterSpacing: "0.06em", textTransform: "uppercase", fontWeight: 600 }}>🛡️ Cierre Continuo</span>
          <FBadge color={FT.green}>Periodo 2026-02</FBadge>
        </div>
        <div style={{ display: "flex", alignItems: "baseline", gap: 8 }}>
          <span style={{ fontSize: 36, fontWeight: 800, color: FT.green, fontFamily: "monospace" }}>{pcDone}%</span>
          <span style={{ fontSize: 13, color: FT.textMuted }}>completado</span>
        </div>
        <div style={{ marginTop: 8 }}><FProgress value={pcDone} color={FT.green} height={8} /></div>
        <div style={{ marginTop: 12, display: "flex", gap: 16 }}>
          <FMiniStat label="Auto-completado" value={autoDone} color={FT.accent} />
          <FMiniStat label="Pendiente revisión" value={total - done} color={FT.amber} />
        </div>
        <div style={{ marginTop: 12 }}>
          {CLOSE_TASKS.map((t, i) => (
            <div key={i} style={{ display: "flex", alignItems: "center", gap: 8, padding: "4px 0", borderBottom: i < CLOSE_TASKS.length - 1 ? `1px solid ${FT.border}` : "none" }}>
              <span style={{ color: t.done ? FT.green : FT.amber, fontSize: 12 }}>{t.done ? "✓" : "◷"}</span>
              <span style={{ fontSize: 12, color: t.done ? FT.textMuted : FT.text, flex: 1 }}>{t.name}</span>
              {t.auto && t.done && <FBadge color={FT.accent}>IA</FBadge>}
            </div>
          ))}
        </div>
      </div>);
    }

    /* CARD: ANOMALY FEED */
    function FAnomalyFeed() {
      const [expanded, setExpanded] = useState(null);
      return (<div style={fcard}>
        <div style={fcardGlow(FT.red)} />
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
          <span style={{ fontSize: 12, color: FT.textMuted, letterSpacing: "0.06em", textTransform: "uppercase", fontWeight: 600 }}>⚠️ Feed de Anomalías</span>
          <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
            <FPulse color={FT.red} />
            <FBadge color={FT.red}>2 alertas</FBadge>
          </div>
        </div>
        <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
          {ANOMALY_FEED.map((a, i) => (
            <div key={i} style={{ padding: "10px 12px", borderRadius: 6, background: a.severity === "high" ? `${FT.red}08` : a.severity === "medium" ? `${FT.amber}06` : FT.surfaceAlt, border: `1px solid ${a.severity === "high" ? `${FT.red}30` : a.severity === "medium" ? `${FT.amber}25` : FT.border}`, cursor: "pointer", transition: "all 0.2s" }} onClick={() => setExpanded(expanded === i ? null : i)}>
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <FSeverityDot severity={a.severity} />
                <span style={{ fontSize: 12, fontWeight: 700, color: FT.text, fontFamily: "monospace" }}>{a.id}</span>
                <span style={{ fontSize: 10, color: FT.textMuted, marginLeft: "auto" }}>{a.time}</span>
                <span style={{ fontSize: 12, color: FT.textMuted }}>{expanded === i ? "▾" : "▸"}</span>
              </div>
              {expanded === i && (<div style={{ marginTop: 8 }}>
                <p style={{ fontSize: 12, color: FT.textMuted, lineHeight: 1.5, margin: 0 }}>{a.message}</p>
                <div style={{ display: "flex", gap: 8, marginTop: 8 }}>
                  <span style={{ fontSize: 10, color: FT.accent, fontFamily: "monospace" }}>Score: {a.score}</span>
                  <span style={{ fontSize: 10, color: FT.textMuted }}>Flags: {a.flags.toString(2).padStart(3, "0")}</span>
                </div>
                {a.status === "FLAGGED" && (<div style={{ display: "flex", gap: 8, marginTop: 8 }}>
                  <button style={{ padding: "4px 12px", borderRadius: 4, border: `1px solid ${FT.amber}`, background: "transparent", color: FT.amber, fontSize: 11, cursor: "pointer", fontWeight: 600 }}>Investigar</button>
                  <button style={{ padding: "4px 12px", borderRadius: 4, border: `1px solid ${FT.textDim}`, background: "transparent", color: FT.textMuted, fontSize: 11, cursor: "pointer" }}>Descartar</button>
                </div>)}
              </div>)}
            </div>
          ))}
        </div>
        <div style={{ marginTop: 8, display: "flex", alignItems: "center", gap: 6 }}>
          <span style={{ color: FT.green }}>✓</span>
          <span style={{ fontSize: 12, color: FT.green }}>847 entradas sin observaciones</span>
        </div>
      </div>);
    }

    /* P&L HEATMAP */
    function FPLHeatmap() {
      return (<div style={fcard}>
        <div style={fcardGlow(FT.accent)} />
        <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 12 }}>
          <span style={{ fontSize: 12, color: FT.textMuted, letterSpacing: "0.06em", textTransform: "uppercase", fontWeight: 600 }}>📊 P&L Heatmap en Tiempo Real</span>
        </div>
        <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
          {trialBalance.map((row, i) => {
            const pc = (row.actual / row.budget) * 100;
            const isGood = row.type === "RE" ? row.variance > 0 : row.variance < 0;
            const barColor = isGood ? FT.green : Math.abs(row.variance) > 3 ? FT.red : FT.amber;
            return (<div key={i}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 3 }}>
                <span style={{ fontSize: 12, color: FT.text, fontWeight: 500 }}>{row.account}</span>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <span style={{ fontSize: 11, color: FT.textMuted, fontFamily: "monospace" }}>{formatPEN(row.actual)}</span>
                  <span style={{ fontSize: 11, fontWeight: 700, fontFamily: "monospace", color: barColor }}>{row.variance > 0 ? "+" : ""}{row.variance}%</span>
                </div>
              </div>
              <div style={{ height: 10, background: FT.border, borderRadius: 3, overflow: "hidden", position: "relative" }}>
                <div style={{ width: `${Math.min(pc, 120)}%`, height: "100%", background: `linear-gradient(90deg, ${barColor}40, ${barColor}90)`, borderRadius: 3, transition: "width 1s ease" }} />
                <div style={{ position: "absolute", left: "100%", top: 0, bottom: 0, width: 2, background: FT.textDim, transform: "translateX(-1px)" }} />
              </div>
            </div>);
          })}
        </div>
        <div style={{ marginTop: 8, fontSize: 10, color: FT.textDim, textAlign: "right" }}>Línea = Presupuesto</div>
      </div>);
    }

    /* CASH FLOW TIME MACHINE */
    function FCashFlowTimeMachine() {
      const [sliderDay, setSliderDay] = useState(0);
      const sel = cashForecast.find(d => d.day === sliderDay);
      const isHist = sliderDay <= 0;
      return (<div style={{ ...fcard, gridColumn: "1 / -1" }}>
        <div style={fcardGlow(FT.purple)} />
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
          <span style={{ fontSize: 12, color: FT.textMuted, letterSpacing: "0.06em", textTransform: "uppercase", fontWeight: 600 }}>⏳ Máquina del Tiempo — Flujo de Caja</span>
          <FBadge color={isHist ? FT.blue : FT.purple}>{isHist ? "HISTÓRICO" : "PROYECCIÓN"}</FBadge>
        </div>
        {sel && (<div style={{ display: "flex", gap: 20, marginBottom: 8, alignItems: "baseline", flexWrap: "wrap" }}>
          <span style={{ fontSize: 11, color: FT.textMuted }}>{sliderDay === 0 ? "HOY" : sliderDay < 0 ? `Hace ${Math.abs(sliderDay)} días` : `En ${sliderDay} días`} · {sel.date}</span>
          <span style={{ fontSize: 18, fontWeight: 700, fontFamily: "monospace", color: FT.text }}>{formatPEN(sel.expected)}</span>
          {!isHist && <span style={{ fontSize: 11, color: FT.textMuted }}>Rango: {formatPEN(sel.pessimistic || 0)} — {formatPEN(sel.optimistic || 0)}</span>}
        </div>)}
        <div style={{ height: 200 }}>
          <ResponsiveContainer>
            <ComposedChart data={cashForecast} margin={{ top: 5, right: 10, left: 10, bottom: 5 }}>
              <CartesianGrid strokeDasharray="3 3" stroke={FT.border} />
              <XAxis dataKey="label" tick={{ fontSize: 10, fill: FT.textDim }} interval={4} />
              <YAxis tick={{ fontSize: 10, fill: FT.textDim }} tickFormatter={v => `${(v / 1e6).toFixed(1)}M`} domain={["auto", "auto"]} />
              <Tooltip contentStyle={{ background: FT.surfaceAlt, border: `1px solid ${FT.border}`, borderRadius: 6, fontSize: 12 }} labelStyle={{ color: FT.textMuted }} formatter={v => v ? formatPEN(v) : "—"} />
              <Area dataKey="optimistic" stroke="none" fill={FT.purple} fillOpacity={0.08} name="Optimista (p10)" />
              <Area dataKey="pessimistic" stroke="none" fill={FT.purple} fillOpacity={0.08} name="Pesimista (p90)" />
              <Line dataKey="actual" stroke={FT.accent} strokeWidth={2} dot={false} name="Real" />
              <Line dataKey="expected" stroke={FT.purple} strokeWidth={2} dot={false} strokeDasharray="6 3" name="Esperado (p50)" />
            </ComposedChart>
          </ResponsiveContainer>
        </div>
        <div style={{ marginTop: 8, display: "flex", alignItems: "center", gap: 12 }}>
          <span style={{ fontSize: 10, color: FT.textDim, whiteSpace: "nowrap" }}>-30d</span>
          <input type="range" min={-30} max={30} value={sliderDay} onChange={e => setSliderDay(Number(e.target.value))} style={{ flex: 1, accentColor: FT.purple, height: 4, cursor: "pointer" }} />
          <span style={{ fontSize: 10, color: FT.textDim, whiteSpace: "nowrap" }}>+30d</span>
        </div>
        <div style={{ display: "flex", justifyContent: "center", gap: 20, marginTop: 8 }}>
          <span style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 10, color: FT.accent }}><span style={{ width: 16, height: 2, background: FT.accent, display: "inline-block" }} /> Real</span>
          <span style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 10, color: FT.purple }}><span style={{ width: 16, height: 2, background: FT.purple, display: "inline-block", borderTop: "1px dashed" }} /> Proyección p50</span>
          <span style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 10, color: FT.purple }}><span style={{ width: 12, height: 8, background: `${FT.purple}20`, display: "inline-block", borderRadius: 2 }} /> Banda p10-p90</span>
        </div>
      </div>);
    }

    /* AUTONOMOUS JOURNAL */
    function FAutonomousJournal() {
      const typeConfig = { recon: { emoji: "🔗", color: FT.accent }, reclass: { emoji: "🔄", color: FT.blue }, anomaly: { emoji: "⚠️", color: FT.red }, forecast: { emoji: "📈", color: FT.purple }, accrual: { emoji: "📖", color: FT.green } };
      return (<div style={fcard}>
        <div style={fcardGlow(FT.accent)} />
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
          <span style={{ fontSize: 12, color: FT.textMuted, letterSpacing: "0.06em", textTransform: "uppercase", fontWeight: 600 }}>🤖 Diario Autónomo — "El Bot Hizo Esto"</span>
          <FBadge color={FT.accent}>{BOT_ACTIONS.length} acciones hoy</FBadge>
        </div>
        <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
          {BOT_ACTIONS.map(a => {
            const cfg = typeConfig[a.type] || typeConfig.recon;
            return (<div key={a.id} style={{ display: "flex", gap: 10, padding: "10px 10px", borderRadius: 6, background: FT.surfaceAlt, border: `1px solid ${FT.border}`, alignItems: "flex-start" }}>
              <div style={{ width: 30, height: 30, borderRadius: 6, flexShrink: 0, background: `${cfg.color}15`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14 }}>{cfg.emoji}</div>
              <div style={{ flex: 1, minWidth: 0 }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                  <span style={{ fontSize: 12, fontWeight: 600, color: FT.text }}>{a.action}</span>
                  <span style={{ fontSize: 10, color: FT.textDim, fontFamily: "monospace" }}>{a.time}</span>
                </div>
                <p style={{ fontSize: 11, color: FT.textMuted, margin: "3px 0 0", lineHeight: 1.4 }}>{a.detail}</p>
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginTop: 6 }}>
                  <div style={{ height: 3, flex: 1, background: FT.border, borderRadius: 2, overflow: "hidden", maxWidth: 80 }}>
                    <div style={{ width: `${a.confidence}%`, height: "100%", borderRadius: 2, background: a.confidence > 95 ? FT.green : a.confidence > 85 ? FT.accent : FT.amber }} />
                  </div>
                  <span style={{ fontSize: 10, color: FT.textMuted, fontFamily: "monospace" }}>{a.confidence}%</span>
                  {a.type !== "anomaly" && a.type !== "forecast" && (
                    <div style={{ display: "flex", gap: 4, marginLeft: "auto" }}>
                      <button style={{ padding: "2px 8px", borderRadius: 3, fontSize: 10, fontWeight: 600, background: `${FT.green}20`, color: FT.green, border: `1px solid ${FT.green}40`, cursor: "pointer" }}>✓ Aprobar</button>
                      <button style={{ padding: "2px 8px", borderRadius: 3, fontSize: 10, background: "transparent", color: FT.textDim, border: `1px solid ${FT.border}`, cursor: "pointer" }}>✕ Rechazar</button>
                    </div>
                  )}
                </div>
              </div>
            </div>);
          })}
        </div>
      </div>);
    }

    /* INTERCOMPANY NERVE MAP */
    function FIntercompanyMap() {
      const svgRef = useRef(null);
      useEffect(() => {
        if (!svgRef.current) return;
        const svg = d3.select(svgRef.current);
        svg.selectAll("*").remove();
        const nodes = INTERCOMPANY_NODES.map(n => ({ ...n }));
        const links = INTERCOMPANY_EDGES.map(e => ({ ...e, source: nodes.find(n => n.id === e.source), target: nodes.find(n => n.id === e.target) }));
        const g = svg.append("g");
        const linkGroup = g.selectAll(".link").data(links).enter().append("g").attr("class", "link");
        linkGroup.append("line").attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y).attr("stroke", d => d.reconciled ? "#22d3ee50" : "#ef444480").attr("stroke-width", d => Math.max(1.5, d.volume / 1500000)).attr("stroke-dasharray", d => d.reconciled ? "none" : "6 4");
        linkGroup.append("text").attr("x", d => (d.source.x + d.target.x) / 2).attr("y", d => (d.source.y + d.target.y) / 2 - 6).attr("text-anchor", "middle").attr("fill", "#8896ab").attr("font-size", 9).attr("font-family", "monospace").text(d => `S/${(d.volume / 1e6).toFixed(1)}M`);
        const nodeGroup = g.selectAll(".node").data(nodes).enter().append("g").attr("class", "node").attr("transform", d => `translate(${d.x}, ${d.y})`);
        nodeGroup.append("circle").attr("r", d => 12 + d.revenue * 0.8).attr("fill", `${FT.accent}15`).attr("stroke", FT.accent).attr("stroke-width", 1.5);
        nodeGroup.append("text").attr("dy", -22 - 8).attr("text-anchor", "middle").attr("fill", FT.text).attr("font-size", 11).attr("font-weight", 600).text(d => d.label);
        nodeGroup.append("text").attr("dy", 4).attr("text-anchor", "middle").attr("fill", FT.accent).attr("font-size", 10).attr("font-family", "monospace").text(d => `S/${d.revenue}M`);
        const wG = svg.append("g").attr("transform", `translate(612, 8)`);
        wG.append("rect").attr("x", -160).attr("y", 0).attr("width", 160).attr("height", 26).attr("rx", 4).attr("fill", `${FT.amber}18`).attr("stroke", `${FT.amber}40`);
        wG.append("text").attr("x", -80).attr("y", 17).attr("text-anchor", "middle").attr("fill", FT.amber).attr("font-size", 10).attr("font-weight", 600).text("⚠ Flujo circular detectado");
      }, []);
      return (<div style={{ ...fcard, gridColumn: "1 / -1" }}>
        <div style={fcardGlow(FT.accent)} />
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8, flexWrap: "wrap", gap: 8 }}>
          <span style={{ fontSize: 12, color: FT.textMuted, letterSpacing: "0.06em", textTransform: "uppercase", fontWeight: 600 }}>🌐 Mapa Nervioso Intercompañía</span>
          <div style={{ display: "flex", gap: 8 }}>
            <FBadge color={FT.red}>2 sin conciliar</FBadge>
            <FBadge color={FT.amber}>1 flujo circular</FBadge>
          </div>
        </div>
        <div style={{ display: "flex", gap: 16, marginBottom: 8 }}>
          <span style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 10, color: FT.textMuted }}><span style={{ width: 16, height: 2, background: FT.accent, display: "inline-block" }} /> Conciliado</span>
          <span style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 10, color: FT.textMuted }}><span style={{ width: 16, height: 0, borderTop: `2px dashed ${FT.red}`, display: "inline-block" }} /> Sin conciliar</span>
          <span style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 10, color: FT.textMuted }}><span style={{ width: 10, height: 10, borderRadius: "50%", background: `${FT.accent}20`, border: `1px solid ${FT.accent}`, display: "inline-block" }} /> Entidad</span>
        </div>
        <svg ref={svgRef} width="100%" height={320} viewBox="0 0 620 320" style={{ overflow: "visible" }} />
      </div>);
    }

    /* SYSTEM METRICS BAR */
    function FSystemMetrics() {
      return (<div style={{ display: "flex", gap: 16, padding: "8px 12px", background: FT.surfaceAlt, borderRadius: 6, border: `1px solid ${FT.border}`, fontSize: 11, color: FT.textMuted, alignItems: "center", flexWrap: "wrap", marginBottom: 8 }}>
        <span style={{ display: "flex", alignItems: "center", gap: 4 }}><FPulse color={FT.green} size={6} /> Kafka: <span style={{ color: FT.green, fontFamily: "monospace" }}>OK</span></span>
        <span>Journal: <span style={{ color: FT.accent, fontFamily: "monospace" }}>2.4M rows</span></span>
        <span>Ledger p99: <span style={{ color: FT.green, fontFamily: "monospace" }}>23ms</span></span>
        <span>ML Scoring p95: <span style={{ color: FT.accent, fontFamily: "monospace" }}>1.2s</span></span>
        <span>Eventos/min: <span style={{ color: FT.accent, fontFamily: "monospace" }}>847</span></span>
        <span style={{ marginLeft: "auto", fontFamily: "monospace", color: FT.textDim, fontSize: 10 }}>v1.0 · TimescaleDB · OpenTelemetry</span>
      </div>);
    }

    /* UNIVERSAL JOURNAL TABLE */
    function FJournalTable() {
      const rows = [
        { time: "14:23:41", corr: "0194f2a8-...", type: "GRPO", account: "140100", dc: "D", amount: 89000, ccy: "PEN", dims: "CC100, MAT-500", score: 0.89, status: "FLAGGED" },
        { time: "14:23:41", corr: "0194f2a8-...", type: "GRPO", account: "211000", dc: "C", amount: 89000, ccy: "PEN", dims: "V-TechCorp", score: 0.89, status: "FLAGGED" },
        { time: "14:22:18", corr: "0194f2a3-...", type: "APIV", account: "510200", dc: "D", amount: 4200, ccy: "PEN", dims: "CC200", score: 0.12, status: "CLEAR" },
        { time: "14:22:18", corr: "0194f2a3-...", type: "APIV", account: "210100", dc: "C", amount: 4200, ccy: "PEN", dims: "V-Limpieza", score: 0.12, status: "CLEAR" },
        { time: "14:21:05", corr: "0194f29e-...", type: "ARIV", account: "130100", dc: "D", amount: 25600, ccy: "PEN", dims: "CUST-042", score: 0.08, status: "CLEAR" },
        { time: "14:21:05", corr: "0194f29e-...", type: "ARIV", account: "410100", dc: "C", amount: 25600, ccy: "PEN", dims: "PC200", score: 0.08, status: "CLEAR" },
      ];
      return (<div style={fcard}>
        <div style={fcardGlow(FT.blue)} />
        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 }}>
          <span style={{ fontSize: 14, fontWeight: 700, color: FT.text }}>📖 Diario Universal — Últimas Entradas</span>
          <div style={{ display: "flex", alignItems: "center", gap: 8, padding: "6px 12px", borderRadius: 6, background: FT.surfaceAlt, border: `1px solid ${FT.border}` }}>
            <span style={{ fontSize: 12, color: FT.textDim }}>🔍 Buscar por correlación, cuenta, documento...</span>
          </div>
        </div>
        <div style={{ overflowX: "auto" }}>
          <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 11 }}>
            <thead><tr style={{ borderBottom: `1px solid ${FT.border}` }}>
              {["Hora", "Correlation ID", "Tipo", "Cuenta", "D/C", "Monto (FC)", "Mon", "Dims", "Score", "Estado"].map(h => (
                <th key={h} style={{ padding: "8px 6px", textAlign: "left", color: FT.textMuted, fontWeight: 600, letterSpacing: "0.04em", textTransform: "uppercase", fontSize: 10, whiteSpace: "nowrap" }}>{h}</th>
              ))}
            </tr></thead>
            <tbody>
              {rows.map((r, i) => (
                <tr key={i} style={{ borderBottom: `1px solid ${FT.border}`, background: r.status === "FLAGGED" ? `${FT.red}06` : "transparent" }}>
                  <td style={{ padding: 6, fontFamily: "monospace", color: FT.textMuted }}>{r.time}</td>
                  <td style={{ padding: 6, fontFamily: "monospace", color: FT.accent, fontSize: 10 }}>{r.corr}</td>
                  <td style={{ padding: 6 }}><FBadge color={FT.blue}>{r.type}</FBadge></td>
                  <td style={{ padding: 6, fontFamily: "monospace", fontWeight: 600, color: FT.text }}>{r.account}</td>
                  <td style={{ padding: 6 }}><span style={{ display: "inline-flex", width: 18, height: 18, borderRadius: 3, alignItems: "center", justifyContent: "center", fontSize: 10, fontWeight: 700, background: r.dc === "D" ? `${FT.blue}20` : `${FT.green}20`, color: r.dc === "D" ? FT.blue : FT.green }}>{r.dc}</span></td>
                  <td style={{ padding: 6, fontFamily: "monospace", fontWeight: 600, textAlign: "right", color: FT.text }}>{r.amount.toLocaleString("es-PE", { minimumFractionDigits: 2 })}</td>
                  <td style={{ padding: 6, color: FT.textMuted }}>{r.ccy}</td>
                  <td style={{ padding: 6, color: FT.textDim, fontSize: 10 }}>{r.dims}</td>
                  <td style={{ padding: 6 }}><div style={{ width: 32, height: 4, background: FT.border, borderRadius: 2, overflow: "hidden" }}><div style={{ width: `${r.score * 100}%`, height: "100%", background: r.score > 0.65 ? FT.red : r.score > 0.3 ? FT.amber : FT.green, borderRadius: 2 }} /></div></td>
                  <td style={{ padding: 6 }}><FBadge color={r.status === "FLAGGED" ? FT.red : FT.green}>{r.status === "FLAGGED" ? "⚠ FLAG" : "✓ OK"}</FBadge></td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>);
    }

    /* QUICK METRICS CARD */
    function FQuickMetrics() {
      return (<div style={fcard}>
        <div style={fcardGlow(FT.blue)} />
        <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 12 }}>
          <span style={{ fontSize: 12, color: FT.textMuted, letterSpacing: "0.06em", textTransform: "uppercase", fontWeight: 600 }}>📋 Métricas Rápidas</span>
        </div>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 14 }}>
          <FMiniStat label="Entradas hoy" value="849" color={FT.accent} sub="+12% vs promedio" trend="up" />
          <FMiniStat label="Tasa auto-match" value="98.2%" color={FT.green} sub="47/48 líneas" trend="up" />
          <FMiniStat label="Anomalías flag." value="2" color={FT.red} sub="de 849 entradas" trend="down" />
          <FMiniStat label="FX PEN/USD" value="3.742" color={FT.purple} sub="-0.3% hoy" trend="down" />
        </div>
      </div>);
    }

    /* TAB DEFINITIONS */
    const FIN_TABS = [
      { id: "dashboard", l: "Dashboard" }, { id: "journal", l: "Diario Universal" }, { id: "interco", l: "Intercompañía" },
    ];

    return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
      <style>{`@keyframes fin-pulse { 0% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(2); opacity: 0; } 100% { transform: scale(1); opacity: 0; } }`}</style>
      <div style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
        <span style={{ fontSize: 14, fontWeight: 800 }}>FinCore — CFO Cockpit</span>
        <Tabs tabs={FIN_TABS} active={finTab} onChange={setFinTab} />
        <div style={{ marginLeft: "auto", display: "flex", alignItems: "center", gap: 8 }}>
          <span style={{ fontSize: 12, fontWeight: 600, fontFamily: "monospace", color: FT.text }}>{currentTime.toLocaleTimeString("es-PE")}</span>
          <span style={{ fontSize: 10, color: FT.textMuted }}>Periodo 2026-02</span>
        </div>
      </div>

      <FSystemMetrics />

      {finTab === "dashboard" && (
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
          <FCashPosition />
          <FCloseReadiness />
          <FAnomalyFeed />
          <FPLHeatmap />
          <FCashFlowTimeMachine />
          <FAutonomousJournal />
          <FQuickMetrics />
          <FIntercompanyMap />
        </div>
      )}

      {finTab === "journal" && <FJournalTable />}
      {finTab === "interco" && <FIntercompanyMap />}
    </div>);
  }

  /* FORMS */
  const forms = {
    facturas: () => (<G c={2}><Inp l="Serie" v={fv("serie")} onChange={v => sf("serie", v)} req /><Inp l="Numero" v={fv("numero")} onChange={v => sf("numero", v)} req /><Inp l="Fecha" v={fv("fecha", today())} onChange={v => sf("fecha", v)} type="date" /><Inp l="Tipo" v={fv("tipo", "Factura")} onChange={v => sf("tipo", v)} opts={["Factura", "Boleta", "Nota Credito", "Nota Debito"]} /><Inp l="Cliente" v={fv("cliente")} onChange={v => sf("cliente", v)} req /><Inp l="RUC/DNI" v={fv("ruc")} onChange={v => sf("ruc", v)} req /><Inp l="Tipo Doc" v={fv("tipoDoc", "6")} onChange={v => sf("tipoDoc", v)} opts={["6", "1", "4"]} /><Inp l="Moneda" v={fv("moneda", "PEN")} onChange={v => sf("moneda", v)} opts={["PEN", "USD"]} /><Inp l="TC" v={fv("tc", "1.000")} onChange={v => sf("tc", v)} /><Inp l="Base Imponible" v={fv("subtotal")} onChange={setSub2} type="number" req /><Inp l="IGV" v={fv("igv")} ro /><Inp l="Total" v={fv("total")} ro /><Inp l="Estado" v={fv("estado", "Pendiente")} onChange={v => sf("estado", v)} opts={["Pendiente", "Emitida", "Pagada", "Anulada"]} /></G>),
    compras: () => (<G c={2}><Inp l="Serie" v={fv("serie")} onChange={v => sf("serie", v)} req /><Inp l="Numero" v={fv("numero")} onChange={v => sf("numero", v)} req /><Inp l="Fecha" v={fv("fecha", today())} onChange={v => sf("fecha", v)} type="date" /><Inp l="Tipo" v={fv("tipo", "Factura")} onChange={v => sf("tipo", v)} opts={["Factura", "Boleta", "Nota Credito"]} /><Inp l="Proveedor" v={fv("proveedor")} onChange={v => sf("proveedor", v)} req /><Inp l="RUC" v={fv("ruc")} onChange={v => sf("ruc", v)} req /><Inp l="Moneda" v={fv("moneda", "PEN")} onChange={v => sf("moneda", v)} opts={["PEN", "USD"]} /><Inp l="TC" v={fv("tc", "1.000")} onChange={v => sf("tc", v)} /><Inp l="Base Imp." v={fv("subtotal")} onChange={setSub2} type="number" req /><Inp l="IGV" v={fv("igv")} ro /><Inp l="Total" v={fv("total")} ro /><Inp l="DUA" v={fv("dua")} onChange={v => sf("dua", v)} /><Inp l="Estado" v={fv("estado", "Pendiente")} onChange={v => sf("estado", v)} opts={["Pendiente", "Pagado", "Anulada"]} /></G>),
    productos: () => (<G c={2}><Inp l="SKU" v={fv("sku")} onChange={v => sf("sku", v)} req /><Inp l="Nombre" v={fv("nombre")} onChange={v => sf("nombre", v)} req /><Inp l="Categoria" v={fv("categoria")} onChange={v => sf("categoria", v)} opts={["Electronica", "Mecanica", "Quimicos", "Agroindustria"]} /><Inp l="Stock" v={fv("stock", "0")} onChange={v => sf("stock", v)} type="number" /><Inp l="Stock Min" v={fv("stockMin", "0")} onChange={v => sf("stockMin", v)} type="number" /><Inp l="Costo" v={fv("costo")} onChange={v => sf("costo", v)} type="number" /><Inp l="Landed" v={fv("landed")} onChange={v => sf("landed", v)} type="number" /><Inp l="Venta" v={fv("venta")} onChange={v => sf("venta", v)} type="number" /></G>),
    bancos: () => (<G c={2}><Inp l="Banco" v={fv("banco")} onChange={v => sf("banco", v)} opts={["BCP", "BBVA", "Interbank", "Scotiabank"]} /><Inp l="Cuenta" v={fv("cuenta")} onChange={v => sf("cuenta", v)} /><Inp l="Tipo" v={fv("tipo", "Corriente")} onChange={v => sf("tipo", v)} opts={["Corriente", "Ahorro", "CTS"]} /><Inp l="Moneda" v={fv("moneda", "PEN")} onChange={v => sf("moneda", v)} opts={["PEN", "USD"]} /><Inp l="Saldo" v={fv("saldo")} onChange={v => sf("saldo", v)} type="number" /></G>),
    asientos: () => (<G c={2}><Inp l="Numero" v={fv("num")} onChange={v => sf("num", v)} req /><Inp l="Fecha" v={fv("fecha", today())} onChange={v => sf("fecha", v)} type="date" /><Inp l="Glosa" v={fv("glosa")} onChange={v => sf("glosa", v)} /><Inp l="Debe" v={fv("debe")} onChange={v => sf("debe", v)} /><Inp l="Haber" v={fv("haber")} onChange={v => sf("haber", v)} /><Inp l="Monto" v={fv("monto")} onChange={v => sf("monto", v)} type="number" /><Inp l="Tipo" v={fv("tipo")} onChange={v => sf("tipo", v)} opts={["Diario", "Ventas", "Compras", "Importacion"]} /></G>),
    imports: () => (<G c={2}><Inp l="Carpeta" v={fv("folder")} onChange={v => sf("folder", v)} req /><Inp l="B/L" v={fv("bl")} onChange={v => sf("bl", v)} /><Inp l="Proveedor" v={fv("proveedor")} onChange={v => sf("proveedor", v)} /><Inp l="FOB" v={fv("fob")} onChange={v => sf("fob", v)} type="number" /><Inp l="CIF" v={fv("cif")} onChange={v => sf("cif", v)} type="number" /><Inp l="Estado" v={fv("estado", "Borrador")} onChange={v => sf("estado", v)} opts={["Borrador", "En Transito", "Nacionalizado"]} /></G>),
    exports: () => (<G c={2}><Inp l="Booking" v={fv("booking")} onChange={v => sf("booking", v)} req /><Inp l="Cliente" v={fv("cliente")} onChange={v => sf("cliente", v)} /><Inp l="Destino" v={fv("destino")} onChange={v => sf("destino", v)} /><Inp l="FOB" v={fv("fob")} onChange={v => sf("fob", v)} type="number" /><Inp l="Estado" v={fv("estado", "Documentacion")} onChange={v => sf("estado", v)} opts={["Documentacion", "En Transito", "Entregado"]} /></G>),
  };

  /* TABLE */
  function TH({ title, table, cols, data, skeys, extra, acts, noAdd }) {
    const fd2 = filt(data, skeys || []);
    return (<div style={{ display: "flex", flexDirection: "column", gap: 10 }}>{extra}
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: 6 }}>
        <div style={{ fontSize: 14, fontWeight: 700 }}>{title} <span style={{ color: P.s2, fontSize: 11 }}>({fd2.length})</span></div>
        <div style={{ display: "flex", gap: 5, alignItems: "center", flexWrap: "wrap" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 4, background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 5, padding: "4px 7px" }}><I.Se /><input value={search} onChange={e => setSearch(e.target.value)} placeholder="Buscar..." style={{ background: "transparent", border: "none", color: P.tx, fontSize: 10, outline: "none", width: 100 }} />{search && <button onClick={() => setSearch("")} style={{ background: "none", border: "none", color: P.s2, cursor: "pointer", padding: 0 }}><I.Xx /></button>}</div>
          {acts}{!noAdd && <Btn p onClick={() => { setFd({}); setMl({ type: table, editing: false }); }}><I.Pl /> Nuevo</Btn>}
        </div>
      </div>
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 9, overflow: "hidden" }}><div style={{ overflowX: "auto" }}>
        <table style={{ width: "100%", borderCollapse: "collapse" }}>
          <thead><tr>{cols.map(h => (<th key={h.k || h.l} style={{ textAlign: h.r ? "right" : "left", padding: "6px 7px", color: P.s2, fontSize: 8, fontWeight: 700, borderBottom: `1px solid ${P.bd}`, textTransform: "uppercase", whiteSpace: "nowrap" }}>{h.l}</th>))}<th style={{ width: 50 }}></th></tr></thead>
          <tbody>{fd2.length === 0 ? <tr><td colSpan={cols.length + 1} style={{ padding: 24, textAlign: "center", color: P.s2, fontSize: 11 }}>Sin registros</td></tr> : fd2.map((r, i) => (
            <tr key={r.id || i} style={{ borderBottom: "1px solid #0c1320" }} onMouseEnter={e => e.currentTarget.style.background = P.hv} onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
              {cols.map(h => (<td key={h.k || h.l} style={{ padding: "5px 7px", color: h.c?.(r) || h.color || (h.b ? P.tx : P.s1), fontSize: 10, fontWeight: h.b ? 600 : 400, fontFamily: h.mono ? "monospace" : "inherit", textAlign: h.r ? "right" : "left", whiteSpace: "nowrap", maxWidth: 160, overflow: "hidden", textOverflow: "ellipsis" }}>{h.render ? h.render(r) : h.fmt ? h.fmt(r[h.k]) : r[h.k]}</td>))}
              <td style={{ padding: "5px 7px" }}><div style={{ display: "flex", gap: 2 }}><button onClick={() => { setFd({ ...r }); setMl({ type: table, editing: true, id: r.id }); }} style={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 3, padding: 2, color: P.s1, cursor: "pointer", display: "flex" }}><I.Ed /></button><button onClick={() => setCfm({ msg: "¿Eliminar?", fn: () => del(table, r.id) })} style={{ background: "#FF453A08", border: "1px solid #FF453A18", borderRadius: 3, padding: 2, color: P.red, cursor: "pointer", display: "flex" }}><I.Tr /></button></div></td>
            </tr>))}</tbody>
        </table></div></div>
    </div>);
  }

  /* ===== ENHANCED DASHBOARD ===== */
  function VDash() {
    return (
      <div ref={dashRef} style={{ display: "flex", flexDirection: "column", gap: 10 }}>
        {/* Download Bar */}
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <div style={{ fontSize: 15, fontWeight: 800 }}>Dashboard Ejecutivo</div>
          <div style={{ display: "flex", gap: 5 }}>
            <Btn s onClick={() => { notify("Generando imagen..."); setTimeout(() => { const el = dashRef.current; if (el) captureEl(el, "png"); }, 200); }}><I.Im /> PNG</Btn>
            <Btn s onClick={() => { notify("Generando JPG..."); setTimeout(() => { const el = dashRef.current; if (el) captureEl(el, "jpg"); }, 200); }}><I.Im /> JPG</Btn>
            <Btn s onClick={() => {
              exportCSV([{ Metrica: "Ventas", Monto: tv }, { Metrica: "Compras", Monto: tc2 }, { Metrica: "Utilidad Bruta", Monto: tv - tc2 }, { Metrica: "Planilla", Monto: tp }, { Metrica: "Inv. Almacen MRPII", Monto: mrpVal }, { Metrica: "IGV Neto", Monto: igvD - igvC }, { Metrica: "Tributos Pend", Monto: tt }, { Metrica: "Bancos", Monto: tb }], [{ k: "Metrica", l: "Metrica" }, { k: "Monto", l: "Monto" }], `Dashboard_Resumen_${today()}`);
            }}><I.Dw /> CSV</Btn>
          </div>
        </div>

        {/* KPIs */}
        <G c={5}>
          <K l="Ventas" v={$(tv)} icon={<I.Sa />} color={P.grn} sub={`${D.facturas.length} CDP`} glow onClick={() => setMod("sales")} />
          <K l="Compras" v={$(tc2)} icon={<I.Bx />} color={P.org} sub={`${D.compras.length} CDP`} onClick={() => setMod("compras")} />
          <K l="Utilidad Bruta" v={$(tv - tc2)} icon={<I.Sp />} color={tv > tc2 ? P.grn : P.red} sub={`Margen: ${tv > 0 ? ((tv - tc2) / tv * 100).toFixed(1) : 0}%`} glow />
          <K l="IGV Neto" v={$(igvD - igvC)} icon={<I.Cd />} color={igvD > igvC ? P.red : P.grn} sub={`D:${$(igvD)} C:${$(igvC)}`} />
          <K l="Bancos" v={$(tb)} icon={<I.Bk />} color={P.cyan} sub={`${D.bancos.length} cuentas`} onClick={() => setMod("fin")} />
        </G>

        {/* Charts Row 1 */}
        <G c={2}>
          <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 9, padding: 14 }}>
            <div style={{ fontSize: 11, fontWeight: 700, marginBottom: 8, display: "flex", justifyContent: "space-between" }}><span>Tendencia Ventas vs Compras</span><Badge s="Tiempo Real" c={P.grn} /></div>
            {monthData.length > 0 ? (
              <ResponsiveContainer width="100%" height={170}>
                <AreaChart data={monthData}>
                  <defs><linearGradient id="gv" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={P.grn} stopOpacity={.3}/><stop offset="95%" stopColor={P.grn} stopOpacity={0}/></linearGradient><linearGradient id="gc" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={P.org} stopOpacity={.3}/><stop offset="95%" stopColor={P.org} stopOpacity={0}/></linearGradient></defs>
                  <CartesianGrid strokeDasharray="3 3" stroke={P.bd} />
                  <XAxis dataKey="m" tick={{ fill: P.s2, fontSize: 9 }} axisLine={false} />
                  <YAxis tick={{ fill: P.s2, fontSize: 8 }} axisLine={false} tickFormatter={v => `${(v / 1000).toFixed(0)}k`} />
                  <Tooltip contentStyle={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 6, fontSize: 10 }} formatter={v => $(v)} />
                  <Area type="monotone" dataKey="v" stroke={P.grn} fill="url(#gv)" strokeWidth={2} name="Ventas" />
                  <Area type="monotone" dataKey="c" stroke={P.org} fill="url(#gc)" strokeWidth={2} name="Compras" />
                  <Legend wrapperStyle={{ fontSize: 9 }} />
                </AreaChart>
              </ResponsiveContainer>
            ) : (
              <div style={{ height: 170, display: "flex", alignItems: "center", justifyContent: "center", color: P.s2, fontSize: 11 }}>Sin registros · Escanea o registra ventas y compras</div>
            )}
          </div>
          <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 9, padding: 14 }}>
            <div style={{ fontSize: 11, fontWeight: 700, marginBottom: 8 }}>Utilidad Mensual</div>
            {monthData.length > 0 ? (
              <ResponsiveContainer width="100%" height={170}>
                <BarChart data={monthData}>
                  <CartesianGrid strokeDasharray="3 3" stroke={P.bd} />
                  <XAxis dataKey="m" tick={{ fill: P.s2, fontSize: 9 }} axisLine={false} />
                  <YAxis tick={{ fill: P.s2, fontSize: 8 }} axisLine={false} tickFormatter={v => `${(v / 1000).toFixed(0)}k`} />
                  <Tooltip contentStyle={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 6, fontSize: 10 }} formatter={v => $(v)} />
                  <Bar dataKey="g" radius={[4, 4, 0, 0]} name="Utilidad">{monthData.map((_, i) => <Cell key={i} fill={P.grn} />)}</Bar>
                </BarChart>
              </ResponsiveContainer>
            ) : (
              <div style={{ height: 170, display: "flex", alignItems: "center", justifyContent: "center", color: P.s2, fontSize: 11 }}>Sin datos de utilidad</div>
            )}
          </div>
        </G>

        {/* Charts Row 2 */}
        <G c={3}>
          <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 9, padding: 14 }}>
            <div style={{ fontSize: 11, fontWeight: 700, marginBottom: 6 }}>Inventario por Categoria</div>
            {catData.length > 0 ? (
              <><ResponsiveContainer width="100%" height={155}>
                <PieChart><Pie data={catData} cx="50%" cy="50%" innerRadius={30} outerRadius={58} paddingAngle={3} dataKey="value">{catData.map((_, i) => <Cell key={i} fill={pieColors[i % pieColors.length]} />)}</Pie><Tooltip contentStyle={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 6, fontSize: 9 }} formatter={v => $(v)} /></PieChart>
              </ResponsiveContainer>
              <div style={{ display: "flex", flexWrap: "wrap", gap: 6, justifyContent: "center" }}>{catData.map((c, i) => (<span key={i} style={{ fontSize: 8, color: pieColors[i % pieColors.length], display: "flex", alignItems: "center", gap: 3 }}><span style={{ width: 6, height: 6, borderRadius: 2, background: pieColors[i % pieColors.length], display: "inline-block" }} />{c.name}</span>))}</div></>
            ) : (
              <div style={{ height: 155, display: "flex", alignItems: "center", justifyContent: "center", color: P.s2, fontSize: 11 }}>Sin productos</div>
            )}
          </div>
          <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 9, padding: 14 }}>
            <div style={{ fontSize: 11, fontWeight: 700, marginBottom: 6 }}>Estado Ventas</div>
            {estadoVentas.length > 0 ? (
              <ResponsiveContainer width="100%" height={155}>
                <PieChart><Pie data={estadoVentas} cx="50%" cy="50%" outerRadius={58} dataKey="value" label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}>{estadoVentas.map((e, i) => <Cell key={i} fill={e.color} />)}</Pie><Tooltip contentStyle={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 6, fontSize: 9 }} /></PieChart>
              </ResponsiveContainer>
            ) : (
              <div style={{ height: 155, display: "flex", alignItems: "center", justifyContent: "center", color: P.s2, fontSize: 11 }}>Sin facturas emitidas</div>
            )}
          </div>
          <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 9, padding: 14 }}>
            <div style={{ fontSize: 11, fontWeight: 700, marginBottom: 6 }}>Salud Operativa</div>
            <ResponsiveContainer width="100%" height={155}>
              <RadarChart data={radarData}><PolarGrid stroke={P.bd} /><PolarAngleAxis dataKey="s" tick={{ fill: P.s2, fontSize: 8 }} /><PolarRadiusAxis tick={false} domain={[0, 100]} /><Radar dataKey="v" stroke={P.blue} fill={P.blue} fillOpacity={.2} strokeWidth={2} /></RadarChart>
            </ResponsiveContainer>
          </div>
        </G>

        {/* Bottom Row */}
        <G c={2}>
          <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 9, padding: 14 }}>
            <div style={{ fontSize: 11, fontWeight: 700, marginBottom: 6 }}>Flujo de Caja</div>
            <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
              {[{ l: "Ingresos Ventas", v: tv, c: P.grn }, { l: "Egresos Compras", v: -tc2, c: P.red }, { l: "Planilla", v: -tp, c: P.org }, { l: "Inv. Almacen", v: mrpVal, c: P.lime }, { l: "IGV Neto", v: -(igvD - igvC), c: P.pk }, { l: "Tributos Pend.", v: -tt, c: P.red }, { l: "Saldo Bancos", v: tb, c: P.cyan }].map((r, i) => (
                <div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "5px 0", borderBottom: `1px solid ${P.bd}10` }}>
                  <span style={{ fontSize: 10, color: P.s1 }}>{r.l}</span>
                  <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                    <div style={{ width: Math.min(Math.abs(r.v) / 3000, 80), height: 6, borderRadius: 3, background: r.c + "40" }} />
                    <span style={{ fontSize: 10, fontWeight: 700, color: r.c, minWidth: 80, textAlign: "right" }}>{$(r.v)}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
          <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 9, padding: 14 }}>
            <div style={{ fontSize: 11, fontWeight: 700, marginBottom: 6 }}>Alertas & Vencimientos</div>
            {lowS.map(p => (<div key={p.id} style={{ display: "flex", justifyContent: "space-between", padding: "4px 0", fontSize: 10 }}><span style={{ color: P.red }}>⚠ {p.sku}: Stock {p.stock}/{p.stockMin}</span></div>))}
            {INSUMOS_MRP.filter(i => i.stock_actual <= i.stock_minimo).map((i, x) => (<div key={`mrp${x}`} style={{ display: "flex", justifyContent: "space-between", padding: "4px 0", fontSize: 10 }}><span style={{ color: P.org }}>🏗 {i.codigo}: {fmtI(i.stock_actual)}/{fmtI(i.stock_minimo)} {i.unidad}</span></div>))}
            {EQUIPOS_MRP.filter(e => e.estado === "VENCIDO").map((e, x) => (<div key={`eq${x}`} style={{ display: "flex", justifyContent: "space-between", padding: "4px 0", fontSize: 10 }}><span style={{ color: P.red }}>🔧 {e.descripcion}: Mto VENCIDO ({e.hrs_rest}HM)</span></div>))}
            {SHADOW_ALERTS.filter(a => !a.resolved && a.severity === "CRITICAL").map((a, x) => (<div key={`sh${x}`} style={{ display: "flex", justifyContent: "space-between", padding: "4px 0", fontSize: 10 }}><span style={{ color: P.red }}>🔴 {a.type}: {a.desc.substring(0, 50)}...</span></div>))}
            <div style={{ marginTop: 8, padding: "8px", background: `${P.blue}08`, border: `1px solid ${P.blue}20`, borderRadius: 6 }}>
              <div style={{ fontSize: 9, color: P.blue, fontWeight: 700 }}>📊 Plan: {subscription.plan.toUpperCase()} · {subscription.daysLeft} dias restantes</div>
            </div>
          </div>
        </G>
      </div>
    );
  }

  /* SIRE VIEW */
  function SIREV({ title, sireData, sireCols, fn }) {
    return (
      <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 9, overflow: "hidden", marginTop: 8 }}>
        <div style={{ padding: "8px 12px", borderBottom: `1px solid ${P.bd}`, display: "flex", justifyContent: "space-between", alignItems: "center", background: "linear-gradient(90deg,#0A84FF06,#32D74B06)" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 5 }}><I.Cl /><span style={{ fontSize: 11, fontWeight: 700 }}>{title} — SIRE</span><Badge s={`${sireData.length}`} c={P.blue} /></div>
          <div style={{ display: "flex", gap: 4 }}>
            <Btn s onClick={() => { const sc = sireCols.map(c => ({ k: c.k, l: c.l, num: ["subtotal", "igv", "total", "mtoIGV", "mtoTotal", "mtoBase"].includes(c.k) })); exportXLS(sireData, fn, sc); notify("SIRE XLS exportado"); }} style={{ background: P.grn + "15", color: P.grn, border: `1px solid ${P.grn}30` }}><I.Dw /> XLS</Btn>
            <Btn s onClick={() => { exportCSV(sireData, sireCols, fn); notify("Exportado SIRE → Google Sheets"); }} style={{ background: "#34A853", color: "#fff", border: "none" }}><I.Dw /> CSV Sheets</Btn>
          </div>
        </div>
        <div style={{ overflowX: "auto", maxHeight: 200 }}><table style={{ width: "100%", borderCollapse: "collapse" }}><thead><tr>{sireCols.map(c => (<th key={c.k} style={{ padding: "4px 5px", color: P.s2, fontSize: 7, fontWeight: 700, borderBottom: `1px solid ${P.bd}`, textTransform: "uppercase", whiteSpace: "nowrap", position: "sticky", top: 0, background: P.c1 }}>{c.l}</th>))}</tr></thead><tbody>{sireData.map((r, i) => (<tr key={i} style={{ borderBottom: "1px solid #0c1320" }}>{sireCols.map(c => (<td key={c.k} style={{ padding: "3px 5px", color: P.s1, fontSize: 9, fontFamily: "monospace", whiteSpace: "nowrap" }}>{r[c.k]}</td>))}</tr>))}</tbody></table></div>
      </div>
    );
  }

  /* PLANS VIEW */
  function VPlans() {
    return (
      <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
        <div style={{ textAlign: "center", marginBottom: 4 }}><div style={{ fontSize: 18, fontWeight: 800 }}>Planes SumaERP</div><div style={{ fontSize: 11, color: P.s2 }}>Elige el plan ideal para tu empresa · Paga con Yape o tarjeta</div></div>
        <div style={{ display: "grid", gridTemplateColumns: "repeat(4,1fr)", gap: 10 }}>
          {PLANS.map(p => (
            <div key={p.id} style={{ background: P.c1, border: `1.5px solid ${p.popular ? p.color : P.bd}`, borderRadius: 12, padding: 18, display: "flex", flexDirection: "column", position: "relative", boxShadow: p.popular ? `0 0 30px ${p.color}15` : "none" }}>
              {p.popular && <div style={{ position: "absolute", top: -10, left: "50%", transform: "translateX(-50%)", background: p.color, color: "#fff", fontSize: 8, fontWeight: 700, padding: "3px 10px", borderRadius: 10 }}>MAS POPULAR</div>}
              {p.badge && <div style={{ position: "absolute", top: -10, left: "50%", transform: "translateX(-50%)", background: p.color, color: "#fff", fontSize: 8, fontWeight: 700, padding: "3px 10px", borderRadius: 10 }}>{p.badge}</div>}
              <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 10, marginTop: p.popular || p.badge ? 6 : 0 }}><span style={{ color: p.color }}>{p.icon}</span><span style={{ fontSize: 14, fontWeight: 800 }}>{p.name}</span></div>
              <div style={{ display: "flex", alignItems: "baseline", gap: 3, marginBottom: 12 }}><span style={{ fontSize: 28, fontWeight: 800, color: p.color }}>{p.price === 0 ? "Gratis" : `S/${p.price}`}</span>{p.price > 0 && <span style={{ fontSize: 10, color: P.s2 }}>{p.period}</span>}</div>
              <div style={{ flex: 1, display: "flex", flexDirection: "column", gap: 5, marginBottom: 14 }}>
                {p.features.map((f, i) => (<div key={i} style={{ display: "flex", alignItems: "center", gap: 5, fontSize: 10, color: P.s1 }}><span style={{ color: p.color }}><I.Ck /></span>{f}</div>))}
              </div>
              <Btn p={p.popular} full onClick={() => selectPlan(p)} style={{ padding: "9px", borderRadius: 7, ...(p.popular ? {} : { background: p.color + "15", color: p.color, border: `1px solid ${p.color}30` }) }}>
                {p.price === 0 ? "Iniciar Free Trial" : "Seleccionar"} {p.price > 0 && <I.Sa />}
              </Btn>
            </div>
          ))}
        </div>
        <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 9, padding: 14, display: "flex", alignItems: "center", justifyContent: "center", gap: 16 }}>
          <div style={{ display: "flex", alignItems: "center", gap: 6 }}><YapeIcon /><span style={{ fontSize: 11, color: P.s1 }}>Paga con Yape</span></div>
          <div style={{ height: 20, width: 1, background: P.bd }} />
          <div style={{ display: "flex", alignItems: "center", gap: 4 }}><I.Cd /><span style={{ fontSize: 11, color: P.s1 }}>Visa / Mastercard</span></div>
          <div style={{ height: 20, width: 1, background: P.bd }} />
          <div style={{ display: "flex", alignItems: "center", gap: 4 }}><I.Bk /><span style={{ fontSize: 11, color: P.s1 }}>Transferencia</span></div>
        </div>
      </div>
    );
  }

  /* CONTENT */
  const content = () => {
    switch (mod) {
      case "dash": return <VDash />;
      case "sales": return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
        {user?.role === "cliente" ? (
          /* Client view - ventas with scanning */
          <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <div><div style={{ fontSize: 14, fontWeight: 800 }}>Mis Ventas · {user.empresaRazon || "Mi Empresa"}</div><div style={{ fontSize: 9, color: P.s2 }}>RUC: {user.empresaRuc} · Facturas y boletas emitidas</div></div>
              <div style={{ display: "flex", gap: 5 }}>
                <Btn s onClick={() => handleClientScan("ventas")} style={{ background: `${P.tl}15`, color: P.tl, border: `1px solid ${P.tl}30` }}><I.Sc /> Escanear Documento</Btn>
                <Btn s onClick={() => { setFd({}); setMl({ type: "facturas", editing: false }); }} style={{ background: P.grn + "15", color: P.grn, border: `1px solid ${P.grn}30` }}><I.Pl /> Nuevo</Btn>
                <Btn s onClick={() => exportXLS(filteredVentasDocs, `Ventas_${user.empresaRuc}_${today()}`)} style={{ background: `${P.grn}15`, color: P.grn, border: `1px solid ${P.grn}30` }}><I.Dw /> Exportar</Btn>
              </div>
            </div>
            <G c={4}>
              <K l="Total Docs" v={filteredVentasDocs.length} icon={<I.Sa />} color={P.grn} />
              <K l="Procesados" v={filteredVentasDocs.filter(d => d.estado === "Procesado").length} icon={<I.Ck />} color={P.grn} />
              <K l="Monto Total" v={$(filteredVentasDocs.reduce((a, d) => a + nn(d.total), 0))} icon={<I.Dl />} color={P.blue} />
              <K l="IGV Debito" v={$(filteredVentasDocs.reduce((a, d) => a + nn(d.igv), 0))} icon={<I.Cd />} color={P.red} />
            </G>
            <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
              <div style={{ overflowX: "auto" }}>
                <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 10 }}>
                  <thead><tr style={{ borderBottom: `1px solid ${P.bd}` }}>
                    <th style={cH}>Serie-Num</th><th style={cH}>Fecha</th><th style={cH}>Tipo</th><th style={cH}>Cliente</th><th style={{ ...cH, textAlign: "right" }}>Total</th><th style={cH}>Estado</th><th style={cH}>IA</th>
                  </tr></thead>
                  <tbody>{filteredVentasDocs.length === 0 ? (
                    <tr><td colSpan={7} style={{ padding: 24, textAlign: "center", color: P.s2, fontSize: 11 }}>Sin documentos de venta. Usa "Escanear Documento" para registrar.</td></tr>
                  ) : filteredVentasDocs.map(d => (
                    <tr key={d.id} style={{ borderBottom: `1px solid ${P.bd}10` }} onMouseEnter={e => e.currentTarget.style.background = P.hv} onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
                      <td style={{ ...cS, fontFamily: "monospace", color: P.blue, fontWeight: 600 }}>{d.serie}-{d.numero}</td>
                      <td style={cS}>{d.fecha}</td><td style={cS}>{d.tipo}</td>
                      <td style={cS}>{d.proveedor || d.cliente || "—"}</td>
                      <td style={{ ...cS, textAlign: "right", fontWeight: 700 }}>{d.moneda === "USD" ? "$ " : "S/ "}{fmtN(d.total)}</td>
                      <td style={cS}><CBadge s={d.estado} c={d.estado === "Procesado" ? P.grn : P.org} /></td>
                      <td style={cS}><CBadge s={d.scanIA} c={d.scanIA === "Aprobado IA" ? P.grn : P.org} /></td>
                    </tr>
                  ))}</tbody>
                </table>
              </div>
            </div>
          </div>
        ) : (
          /* Contador/Admin ventas */
          <><TH title="Registro Ventas" table="facturas" data={D.facturas} skeys={["serie", "numero", "cliente", "ruc"]} acts={<><Btn s onClick={() => doScan("ventas")} style={{ background: `${P.tl}15`, color: P.tl, border: `1px solid ${P.tl}30` }}><I.Sc /> Escanear</Btn><Btn s onClick={() => { const vc = [{ k: "serie", l: "Serie" }, { k: "numero", l: "Numero" }, { k: "fecha", l: "Fecha" }, { k: "tipo", l: "Tipo" }, { k: "cliente", l: "Cliente" }, { k: "ruc", l: "RUC" }, { k: "moneda", l: "Moneda" }, { k: "subtotal", l: "Subtotal", num: 1 }, { k: "igv", l: "IGV", num: 1 }, { k: "total", l: "Total", num: 1 }, { k: "estado", l: "Estado" }]; exportXLS(D.facturas, `Ventas_SIRE_${today()}`, vc); notify("Ventas XLS exportado"); }} style={{ background: P.grn + "15", color: P.grn, border: `1px solid ${P.grn}30` }}><I.Dw /> XLS</Btn></>} extra={<G c={4}><K l="Total" v={$(tv)} icon={<I.Sa />} color={P.grn} /><K l="Pagadas" v={D.facturas.filter(f => f.estado === "Pagada").length} icon={<I.Ck />} color={P.grn} /><K l="Pendientes" v={D.facturas.filter(f => f.estado === "Pendiente").length} icon={<I.Wn />} color={P.org} /><K l="IGV Debito" v={$(igvD)} icon={<I.Cd />} color={P.red} /></G>} cols={[{ k: "serie", l: "Serie", mono: 1, color: "#5B9CF6", b: 1 }, { k: "numero", l: "Num", mono: 1 }, { k: "fecha", l: "Fecha" }, { k: "tipo", l: "Tipo" }, { k: "cliente", l: "Cliente" }, { k: "ruc", l: "RUC", mono: 1 }, { k: "moneda", l: "Mon", color: P.yel }, { k: "subtotal", l: "Base", r: 1, fmt: v => $(v) }, { k: "igv", l: "IGV", r: 1, fmt: v => $(v) }, { k: "total", l: "Total", r: 1, b: 1, fmt: v => $(v) }, { k: "estado", l: "Est", render: r => <Badge s={r.estado} /> }]} />
          <SIREV title="Reg. Ventas" sireData={genSV()} sireCols={SIRE_V} fn={`SIRE_Ventas_${today()}`} /></>
        )}
      </div>);
      case "compras": return (<div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
        {user?.role === "cliente" ? (
          /* Client view - compras with scanning */
          <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <div><div style={{ fontSize: 14, fontWeight: 800 }}>Mis Compras · {user.empresaRazon || "Mi Empresa"}</div><div style={{ fontSize: 9, color: P.s2 }}>RUC: {user.empresaRuc} · Documentos escaneados para procesamiento contable</div></div>
              <div style={{ display: "flex", gap: 5 }}>
                <Btn s onClick={() => handleClientScan("compras")} style={{ background: `${P.tl}15`, color: P.tl, border: `1px solid ${P.tl}30` }}><I.Sc /> Escanear Documento</Btn>
                <Btn s onClick={() => exportXLS(filteredComprasDocs, `Compras_${user.empresaRuc}_${today()}`)} style={{ background: `${P.grn}15`, color: P.grn, border: `1px solid ${P.grn}30` }}><I.Dw /> Exportar XLS</Btn>
              </div>
            </div>
            <G c={4}>
              <K l="Total Docs" v={filteredComprasDocs.length} icon={<I.Bx />} color={P.org} />
              <K l="Procesados" v={filteredComprasDocs.filter(d => d.estado === "Procesado").length} icon={<I.Ck />} color={P.grn} />
              <K l="Monto Total" v={$(filteredComprasDocs.reduce((a, d) => a + nn(d.total), 0))} icon={<I.Dl />} color={P.blue} />
              <K l="IGV Credito" v={$(filteredComprasDocs.reduce((a, d) => a + nn(d.igv), 0))} icon={<I.Cd />} color={P.cyan} />
            </G>
            <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12 }}>
              <div style={{ overflowX: "auto" }}>
                <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 10 }}>
                  <thead><tr style={{ borderBottom: `1px solid ${P.bd}` }}>
                    <th style={cH}>Serie-Num</th><th style={cH}>Fecha</th><th style={cH}>Tipo</th><th style={cH}>Proveedor</th><th style={{ ...cH, textAlign: "right" }}>Total</th><th style={cH}>Estado</th><th style={cH}>IA</th>
                  </tr></thead>
                  <tbody>{filteredComprasDocs.map(d => (
                    <tr key={d.id} style={{ borderBottom: `1px solid ${P.bd}10` }} onMouseEnter={e => e.currentTarget.style.background = P.hv} onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
                      <td style={{ ...cS, fontFamily: "monospace", color: P.blue, fontWeight: 600 }}>{d.serie}-{d.numero}</td>
                      <td style={cS}>{d.fecha}</td><td style={cS}>{d.tipo}</td>
                      <td style={cS}>{d.proveedor}</td>
                      <td style={{ ...cS, textAlign: "right", fontWeight: 700 }}>S/ {fmtN(d.total)}</td>
                      <td style={cS}><CBadge s={d.estado} c={d.estado === "Procesado" ? P.grn : P.org} /></td>
                      <td style={cS}><CBadge s={d.scanIA} c={d.scanIA === "Aprobado IA" ? P.grn : P.org} /></td>
                    </tr>
                  ))}</tbody>
                </table>
              </div>
            </div>
          </div>
        ) : (
          /* Contador/Admin original compras */
          <><TH title="Registro Compras" table="compras" data={D.compras} skeys={["serie", "numero", "proveedor", "ruc"]} acts={<><Btn s onClick={() => doScan("compras")} style={{ background: `${P.tl}15`, color: P.tl, border: `1px solid ${P.tl}30` }}><I.Sc /> Escanear</Btn><Btn s onClick={() => { const cc = [{ k: "serie", l: "Serie" }, { k: "numero", l: "Numero" }, { k: "fecha", l: "Fecha" }, { k: "proveedor", l: "Proveedor" }, { k: "ruc", l: "RUC" }, { k: "moneda", l: "Moneda" }, { k: "subtotal", l: "Subtotal", num: 1 }, { k: "igv", l: "IGV", num: 1 }, { k: "total", l: "Total", num: 1 }, { k: "dua", l: "DUA" }, { k: "estado", l: "Estado" }]; exportXLS(D.compras, `Compras_SIRE_${today()}`, cc); notify("Compras XLS exportado"); }} style={{ background: P.grn + "15", color: P.grn, border: `1px solid ${P.grn}30` }}><I.Dw /> XLS</Btn></>} extra={<G c={4}><K l="Total" v={$(tc2)} icon={<I.Bx />} color={P.org} /><K l="Pagados" v={D.compras.filter(c => c.estado === "Pagado").length} icon={<I.Ck />} color={P.grn} /><K l="Pendientes" v={D.compras.filter(c => c.estado === "Pendiente").length} icon={<I.Wn />} color={P.org} /><K l="IGV Credito" v={$(igvC)} icon={<I.Cd />} color={P.blue} /></G>} cols={[{ k: "serie", l: "Serie", mono: 1, color: "#5B9CF6", b: 1 }, { k: "numero", l: "Num", mono: 1 }, { k: "fecha", l: "Fecha" }, { k: "proveedor", l: "Proveedor" }, { k: "ruc", l: "RUC", mono: 1 }, { k: "moneda", l: "Mon", color: P.yel }, { k: "subtotal", l: "Base", r: 1, fmt: v => $(v) }, { k: "igv", l: "IGV", r: 1, fmt: v => $(v) }, { k: "total", l: "Total", r: 1, b: 1, fmt: v => $(v) }, { k: "dua", l: "DUA", mono: 1, color: P.cyan }, { k: "estado", l: "Est", render: r => <Badge s={r.estado} /> }]} />
          <SIREV title="Reg. Compras" sireData={genSC()} sireCols={SIRE_C} fn={`SIRE_Compras_${today()}`} /></>
        )}
      </div>);
      case "plans": return <VPlans />;
      case "database": return (<div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
        <G c={3}><K l="Registros" v={Object.values(D).reduce((a, t) => a + (Array.isArray(t) ? t.length : 0), 0)} icon={<I.Db />} color={P.blue} /><K l="Tablas" v={Object.keys(D).length} icon={<I.Cl />} color={P.cyan} /><K l="Perfil" v={user.role} icon={<I.Ge />} color={P.pur} /></G>
        <div style={{ display: "flex", gap: 6 }}>
          <Btn p onClick={() => { const all = Object.entries(D).filter(([,v]) => Array.isArray(v) && v.length).map(([k, v]) => ({ k, cols: Object.keys(v[0]).filter(x => x !== "id").map(x => ({ k: x, l: x })), data: v })); if (all.length) { const biggest = all.reduce((a, b) => b.data.length > a.data.length ? b : a); exportCSV(biggest.data, biggest.cols, `SumaERP_${biggest.k}_${today()}`); } }}><I.Dw /> Exportar Tabla Principal</Btn>
          <Btn d onClick={() => setCfm({ msg: "⚠️ Limpiar TODA la base de datos, registros escaneados, RRHH y dashboards? Esta acción no se puede deshacer.", fn: () => { setD(initData()); setScannedDocs([]); setHR({ empleados: [], requisiciones: [], postulantes: [], asistencia: [], vacaciones: [], capacitaciones: [], prestamos: [], solicitudesESS: [] }); setCfm(null); notify("✅ Sistema limpio · Todas las BD, registros y dashboards reiniciados"); } })}><I.Tr /> Limpiar BD</Btn>
        </div>
        {Object.entries(D).map(([k, v]) => Array.isArray(v) ? (
          <div key={k} style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 10, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <div><span style={{ fontSize: 12, fontWeight: 700, color: P.cyan }}>{k}</span><span style={{ fontSize: 10, color: P.s2 }}> · {v.length} registros</span></div>
            <Btn s onClick={() => { if (v.length) { const cols = Object.keys(v[0]).filter(x => x !== "id").map(x => ({ k: x, l: x })); exportCSV(v, cols, `SumaERP_${k}_${today()}`); notify(`${k} exportado`); } }}><I.Dw /> CSV</Btn>
          </div>
        ) : null)}
      </div>);
      case "inv": return <INVView />;
      case "hr": return <HRView />;
      case "acct": return <ACCTView />;
      case "fin": return <FinView />;
      case "trade": return <TradeView />;
      default: {
        const modMap = {};
        const m = modMap[mod]; if (!m) return <VDash />;
        return <TH title={m[0]} table={m[1]} data={m[2]} skeys={m[3]} cols={m[4]} />;
      }
    }
  };

  /* NAV */
  const rl = { cliente: "Cliente Empresa", contador: "Contador", admin: "Admin" };
  const rc = { cliente: P.grn, contador: P.blue, admin: P.pur };
  const NAV = user?.role === "cliente"
    ? [{ id: "dash", l: "Dashboard", ic: <I.Da /> }, null, { id: "sales", l: "Mis Ventas", ic: <I.Sa /> }, { id: "compras", l: "Mis Compras", ic: <I.Bx /> }, { id: "acct", l: "Contabilidad", ic: <I.Bo /> }, null, { id: "plans", l: "Planes", ic: <I.St />, dot: 1 }]
    : [{ id: "dash", l: "Dashboard", ic: <I.Da /> }, null, { id: "sales", l: "Ventas SIRE", ic: <I.Sa /> }, { id: "compras", l: "Compras SIRE", ic: <I.Bx /> }, { id: "inv", l: "Almacen MRPII", ic: <I.Iv /> }, null, { id: "trade", l: "Comercio Ext.", ic: <I.Gl /> }, { id: "fin", l: "Finanzas", ic: <I.Bk /> }, { id: "acct", l: "Contabilidad", ic: <I.Bo /> }, null, { id: "hr", l: "RRHH", ic: <I.Pp /> }, null, { id: "plans", l: "Planes", ic: <I.St />, dot: 1 }, ...(canDB ? [{ id: "database", l: "Base Datos", ic: <I.Db /> }] : [])];
  const titles = Object.fromEntries(NAV.filter(Boolean).map(n => [n.id, n.l]));

  return (
    <div style={{ display: "flex", height: "100vh", background: P.bg, fontFamily: "'DM Sans',-apple-system,sans-serif", color: P.tx, overflow: "hidden", fontSize: 13 }}>
      <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
      <aside style={{ width: 180, background: "linear-gradient(180deg,#080c15,#050710)", borderRight: `1px solid ${P.bd}`, display: "flex", flexDirection: "column", flexShrink: 0 }}>
        <div style={{ padding: "10px 9px", borderBottom: `1px solid ${P.bd}`, display: "flex", alignItems: "center", gap: 6 }}>
          <div style={{ width: 26, height: 26, borderRadius: 6, background: "linear-gradient(135deg,#0A84FF,#BF5AF2)", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 13, fontWeight: 800, color: "#fff" }}>Σ</div>
          <div><div style={{ fontSize: 11, fontWeight: 700 }}>SumaERP</div><div style={{ fontSize: 7, color: P.s2, fontWeight: 600 }}>SIRE · Peru 2026</div></div>
        </div>
        <nav style={{ flex: 1, overflowY: "auto", padding: "3px 4px", scrollbarWidth: "thin" }}>
          {NAV.map((x, i) => x === null ? <div key={`s${i}`} style={{ height: 1, background: P.bd, margin: "3px 6px" }} /> : (
            <div key={x.id} onClick={() => { setMod(x.id); setSearch(""); }} style={{ display: "flex", alignItems: "center", gap: 5, padding: "5px 6px", borderRadius: 5, cursor: "pointer", marginBottom: 1, background: mod === x.id ? `${P.blue}10` : "transparent", color: mod === x.id ? P.tx : "#455876", borderLeft: mod === x.id ? `2px solid ${P.blue}` : "2px solid transparent" }}>
              <span style={{ opacity: mod === x.id ? 1 : .4 }}>{x.ic}</span><span style={{ fontSize: 10, fontWeight: mod === x.id ? 600 : 500 }}>{x.l}</span>
              {x.dot && <div style={{ marginLeft: "auto", width: 4, height: 4, borderRadius: 2, background: P.cyan, boxShadow: `0 0 5px ${P.cyan}` }} />}
            </div>
          ))}
        </nav>
        <div style={{ padding: 5, borderTop: `1px solid ${P.bd}` }}>
          <div style={{ display: "flex", alignItems: "center", gap: 4, padding: "4px" }}>
            <div style={{ width: 20, height: 20, borderRadius: 4, background: `linear-gradient(135deg,${rc[user.role]},${P.blue})`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 7.5, fontWeight: 700, color: "#fff" }}>{user.empresaRazon ? user.empresaRazon[0] : user.displayName ? user.displayName[0] : user.email?.[0]?.toUpperCase()}</div>
            <div style={{ flex: 1, minWidth: 0 }}><div style={{ fontSize: 8.5, fontWeight: 600, color: "#a0acc0", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{user.empresaRazon || user.displayName || user.email?.split("@")[0]}</div><div style={{ fontSize: 7, color: rc[user.role], fontWeight: 700 }}>{rl[user.role]}{user.empresaRuc ? ` · ${user.empresaRuc}` : ""}</div>{user.email && <div style={{ fontSize: 6.5, color: P.s2, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{user.email}</div>}</div>
            <button onClick={() => setUser(null)} style={{ background: "none", border: "none", color: P.s2, cursor: "pointer", padding: 1 }}><I.Lo /></button>
          </div>
        </div>
      </aside>
      <main style={{ flex: 1, display: "flex", flexDirection: "column", overflow: "hidden" }}>
        <header style={{ height: 38, borderBottom: `1px solid ${P.bd}`, display: "flex", alignItems: "center", justifyContent: "space-between", padding: "0 14px", flexShrink: 0, background: "#070a12" }}>
          <span style={{ fontSize: 13, fontWeight: 700 }}>{titles[mod] || "Dashboard"}</span>
          <div style={{ display: "flex", alignItems: "center", gap: 6 }}><Badge s={rl[user.role]} c={rc[user.role]} />{user.empresaRazon && <Badge s={user.empresaRazon.substring(0, 20)} c={user.empresa?.color || P.cyan} />}<Badge s={subscription.plan.toUpperCase()} /><span style={{ fontSize: 9, color: P.s2 }}>{today()}</span></div>
        </header>
        <div style={{ flex: 1, overflow: "auto", padding: "10px 14px", scrollbarWidth: "thin" }}>{content()}</div>
      </main>

      {/* FORM MODAL */}
      <Modal open={!!ml} onClose={closeMl} title={ml ? `${ml.editing ? "Editar" : "Nuevo"} ${ml.type}` : ""} wide>
        {ml && forms[ml.type]?.()}
        <div style={{ display: "flex", gap: 6, justifyContent: "flex-end", marginTop: 12, paddingTop: 8, borderTop: `1px solid ${P.bd}` }}><Btn onClick={closeMl}>Cancelar</Btn><Btn p onClick={saveMl}><I.Ck /> Guardar</Btn></div>
      </Modal>

      {/* SCAN MODAL */}
      <Modal open={!!scanModal} onClose={() => setScanModal(null)} title={scanModal?.clientScan ? "Escaneo Documento — Claude IA" : "Escaneo CDP SIRE — Claude IA"} wide>
        {scanModal?.processing ? (<div style={{ textAlign: "center", padding: 36 }}><div style={{ width: 32, height: 32, border: `3px solid ${P.bd}`, borderTopColor: P.blue, borderRadius: "50%", animation: "spin .8s linear infinite", margin: "0 auto 12px" }} /><div style={{ fontSize: 12, fontWeight: 600 }}>Claude IA analizando {scanModal.file}...</div><div style={{ fontSize: 9, color: P.s2, marginTop: 4 }}>Extrayendo datos con vision OCR · Identificando tipo de documento · Asignando cuentas PCGE</div></div>
        ) : scanModal?.data ? (<div>
          <div style={{ display: "flex", alignItems: "center", gap: 5, marginBottom: 8 }}>
            <span style={{ color: P.grn }}><I.Ck /></span>
            <span style={{ fontSize: 12, fontWeight: 700, color: P.grn }}>Documento analizado — {scanModal.file}</span>
            {scanModal.aiSource && <span style={{ fontSize: 8, background: P.pur + "20", color: P.pur, padding: "2px 6px", borderRadius: 4, fontWeight: 600 }}>Claude IA</span>}
          </div>

          {/* Nature detection */}
          {scanModal.data._ai && (
            <div style={{ display: "flex", gap: 6, marginBottom: 8 }}>
              <div style={{ flex: 1, background: scanModal.data._ai?.naturaleza?.includes("VENTA") ? P.grn + "10" : P.org + "10", border: `1px solid ${scanModal.data._ai?.naturaleza?.includes("VENTA") ? P.grn : P.org}30`, borderRadius: 6, padding: "6px 10px", display: "flex", alignItems: "center", gap: 6 }}>
                <span style={{ fontSize: 14 }}>{scanModal.data._ai?.naturaleza?.includes("VENTA") ? "📤" : "📥"}</span>
                <div><div style={{ fontSize: 10, fontWeight: 700, color: scanModal.data._ai?.naturaleza?.includes("VENTA") ? P.grn : P.org }}>{scanModal.data._ai?.naturaleza || "COMPRA"} — {scanModal.data.tipo}</div>
                <div style={{ fontSize: 8, color: P.s2 }}>{scanModal.data._ai?.items || ""}</div></div>
              </div>
              {scanModal.data._ai?.cuenta && (
                <div style={{ background: P.cyan + "10", border: `1px solid ${P.cyan}30`, borderRadius: 6, padding: "6px 10px", minWidth: 100 }}>
                  <div style={{ fontSize: 8, color: P.s2 }}>Cuenta PCGE</div>
                  <div style={{ fontSize: 14, fontWeight: 800, color: P.cyan, fontFamily: "monospace" }}>{scanModal.data._ai.cuenta}</div>
                  <div style={{ fontSize: 8, color: P.s2 }}>Contrap: {scanModal.data._ai.contrapartida}</div>
                </div>
              )}
            </div>
          )}

          {/* Main data grid */}
          <div style={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 7, padding: 10, marginBottom: 8 }}>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "0 16px" }}>
              {[
                ["Serie", scanModal.data.serie], ["Numero", scanModal.data.numero],
                ["Fecha Emision", scanModal.data.fecha],
                ["Fecha Venc.", scanModal.data._ai?.fechaVenc || "—"],
                ["Tipo CDP", scanModal.data.tipo],
                [scanModal.data.proveedor ? "Proveedor" : "Cliente", scanModal.data.proveedor || scanModal.data.cliente || ""],
                [scanModal.data.proveedor ? "RUC Proveedor" : "RUC Cliente", scanModal.data.ruc || scanModal.data.rucProv || ""],
                ["Moneda", scanModal.data.moneda],
              ].map(([label, val], i) => (
                <div key={i} style={{ display: "flex", justifyContent: "space-between", padding: "3px 0", borderBottom: `1px solid ${P.bd}20` }}>
                  <span style={{ fontSize: 9, color: P.s2, fontWeight: 600 }}>{label}</span>
                  <span style={{ fontSize: 10, fontWeight: 700, fontFamily: "monospace", color: P.tx }}>{String(val || "—")}</span>
                </div>
              ))}
            </div>
          </div>

          {/* Amounts section */}
          <div style={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 7, padding: 10, marginBottom: 8 }}>
            <div style={{ fontSize: 9, fontWeight: 700, color: P.s2, marginBottom: 4, textTransform: "uppercase" }}>Importes</div>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 6 }}>
              {[
                ["Op. Gravadas", scanModal.data.subtotal, P.s1],
                ["Op. Inafectas", scanModal.data._ai?.inaf || 0, P.s2],
                ["Op. Exoneradas", scanModal.data._ai?.exon || 0, P.s2],
                ["IGV 18%", scanModal.data.igv, P.org],
                ["Detraccion", scanModal.data._ai?.detraccion || 0, P.red],
                ["Retencion", scanModal.data._ai?.retencion || 0, P.red],
              ].map(([label, val, color], i) => (
                <div key={i} style={{ textAlign: "right", padding: "2px 4px" }}>
                  <div style={{ fontSize: 8, color: P.s2 }}>{label}</div>
                  <div style={{ fontSize: 11, fontWeight: 600, fontFamily: "monospace", color }}>{scanModal.data.moneda === "USD" ? "$ " : "S/ "}{fmtN(val)}</div>
                </div>
              ))}
            </div>
            <div style={{ borderTop: `1px solid ${P.bd}`, marginTop: 6, paddingTop: 6, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <span style={{ fontSize: 11, fontWeight: 700 }}>TOTAL</span>
              <span style={{ fontSize: 18, fontWeight: 800, color: P.grn, fontFamily: "monospace" }}>{scanModal.data.moneda === "USD" ? "$ " : "S/ "}{fmtN(scanModal.data.total)}</span>
            </div>
            {(scanModal.data._ai?.neto && scanModal.data._ai.neto !== scanModal.data.total) ? (
              <div style={{ display: "flex", justifyContent: "space-between", marginTop: 2 }}>
                <span style={{ fontSize: 9, color: P.s2 }}>Neto a Pagar</span>
                <span style={{ fontSize: 12, fontWeight: 700, color: P.blue, fontFamily: "monospace" }}>{scanModal.data.moneda === "USD" ? "$ " : "S/ "}{fmtN(scanModal.data._ai.neto)}</span>
              </div>
            ) : null}
          </div>

          {/* Additional AI info */}
          {scanModal.data._ai && (
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6, marginBottom: 10 }}>
              {scanModal.data._ai.emisor && (
                <div style={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 6, padding: 8 }}>
                  <div style={{ fontSize: 8, color: P.s2, fontWeight: 600, marginBottom: 2 }}>EMISOR</div>
                  <div style={{ fontSize: 10, fontWeight: 700 }}>{scanModal.data._ai.emisor}</div>
                  <div style={{ fontSize: 9, color: P.cyan, fontFamily: "monospace" }}>{scanModal.data._ai.emisorRuc}</div>
                </div>
              )}
              {scanModal.data._ai.receptor && (
                <div style={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 6, padding: 8 }}>
                  <div style={{ fontSize: 8, color: P.s2, fontWeight: 600, marginBottom: 2 }}>RECEPTOR</div>
                  <div style={{ fontSize: 10, fontWeight: 700 }}>{scanModal.data._ai.receptor}</div>
                  <div style={{ fontSize: 9, color: P.cyan, fontFamily: "monospace" }}>{scanModal.data._ai.receptorRuc}</div>
                </div>
              )}
              {scanModal.data._ai.formaPago && (
                <div style={{ fontSize: 9, color: P.s1 }}><strong>Forma Pago:</strong> {scanModal.data._ai.formaPago}</div>
              )}
              {scanModal.data._ai.obs && (
                <div style={{ fontSize: 9, color: P.s1 }}><strong>Obs:</strong> {scanModal.data._ai.obs}</div>
              )}
            </div>
          )}

          <div style={{ display: "flex", gap: 6, justifyContent: "flex-end" }}>
            <Btn onClick={() => setScanModal(null)}>Descartar</Btn>
            <Btn p onClick={() => {
              const cleanData = { ...scanModal.data };
              delete cleanData._ai;
              if (scanModal.clientScan) { confirmClientScan(scanModal.data); }
              else { if (scanModal.type === "ventas") add("facturas", cleanData); else add("compras", cleanData); setScanModal(null); notify("Registrado en SIRE · Cuenta: " + (scanModal.data._ai?.cuenta || "pendiente")); }
            }}><I.Ck /> {scanModal?.clientScan ? "Registrar y Procesar IA" : "Registrar en SIRE"}</Btn>
          </div>
        </div>) : null}
      </Modal>

      {/* CART / PAYMENT MODAL */}
      <Modal open={!!planModal} onClose={() => { setPlanModal(null); setPayMethod(null); }} title={planModal === "cart" ? "Carrito de Compras" : planModal === "pay" ? "Metodo de Pago" : planModal === "yape" ? "Pago con Yape" : planModal === "processing" ? "Procesando..." : planModal === "done" ? "Pago Exitoso" : ""} wide>
        {planModal === "cart" && cart && (<div>
          <div style={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 9, padding: 14, marginBottom: 14 }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}><span style={{ color: cart.color }}>{cart.icon}</span><div><div style={{ fontSize: 14, fontWeight: 800 }}>{cart.name}</div><div style={{ fontSize: 9, color: P.s2 }}>{cart.features.length} caracteristicas incluidas</div></div></div>
              <button onClick={() => { setPlanModal(null); setCart(null); }} style={{ background: "none", border: "none", color: P.red, cursor: "pointer" }}><I.Tr /></button>
            </div>
            <div style={{ borderTop: `1px solid ${P.bd}`, paddingTop: 10 }}>
              {cart.features.map((f, i) => (<div key={i} style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 10, color: P.s1, padding: "2px 0" }}><span style={{ color: P.grn }}><I.Ck /></span>{f}</div>))}
            </div>
          </div>
          <div style={{ background: P.c1, border: `1px solid ${P.bd}`, borderRadius: 8, padding: 12, marginBottom: 14 }}>
            <div style={{ display: "flex", justifyContent: "space-between", fontSize: 11 }}><span style={{ color: P.s1 }}>Subtotal</span><span>{$(cart.price)}</span></div>
            <div style={{ display: "flex", justifyContent: "space-between", fontSize: 11, marginTop: 4 }}><span style={{ color: P.s1 }}>IGV 18%</span><span>{$(cart.price * .18)}</span></div>
            <div style={{ borderTop: `1px solid ${P.bd}`, marginTop: 8, paddingTop: 8, display: "flex", justifyContent: "space-between" }}><span style={{ fontSize: 13, fontWeight: 800 }}>Total</span><span style={{ fontSize: 16, fontWeight: 800, color: cart.color }}>{$(cart.price * 1.18)}</span></div>
          </div>
          <Btn p full onClick={() => setPlanModal("pay")} style={{ padding: "10px", fontSize: 13, borderRadius: 8 }}>Proceder al Pago</Btn>
        </div>)}

        {planModal === "pay" && (<div>
          <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 12 }}>Selecciona metodo de pago</div>
          <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
            {[{ id: "yape", l: "Yape", d: "Pago instantaneo con QR", icon: <YapeIcon />, color: "#6C2DC7" },
              { id: "card", l: "Tarjeta Visa/MC", d: "Debito o credito", icon: <I.Cd />, color: P.blue },
              { id: "transfer", l: "Transferencia", d: "BCP, BBVA, Interbank", icon: <I.Bk />, color: P.cyan }
            ].map(m => (<div key={m.id} onClick={() => setPayMethod(m.id)} style={{ display: "flex", alignItems: "center", gap: 10, padding: "12px 14px", background: payMethod === m.id ? m.color + "10" : P.c2, border: `1.5px solid ${payMethod === m.id ? m.color + "50" : P.bd}`, borderRadius: 9, cursor: "pointer" }}><span style={{ color: m.color }}>{m.icon}</span><div style={{ flex: 1 }}><div style={{ fontSize: 12, fontWeight: 700 }}>{m.l}</div><div style={{ fontSize: 9, color: P.s2 }}>{m.d}</div></div>{payMethod === m.id && <span style={{ color: m.color }}><I.Ck /></span>}</div>))}
          </div>
          {payMethod === "yape" && (<div style={{ marginTop: 14, textAlign: "center", background: P.c2, borderRadius: 10, padding: 16 }}>
            <div style={{ width: 140, height: 140, background: "#fff", borderRadius: 8, margin: "0 auto 10px", display: "flex", alignItems: "center", justifyContent: "center" }}>
              <div style={{ width: 120, height: 120, background: `repeating-conic-gradient(#000 0% 25%, #fff 0% 50%) 0 0/10px 10px`, borderRadius: 4 }} />
            </div>
            <div style={{ fontSize: 11, fontWeight: 700, color: "#6C2DC7" }}>Escanea el QR con tu app Yape</div>
            <div style={{ fontSize: 10, color: P.s2, marginTop: 3 }}>Monto: {$(cart?.price * 1.18 || 0)}</div>
          </div>)}
          <div style={{ marginTop: 14, display: "flex", gap: 6 }}>
            <Btn onClick={() => setPlanModal("cart")}>← Volver</Btn>
            <Btn p full onClick={processPayment} dis={!payMethod} style={{ padding: "9px", borderRadius: 7 }}>Confirmar Pago</Btn>
          </div>
        </div>)}

        {planModal === "processing" && (<div style={{ textAlign: "center", padding: 40 }}><div style={{ width: 36, height: 36, border: `3px solid ${P.bd}`, borderTopColor: P.grn, borderRadius: "50%", animation: "spin .8s linear infinite", margin: "0 auto 14px" }} /><div style={{ fontSize: 14, fontWeight: 700 }}>Procesando pago...</div></div>)}

        {planModal === "done" && (<div style={{ textAlign: "center" }}>
          <div style={{ width: 48, height: 48, borderRadius: 24, background: P.grn + "20", border: `2px solid ${P.grn}`, display: "inline-flex", alignItems: "center", justifyContent: "center", marginBottom: 12 }}><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke={P.grn} strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div style={{ fontSize: 16, fontWeight: 800, marginBottom: 4 }}>¡Pago exitoso!</div>
          <div style={{ fontSize: 11, color: P.s2, marginBottom: 16 }}>Plan {cart?.name} activado · {$(cart?.price * 1.18 || 0)}</div>
          <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 10 }}>¿Deseas comprobante?</div>
          <div style={{ display: "flex", gap: 8, justifyContent: "center" }}>
            <Btn onClick={() => genInvoice("Factura")} style={{ background: P.blue + "15", color: P.blue, border: `1px solid ${P.blue}30`, padding: "8px 16px" }}><I.Fl /> Factura</Btn>
            <Btn onClick={() => genInvoice("Boleta")} style={{ background: P.grn + "15", color: P.grn, border: `1px solid ${P.grn}30`, padding: "8px 16px" }}><I.Fl /> Boleta</Btn>
          </div>
          <div style={{ marginTop: 14 }}><Btn p onClick={() => { setPlanModal(null); setPayMethod(null); setCart(null); }} style={{ padding: "8px 20px" }}>Cerrar</Btn></div>
        </div>)}
      </Modal>

      {/* INVOICE MODAL */}
      <Modal open={!!invoiceModal} onClose={() => setInvoiceModal(null)} title={`${invoiceModal?.tipo} Electronica`}>
        {invoiceModal && (<div>
          <div style={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 10, padding: 16, fontFamily: "monospace" }}>
            <div style={{ textAlign: "center", marginBottom: 12 }}>
              <div style={{ fontSize: 16, fontWeight: 800 }}>SumaERP S.A.C.</div>
              <div style={{ fontSize: 9, color: P.s2 }}>RUC: 20600000001</div>
              <div style={{ fontSize: 12, fontWeight: 700, color: P.blue, marginTop: 6 }}>{invoiceModal.tipo} ELECTRONICA</div>
              <div style={{ fontSize: 11, color: P.org }}>{invoiceModal.serie}-{invoiceModal.numero}</div>
            </div>
            <div style={{ borderTop: `1px dashed ${P.bd}`, paddingTop: 8 }}>
              {[["Fecha", invoiceModal.fecha], ["Plan", invoiceModal.plan], ["Moneda", "PEN"]].map(([l, v]) => (<div key={l} style={{ display: "flex", justifyContent: "space-between", fontSize: 10, padding: "2px 0" }}><span style={{ color: P.s2 }}>{l}:</span><span>{v}</span></div>))}
            </div>
            <div style={{ borderTop: `1px dashed ${P.bd}`, marginTop: 6, paddingTop: 6 }}>
              {[["Subtotal", invoiceModal.monto], ["IGV 18%", invoiceModal.igv], ["TOTAL", invoiceModal.total]].map(([l, v], i) => (<div key={l} style={{ display: "flex", justifyContent: "space-between", fontSize: i === 2 ? 13 : 10, fontWeight: i === 2 ? 800 : 400, padding: "2px 0", color: i === 2 ? P.grn : P.tx }}><span>{l}</span><span>{$(v)}</span></div>))}
            </div>
          </div>
          <div style={{ display: "flex", gap: 6, marginTop: 12, justifyContent: "center" }}>
            <Btn onClick={() => {
              const inv = invoiceModal;
              const txt = `${inv.tipo} ELECTRONICA\n${inv.serie}-${inv.numero}\nFecha: ${inv.fecha}\nPlan: ${inv.plan}\nSubtotal: ${$(inv.monto)}\nIGV: ${$(inv.igv)}\nTotal: ${$(inv.total)}`;
              navigator.clipboard.writeText(txt).then(() => notify("Comprobante copiado al portapapeles")).catch(() => {
                const ta = document.createElement("textarea"); ta.value = txt; ta.style.cssText = "position:fixed;left:-9999px"; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
                notify("Comprobante copiado al portapapeles");
              });
            }}><I.Dw /> Copiar</Btn>
            <Btn p onClick={() => setInvoiceModal(null)}>Cerrar</Btn>
          </div>
        </div>)}
      </Modal>

      {/* EXPORT MODAL - Copiar datos para Excel/Sheets */}
      <Modal open={!!exportModal} onClose={() => setExportModal(null)} title={exportModal?.imageMode ? "Captura Dashboard" : `Exportar: ${exportModal?.filename || ""}`} wide>
        {exportModal?.imageMode ? (
          <div style={{ textAlign: "center", padding: 20 }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: exportModal.fallback ? P.org : P.grn, marginBottom: 8 }}>{exportModal.fallback ? "Usa la herramienta de recorte del sistema" : "Imagen copiada al portapapeles"}</div>
            <div style={{ fontSize: 10, color: P.s2, marginBottom: 12 }}>{exportModal.fallback ? "Presiona Win+Shift+S (Windows) o Cmd+Shift+4 (Mac) para capturar la pantalla" : `Pega la imagen ${exportModal.imageType?.toUpperCase()} con Ctrl+V en cualquier app`}</div>
            <Btn p onClick={() => setExportModal(null)}>Entendido</Btn>
          </div>
        ) : exportModal && (<div>
          <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 8 }}>
            <span style={{ color: P.grn }}><I.Ck /></span>
            <span style={{ fontSize: 12, fontWeight: 700, color: P.grn }}>{exportModal.rows?.length || 0} registros listos para exportar</span>
          </div>
          <div style={{ fontSize: 10, color: P.s2, marginBottom: 8, padding: "6px 10px", background: P.c2, borderRadius: 6, border: `1px solid ${P.bd}`, lineHeight: 1.6 }}>
            <strong style={{ color: P.org }}>Pasos:</strong> 1) Click en <strong style={{ color: P.grn }}>"Copiar para Excel"</strong> o <strong style={{ color: P.blue }}>"Copiar CSV"</strong> → 2) Abre Excel o Google Sheets → 3) Pega con <strong>Ctrl+V</strong>
          </div>
          <div style={{ background: P.c2, border: `1px solid ${P.bd}`, borderRadius: 7, maxHeight: 200, overflow: "auto", scrollbarWidth: "thin", marginBottom: 10 }}>
            <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 9 }}>
              <thead><tr style={{ position: "sticky", top: 0, background: P.c2, zIndex: 1 }}>
                {(exportModal.headers || []).map((h, i) => <th key={i} style={{ padding: "4px 6px", color: P.s2, fontSize: 8, fontWeight: 700, borderBottom: `1px solid ${P.bd}`, textAlign: "left", whiteSpace: "nowrap" }}>{h}</th>)}
              </tr></thead>
              <tbody>{(exportModal.rows || []).slice(0, 25).map((r, ri) => (
                <tr key={ri} style={{ borderBottom: `1px solid ${P.bd}10` }}>
                  {r.map((c, ci) => <td key={ci} style={{ padding: "3px 6px", fontSize: 9, color: P.s1, whiteSpace: "nowrap", fontFamily: exportModal.numCols?.has(ci) ? "monospace" : "inherit", textAlign: exportModal.numCols?.has(ci) ? "right" : "left" }}>{String(c ?? "")}</td>)}
                </tr>
              ))}</tbody>
            </table>
            {(exportModal.rows?.length || 0) > 25 && <div style={{ textAlign: "center", padding: 6, fontSize: 9, color: P.s2 }}>... y {exportModal.rows.length - 25} registros mas</div>}
          </div>
          <div style={{ display: "flex", gap: 6, justifyContent: "flex-end" }}>
            <Btn onClick={() => setExportModal(null)}>Cerrar</Btn>
            <Btn p onClick={() => {
              const copyText = (txt, msg) => { navigator.clipboard.writeText(txt).then(() => notify(msg)).catch(() => { const ta = document.createElement("textarea"); ta.value = txt; ta.style.cssText = "position:fixed;left:-9999px"; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); notify(msg); }); };
              copyText(exportModal.content, "Copiado · Pega en Excel con Ctrl+V");
            }} style={{ background: P.grn + "20", color: P.grn, border: `1px solid ${P.grn}40` }}><I.Dw /> Copiar para Excel</Btn>
            <Btn p onClick={() => {
              const csvContent = [(exportModal.headers || []).join(","), ...(exportModal.rows || []).map(r => r.map(c => `"${String(c ?? "").replace(/"/g, '""')}"`).join(","))].join("\n");
              const copyText = (txt, msg) => { navigator.clipboard.writeText(txt).then(() => notify(msg)).catch(() => { const ta = document.createElement("textarea"); ta.value = txt; ta.style.cssText = "position:fixed;left:-9999px"; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); notify(msg); }); };
              copyText(csvContent, "CSV copiado · Pega en Google Sheets");
            }} style={{ background: P.blue + "20", color: P.blue, border: `1px solid ${P.blue}40` }}><I.Dw /> Copiar CSV</Btn>
          </div>
        </div>)}
      </Modal>

      <Confirm open={!!cfm} msg={cfm?.msg} onYes={cfm?.fn} onNo={() => setCfm(null)} btnText={cfm?.btnText} />
      {toast && <Toast msg={toast.msg} type={toast.type} onDone={() => setToast(null)} />}
      <style>{`@keyframes spin{to{transform:rotate(360deg)}}`}</style>
    </div>
  );
}


      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(React.createElement(SumaERP));
    </script>
</body>
</html>
