<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TransCaña ERPremium - ERP Industria Azucarera Guatemala</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: #05070c;
      color: #d6e0f0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: #0a0e17;
    }
    ::-webkit-scrollbar-thumb {
      background: #1a2540;
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #2a3550;
    }
    input, select, textarea {
      background: #0f1520;
      border: 1px solid #1a2540;
      color: #d6e0f0;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      width: 100%;
      outline: none;
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #0A84FF;
    }
    select option {
      background: #0f1520;
      color: #d6e0f0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      text-align: left;
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 600;
      color: #8095b3;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid #1a2540;
    }
    td {
      padding: 10px 12px;
      font-size: 14px;
      border-bottom: 1px solid #0f1520;
    }
    tr:hover td {
      background: rgba(10, 14, 23, 0.6);
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .pulse {
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
/* ============================================================
 *  TransCaña ERPremium
 *  ERP para Industria Azucarera - Guatemala
 *  Single-file React 18 Application
 *  All modules: Dashboard, Ventas, Compras, Inventario,
 *  Clientes, RRHH, CRM, Contabilidad, Proveedores,
 *  Órdenes de Compra, Planificación Zafra, Logística,
 *  Laboratorio, Nómina, Portal Colonos, BI, Mantenimiento
 * ============================================================ */

const {
  useState,
  useEffect,
  useCallback,
  useMemo,
  useRef,
  createContext,
  useContext
} = React;

const {
  BarChart,
  Bar,
  LineChart,
  Line,
  PieChart,
  Pie,
  Cell,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  AreaChart,
  Area
} = Recharts;

/* ============================================================
 *  THEME CONSTANTS
 * ============================================================ */
const T = {
  bg:     "#05070c",
  card:   "#0a0e17",
  card2:  "#0f1520",
  border: "#1a2540",
  text:   "#d6e0f0",
  subtle: "#8095b3",
  blue:   "#0A84FF",
  green:  "#32D74B",
  orange: "#FF9F0A",
  red:    "#FF453A",
  purple: "#BF5AF2",
  cyan:   "#64D2FF",
  yellow: "#FFD60A",
  teal:   "#2AC7B8"
};

/* ============================================================
 *  UTILITY FUNCTIONS
 * ============================================================ */

/** Generate a unique ID */
const uid = () => {
  return 'id_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
};

/** Format as Quetzales (GTQ) */
const fmtQ = (n) => {
  return 'Q ' + Number(n || 0).toLocaleString('es-GT', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
};

/** Format number with locale */
const fmtN = (n) => {
  return Number(n || 0).toLocaleString('es-GT');
};

/** Format date */
const fmtD = (d) => {
  if (!d) return '-';
  const dt = new Date(d);
  return dt.toLocaleDateString('es-GT', {
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  });
};

/** Format date and time */
const fmtDT = (d) => {
  if (!d) return '-';
  const dt = new Date(d);
  return dt.toLocaleDateString('es-GT', {
    day: '2-digit',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};

/** Get today's date as YYYY-MM-DD */
const today = () => new Date().toISOString().split('T')[0];

/** Sum an array by key */
const sum = (arr, k) => arr.reduce((a, b) => a + (Number(b[k]) || 0), 0);

/** Average an array by key */
const avg = (arr, k) => arr.length ? sum(arr, k) / arr.length : 0;

/* ============================================================
 *  LOCALSTORAGE HELPERS
 * ============================================================ */
const LS = {
  get: (k, d) => {
    try {
      const v = localStorage.getItem('tc_' + k);
      return v ? JSON.parse(v) : d;
    } catch (e) {
      return d;
    }
  },
  set: (k, v) => {
    try {
      localStorage.setItem('tc_' + k, JSON.stringify(v));
    } catch (e) {
      // storage full or unavailable
    }
  }
};

/* ============================================================
 *  SVG ICON FACTORY
 *  Creates Lucide-like SVG icons from path data
 * ============================================================ */
const I = (paths, vb = "0 0 24 24") => {
  return ({ size = 20, color = T.subtle, style = {}, className = "" }) => {
    return React.createElement(
      'svg',
      {
        width: size,
        height: size,
        viewBox: vb,
        fill: 'none',
        stroke: color,
        strokeWidth: 2,
        strokeLinecap: 'round',
        strokeLinejoin: 'round',
        style: style,
        className: className
      },
      paths.map((d, i) => React.createElement('path', { key: i, d: d }))
    );
  };
};

/* ---- Icon Definitions ---- */
const Icons = {
  Home: I([
    "M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z",
    "M9 22V12h6v10"
  ]),
  Package: I([
    "M16.5 9.4l-9-5.19",
    "M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z",
    "M3.27 6.96L12 12.01l8.73-5.05",
    "M12 22.08V12"
  ]),
  Users: I([
    "M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2",
    "M9 11a4 4 0 100-8 4 4 0 000 8",
    "M23 21v-2a4 4 0 00-3-3.87",
    "M16 3.13a4 4 0 010 7.75"
  ]),
  FileText: I([
    "M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z",
    "M14 2v6h6",
    "M16 13H8",
    "M16 17H8",
    "M10 9H8"
  ]),
  DollarSign: I([
    "M12 1v22",
    "M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"
  ]),
  TrendingUp: I([
    "M23 6l-9.5 9.5-5-5L1 18"
  ]),
  ShoppingCart: I([
    "M9 22a1 1 0 100-2 1 1 0 000 2z",
    "M20 22a1 1 0 100-2 1 1 0 000 2z",
    "M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"
  ]),
  Truck: I([
    "M1 3h15v13H1z",
    "M16 8h4l3 3v5h-7V8z",
    "M5.5 21.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z",
    "M18.5 21.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"
  ]),
  CreditCard: I([
    "M21 4H3a2 2 0 00-2 2v12a2 2 0 002 2h18a2 2 0 002-2V6a2 2 0 00-2-2z",
    "M1 10h22"
  ]),
  Target: I([
    "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z",
    "M12 18a6 6 0 100-12 6 6 0 000 12z",
    "M12 14a2 2 0 100-4 2 2 0 000 4z"
  ]),
  BookOpen: I([
    "M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z",
    "M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"
  ]),
  Briefcase: I([
    "M20 7H4a2 2 0 00-2 2v10a2 2 0 002 2h16a2 2 0 002-2V9a2 2 0 00-2-2z",
    "M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"
  ]),
  Tractor: I([
    "M5 18a3 3 0 100-6 3 3 0 000 6z",
    "M18 18a3 3 0 100-6 3 3 0 000 6z",
    "M5 15h5V7H7l-3 4",
    "M10 7h4l3 4v4h-2",
    "M10 15h3"
  ]),
  Flask: I([
    "M9 3h6",
    "M10 3v5.172a2 2 0 01-.586 1.414l-5.828 5.828A2 2 0 003 16.828V19a2 2 0 002 2h14a2 2 0 002-2v-2.172a2 2 0 00-.586-1.414l-5.828-5.828A2 2 0 0114 8.172V3"
  ]),
  Banknote: I([
    "M2 6h20v12H2z",
    "M12 12a3 3 0 100-6 3 3 0 000 6z",
    "M2 10h2",
    "M20 10h2",
    "M2 14h2",
    "M20 14h2"
  ]),
  UserCheck: I([
    "M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2",
    "M8.5 11a4 4 0 100-8 4 4 0 000 8",
    "M17 11l2 2 4-4"
  ]),
  Wrench: I([
    "M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"
  ]),
  Route: I([
    "M18 6a3 3 0 100-6 3 3 0 000 6z",
    "M6 24a3 3 0 100-6 3 3 0 000 6z",
    "M18 6v6a6 6 0 01-6 6H6"
  ]),
  Calendar: I([
    "M19 4H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2z",
    "M16 2v4",
    "M8 2v4",
    "M3 10h18"
  ]),
  BarChart2: I([
    "M18 20V10",
    "M12 20V4",
    "M6 20v-6"
  ]),
  Activity: I([
    "M22 12h-4l-3 9L9 3l-3 9H2"
  ]),
  AlertTriangle: I([
    "M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z",
    "M12 9v4",
    "M12 17h.01"
  ]),
  Settings: I([
    "M12 15a3 3 0 100-6 3 3 0 000 6z",
    "M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"
  ]),
  Search: I([
    "M11 19a8 8 0 100-16 8 8 0 000 16z",
    "M21 21l-4.35-4.35"
  ]),
  Plus: I([
    "M12 5v14",
    "M5 12h14"
  ]),
  Edit: I([
    "M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7",
    "M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"
  ]),
  Trash: I([
    "M3 6h18",
    "M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
  ]),
  X: I([
    "M18 6L6 18",
    "M6 6l12 12"
  ]),
  Check: I([
    "M20 6L9 17l-5-5"
  ]),
  ChevronDown: I([
    "M6 9l6 6 6-6"
  ]),
  ChevronRight: I([
    "M9 18l6-6-6-6"
  ]),
  ChevronLeft: I([
    "M15 18l-6-6 6-6"
  ]),
  Menu: I([
    "M3 12h18",
    "M3 6h18",
    "M3 18h18"
  ]),
  LogOut: I([
    "M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4",
    "M16 17l5-5-5-5",
    "M21 12H9"
  ]),
  Download: I([
    "M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4",
    "M7 10l5 5 5-5",
    "M12 15V3"
  ]),
  Copy: I([
    "M20 9h-9a2 2 0 00-2 2v9a2 2 0 002 2h9a2 2 0 002-2v-9a2 2 0 00-2-2z",
    "M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"
  ]),
  Eye: I([
    "M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z",
    "M12 15a3 3 0 100-6 3 3 0 000 6z"
  ]),
  Filter: I([
    "M22 3H2l8 9.46V19l4 2v-8.54L22 3z"
  ]),
  Leaf: I([
    "M17 8C8 10 5.9 16.17 3.82 21.34l1.89.66.95-2.3c.48.17.98.3 1.34.3C19 20 22 3 22 3c-1 0-8 2-10 5z"
  ]),
  Zap: I([
    "M13 2L3 14h9l-1 10 10-12h-9l1-10z"
  ]),
  Award: I([
    "M12 15a7 7 0 100-14 7 7 0 000 14z",
    "M8.21 13.89L7 23l5-3 5 3-1.21-9.12"
  ]),
  Clipboard: I([
    "M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2",
    "M9 2h6a1 1 0 011 1v1a1 1 0 01-1 1H9a1 1 0 01-1-1V3a1 1 0 011-1z"
  ]),
  Clock: I([
    "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z",
    "M12 6v6l4 2"
  ]),
  Map: I([
    "M1 6v16l7-4 8 4 7-4V2l-7 4-8-4-7 4z",
    "M8 2v16",
    "M16 6v16"
  ]),
  Layers: I([
    "M12 2L2 7l10 5 10-5-10-5z",
    "M2 17l10 5 10-5",
    "M2 12l10 5 10-5"
  ]),
  Database: I([
    "M12 2C6.48 2 2 4.02 2 6.5v11C2 19.98 6.48 22 12 22s10-2.02 10-4.5v-11C22 4.02 17.52 2 12 2z",
    "M2 6.5C2 8.98 6.48 11 12 11s10-2.02 10-4.5",
    "M2 12c0 2.48 4.48 4.5 10 4.5s10-2.02 10-4.5"
  ]),
  PieChartIcon: I([
    "M21.21 15.89A10 10 0 118 2.83",
    "M22 12A10 10 0 0012 2v10z"
  ]),
  Star: I([
    "M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
  ]),
};


/* ============================================================
 *  UI COMPONENT LIBRARY
 * ============================================================ */

/**
 * Badge - Small colored label for statuses, categories, etc.
 */
const Badge = ({ children, color = T.blue, style = {} }) => (
  <span style={{
    display: 'inline-block',
    padding: '2px 10px',
    borderRadius: 12,
    fontSize: 12,
    fontWeight: 600,
    background: color + '22',
    color: color,
    border: `1px solid ${color}44`,
    ...style
  }}>
    {children}
  </span>
);

/**
 * K - KPI Card component for dashboard metrics
 */
const K = ({ icon: Ic, label, value, sub, color = T.blue, onClick }) => (
  <div
    onClick={onClick}
    style={{
      background: T.card,
      border: `1px solid ${T.border}`,
      borderRadius: 12,
      padding: 16,
      cursor: onClick ? 'pointer' : 'default',
      transition: 'all 0.2s',
      borderLeft: `3px solid ${color}`
    }}
    onMouseEnter={e => { e.currentTarget.style.borderColor = color; }}
    onMouseLeave={e => { e.currentTarget.style.borderColor = T.border; }}
  >
    <div style={{
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 8
    }}>
      <span style={{
        fontSize: 12,
        color: T.subtle,
        fontWeight: 600,
        textTransform: 'uppercase',
        letterSpacing: '0.05em'
      }}>
        {label}
      </span>
      {Ic && <Ic size={18} color={color} />}
    </div>
    <div style={{ fontSize: 24, fontWeight: 700, color: T.text }}>
      {value}
    </div>
    {sub && (
      <div style={{ fontSize: 12, color: T.subtle, marginTop: 4 }}>
        {sub}
      </div>
    )}
  </div>
);

/**
 * Btn - Button component with solid, outline, and ghost variants
 */
const Btn = ({
  children,
  onClick,
  color = T.blue,
  variant = 'solid',
  size = 'md',
  disabled = false,
  style = {},
  ...props
}) => {
  const sizeMap = {
    sm: { padding: '4px 12px', fontSize: 12 },
    md: { padding: '8px 16px', fontSize: 14 },
    lg: { padding: '12px 24px', fontSize: 16 }
  };
  const base = {
    ...sizeMap[size],
    borderRadius: 8,
    fontWeight: 600,
    cursor: disabled ? 'not-allowed' : 'pointer',
    transition: 'all 0.2s',
    display: 'inline-flex',
    alignItems: 'center',
    gap: 6,
    border: 'none',
    opacity: disabled ? 0.5 : 1
  };
  const variants = {
    solid: { ...base, background: color, color: '#fff' },
    outline: { ...base, background: 'transparent', border: `1px solid ${color}`, color: color },
    ghost: { ...base, background: 'transparent', color: color }
  };
  return (
    <button
      onClick={disabled ? undefined : onClick}
      style={{ ...variants[variant], ...style }}
      {...props}
    >
      {children}
    </button>
  );
};

/**
 * Inp - Input component supporting text, number, date, select, and textarea
 */
const Inp = ({
  label,
  type = 'text',
  value,
  onChange,
  placeholder = '',
  options,
  style = {},
  required = false,
  ...props
}) => (
  <div style={{ marginBottom: 12, ...style }}>
    {label && (
      <label style={{
        display: 'block',
        fontSize: 12,
        fontWeight: 600,
        color: T.subtle,
        marginBottom: 4,
        textTransform: 'uppercase',
        letterSpacing: '0.03em'
      }}>
        {label}
        {required && <span style={{ color: T.red }}> *</span>}
      </label>
    )}
    {options ? (
      <select
        value={value}
        onChange={e => onChange(e.target.value)}
        style={{ height: 38 }}
        {...props}
      >
        <option value="">Seleccionar...</option>
        {options.map(o => (
          typeof o === 'string'
            ? <option key={o} value={o}>{o}</option>
            : <option key={o.value} value={o.value}>{o.label}</option>
        ))}
      </select>
    ) : type === 'textarea' ? (
      <textarea
        value={value}
        onChange={e => onChange(e.target.value)}
        placeholder={placeholder}
        rows={3}
        {...props}
      />
    ) : (
      <input
        type={type}
        value={value}
        onChange={e => onChange(e.target.value)}
        placeholder={placeholder}
        {...props}
      />
    )}
  </div>
);

/**
 * G - Grid layout component
 */
const G = ({ children, cols = 4, gap = 16, style = {} }) => (
  <div style={{
    display: 'grid',
    gridTemplateColumns: `repeat(${cols}, 1fr)`,
    gap: gap,
    ...style
  }}>
    {children}
  </div>
);

/**
 * Modal - Dialog overlay component
 */
const Modal = ({ open, onClose, title, children, width = 600 }) => {
  if (!open) return null;
  return (
    <div
      style={{
        position: 'fixed',
        inset: 0,
        zIndex: 1000,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        background: 'rgba(0,0,0,0.7)',
        backdropFilter: 'blur(4px)'
      }}
      onClick={onClose}
    >
      <div
        className="fade-in"
        style={{
          background: T.card,
          border: `1px solid ${T.border}`,
          borderRadius: 16,
          width: width,
          maxWidth: '95vw',
          maxHeight: '90vh',
          overflow: 'auto',
          padding: 24
        }}
        onClick={e => e.stopPropagation()}
      >
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: 20
        }}>
          <h2 style={{ fontSize: 20, fontWeight: 700 }}>{title}</h2>
          <button
            onClick={onClose}
            style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}
          >
            <Icons.X size={20} color={T.subtle} />
          </button>
        </div>
        {children}
      </div>
    </div>
  );
};

/**
 * ProgressBar - Horizontal progress bar with label
 */
const ProgressBar = ({
  value = 0,
  max = 100,
  color = T.blue,
  height = 8,
  showLabel = true
}) => (
  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
    <div style={{
      flex: 1,
      background: T.card2,
      borderRadius: height / 2,
      height: height,
      overflow: 'hidden'
    }}>
      <div style={{
        width: `${Math.min((value / max) * 100, 100)}%`,
        height: '100%',
        background: color,
        borderRadius: height / 2,
        transition: 'width 0.5s ease'
      }} />
    </div>
    {showLabel && (
      <span style={{
        fontSize: 12,
        color: T.subtle,
        minWidth: 40,
        textAlign: 'right'
      }}>
        {Math.round((value / max) * 100)}%
      </span>
    )}
  </div>
);

/**
 * Tabs - Tab navigation component
 */
const Tabs = ({ tabs, active, onChange }) => (
  <div style={{
    display: 'flex',
    gap: 4,
    marginBottom: 16,
    borderBottom: `1px solid ${T.border}`,
    paddingBottom: 0
  }}>
    {tabs.map(t => (
      <button
        key={t.key || t}
        onClick={() => onChange(t.key || t)}
        style={{
          padding: '8px 16px',
          fontSize: 14,
          fontWeight: 600,
          background: 'none',
          border: 'none',
          cursor: 'pointer',
          borderBottom: active === (t.key || t)
            ? `2px solid ${T.blue}`
            : '2px solid transparent',
          color: active === (t.key || t) ? T.blue : T.subtle,
          transition: 'all 0.2s'
        }}
      >
        {t.label || t}
      </button>
    ))}
  </div>
);

/* ============================================================
 *  TOAST NOTIFICATION SYSTEM
 * ============================================================ */
const ToastCtx = createContext();

const ToastProvider = ({ children }) => {
  const [toasts, setToasts] = useState([]);

  const addToast = (msg, type = 'success') => {
    const id = uid();
    setToasts(prev => [...prev, { id, msg, type }]);
    setTimeout(() => {
      setToasts(prev => prev.filter(t => t.id !== id));
    }, 3500);
  };

  const colors = {
    success: T.green,
    error: T.red,
    warning: T.orange,
    info: T.blue
  };

  return (
    <ToastCtx.Provider value={addToast}>
      {children}
      <div style={{
        position: 'fixed',
        top: 16,
        right: 16,
        zIndex: 9999,
        display: 'flex',
        flexDirection: 'column',
        gap: 8
      }}>
        {toasts.map(t => (
          <div
            key={t.id}
            className="fade-in"
            style={{
              padding: '12px 20px',
              borderRadius: 10,
              background: T.card,
              border: `1px solid ${colors[t.type]}`,
              color: colors[t.type],
              fontSize: 14,
              fontWeight: 600,
              boxShadow: `0 4px 12px ${colors[t.type]}22`,
              minWidth: 250
            }}
          >
            {t.msg}
          </div>
        ))}
      </div>
    </ToastCtx.Provider>
  );
};

const useToast = () => useContext(ToastCtx);

/* ============================================================
 *  CONFIRM DIALOG SYSTEM
 * ============================================================ */
const ConfirmCtx = createContext();

const ConfirmProvider = ({ children }) => {
  const [state, setState] = useState({
    open: false,
    msg: '',
    onOk: null,
    onCancel: null
  });

  const confirm = (msg) => {
    return new Promise(resolve => {
      setState({
        open: true,
        msg: msg,
        onOk: () => {
          setState({ open: false, msg: '', onOk: null, onCancel: null });
          resolve(true);
        },
        onCancel: () => {
          setState({ open: false, msg: '', onOk: null, onCancel: null });
          resolve(false);
        }
      });
    });
  };

  return (
    <ConfirmCtx.Provider value={confirm}>
      {children}
      <Modal open={state.open} onClose={state.onCancel} title="Confirmar" width={400}>
        <p style={{ marginBottom: 20, color: T.text }}>{state.msg}</p>
        <div style={{ display: 'flex', gap: 8, justifyContent: 'flex-end' }}>
          <Btn variant="outline" onClick={state.onCancel}>Cancelar</Btn>
          <Btn color={T.red} onClick={state.onOk}>Confirmar</Btn>
        </div>
      </Modal>
    </ConfirmCtx.Provider>
  );
};

const useConfirm = () => useContext(ConfirmCtx);

/* ============================================================
 *  EXPORT / COPY HELPERS
 * ============================================================ */

/** Export data array as CSV file download */
const exportCSV = (data, filename) => {
  if (!data.length) return;
  const keys = Object.keys(data[0]);
  const csv = [
    keys.join(','),
    ...data.map(r => keys.map(k => '"' + (r[k] || '') + '"').join(','))
  ].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename + '.csv';
  a.click();
  URL.revokeObjectURL(url);
};

/** Copy data array as tab-separated text to clipboard */
const copyTable = (data) => {
  if (!data.length) return;
  const keys = Object.keys(data[0]);
  const txt = [
    keys.join('\t'),
    ...data.map(r => keys.map(k => r[k] || '').join('\t'))
  ].join('\n');
  navigator.clipboard.writeText(txt);
};


/* ============================================================
 *  DEMO DATA - Core ERP Modules
 * ============================================================ */
const initData = () => {
  const D = {};

  /* ---- Clientes ---- */
  D.clientes = [
    {
      id: uid(),
      nombre: "Distribuidora Nacional S.A.",
      nit: "1234567-8",
      contacto: "Carlos Mendoza",
      email: "carlos@distnacional.gt",
      telefono: "2334-5678",
      direccion: "6a Av. 10-20 Zona 1, Guatemala",
      tipo: "corporativo",
      credito: 500000,
      saldo: 125000,
      creado: "2024-06-15"
    },
    {
      id: uid(),
      nombre: "Supermercados El Ahorro",
      nit: "9876543-2",
      contacto: "Ana Martínez",
      email: "ana@elahorro.gt",
      telefono: "2456-7890",
      direccion: "Blvd. Los Próceres 15-30, Zona 10",
      tipo: "corporativo",
      credito: 300000,
      saldo: 45000,
      creado: "2024-07-20"
    },
    {
      id: uid(),
      nombre: "Tiendas La Economía",
      nit: "5544332-1",
      contacto: "Roberto Juárez",
      email: "rjuarez@laeconomia.gt",
      telefono: "2223-4456",
      direccion: "Calzada Roosevelt 25-80, Zona 11",
      tipo: "corporativo",
      credito: 200000,
      saldo: 78000,
      creado: "2024-08-10"
    },
    {
      id: uid(),
      nombre: "Exportadora del Sur",
      nit: "6677889-0",
      contacto: "Lucía Herrera",
      email: "lucia@exportsur.gt",
      telefono: "7832-1234",
      direccion: "Km 92 Carretera al Pacífico, Escuintla",
      tipo: "exportador",
      credito: 1000000,
      saldo: 350000,
      creado: "2024-05-01"
    },
    {
      id: uid(),
      nombre: "Dulces Típicos Guatemala",
      nit: "3344556-7",
      contacto: "Miguel Ángel Pérez",
      email: "miguel@dulcestipicos.gt",
      telefono: "2445-6789",
      direccion: "3a Calle 5-67 Zona 4, Quetzaltenango",
      tipo: "industrial",
      credito: 150000,
      saldo: 22000,
      creado: "2024-09-15"
    },
    {
      id: uid(),
      nombre: "Panadería Los Trigales",
      nit: "1122334-5",
      contacto: "Sandra López",
      email: "sandra@trigales.gt",
      telefono: "2334-8901",
      direccion: "7a Av. 12-45 Zona 1, Antigua Guatemala",
      tipo: "pyme",
      credito: 50000,
      saldo: 8000,
      creado: "2024-10-01"
    }
  ];

  /* ---- Proveedores ---- */
  D.proveedores = [
    {
      id: uid(),
      nombre: "Agroinsumos Guatemala S.A.",
      nit: "4455667-8",
      contacto: "Fernando Castillo",
      email: "fcastillo@agroinsumos.gt",
      telefono: "2334-1122",
      direccion: "Km 28 Carretera al Atlántico",
      tipo: "insumos",
      condiciones: "30 días",
      creado: "2024-03-15"
    },
    {
      id: uid(),
      nombre: "Repuestos Industriales Centroamérica",
      nit: "7788990-1",
      contacto: "Héctor Ramírez",
      email: "hramirez@repuestosca.gt",
      telefono: "2456-3344",
      direccion: "12 Calle 3-45 Zona 7, Guatemala",
      tipo: "repuestos",
      condiciones: "15 días",
      creado: "2024-04-20"
    },
    {
      id: uid(),
      nombre: "Combustibles del Pacífico",
      nit: "2233445-6",
      contacto: "Jorge Morales",
      email: "jmorales@combpac.gt",
      telefono: "7832-5566",
      direccion: "Km 85 Ruta al Pacífico, Escuintla",
      tipo: "combustible",
      condiciones: "contado",
      creado: "2024-05-10"
    },
    {
      id: uid(),
      nombre: "Químicos y Fertilizantes S.A.",
      nit: "8899001-2",
      contacto: "Patricia Vásquez",
      email: "pvasquez@quimfert.gt",
      telefono: "2445-7788",
      direccion: "Blvd. Liberación 20-15, Zona 13",
      tipo: "químicos",
      condiciones: "45 días",
      creado: "2024-06-01"
    },
    {
      id: uid(),
      nombre: "Empaques y Sacos Guatemala",
      nit: "5566778-9",
      contacto: "Diego Hernández",
      email: "dhernandez@empaquesgt.gt",
      telefono: "2223-9900",
      direccion: "Km 17 Carretera a El Salvador",
      tipo: "empaques",
      condiciones: "30 días",
      creado: "2024-07-15"
    },
    {
      id: uid(),
      nombre: "Transportes Pesados del Sur",
      nit: "3344556-0",
      contacto: "Mario López",
      email: "mlopez@transpesados.gt",
      telefono: "7834-2211",
      direccion: "Km 90 Carretera al Pacífico",
      tipo: "transporte",
      condiciones: "15 días",
      creado: "2024-08-01"
    }
  ];

  /* ---- Productos ---- */
  D.productos = [
    {
      id: uid(),
      nombre: "Azúcar Blanca Estándar",
      codigo: "AZB-001",
      categoria: "azúcar",
      unidad: "quintal",
      precio: 285,
      costo: 180,
      stock: 15000,
      stockMin: 2000,
      ubicacion: "Bodega Principal A1"
    },
    {
      id: uid(),
      nombre: "Azúcar Morena",
      codigo: "AZM-002",
      categoria: "azúcar",
      unidad: "quintal",
      precio: 250,
      costo: 155,
      stock: 8500,
      stockMin: 1500,
      ubicacion: "Bodega Principal A2"
    },
    {
      id: uid(),
      nombre: "Azúcar Refinada Premium",
      codigo: "AZR-003",
      categoria: "azúcar",
      unidad: "quintal",
      precio: 340,
      costo: 220,
      stock: 5200,
      stockMin: 1000,
      ubicacion: "Bodega Premium B1"
    },
    {
      id: uid(),
      nombre: "Melaza de Caña",
      codigo: "MEL-001",
      categoria: "subproducto",
      unidad: "galón",
      precio: 45,
      costo: 12,
      stock: 25000,
      stockMin: 5000,
      ubicacion: "Tanque T1"
    },
    {
      id: uid(),
      nombre: "Bagazo de Caña",
      codigo: "BAG-001",
      categoria: "subproducto",
      unidad: "tonelada",
      precio: 120,
      costo: 15,
      stock: 3500,
      stockMin: 500,
      ubicacion: "Patio Exterior"
    },
    {
      id: uid(),
      nombre: "Cachaza",
      codigo: "CAC-001",
      categoria: "subproducto",
      unidad: "tonelada",
      precio: 80,
      costo: 8,
      stock: 1200,
      stockMin: 200,
      ubicacion: "Área Compost"
    },
    {
      id: uid(),
      nombre: "Alcohol Etílico",
      codigo: "ALC-001",
      categoria: "derivado",
      unidad: "litro",
      precio: 35,
      costo: 18,
      stock: 45000,
      stockMin: 10000,
      ubicacion: "Bodega Químicos C1"
    },
    {
      id: uid(),
      nombre: "Fertilizante Orgánico (Vinaza)",
      codigo: "FER-001",
      categoria: "derivado",
      unidad: "litro",
      precio: 15,
      costo: 3,
      stock: 80000,
      stockMin: 15000,
      ubicacion: "Tanque T3"
    }
  ];

  /* ---- Facturas / Ventas ---- */
  D.facturas = [
    {
      id: uid(),
      numero: "FAC-2025-001",
      cliente: D.clientes[0].nombre,
      clienteId: D.clientes[0].id,
      fecha: "2025-01-15",
      vencimiento: "2025-02-15",
      items: [
        { producto: "Azúcar Blanca Estándar", cantidad: 500, precio: 285, total: 142500 }
      ],
      subtotal: 142500,
      iva: 17100,
      total: 159600,
      estado: "pagada",
      notas: "Entrega en bodega central"
    },
    {
      id: uid(),
      numero: "FAC-2025-002",
      cliente: D.clientes[1].nombre,
      clienteId: D.clientes[1].id,
      fecha: "2025-01-20",
      vencimiento: "2025-02-20",
      items: [
        { producto: "Azúcar Morena", cantidad: 300, precio: 250, total: 75000 },
        { producto: "Azúcar Refinada Premium", cantidad: 100, precio: 340, total: 34000 }
      ],
      subtotal: 109000,
      iva: 13080,
      total: 122080,
      estado: "pendiente",
      notas: ""
    },
    {
      id: uid(),
      numero: "FAC-2025-003",
      cliente: D.clientes[3].nombre,
      clienteId: D.clientes[3].id,
      fecha: "2025-01-25",
      vencimiento: "2025-03-25",
      items: [
        { producto: "Azúcar Blanca Estándar", cantidad: 2000, precio: 280, total: 560000 }
      ],
      subtotal: 560000,
      iva: 67200,
      total: 627200,
      estado: "pagada",
      notas: "Exportación FOB Puerto Quetzal"
    },
    {
      id: uid(),
      numero: "FAC-2025-004",
      cliente: D.clientes[2].nombre,
      clienteId: D.clientes[2].id,
      fecha: "2025-02-01",
      vencimiento: "2025-03-01",
      items: [
        { producto: "Azúcar Blanca Estándar", cantidad: 200, precio: 285, total: 57000 },
        { producto: "Azúcar Morena", cantidad: 150, precio: 250, total: 37500 }
      ],
      subtotal: 94500,
      iva: 11340,
      total: 105840,
      estado: "pendiente",
      notas: ""
    },
    {
      id: uid(),
      numero: "FAC-2025-005",
      cliente: D.clientes[4].nombre,
      clienteId: D.clientes[4].id,
      fecha: "2025-02-10",
      vencimiento: "2025-03-10",
      items: [
        { producto: "Melaza de Caña", cantidad: 5000, precio: 45, total: 225000 }
      ],
      subtotal: 225000,
      iva: 27000,
      total: 252000,
      estado: "vencida",
      notas: ""
    },
    {
      id: uid(),
      numero: "FAC-2025-006",
      cliente: D.clientes[5].nombre,
      clienteId: D.clientes[5].id,
      fecha: "2025-02-15",
      vencimiento: "2025-03-15",
      items: [
        { producto: "Azúcar Morena", cantidad: 50, precio: 250, total: 12500 }
      ],
      subtotal: 12500,
      iva: 1500,
      total: 14000,
      estado: "borrador",
      notas: "Pedido quincenal regular"
    },
    {
      id: uid(),
      numero: "COT-2025-001",
      cliente: D.clientes[0].nombre,
      clienteId: D.clientes[0].id,
      fecha: "2025-02-20",
      vencimiento: "2025-03-20",
      items: [
        { producto: "Azúcar Refinada Premium", cantidad: 1000, precio: 335, total: 335000 }
      ],
      subtotal: 335000,
      iva: 40200,
      total: 375200,
      estado: "cotización",
      notas: "Precio especial por volumen"
    }
  ];

  /* ---- Compras / Órdenes de Compra ---- */
  D.compras = [
    {
      id: uid(),
      numero: "OC-2025-001",
      proveedor: D.proveedores[0].nombre,
      proveedorId: D.proveedores[0].id,
      fecha: "2025-01-10",
      items: [
        { producto: "Herbicida Glifosato", cantidad: 200, precio: 450, total: 90000 }
      ],
      subtotal: 90000,
      iva: 10800,
      total: 100800,
      estado: "recibida"
    },
    {
      id: uid(),
      numero: "OC-2025-002",
      proveedor: D.proveedores[1].nombre,
      proveedorId: D.proveedores[1].id,
      fecha: "2025-01-18",
      items: [
        { producto: "Cuchillas para molino", cantidad: 24, precio: 1200, total: 28800 },
        { producto: "Rodamiento SKF 6310", cantidad: 8, precio: 850, total: 6800 }
      ],
      subtotal: 35600,
      iva: 4272,
      total: 39872,
      estado: "recibida"
    },
    {
      id: uid(),
      numero: "OC-2025-003",
      proveedor: D.proveedores[2].nombre,
      proveedorId: D.proveedores[2].id,
      fecha: "2025-02-01",
      items: [
        { producto: "Diesel", cantidad: 5000, precio: 32, total: 160000 }
      ],
      subtotal: 160000,
      iva: 19200,
      total: 179200,
      estado: "aprobada"
    },
    {
      id: uid(),
      numero: "OC-2025-004",
      proveedor: D.proveedores[3].nombre,
      proveedorId: D.proveedores[3].id,
      fecha: "2025-02-05",
      items: [
        { producto: "Cal hidratada", cantidad: 500, precio: 85, total: 42500 }
      ],
      subtotal: 42500,
      iva: 5100,
      total: 47600,
      estado: "pendiente"
    },
    {
      id: uid(),
      numero: "OC-2025-005",
      proveedor: D.proveedores[4].nombre,
      proveedorId: D.proveedores[4].id,
      fecha: "2025-02-10",
      items: [
        { producto: "Sacos de polipropileno 50kg", cantidad: 10000, precio: 8.5, total: 85000 }
      ],
      subtotal: 85000,
      iva: 10200,
      total: 95200,
      estado: "pendiente"
    }
  ];

  /* ---- Empleados ---- */
  D.empleados = [
    {
      id: uid(),
      nombre: "Carlos Alberto Galarreta Morales",
      dpi: "1234567890101",
      puesto: "Gerente General",
      departamento: "Dirección",
      salario: 35000,
      fechaIngreso: "2018-03-15",
      telefono: "5512-3456",
      email: "cgalarreta@transcana.gt",
      estado: "activo",
      igss: "12345678"
    },
    {
      id: uid(),
      nombre: "María Elena Rodríguez Pérez",
      dpi: "2345678901202",
      puesto: "Contadora General",
      departamento: "Contabilidad",
      salario: 18000,
      fechaIngreso: "2019-06-01",
      telefono: "5523-4567",
      email: "mrodriguez@transcana.gt",
      estado: "activo",
      igss: "23456789"
    },
    {
      id: uid(),
      nombre: "José Luis Hernández García",
      dpi: "3456789012303",
      puesto: "Jefe de Producción",
      departamento: "Producción",
      salario: 22000,
      fechaIngreso: "2017-01-15",
      telefono: "5534-5678",
      email: "jhernandez@transcana.gt",
      estado: "activo",
      igss: "34567890"
    },
    {
      id: uid(),
      nombre: "Ana Lucía Martínez López",
      dpi: "4567890123404",
      puesto: "Jefa de RRHH",
      departamento: "Recursos Humanos",
      salario: 16000,
      fechaIngreso: "2020-02-01",
      telefono: "5545-6789",
      email: "amartinez@transcana.gt",
      estado: "activo",
      igss: "45678901"
    },
    {
      id: uid(),
      nombre: "Pedro Francisco Morales Juárez",
      dpi: "5678901234505",
      puesto: "Supervisor de Campo",
      departamento: "Agrícola",
      salario: 12000,
      fechaIngreso: "2019-11-15",
      telefono: "5556-7890",
      email: "pmorales@transcana.gt",
      estado: "activo",
      igss: "56789012"
    },
    {
      id: uid(),
      nombre: "Rosa María Castillo Vásquez",
      dpi: "6789012345606",
      puesto: "Analista de Laboratorio",
      departamento: "Laboratorio",
      salario: 10000,
      fechaIngreso: "2021-04-01",
      telefono: "5567-8901",
      email: "rcastillo@transcana.gt",
      estado: "activo",
      igss: "67890123"
    },
    {
      id: uid(),
      nombre: "Diego Alejandro López Ramírez",
      dpi: "7890123456707",
      puesto: "Mecánico Industrial",
      departamento: "Mantenimiento",
      salario: 11000,
      fechaIngreso: "2020-08-15",
      telefono: "5578-9012",
      email: "dlopez@transcana.gt",
      estado: "activo",
      igss: "78901234"
    },
    {
      id: uid(),
      nombre: "Sofía Valentina Pérez Herrera",
      dpi: "8901234567808",
      puesto: "Coordinadora de Logística",
      departamento: "Logística",
      salario: 14000,
      fechaIngreso: "2021-01-10",
      telefono: "5589-0123",
      email: "sperez@transcana.gt",
      estado: "activo",
      igss: "89012345"
    }
  ];

  /* ---- Departamentos ---- */
  D.departamentos = [
    { id: uid(), nombre: "Dirección", jefe: "Carlos Alberto Galarreta Morales", empleados: 2 },
    { id: uid(), nombre: "Contabilidad", jefe: "María Elena Rodríguez Pérez", empleados: 4 },
    { id: uid(), nombre: "Producción", jefe: "José Luis Hernández García", empleados: 25 },
    { id: uid(), nombre: "Recursos Humanos", jefe: "Ana Lucía Martínez López", empleados: 3 },
    { id: uid(), nombre: "Agrícola", jefe: "Pedro Francisco Morales Juárez", empleados: 40 },
    { id: uid(), nombre: "Laboratorio", jefe: "Rosa María Castillo Vásquez", empleados: 6 },
    { id: uid(), nombre: "Mantenimiento", jefe: "Diego Alejandro López Ramírez", empleados: 15 },
    { id: uid(), nombre: "Logística", jefe: "Sofía Valentina Pérez Herrera", empleados: 12 }
  ];

  /* ---- CRM Leads ---- */
  D.leads = [
    {
      id: uid(),
      nombre: "Corporación Alimentos CA",
      contacto: "Ricardo Estrada",
      email: "restrada@corpca.gt",
      telefono: "2334-5566",
      valor: 500000,
      etapa: "prospecto",
      probabilidad: 20,
      origen: "referido",
      notas: "Interesado en azúcar refinada para exportación a Honduras",
      creado: "2025-01-10"
    },
    {
      id: uid(),
      nombre: "Industrias Bebidas GT",
      contacto: "Mariana Flores",
      email: "mflores@bebidasgt.gt",
      telefono: "2456-7788",
      valor: 350000,
      etapa: "calificado",
      probabilidad: 40,
      origen: "web",
      notas: "Necesitan melaza para producción de ron",
      creado: "2025-01-15"
    },
    {
      id: uid(),
      nombre: "Cadena Hoteles Pacífico",
      contacto: "Roberto Díaz",
      email: "rdiaz@hotelpacifico.gt",
      telefono: "7832-9900",
      valor: 80000,
      etapa: "propuesta",
      probabilidad: 65,
      origen: "feria",
      notas: "Suministro mensual de azúcar para 12 hoteles",
      creado: "2025-01-20"
    },
    {
      id: uid(),
      nombre: "Biocombustibles Centroamérica",
      contacto: "Eduardo Monzón",
      email: "emonzon@biocomca.gt",
      telefono: "2223-1122",
      valor: 1200000,
      etapa: "negociación",
      probabilidad: 75,
      origen: "directo",
      notas: "Contrato anual de alcohol etílico",
      creado: "2024-12-01"
    },
    {
      id: uid(),
      nombre: "Dulcería Artesanal Xela",
      contacto: "Claudia Mazariegos",
      email: "cmazariegos@dulcexela.gt",
      telefono: "7765-3344",
      valor: 45000,
      etapa: "prospecto",
      probabilidad: 15,
      origen: "web",
      notas: "Azúcar morena para confitería artesanal",
      creado: "2025-02-01"
    },
    {
      id: uid(),
      nombre: "Exportadora Caribe S.A.",
      contacto: "Alfredo Pineda",
      email: "apineda@expcaribe.gt",
      telefono: "2334-5577",
      valor: 2000000,
      etapa: "ganado",
      probabilidad: 100,
      origen: "referido",
      notas: "Contrato exportación azúcar cruda 20,000 TM",
      creado: "2024-11-15"
    }
  ];

  /* ---- Contabilidad: Plan de Cuentas ---- */
  D.cuentas = [
    { id: uid(), codigo: "1000", nombre: "Activos", tipo: "activo", saldo: 15000000, padre: null },
    { id: uid(), codigo: "1100", nombre: "Bancos", tipo: "activo", saldo: 3500000, padre: "1000" },
    { id: uid(), codigo: "1200", nombre: "Cuentas por Cobrar", tipo: "activo", saldo: 1250000, padre: "1000" },
    { id: uid(), codigo: "1300", nombre: "Inventarios", tipo: "activo", saldo: 8500000, padre: "1000" },
    { id: uid(), codigo: "2000", nombre: "Pasivos", tipo: "pasivo", saldo: 5000000, padre: null },
    { id: uid(), codigo: "2100", nombre: "Cuentas por Pagar", tipo: "pasivo", saldo: 2800000, padre: "2000" },
    { id: uid(), codigo: "3000", nombre: "Capital", tipo: "capital", saldo: 10000000, padre: null },
    { id: uid(), codigo: "4000", nombre: "Ingresos", tipo: "ingreso", saldo: 12500000, padre: null },
    { id: uid(), codigo: "4100", nombre: "Ventas de Azúcar", tipo: "ingreso", saldo: 9800000, padre: "4000" },
    { id: uid(), codigo: "4200", nombre: "Ventas de Subproductos", tipo: "ingreso", saldo: 2700000, padre: "4000" },
    { id: uid(), codigo: "5000", nombre: "Gastos", tipo: "gasto", saldo: 8200000, padre: null },
    { id: uid(), codigo: "5100", nombre: "Costo de Producción", tipo: "gasto", saldo: 5500000, padre: "5000" },
    { id: uid(), codigo: "5200", nombre: "Gastos Administrativos", tipo: "gasto", saldo: 1800000, padre: "5000" },
    { id: uid(), codigo: "5300", nombre: "Gastos de Ventas", tipo: "gasto", saldo: 900000, padre: "5000" }
  ];

  /* ---- Contabilidad: Asientos ---- */
  D.asientos = [
    {
      id: uid(),
      numero: "AS-2025-001",
      fecha: "2025-01-31",
      descripcion: "Registro ventas enero 2025",
      lineas: [
        { cuenta: "4100", debe: 0, haber: 929200 },
        { cuenta: "1100", debe: 929200, haber: 0 }
      ],
      total: 929200,
      estado: "aprobado"
    },
    {
      id: uid(),
      numero: "AS-2025-002",
      fecha: "2025-01-31",
      descripcion: "Compra de insumos agrícolas enero",
      lineas: [
        { cuenta: "5100", debe: 100800, haber: 0 },
        { cuenta: "2100", debe: 0, haber: 100800 }
      ],
      total: 100800,
      estado: "aprobado"
    },
    {
      id: uid(),
      numero: "AS-2025-003",
      fecha: "2025-02-15",
      descripcion: "Nómina primera quincena febrero",
      lineas: [
        { cuenta: "5200", debe: 180000, haber: 0 },
        { cuenta: "1100", debe: 0, haber: 180000 }
      ],
      total: 180000,
      estado: "borrador"
    },
    {
      id: uid(),
      numero: "AS-2025-004",
      fecha: "2025-02-20",
      descripcion: "Venta exportación azúcar febrero",
      lineas: [
        { cuenta: "1200", debe: 627200, haber: 0 },
        { cuenta: "4100", debe: 0, haber: 627200 }
      ],
      total: 627200,
      estado: "aprobado"
    }
  ];

  return D;
};


/* ============================================================
 *  DEMO DATA - TransCaña Specific Modules
 * ============================================================ */
const initTransCana = () => {
  const D = {};

  /* ---- Zafras (Harvest Campaigns) ---- */
  D.zafras = [
    {
      id: uid(),
      nombre: "Zafra 2025-2026",
      codigo: "ZAF-2526",
      fechaInicio: "2025-11-01",
      fechaFin: "2026-04-30",
      metaToneladas: 850000,
      toneladasProcesadas: 320000,
      metaAzucar: 95000,
      azucarProducida: 36000,
      estado: "activa",
      notas: "Zafra actual en curso, rendimiento dentro de lo esperado"
    },
    {
      id: uid(),
      nombre: "Zafra 2024-2025",
      codigo: "ZAF-2425",
      fechaInicio: "2024-11-01",
      fechaFin: "2025-04-30",
      metaToneladas: 800000,
      toneladasProcesadas: 785000,
      metaAzucar: 90000,
      azucarProducida: 88500,
      estado: "finalizada",
      notas: "Excelente rendimiento general, 98.3% de cumplimiento"
    },
    {
      id: uid(),
      nombre: "Zafra 2023-2024",
      codigo: "ZAF-2324",
      fechaInicio: "2023-11-01",
      fechaFin: "2024-04-30",
      metaToneladas: 750000,
      toneladasProcesadas: 742000,
      metaAzucar: 82000,
      azucarProducida: 79800,
      estado: "finalizada",
      notas: "Afectada por lluvias tardías en marzo y abril"
    }
  ];

  /* ---- Rutas de Transporte ---- */
  D.rutas = [
    {
      id: uid(),
      nombre: "Ingenio-Finca El Progreso",
      origen: "Ingenio TransCaña",
      destino: "Finca El Progreso",
      distanciaKm: 45,
      tiempoEstimado: 75,
      estado: "activa",
      tipo: "recolección"
    },
    {
      id: uid(),
      nombre: "Ingenio-Finca Santa Lucía",
      origen: "Ingenio TransCaña",
      destino: "Finca Santa Lucía",
      distanciaKm: 32,
      tiempoEstimado: 50,
      estado: "activa",
      tipo: "recolección"
    },
    {
      id: uid(),
      nombre: "Ingenio-Finca Las Palmas",
      origen: "Ingenio TransCaña",
      destino: "Finca Las Palmas",
      distanciaKm: 58,
      tiempoEstimado: 90,
      estado: "activa",
      tipo: "recolección"
    },
    {
      id: uid(),
      nombre: "Ingenio-Finca San Cristóbal",
      origen: "Ingenio TransCaña",
      destino: "Finca San Cristóbal",
      distanciaKm: 25,
      tiempoEstimado: 40,
      estado: "activa",
      tipo: "recolección"
    },
    {
      id: uid(),
      nombre: "Ingenio-Puerto Quetzal",
      origen: "Ingenio TransCaña",
      destino: "Puerto Quetzal",
      distanciaKm: 78,
      tiempoEstimado: 120,
      estado: "activa",
      tipo: "exportación"
    },
    {
      id: uid(),
      nombre: "Ingenio-Bodega Capital",
      origen: "Ingenio TransCaña",
      destino: "Bodega Guatemala Ciudad",
      distanciaKm: 95,
      tiempoEstimado: 150,
      estado: "activa",
      tipo: "distribución"
    }
  ];

  /* ---- Viajes (Trips) ---- */
  D.viajes = [
    {
      id: uid(),
      ruta: "Ingenio-Finca El Progreso",
      conductor: "Manuel Tzoc",
      placa: "P-456ABC",
      fechaSalida: "2025-02-20T06:00",
      fechaLlegada: "2025-02-20T07:15",
      toneladas: 28.5,
      estado: "completado",
      observaciones: "Sin novedad"
    },
    {
      id: uid(),
      ruta: "Ingenio-Finca Santa Lucía",
      conductor: "Juan Carlos Ixchop",
      placa: "P-789DEF",
      fechaSalida: "2025-02-20T06:30",
      fechaLlegada: "2025-02-20T07:20",
      toneladas: 32.1,
      estado: "completado",
      observaciones: ""
    },
    {
      id: uid(),
      ruta: "Ingenio-Finca Las Palmas",
      conductor: "Pedro Ajcac",
      placa: "P-123GHI",
      fechaSalida: "2025-02-20T05:30",
      fechaLlegada: "2025-02-20T07:00",
      toneladas: 25.8,
      estado: "completado",
      observaciones: "Camino en mal estado km 45"
    },
    {
      id: uid(),
      ruta: "Ingenio-Finca El Progreso",
      conductor: "Manuel Tzoc",
      placa: "P-456ABC",
      fechaSalida: "2025-02-21T06:00",
      fechaLlegada: "2025-02-21T07:10",
      toneladas: 30.2,
      estado: "completado",
      observaciones: ""
    },
    {
      id: uid(),
      ruta: "Ingenio-Finca San Cristóbal",
      conductor: "Luis Hernández",
      placa: "P-321JKL",
      fechaSalida: "2025-02-21T07:00",
      fechaLlegada: "",
      toneladas: 27.0,
      estado: "en_tránsito",
      observaciones: "Salió a las 7am"
    },
    {
      id: uid(),
      ruta: "Ingenio-Puerto Quetzal",
      conductor: "Roberto Caal",
      placa: "P-654MNO",
      fechaSalida: "2025-02-21T04:00",
      fechaLlegada: "2025-02-21T06:05",
      toneladas: 35.0,
      estado: "completado",
      observaciones: "Exportación lote EXP-2025-012"
    },
    {
      id: uid(),
      ruta: "Ingenio-Bodega Capital",
      conductor: "Carlos Mejía",
      placa: "P-987PQR",
      fechaSalida: "2025-02-22T05:00",
      fechaLlegada: "",
      toneladas: 22.5,
      estado: "programado",
      observaciones: "Entrega distribuidora"
    }
  ];

  /* ---- Muestras de Laboratorio ---- */
  D.muestras = [
    {
      id: uid(), codigo: "LAB-2025-001", fecha: "2025-02-20",
      origen: "Finca El Progreso", lote: "LOT-EP-001",
      brix: 20.5, pol: 16.2, fibra: 13.1,
      pureza: 0, rendimiento: 0, grado: "",
      analista: "Rosa María Castillo",
      observaciones: "Caña fresca, buena calidad"
    },
    {
      id: uid(), codigo: "LAB-2025-002", fecha: "2025-02-20",
      origen: "Finca Santa Lucía", lote: "LOT-SL-001",
      brix: 19.8, pol: 15.5, fibra: 12.8,
      pureza: 0, rendimiento: 0, grado: "",
      analista: "Rosa María Castillo",
      observaciones: ""
    },
    {
      id: uid(), codigo: "LAB-2025-003", fecha: "2025-02-20",
      origen: "Finca Las Palmas", lote: "LOT-LP-001",
      brix: 18.2, pol: 13.8, fibra: 14.2,
      pureza: 0, rendimiento: 0, grado: "",
      analista: "Rosa María Castillo",
      observaciones: "Fibra alta, caña madura"
    },
    {
      id: uid(), codigo: "LAB-2025-004", fecha: "2025-02-21",
      origen: "Finca El Progreso", lote: "LOT-EP-002",
      brix: 21.0, pol: 17.1, fibra: 12.5,
      pureza: 0, rendimiento: 0, grado: "",
      analista: "Juan Pablo Méndez",
      observaciones: "Excelente calidad"
    },
    {
      id: uid(), codigo: "LAB-2025-005", fecha: "2025-02-21",
      origen: "Finca San Cristóbal", lote: "LOT-SC-001",
      brix: 19.0, pol: 14.5, fibra: 13.5,
      pureza: 0, rendimiento: 0, grado: "",
      analista: "Juan Pablo Méndez",
      observaciones: ""
    },
    {
      id: uid(), codigo: "LAB-2025-006", fecha: "2025-02-21",
      origen: "Finca Santa Lucía", lote: "LOT-SL-002",
      brix: 20.1, pol: 15.9, fibra: 13.0,
      pureza: 0, rendimiento: 0, grado: "",
      analista: "Rosa María Castillo",
      observaciones: "Segundo corte de la temporada"
    },
    {
      id: uid(), codigo: "LAB-2025-007", fecha: "2025-02-22",
      origen: "Finca Las Palmas", lote: "LOT-LP-002",
      brix: 17.5, pol: 12.8, fibra: 15.0,
      pureza: 0, rendimiento: 0, grado: "",
      analista: "Juan Pablo Méndez",
      observaciones: "Caña con exceso de hojas, alto contenido de fibra"
    }
  ];

  // Auto-calculate laboratory values for all samples
  D.muestras = D.muestras.map(m => {
    const pureza = (m.pol / m.brix) * 100;
    const rendimiento = m.pol * (1 - m.fibra / 100) * 0.7;
    const grado = pureza >= 85 ? 'A' : pureza >= 75 ? 'B' : pureza >= 65 ? 'C' : 'D';
    return {
      ...m,
      pureza: Math.round(pureza * 100) / 100,
      rendimiento: Math.round(rendimiento * 100) / 100,
      grado: grado
    };
  });

  /* ---- Colonos (Farmers) ---- */
  D.colonos = [
    {
      id: uid(),
      nombre: "Juan Pérez García",
      dpi: "1234567890101",
      finca: "Finca El Progreso",
      hectareas: 150,
      variedad: "CP 72-2086",
      telefono: "5512-1234",
      email: "jperez@gmail.com",
      banco: "Banrural",
      cuenta: "3001-12345-67",
      estado: "activo",
      creado: "2020-01-15"
    },
    {
      id: uid(),
      nombre: "María López de Hernández",
      dpi: "2345678901202",
      finca: "Finca Santa Lucía",
      hectareas: 85,
      variedad: "MEX 79-431",
      telefono: "5523-2345",
      email: "mlopez@gmail.com",
      banco: "Banrural",
      cuenta: "3001-23456-78",
      estado: "activo",
      creado: "2019-06-01"
    },
    {
      id: uid(),
      nombre: "Roberto Ajcalón Choy",
      dpi: "3456789012303",
      finca: "Finca Las Palmas",
      hectareas: 200,
      variedad: "CP 72-2086",
      telefono: "5534-3456",
      email: "rajcalon@gmail.com",
      banco: "Industrial",
      cuenta: "4001-34567-89",
      estado: "activo",
      creado: "2018-03-15"
    },
    {
      id: uid(),
      nombre: "Carmen Ixchel Tuyuc",
      dpi: "4567890123404",
      finca: "Finca San Cristóbal",
      hectareas: 65,
      variedad: "SP 79-2233",
      telefono: "5545-4567",
      email: "ctuyuc@gmail.com",
      banco: "Banrural",
      cuenta: "3001-45678-90",
      estado: "activo",
      creado: "2021-01-10"
    },
    {
      id: uid(),
      nombre: "Francisco Domingo Caal",
      dpi: "5678901234505",
      finca: "Finca El Paraíso",
      hectareas: 120,
      variedad: "RB 72-454",
      telefono: "5556-5678",
      email: "fcaal@gmail.com",
      banco: "G&T Continental",
      cuenta: "5001-56789-01",
      estado: "activo",
      creado: "2020-08-20"
    },
    {
      id: uid(),
      nombre: "Elena Beatriz Morales",
      dpi: "6789012345606",
      finca: "Finca Los Laureles",
      hectareas: 95,
      variedad: "CP 72-2086",
      telefono: "5567-6789",
      email: "emorales@gmail.com",
      banco: "Banrural",
      cuenta: "3001-67890-12",
      estado: "inactivo",
      creado: "2019-11-01"
    }
  ];

  /* ---- Entregas de Colonos ---- */
  D.entregas = [
    {
      id: uid(),
      colonoId: D.colonos[0].id,
      colono: "Juan Pérez García",
      fecha: "2025-02-20",
      toneladasBruta: 30.5,
      tara: 2.0,
      toneladasNeta: 28.5,
      precioTonelada: 380,
      total: 10830,
      zafra: "Zafra 2025-2026",
      estado: "liquidada",
      boleta: "BOL-2025-001"
    },
    {
      id: uid(),
      colonoId: D.colonos[1].id,
      colono: "María López de Hernández",
      fecha: "2025-02-20",
      toneladasBruta: 34.2,
      tara: 2.1,
      toneladasNeta: 32.1,
      precioTonelada: 380,
      total: 12198,
      zafra: "Zafra 2025-2026",
      estado: "liquidada",
      boleta: "BOL-2025-002"
    },
    {
      id: uid(),
      colonoId: D.colonos[2].id,
      colono: "Roberto Ajcalón Choy",
      fecha: "2025-02-20",
      toneladasBruta: 28.0,
      tara: 2.2,
      toneladasNeta: 25.8,
      precioTonelada: 375,
      total: 9675,
      zafra: "Zafra 2025-2026",
      estado: "pendiente",
      boleta: "BOL-2025-003"
    },
    {
      id: uid(),
      colonoId: D.colonos[0].id,
      colono: "Juan Pérez García",
      fecha: "2025-02-21",
      toneladasBruta: 32.5,
      tara: 2.3,
      toneladasNeta: 30.2,
      precioTonelada: 380,
      total: 11476,
      zafra: "Zafra 2025-2026",
      estado: "pendiente",
      boleta: "BOL-2025-004"
    },
    {
      id: uid(),
      colonoId: D.colonos[3].id,
      colono: "Carmen Ixchel Tuyuc",
      fecha: "2025-02-21",
      toneladasBruta: 29.5,
      tara: 2.5,
      toneladasNeta: 27.0,
      precioTonelada: 370,
      total: 9990,
      zafra: "Zafra 2025-2026",
      estado: "pendiente",
      boleta: "BOL-2025-005"
    },
    {
      id: uid(),
      colonoId: D.colonos[4].id,
      colono: "Francisco Domingo Caal",
      fecha: "2025-02-22",
      toneladasBruta: 37.0,
      tara: 2.0,
      toneladasNeta: 35.0,
      precioTonelada: 385,
      total: 13475,
      zafra: "Zafra 2025-2026",
      estado: "programada",
      boleta: "BOL-2025-006"
    }
  ];

  /* ---- Equipos Industriales ---- */
  D.equipos = [
    {
      id: uid(),
      nombre: "Molino Principal",
      codigo: "EQ-MOL-001",
      tipo: "producción",
      ubicacion: "Área de Molienda",
      estado: "operativo",
      fabricante: "Tongaat Hulett",
      modelo: "TH-5000",
      anio: 2018,
      ultimoMant: "2025-02-01",
      proximoMant: "2025-03-01",
      horasUso: 15200,
      observaciones: "Rendimiento óptimo, eficiencia de extracción 96%"
    },
    {
      id: uid(),
      nombre: "Caldera #1",
      codigo: "EQ-CAL-001",
      tipo: "generación",
      ubicacion: "Casa de Calderas",
      estado: "operativo",
      fabricante: "Babcock & Wilcox",
      modelo: "BW-800",
      anio: 2016,
      ultimoMant: "2025-01-15",
      proximoMant: "2025-04-15",
      horasUso: 22000,
      observaciones: "Presión estable 650 PSI"
    },
    {
      id: uid(),
      nombre: "Centrífuga A",
      codigo: "EQ-CEN-001",
      tipo: "producción",
      ubicacion: "Área de Centrifugación",
      estado: "operativo",
      fabricante: "BMA",
      modelo: "BMA-K2300",
      anio: 2019,
      ultimoMant: "2025-02-10",
      proximoMant: "2025-03-10",
      horasUso: 11500,
      observaciones: ""
    },
    {
      id: uid(),
      nombre: "Caldera #2",
      codigo: "EQ-CAL-002",
      tipo: "generación",
      ubicacion: "Casa de Calderas",
      estado: "mantenimiento",
      fabricante: "Babcock & Wilcox",
      modelo: "BW-600",
      anio: 2014,
      ultimoMant: "2025-02-15",
      proximoMant: "2025-02-28",
      horasUso: 28000,
      observaciones: "En reparación de tubos, 8 de 12 reemplazados"
    },
    {
      id: uid(),
      nombre: "Evaporador Triple Efecto",
      codigo: "EQ-EVA-001",
      tipo: "producción",
      ubicacion: "Área de Evaporación",
      estado: "operativo",
      fabricante: "Fletcher Smith",
      modelo: "FS-TE3",
      anio: 2017,
      ultimoMant: "2025-01-20",
      proximoMant: "2025-03-20",
      horasUso: 17800,
      observaciones: "Eficiencia térmica 92%"
    },
    {
      id: uid(),
      nombre: "Turbina de Vapor #1",
      codigo: "EQ-TUR-001",
      tipo: "generación",
      ubicacion: "Casa de Fuerza",
      estado: "operativo",
      fabricante: "Siemens",
      modelo: "SST-060",
      anio: 2020,
      ultimoMant: "2025-02-05",
      proximoMant: "2025-05-05",
      horasUso: 8500,
      observaciones: "Generación 25 MW estable"
    },
    {
      id: uid(),
      nombre: "Báscula de Patio",
      codigo: "EQ-BAS-001",
      tipo: "pesaje",
      ubicacion: "Patio de Caña",
      estado: "operativo",
      fabricante: "Fairbanks",
      modelo: "FB-8000",
      anio: 2019,
      ultimoMant: "2025-02-12",
      proximoMant: "2025-03-12",
      horasUso: 12000,
      observaciones: "Calibrada febrero 2025, certificado emitido"
    },
    {
      id: uid(),
      nombre: "Difusor de Caña",
      codigo: "EQ-DIF-001",
      tipo: "producción",
      ubicacion: "Área de Extracción",
      estado: "fuera_servicio",
      fabricante: "Bosch Projects",
      modelo: "BP-DC600",
      anio: 2015,
      ultimoMant: "2024-12-01",
      proximoMant: "",
      horasUso: 25000,
      observaciones: "Requiere repuesto importado de Sudáfrica, ETA marzo 2025"
    }
  ];

  /* ---- Órdenes de Trabajo (Work Orders) ---- */
  D.ordenesT = [
    {
      id: uid(),
      numero: "OT-2025-001",
      equipo: "Caldera #2",
      equipoId: D.equipos[3].id,
      tipo: "correctivo",
      prioridad: "alta",
      descripcion: "Reparación de tubos de caldera con fugas detectadas en inspección",
      asignado: "Diego Alejandro López Ramírez",
      fechaCreacion: "2025-02-15",
      fechaInicio: "2025-02-16",
      fechaFin: "",
      estado: "en_progreso",
      costoEstimado: 45000,
      costoReal: 32000,
      observaciones: "Se han reemplazado 8 de 12 tubos dañados"
    },
    {
      id: uid(),
      numero: "OT-2025-002",
      equipo: "Molino Principal",
      equipoId: D.equipos[0].id,
      tipo: "preventivo",
      prioridad: "media",
      descripcion: "Cambio de cuchillas desgastadas y ajuste de mazas de molienda",
      asignado: "Diego Alejandro López Ramírez",
      fechaCreacion: "2025-02-20",
      fechaInicio: "",
      fechaFin: "",
      estado: "pendiente",
      costoEstimado: 28000,
      costoReal: 0,
      observaciones: "Programada para próxima parada de planta"
    },
    {
      id: uid(),
      numero: "OT-2025-003",
      equipo: "Difusor de Caña",
      equipoId: D.equipos[7].id,
      tipo: "correctivo",
      prioridad: "crítica",
      descripcion: "Reemplazo de cadena principal del difusor, falla total",
      asignado: "Diego Alejandro López Ramírez",
      fechaCreacion: "2024-12-01",
      fechaInicio: "2024-12-05",
      fechaFin: "",
      estado: "en_espera",
      costoEstimado: 120000,
      costoReal: 15000,
      observaciones: "Esperando repuesto importado de Sudáfrica, tracking en tránsito"
    },
    {
      id: uid(),
      numero: "OT-2025-004",
      equipo: "Centrífuga A",
      equipoId: D.equipos[2].id,
      tipo: "preventivo",
      prioridad: "baja",
      descripcion: "Lubricación general y revisión de canasta centrífuga",
      asignado: "Mario Toc",
      fechaCreacion: "2025-02-22",
      fechaInicio: "",
      fechaFin: "",
      estado: "pendiente",
      costoEstimado: 5000,
      costoReal: 0,
      observaciones: ""
    },
    {
      id: uid(),
      numero: "OT-2025-005",
      equipo: "Báscula de Patio",
      equipoId: D.equipos[6].id,
      tipo: "preventivo",
      prioridad: "media",
      descripcion: "Calibración trimestral de báscula según norma COGUANOR",
      asignado: "Mario Toc",
      fechaCreacion: "2025-02-10",
      fechaInicio: "2025-02-12",
      fechaFin: "2025-02-12",
      estado: "completada",
      costoEstimado: 3000,
      costoReal: 2800,
      observaciones: "Calibración exitosa, certificado NTG 47001 emitido"
    }
  ];

  /* ---- Repuestos (Spare Parts) ---- */
  D.repuestos = [
    {
      id: uid(),
      nombre: "Cuchillas para molino",
      codigo: "REP-CUC-001",
      equipo: "Molino Principal",
      stock: 24,
      stockMin: 12,
      unidad: "unidad",
      costo: 1200,
      proveedor: "Repuestos Industriales CA",
      ubicacion: "Almacén Rep-A1"
    },
    {
      id: uid(),
      nombre: "Rodamiento SKF 6310",
      codigo: "REP-ROD-001",
      equipo: "Centrífuga A",
      stock: 8,
      stockMin: 4,
      unidad: "unidad",
      costo: 850,
      proveedor: "Repuestos Industriales CA",
      ubicacion: "Almacén Rep-A2"
    },
    {
      id: uid(),
      nombre: "Tubos de caldera 3 pulgadas",
      codigo: "REP-TUB-001",
      equipo: "Caldera #1 y #2",
      stock: 15,
      stockMin: 10,
      unidad: "unidad",
      costo: 2500,
      proveedor: "Repuestos Industriales CA",
      ubicacion: "Almacén Rep-B1"
    },
    {
      id: uid(),
      nombre: "Empaque viton para centrífuga",
      codigo: "REP-EMP-001",
      equipo: "Centrífuga A",
      stock: 30,
      stockMin: 10,
      unidad: "unidad",
      costo: 180,
      proveedor: "Repuestos Industriales CA",
      ubicacion: "Almacén Rep-A2"
    },
    {
      id: uid(),
      nombre: "Cadena transportadora DIN 8187",
      codigo: "REP-CAD-001",
      equipo: "Difusor de Caña",
      stock: 0,
      stockMin: 2,
      unidad: "metro",
      costo: 4500,
      proveedor: "Importación directa Sudáfrica",
      ubicacion: "Pendiente llegada"
    },
    {
      id: uid(),
      nombre: "Filtro de aceite hidráulico",
      codigo: "REP-FIL-001",
      equipo: "Varios",
      stock: 20,
      stockMin: 8,
      unidad: "unidad",
      costo: 350,
      proveedor: "Repuestos Industriales CA",
      ubicacion: "Almacén Rep-C1"
    },
    {
      id: uid(),
      nombre: "Grasa alta temperatura EP2",
      codigo: "REP-GRA-001",
      equipo: "Varios",
      stock: 48,
      stockMin: 12,
      unidad: "cartucho",
      costo: 95,
      proveedor: "Combustibles del Pacífico",
      ubicacion: "Almacén Lub-A1"
    }
  ];

  /* ---- Nómina (Payroll) ---- */
  D.nominas = [
    {
      id: uid(),
      periodo: "2025-02 Q1",
      tipo: "quincenal",
      fechaInicio: "2025-02-01",
      fechaFin: "2025-02-15",
      estado: "pagada",
      totalBruto: 420000,
      totalIGSS: 20286,
      totalISR: 18500,
      totalDeducciones: 38786,
      totalNeto: 381214,
      aprobadoPor: "Carlos Alberto Galarreta Morales",
      fechaAprobacion: "2025-02-14",
      empleados: 8
    },
    {
      id: uid(),
      periodo: "2025-02 Q2",
      tipo: "quincenal",
      fechaInicio: "2025-02-16",
      fechaFin: "2025-02-28",
      estado: "aprobada",
      totalBruto: 420000,
      totalIGSS: 20286,
      totalISR: 18500,
      totalDeducciones: 38786,
      totalNeto: 381214,
      aprobadoPor: "Carlos Alberto Galarreta Morales",
      fechaAprobacion: "2025-02-27",
      empleados: 8
    },
    {
      id: uid(),
      periodo: "2025-01 Mensual",
      tipo: "mensual",
      fechaInicio: "2025-01-01",
      fechaFin: "2025-01-31",
      estado: "pagada",
      totalBruto: 840000,
      totalIGSS: 40572,
      totalISR: 37000,
      totalDeducciones: 77572,
      totalNeto: 762428,
      aprobadoPor: "Carlos Alberto Galarreta Morales",
      fechaAprobacion: "2025-01-30",
      empleados: 8
    }
  ];

  /* ---- BI Snapshots ---- */
  D.biSnapshots = [
    {
      id: uid(),
      fecha: "2025-02-22",
      ventasMes: 1280720,
      comprasMes: 462672,
      margen: 818048,
      toneladasDia: 143.6,
      muestrasAprobadas: 5,
      equiposOperativos: 6,
      otPendientes: 2,
      colonosActivos: 5
    },
    {
      id: uid(),
      fecha: "2025-02-21",
      ventasMes: 1180720,
      comprasMes: 420000,
      margen: 760720,
      toneladasDia: 119.3,
      muestrasAprobadas: 4,
      equiposOperativos: 6,
      otPendientes: 3,
      colonosActivos: 5
    },
    {
      id: uid(),
      fecha: "2025-02-20",
      ventasMes: 1050000,
      comprasMes: 380000,
      margen: 670000,
      toneladasDia: 86.4,
      muestrasAprobadas: 3,
      equiposOperativos: 6,
      otPendientes: 3,
      colonosActivos: 5
    }
  ];

  /* ---- Alertas del Sistema ---- */
  D.alertas = [
    {
      id: uid(),
      tipo: "warning",
      modulo: "Inventario",
      mensaje: "Stock bajo: Cadena transportadora DIN 8187 (0 unidades)",
      fecha: "2025-02-22",
      leida: false
    },
    {
      id: uid(),
      tipo: "error",
      modulo: "Mantenimiento",
      mensaje: "Equipo fuera de servicio: Difusor de Caña - Esperando repuesto importado",
      fecha: "2025-02-22",
      leida: false
    },
    {
      id: uid(),
      tipo: "info",
      modulo: "Laboratorio",
      mensaje: "7 muestras procesadas esta semana - Grado promedio: B+",
      fecha: "2025-02-22",
      leida: true
    },
    {
      id: uid(),
      tipo: "warning",
      modulo: "Nómina",
      mensaje: "Nómina Q2 Febrero pendiente de pago",
      fecha: "2025-02-22",
      leida: false
    },
    {
      id: uid(),
      tipo: "success",
      modulo: "Ventas",
      mensaje: "Factura FAC-2025-003 cobrada exitosamente: Q627,200.00",
      fecha: "2025-02-21",
      leida: true
    }
  ];

  return D;
};


/* ============================================================
 *  LOGIN SCREEN
 * ============================================================ */
const LoginScreen = ({ onLogin }) => {
  const [email, setEmail] = useState('');
  const [pass, setPass] = useState('');
  const [error, setError] = useState('');

  const users = [
    { email: 'admin@transcana.gt', pass: 'admin', nombre: 'Carlos Galarreta', rol: 'Administrador' },
    { email: 'contador@transcana.gt', pass: '1234', nombre: 'María Rodríguez', rol: 'Contador' },
    { email: 'colono@transcana.gt', pass: '1234', nombre: 'Juan Pérez', rol: 'Colono' }
  ];

  const handleLogin = () => {
    const u = users.find(u => u.email === email && u.pass === pass);
    if (u) {
      setError('');
      onLogin(u);
    } else {
      setError('Credenciales inválidas. Intente de nuevo.');
    }
  };

  return (
    <div style={{
      minHeight: '100vh',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      background: `linear-gradient(135deg, ${T.bg}, #0a1628, #0d1a30)`
    }}>
      <div className="fade-in" style={{
        width: 420,
        background: T.card,
        border: `1px solid ${T.border}`,
        borderRadius: 20,
        padding: 40,
        boxShadow: '0 20px 60px rgba(0,0,0,0.5)'
      }}>
        {/* Logo and branding */}
        <div style={{ textAlign: 'center', marginBottom: 32 }}>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: 12,
            marginBottom: 8
          }}>
            <Icons.Leaf size={36} color={T.green} />
            <div>
              <h1 style={{
                fontSize: 28,
                fontWeight: 800,
                background: `linear-gradient(135deg, ${T.green}, ${T.teal})`,
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent'
              }}>
                TransCaña
              </h1>
            </div>
          </div>
          <div style={{ fontSize: 14, color: T.subtle, fontWeight: 600 }}>
            ERPremium - Industria Azucarera
          </div>
          <div style={{ fontSize: 12, color: T.subtle, marginTop: 4 }}>
            Sistema Integral de Gestión Empresarial
          </div>
        </div>

        {/* Login form */}
        <Inp
          label="Correo electrónico"
          type="email"
          value={email}
          onChange={setEmail}
          placeholder="usuario@transcana.gt"
        />
        <Inp
          label="Contraseña"
          type="password"
          value={pass}
          onChange={setPass}
          placeholder="Ingrese su contraseña"
          onKeyDown={e => e.key === 'Enter' && handleLogin()}
        />

        {error && (
          <div style={{
            color: T.red,
            fontSize: 13,
            marginBottom: 12,
            textAlign: 'center'
          }}>
            {error}
          </div>
        )}

        <Btn
          onClick={handleLogin}
          style={{ width: '100%', marginTop: 8, padding: '12px 0', fontSize: 16 }}
          color={T.green}
        >
          Iniciar Sesión
        </Btn>

        {/* Demo credentials */}
        <div style={{
          marginTop: 24,
          padding: 16,
          background: T.card2,
          borderRadius: 10,
          border: `1px solid ${T.border}`
        }}>
          <div style={{
            fontSize: 11,
            color: T.subtle,
            fontWeight: 600,
            marginBottom: 8,
            textTransform: 'uppercase'
          }}>
            Usuarios de demostración
          </div>
          {users.map(u => (
            <div
              key={u.email}
              style={{
                fontSize: 12,
                color: T.subtle,
                marginBottom: 4,
                cursor: 'pointer',
                padding: '4px 0',
                borderBottom: `1px solid ${T.border}11`
              }}
              onClick={() => { setEmail(u.email); setPass(u.pass); }}
            >
              <span style={{ color: T.text }}>{u.email}</span>
              {' / '}
              <span style={{ color: T.blue }}>{u.pass}</span>
              <span style={{ float: 'right', color: T.subtle }}>({u.rol})</span>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

/* ============================================================
 *  SIDEBAR NAVIGATION
 * ============================================================ */
const navSections = [
  {
    title: "General",
    items: [
      { key: "dashboard",    label: "Dashboard",            icon: "Home" },
      { key: "ventas",       label: "Ventas / Facturación", icon: "FileText" },
      { key: "compras",      label: "Compras",              icon: "ShoppingCart" },
      { key: "inventario",   label: "Inventario",           icon: "Package" },
      { key: "clientes",     label: "Clientes",             icon: "Users" },
      { key: "rrhh",         label: "RRHH",                 icon: "Briefcase" },
      { key: "crm",          label: "CRM",                  icon: "Target" },
      { key: "contabilidad", label: "Contabilidad",         icon: "BookOpen" },
      { key: "proveedores",  label: "Proveedores",          icon: "Truck" },
      { key: "ordenes",      label: "Órdenes de Compra",    icon: "Clipboard" }
    ]
  },
  {
    title: "TransCaña",
    items: [
      { key: "zafra",          label: "Planificación Zafra",    icon: "Calendar" },
      { key: "logistica",      label: "Logística",              icon: "Route" },
      { key: "laboratorio",    label: "Laboratorio",            icon: "Flask" },
      { key: "nomina",         label: "Nómina",                 icon: "Banknote" },
      { key: "colonos",        label: "Portal Colonos",         icon: "UserCheck" },
      { key: "bi",             label: "Business Intelligence",  icon: "BarChart2" },
      { key: "mantenimiento",  label: "Mantenimiento Industrial", icon: "Wrench" }
    ]
  }
];

const Sidebar = ({ active, onNav, collapsed, onToggle, user }) => (
  <div style={{
    width: collapsed ? 64 : 260,
    minHeight: '100vh',
    background: T.card,
    borderRight: `1px solid ${T.border}`,
    transition: 'width 0.3s ease',
    overflow: 'hidden',
    display: 'flex',
    flexDirection: 'column',
    position: 'fixed',
    left: 0,
    top: 0,
    zIndex: 100
  }}>
    {/* Header with logo */}
    <div style={{
      padding: collapsed ? '16px 12px' : '16px 20px',
      borderBottom: `1px solid ${T.border}`,
      display: 'flex',
      alignItems: 'center',
      gap: 12,
      minHeight: 64
    }}>
      {!collapsed && (
        <>
          <Icons.Leaf size={28} color={T.green} />
          <div>
            <div style={{ fontSize: 16, fontWeight: 800, color: T.green }}>TransCaña</div>
            <div style={{ fontSize: 10, color: T.subtle }}>ERPremium</div>
          </div>
        </>
      )}
      <button
        onClick={onToggle}
        style={{
          background: 'none',
          border: 'none',
          cursor: 'pointer',
          marginLeft: collapsed ? 0 : 'auto',
          padding: 4
        }}
      >
        <Icons.Menu size={20} color={T.subtle} />
      </button>
    </div>

    {/* Navigation items */}
    <div style={{
      flex: 1,
      overflow: 'auto',
      padding: collapsed ? '8px 4px' : '8px 12px'
    }}>
      {navSections.map(section => (
        <div key={section.title} style={{ marginBottom: 16 }}>
          {!collapsed && (
            <div style={{
              fontSize: 10,
              fontWeight: 700,
              color: T.subtle,
              textTransform: 'uppercase',
              letterSpacing: '0.08em',
              padding: '8px 8px 4px',
              marginBottom: 2
            }}>
              {section.title}
            </div>
          )}
          {collapsed && (
            <div style={{ borderBottom: `1px solid ${T.border}`, margin: '8px 0' }} />
          )}
          {section.items.map(item => {
            const Ic = Icons[item.icon] || Icons.Home;
            const isActive = active === item.key;
            return (
              <button
                key={item.key}
                onClick={() => onNav(item.key)}
                title={item.label}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: 10,
                  width: '100%',
                  padding: collapsed ? '10px 0' : '8px 12px',
                  background: isActive ? T.blue + '18' : 'transparent',
                  border: 'none',
                  borderRadius: 8,
                  cursor: 'pointer',
                  color: isActive ? T.blue : T.subtle,
                  fontSize: 13,
                  fontWeight: isActive ? 600 : 500,
                  borderLeft: isActive ? `2px solid ${T.blue}` : '2px solid transparent',
                  transition: 'all 0.15s',
                  marginBottom: 1,
                  justifyContent: collapsed ? 'center' : 'flex-start'
                }}
              >
                <Ic size={18} color={isActive ? T.blue : T.subtle} />
                {!collapsed && <span>{item.label}</span>}
              </button>
            );
          })}
        </div>
      ))}
    </div>

    {/* User info footer */}
    <div style={{
      padding: collapsed ? '12px 4px' : '12px 16px',
      borderTop: `1px solid ${T.border}`,
      display: 'flex',
      alignItems: 'center',
      gap: 10,
      justifyContent: collapsed ? 'center' : 'flex-start'
    }}>
      <div style={{
        width: 32,
        height: 32,
        borderRadius: '50%',
        background: T.blue + '33',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontSize: 14,
        fontWeight: 700,
        color: T.blue
      }}>
        {user?.nombre?.[0] || 'U'}
      </div>
      {!collapsed && (
        <div style={{ flex: 1, minWidth: 0 }}>
          <div style={{
            fontSize: 13,
            fontWeight: 600,
            color: T.text,
            whiteSpace: 'nowrap',
            overflow: 'hidden',
            textOverflow: 'ellipsis'
          }}>
            {user?.nombre}
          </div>
          <div style={{ fontSize: 11, color: T.subtle }}>{user?.rol}</div>
        </div>
      )}
    </div>
  </div>
);

/* ============================================================
 *  TOP BAR
 * ============================================================ */
const TopBar = ({ title, onLogout, sidebarWidth }) => (
  <div style={{
    height: 56,
    background: T.card,
    borderBottom: `1px solid ${T.border}`,
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'space-between',
    padding: '0 24px',
    position: 'fixed',
    top: 0,
    left: sidebarWidth,
    right: 0,
    zIndex: 90
  }}>
    <h1 style={{ fontSize: 18, fontWeight: 700 }}>{title}</h1>
    <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
      <span style={{ fontSize: 12, color: T.subtle }}>{fmtD(new Date())}</span>
      <button
        onClick={onLogout}
        style={{
          display: 'flex',
          alignItems: 'center',
          gap: 6,
          background: 'none',
          border: 'none',
          cursor: 'pointer',
          color: T.subtle,
          fontSize: 13,
          fontWeight: 500,
          padding: '6px 12px',
          borderRadius: 6,
          transition: 'all 0.2s'
        }}
        onMouseEnter={e => { e.currentTarget.style.color = T.red; }}
        onMouseLeave={e => { e.currentTarget.style.color = T.subtle; }}
      >
        <Icons.LogOut size={16} />
        Salir
      </button>
    </div>
  </div>
);


/* ============================================================
 *  MODULE: Dashboard
 *  KPIs overview with charts for all operations
 * ============================================================ */
const DashboardMod = ({ data }) => {
  // Calculate financial KPIs
  const totalVentas = sum(
    data.facturas.filter(f => f.estado !== 'cotización' && f.estado !== 'borrador'),
    'total'
  );
  const totalCompras = sum(data.compras, 'total');
  const margen = totalVentas - totalCompras;
  const pipeline = sum(
    data.leads.filter(l => l.etapa !== 'ganado'),
    'valor'
  );

  // Count operational metrics
  const stockBajo = data.productos.filter(p => p.stock <= p.stockMin).length;
  const zafrasActivas = data.zafras.filter(z => z.estado === 'activa').length;
  const tonTransportadas = sum(
    data.viajes.filter(v => v.estado === 'completado'),
    'toneladas'
  );
  const muestrasLab = data.muestras.length;
  const colonosActivos = data.colonos.filter(c => c.estado === 'activo').length;
  const otPendientes = data.ordenesT.filter(
    o => o.estado === 'pendiente' || o.estado === 'en_progreso' || o.estado === 'en_espera'
  ).length;
  const equiposOp = data.equipos.filter(e => e.estado === 'operativo').length;

  // Chart data
  const ventasMes = [
    { mes: 'Oct', ventas: 850000 },
    { mes: 'Nov', ventas: 920000 },
    { mes: 'Dic', ventas: 1050000 },
    { mes: 'Ene', ventas: 1180720 },
    { mes: 'Feb', ventas: 1280720 }
  ];

  const prodZafra = [
    { zafra: '2023-24', meta: 82000, real: 79800 },
    { zafra: '2024-25', meta: 90000, real: 88500 },
    { zafra: '2025-26', meta: 95000, real: 36000 }
  ];

  const calidadData = [
    { name: 'Grado A', value: data.muestras.filter(m => m.grado === 'A').length, color: T.green },
    { name: 'Grado B', value: data.muestras.filter(m => m.grado === 'B').length, color: T.blue },
    { name: 'Grado C', value: data.muestras.filter(m => m.grado === 'C').length, color: T.orange },
    { name: 'Grado D', value: data.muestras.filter(m => m.grado === 'D').length, color: T.red }
  ].filter(d => d.value > 0);

  return (
    <div className="fade-in">
      {/* Row 1: Financial KPIs */}
      <div style={{ marginBottom: 8 }}>
        <span style={{
          fontSize: 12,
          color: T.subtle,
          fontWeight: 600,
          textTransform: 'uppercase',
          letterSpacing: '0.06em'
        }}>
          Resumen Financiero
        </span>
      </div>
      <G cols={4} style={{ marginBottom: 16 }}>
        <K
          icon={Icons.TrendingUp}
          label="Total Ventas"
          value={fmtQ(totalVentas)}
          color={T.green}
          sub="Período actual"
        />
        <K
          icon={Icons.ShoppingCart}
          label="Total Compras"
          value={fmtQ(totalCompras)}
          color={T.orange}
          sub="Período actual"
        />
        <K
          icon={Icons.DollarSign}
          label="Margen"
          value={fmtQ(margen)}
          color={margen > 0 ? T.green : T.red}
          sub={`${((margen / totalVentas) * 100 || 0).toFixed(1)}% margen bruto`}
        />
        <K
          icon={Icons.Target}
          label="Pipeline CRM"
          value={fmtQ(pipeline)}
          color={T.purple}
          sub={`${data.leads.filter(l => l.etapa !== 'ganado').length} oportunidades activas`}
        />
      </G>

      {/* Row 2: Operational counts */}
      <G cols={4} style={{ marginBottom: 16 }}>
        <K
          icon={Icons.FileText}
          label="Facturas"
          value={data.facturas.length}
          color={T.blue}
          sub={`${data.facturas.filter(f => f.estado === 'pendiente').length} pendientes de cobro`}
        />
        <K
          icon={Icons.Package}
          label="Productos"
          value={data.productos.length}
          color={T.cyan}
          sub={`${fmtN(sum(data.productos, 'stock'))} unidades en inventario`}
        />
        <K
          icon={Icons.Users}
          label="Clientes"
          value={data.clientes.length}
          color={T.teal}
          sub="Clientes activos"
        />
        <K
          icon={Icons.AlertTriangle}
          label="Stock Bajo"
          value={stockBajo}
          color={stockBajo > 0 ? T.red : T.green}
          sub={stockBajo > 0 ? "Requiere atención inmediata" : "Niveles óptimos"}
        />
      </G>

      {/* Row 3: TransCaña operations */}
      <div style={{ marginBottom: 8 }}>
        <span style={{
          fontSize: 12,
          color: T.subtle,
          fontWeight: 600,
          textTransform: 'uppercase',
          letterSpacing: '0.06em'
        }}>
          TransCaña - Operaciones Azucareras
        </span>
      </div>
      <G cols={4} style={{ marginBottom: 16 }}>
        <K
          icon={Icons.Calendar}
          label="Zafras Activas"
          value={zafrasActivas}
          color={T.green}
          sub={data.zafras.find(z => z.estado === 'activa')?.nombre || 'Sin zafra activa'}
        />
        <K
          icon={Icons.Truck}
          label="Ton. Transportadas"
          value={fmtN(tonTransportadas)}
          color={T.cyan}
          sub={`${data.viajes.filter(v => v.estado === 'completado').length} viajes completados`}
        />
        <K
          icon={Icons.Flask}
          label="Muestras Lab"
          value={muestrasLab}
          color={T.purple}
          sub={`Pureza promedio: ${avg(data.muestras, 'pureza').toFixed(1)}%`}
        />
        <K
          icon={Icons.UserCheck}
          label="Colonos"
          value={colonosActivos}
          color={T.teal}
          sub={`${fmtN(sum(data.colonos.filter(c => c.estado === 'activo'), 'hectareas'))} hectáreas registradas`}
        />
      </G>

      {/* Row 4: Maintenance */}
      <G cols={2} style={{ marginBottom: 16 }}>
        <K
          icon={Icons.Clipboard}
          label="OT Pendientes"
          value={otPendientes}
          color={otPendientes > 2 ? T.red : T.orange}
          sub="Órdenes de trabajo abiertas"
        />
        <K
          icon={Icons.Wrench}
          label="Equipos Operativos"
          value={`${equiposOp}/${data.equipos.length}`}
          color={T.green}
          sub={`${data.equipos.filter(e => e.estado === 'fuera_servicio').length} fuera de servicio`}
        />
      </G>

      {/* Charts Row */}
      <G cols={3} gap={16}>
        {/* Sales by month */}
        <div style={{
          background: T.card,
          border: `1px solid ${T.border}`,
          borderRadius: 12,
          padding: 16
        }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 12 }}>
            Ventas por Mes (Q)
          </h3>
          <ResponsiveContainer width="100%" height={220}>
            <BarChart data={ventasMes}>
              <CartesianGrid strokeDasharray="3 3" stroke={T.border} />
              <XAxis dataKey="mes" stroke={T.subtle} fontSize={12} />
              <YAxis
                stroke={T.subtle}
                fontSize={11}
                tickFormatter={v => `${(v / 1000).toFixed(0)}k`}
              />
              <Tooltip
                contentStyle={{
                  background: T.card2,
                  border: `1px solid ${T.border}`,
                  borderRadius: 8,
                  color: T.text
                }}
                formatter={v => fmtQ(v)}
              />
              <Bar dataKey="ventas" fill={T.blue} radius={[4, 4, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </div>

        {/* Production by zafra */}
        <div style={{
          background: T.card,
          border: `1px solid ${T.border}`,
          borderRadius: 12,
          padding: 16
        }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 12 }}>
            Producción Azúcar por Zafra (TM)
          </h3>
          <ResponsiveContainer width="100%" height={220}>
            <BarChart data={prodZafra}>
              <CartesianGrid strokeDasharray="3 3" stroke={T.border} />
              <XAxis dataKey="zafra" stroke={T.subtle} fontSize={11} />
              <YAxis
                stroke={T.subtle}
                fontSize={11}
                tickFormatter={v => `${(v / 1000).toFixed(0)}k`}
              />
              <Tooltip
                contentStyle={{
                  background: T.card2,
                  border: `1px solid ${T.border}`,
                  borderRadius: 8,
                  color: T.text
                }}
              />
              <Bar dataKey="meta" fill={T.subtle} radius={[4, 4, 0, 0]} name="Meta" />
              <Bar dataKey="real" fill={T.green} radius={[4, 4, 0, 0]} name="Real" />
              <Legend />
            </BarChart>
          </ResponsiveContainer>
        </div>

        {/* Lab quality distribution */}
        <div style={{
          background: T.card,
          border: `1px solid ${T.border}`,
          borderRadius: 12,
          padding: 16
        }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 12 }}>
            Calidad Laboratorio
          </h3>
          <ResponsiveContainer width="100%" height={220}>
            <PieChart>
              <Pie
                data={calidadData}
                cx="50%"
                cy="50%"
                innerRadius={50}
                outerRadius={80}
                paddingAngle={3}
                dataKey="value"
                label={({ name, value }) => `${name}: ${value}`}
              >
                {calidadData.map((d, i) => (
                  <Cell key={i} fill={d.color} />
                ))}
              </Pie>
              <Tooltip
                contentStyle={{
                  background: T.card2,
                  border: `1px solid ${T.border}`,
                  borderRadius: 8,
                  color: T.text
                }}
              />
            </PieChart>
          </ResponsiveContainer>
        </div>
      </G>
    </div>
  );
};


/* ============================================================
 *  GENERIC CRUD MODULE FACTORY
 *  Reusable component for modules with standard CRUD operations
 * ============================================================ */
const CrudModule = ({
  title,
  icon: Ic,
  data,
  setData,
  columns,
  formFields,
  color = T.blue,
  renderExtra,
  emptyObj,
  exportName
}) => {
  const [showModal, setShowModal] = useState(false);
  const [editing, setEditing] = useState(null);
  const [form, setForm] = useState({});
  const [search, setSearch] = useState('');
  const toast = useToast();
  const confirm = useConfirm();

  // Filter data based on search
  const filtered = useMemo(() => {
    if (!search) return data;
    const s = search.toLowerCase();
    return data.filter(r =>
      Object.values(r).some(v => String(v).toLowerCase().includes(s))
    );
  }, [data, search]);

  // Open modal for new record
  const openNew = () => {
    setEditing(null);
    setForm(emptyObj ? { ...emptyObj } : {});
    setShowModal(true);
  };

  // Open modal for editing existing record
  const openEdit = (r) => {
    setEditing(r.id);
    setForm({ ...r });
    setShowModal(true);
  };

  // Save record (create or update)
  const save = () => {
    const required = formFields.filter(f => f.required);
    for (const f of required) {
      if (!form[f.key]) {
        toast(f.label + ' es requerido', 'error');
        return;
      }
    }
    if (editing) {
      setData(data.map(r => r.id === editing ? { ...r, ...form } : r));
      toast('Registro actualizado exitosamente', 'success');
    } else {
      setData([...data, { ...form, id: uid() }]);
      toast('Registro creado exitosamente', 'success');
    }
    setShowModal(false);
  };

  // Delete record with confirmation
  const remove = async (id) => {
    if (await confirm('¿Está seguro de eliminar este registro? Esta acción no se puede deshacer.')) {
      setData(data.filter(r => r.id !== id));
      toast('Registro eliminado', 'success');
    }
  };

  return (
    <div className="fade-in">
      {/* Toolbar */}
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 16
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
          <div style={{ position: 'relative', width: 240 }}>
            <Icons.Search
              size={16}
              color={T.subtle}
              style={{ position: 'absolute', left: 10, top: 10 }}
            />
            <input
              value={search}
              onChange={e => setSearch(e.target.value)}
              placeholder="Buscar..."
              style={{ paddingLeft: 32, height: 36, fontSize: 13 }}
            />
          </div>
          <span style={{ fontSize: 13, color: T.subtle }}>
            {filtered.length} registros
          </span>
        </div>
        <div style={{ display: 'flex', gap: 8 }}>
          <Btn
            variant="ghost"
            size="sm"
            onClick={() => exportCSV(filtered, exportName || title)}
            color={T.subtle}
          >
            <Icons.Download size={14} />CSV
          </Btn>
          <Btn
            variant="ghost"
            size="sm"
            onClick={() => {
              copyTable(filtered);
              toast('Copiado al portapapeles', 'info');
            }}
            color={T.subtle}
          >
            <Icons.Copy size={14} />Copiar
          </Btn>
          <Btn onClick={openNew} color={color} size="sm">
            <Icons.Plus size={14} />Nuevo
          </Btn>
        </div>
      </div>

      {/* Data table */}
      <div style={{
        background: T.card,
        border: `1px solid ${T.border}`,
        borderRadius: 12,
        overflow: 'hidden'
      }}>
        <div style={{ overflowX: 'auto' }}>
          <table>
            <thead>
              <tr>
                {columns.map(c => (
                  <th key={c.key} style={{ minWidth: c.width || 100 }}>{c.label}</th>
                ))}
                <th style={{ width: 100 }}>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {filtered.length === 0 && (
                <tr>
                  <td
                    colSpan={columns.length + 1}
                    style={{ textAlign: 'center', padding: 40, color: T.subtle }}
                  >
                    No se encontraron registros
                  </td>
                </tr>
              )}
              {filtered.map(r => (
                <tr key={r.id}>
                  {columns.map(c => (
                    <td key={c.key}>
                      {c.render ? c.render(r[c.key], r) : (r[c.key] || '-')}
                    </td>
                  ))}
                  <td>
                    <div style={{ display: 'flex', gap: 4 }}>
                      <button
                        onClick={() => openEdit(r)}
                        style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}
                        title="Editar"
                      >
                        <Icons.Edit size={15} color={T.blue} />
                      </button>
                      <button
                        onClick={() => remove(r.id)}
                        style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}
                        title="Eliminar"
                      >
                        <Icons.Trash size={15} color={T.red} />
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Extra content (optional) */}
      {renderExtra && renderExtra(data)}

      {/* Create/Edit Modal */}
      <Modal
        open={showModal}
        onClose={() => setShowModal(false)}
        title={editing ? 'Editar ' + title : 'Nuevo ' + title}
        width={550}
      >
        <G cols={2} gap={12}>
          {formFields.map(f => (
            <div key={f.key} style={f.fullWidth ? { gridColumn: '1/-1' } : {}}>
              <Inp
                label={f.label}
                type={f.type || 'text'}
                value={form[f.key] || ''}
                onChange={v => setForm({ ...form, [f.key]: v })}
                placeholder={f.placeholder || ''}
                options={f.options}
                required={f.required}
              />
            </div>
          ))}
        </G>
        <div style={{ display: 'flex', gap: 8, justifyContent: 'flex-end', marginTop: 16 }}>
          <Btn variant="outline" onClick={() => setShowModal(false)}>Cancelar</Btn>
          <Btn onClick={save} color={color}>{editing ? 'Guardar Cambios' : 'Crear Registro'}</Btn>
        </div>
      </Modal>
    </div>
  );
};

/* ============================================================
 *  MODULE: Ventas / Facturación
 * ============================================================ */
const VentasMod = ({ data, setData }) => {
  const [showModal, setShowModal] = useState(false);
  const [editing, setEditing] = useState(null);
  const [form, setForm] = useState({});
  const [search, setSearch] = useState('');
  const [tab, setTab] = useState('todas');
  const toast = useToast();
  const confirm = useConfirm();

  const estadoColor = {
    pagada: T.green,
    pendiente: T.orange,
    vencida: T.red,
    borrador: T.subtle,
    cotización: T.purple
  };

  const filtered = useMemo(() => {
    let f = data.facturas;
    if (tab === 'facturas') f = f.filter(r => r.estado !== 'cotización');
    if (tab === 'cotizaciones') f = f.filter(r => r.estado === 'cotización');
    if (tab === 'pendientes') f = f.filter(r => r.estado === 'pendiente');
    if (tab === 'pagadas') f = f.filter(r => r.estado === 'pagada');
    if (search) {
      const s = search.toLowerCase();
      f = f.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(s)));
    }
    return f;
  }, [data.facturas, search, tab]);

  const openNew = () => {
    setEditing(null);
    setForm({
      numero: `FAC-2025-${String(data.facturas.length + 1).padStart(3, '0')}`,
      cliente: '',
      fecha: today(),
      vencimiento: '',
      items: [{ producto: '', cantidad: 1, precio: 0, total: 0 }],
      subtotal: 0,
      iva: 0,
      total: 0,
      estado: 'borrador',
      notas: ''
    });
    setShowModal(true);
  };

  const openEdit = (r) => {
    setEditing(r.id);
    setForm({ ...r });
    setShowModal(true);
  };

  const updateItem = (idx, field, val) => {
    const items = [...form.items];
    items[idx] = { ...items[idx], [field]: val };
    if (field === 'cantidad' || field === 'precio') {
      items[idx].total = items[idx].cantidad * items[idx].precio;
    }
    const subtotal = items.reduce((a, i) => a + (i.total || 0), 0);
    setForm({ ...form, items, subtotal, iva: subtotal * 0.12, total: subtotal * 1.12 });
  };

  const addItem = () => {
    setForm({
      ...form,
      items: [...form.items, { producto: '', cantidad: 1, precio: 0, total: 0 }]
    });
  };

  const removeItem = (idx) => {
    const items = form.items.filter((_, i) => i !== idx);
    const subtotal = items.reduce((a, i) => a + (i.total || 0), 0);
    setForm({ ...form, items, subtotal, iva: subtotal * 0.12, total: subtotal * 1.12 });
  };

  const save = () => {
    if (!form.cliente) {
      toast('Cliente es requerido', 'error');
      return;
    }
    if (editing) {
      setData({ ...data, facturas: data.facturas.map(r => r.id === editing ? { ...r, ...form } : r) });
      toast('Factura actualizada', 'success');
    } else {
      setData({ ...data, facturas: [...data.facturas, { ...form, id: uid() }] });
      toast('Factura creada', 'success');
    }
    setShowModal(false);
  };

  const remove = async (id) => {
    if (await confirm('¿Eliminar esta factura?')) {
      setData({ ...data, facturas: data.facturas.filter(r => r.id !== id) });
      toast('Factura eliminada', 'success');
    }
  };

  return (
    <div className="fade-in">
      <Tabs
        tabs={[
          { key: 'todas', label: 'Todas' },
          { key: 'facturas', label: 'Facturas' },
          { key: 'cotizaciones', label: 'Cotizaciones' },
          { key: 'pendientes', label: 'Pendientes' },
          { key: 'pagadas', label: 'Pagadas' }
        ]}
        active={tab}
        onChange={setTab}
      />

      {/* KPI Cards */}
      <G cols={4} style={{ marginBottom: 16 }}>
        <K label="Total Facturado" value={fmtQ(sum(data.facturas.filter(f => f.estado !== 'cotización'), 'total'))} color={T.green} icon={Icons.DollarSign} />
        <K label="Por Cobrar" value={fmtQ(sum(data.facturas.filter(f => f.estado === 'pendiente'), 'total'))} color={T.orange} icon={Icons.Clock} />
        <K label="Pagadas" value={data.facturas.filter(f => f.estado === 'pagada').length} color={T.blue} icon={Icons.Check} />
        <K label="Vencidas" value={data.facturas.filter(f => f.estado === 'vencida').length} color={T.red} icon={Icons.AlertTriangle} />
      </G>

      {/* Toolbar */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
          <div style={{ position: 'relative', width: 240 }}>
            <Icons.Search size={16} color={T.subtle} style={{ position: 'absolute', left: 10, top: 10 }} />
            <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Buscar factura..." style={{ paddingLeft: 32, height: 36, fontSize: 13 }} />
          </div>
          <span style={{ fontSize: 13, color: T.subtle }}>{filtered.length} registros</span>
        </div>
        <div style={{ display: 'flex', gap: 8 }}>
          <Btn variant="ghost" size="sm" onClick={() => exportCSV(filtered, 'ventas')} color={T.subtle}><Icons.Download size={14} />CSV</Btn>
          <Btn onClick={openNew} size="sm"><Icons.Plus size={14} />Nueva Factura</Btn>
        </div>
      </div>

      {/* Table */}
      <div style={{ background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, overflow: 'hidden' }}>
        <table>
          <thead>
            <tr>
              <th>Número</th><th>Cliente</th><th>Fecha</th><th>Subtotal</th>
              <th>IVA</th><th>Total</th><th>Estado</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {filtered.map(r => (
              <tr key={r.id}>
                <td style={{ fontWeight: 600 }}>{r.numero}</td>
                <td>{r.cliente}</td>
                <td>{fmtD(r.fecha)}</td>
                <td>{fmtQ(r.subtotal)}</td>
                <td>{fmtQ(r.iva)}</td>
                <td style={{ fontWeight: 600 }}>{fmtQ(r.total)}</td>
                <td><Badge color={estadoColor[r.estado] || T.subtle}>{r.estado}</Badge></td>
                <td>
                  <div style={{ display: 'flex', gap: 4 }}>
                    <button onClick={() => openEdit(r)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}><Icons.Edit size={15} color={T.blue} /></button>
                    <button onClick={() => remove(r.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}><Icons.Trash size={15} color={T.red} /></button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Create/Edit Modal */}
      <Modal open={showModal} onClose={() => setShowModal(false)} title={editing ? 'Editar Factura' : 'Nueva Factura'} width={700}>
        <G cols={2} gap={12}>
          <Inp label="Número" value={form.numero || ''} onChange={v => setForm({ ...form, numero: v })} />
          <Inp label="Cliente" value={form.cliente || ''} onChange={v => setForm({ ...form, cliente: v })} options={data.clientes.map(c => ({ value: c.nombre, label: c.nombre }))} required />
          <Inp label="Fecha" type="date" value={form.fecha || ''} onChange={v => setForm({ ...form, fecha: v })} />
          <Inp label="Vencimiento" type="date" value={form.vencimiento || ''} onChange={v => setForm({ ...form, vencimiento: v })} />
          <Inp label="Estado" value={form.estado || ''} onChange={v => setForm({ ...form, estado: v })} options={['borrador', 'pendiente', 'pagada', 'vencida', 'cotización']} />
        </G>
        <div style={{ marginTop: 16 }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
            <label style={{ fontSize: 12, fontWeight: 600, color: T.subtle, textTransform: 'uppercase' }}>Líneas de la Factura</label>
            <Btn size="sm" variant="ghost" onClick={addItem}><Icons.Plus size={14} />Agregar Línea</Btn>
          </div>
          {(form.items || []).map((it, idx) => (
            <div key={idx} style={{ display: 'flex', gap: 8, marginBottom: 8, alignItems: 'flex-end' }}>
              <div style={{ flex: 3 }}><Inp label={idx === 0 ? "Producto" : ""} value={it.producto} onChange={v => updateItem(idx, 'producto', v)} placeholder="Nombre del producto" /></div>
              <div style={{ flex: 1 }}><Inp label={idx === 0 ? "Cantidad" : ""} type="number" value={it.cantidad} onChange={v => updateItem(idx, 'cantidad', Number(v))} /></div>
              <div style={{ flex: 1 }}><Inp label={idx === 0 ? "Precio" : ""} type="number" value={it.precio} onChange={v => updateItem(idx, 'precio', Number(v))} /></div>
              <div style={{ flex: 1 }}><Inp label={idx === 0 ? "Total" : ""} value={fmtQ(it.total)} onChange={() => { }} /></div>
              <button onClick={() => removeItem(idx)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4, marginBottom: 14 }}><Icons.Trash size={14} color={T.red} /></button>
            </div>
          ))}
          <div style={{ display: 'flex', justifyContent: 'flex-end', gap: 24, marginTop: 12, padding: 12, background: T.card2, borderRadius: 8 }}>
            <div style={{ textAlign: 'right' }}><div style={{ fontSize: 12, color: T.subtle }}>Subtotal</div><div style={{ fontWeight: 600 }}>{fmtQ(form.subtotal)}</div></div>
            <div style={{ textAlign: 'right' }}><div style={{ fontSize: 12, color: T.subtle }}>IVA 12%</div><div style={{ fontWeight: 600 }}>{fmtQ(form.iva)}</div></div>
            <div style={{ textAlign: 'right' }}><div style={{ fontSize: 12, color: T.subtle }}>Total</div><div style={{ fontWeight: 700, fontSize: 18, color: T.green }}>{fmtQ(form.total)}</div></div>
          </div>
        </div>
        <Inp label="Notas" type="textarea" value={form.notas || ''} onChange={v => setForm({ ...form, notas: v })} style={{ marginTop: 12 }} />
        <div style={{ display: 'flex', gap: 8, justifyContent: 'flex-end', marginTop: 16 }}>
          <Btn variant="outline" onClick={() => setShowModal(false)}>Cancelar</Btn>
          <Btn onClick={save}>{editing ? 'Guardar' : 'Crear Factura'}</Btn>
        </div>
      </Modal>
    </div>
  );
};


/* ============================================================
 *  MODULE: Compras
 * ============================================================ */
const ComprasMod = ({ data, setData }) => {
  const estadoColor = { recibida: T.green, aprobada: T.blue, pendiente: T.orange, cancelada: T.red };
  const [showModal, setShowModal] = useState(false);
  const [editing, setEditing] = useState(null);
  const [form, setForm] = useState({});
  const [search, setSearch] = useState('');
  const toast = useToast();
  const confirm = useConfirm();

  const filtered = useMemo(() => {
    if (!search) return data.compras;
    const s = search.toLowerCase();
    return data.compras.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(s)));
  }, [data.compras, search]);

  const openNew = () => {
    setEditing(null);
    setForm({
      numero: `OC-2025-${String(data.compras.length + 1).padStart(3, '0')}`,
      proveedor: '',
      fecha: today(),
      items: [{ producto: '', cantidad: 1, precio: 0, total: 0 }],
      subtotal: 0, iva: 0, total: 0,
      estado: 'pendiente'
    });
    setShowModal(true);
  };

  const openEdit = (r) => { setEditing(r.id); setForm({ ...r }); setShowModal(true); };

  const updateItem = (idx, field, val) => {
    const items = [...form.items];
    items[idx] = { ...items[idx], [field]: val };
    if (field === 'cantidad' || field === 'precio') {
      items[idx].total = items[idx].cantidad * items[idx].precio;
    }
    const subtotal = items.reduce((a, i) => a + (i.total || 0), 0);
    setForm({ ...form, items, subtotal, iva: subtotal * 0.12, total: subtotal * 1.12 });
  };

  const addItem = () => {
    setForm({ ...form, items: [...form.items, { producto: '', cantidad: 1, precio: 0, total: 0 }] });
  };

  const save = () => {
    if (!form.proveedor) { toast('Proveedor requerido', 'error'); return; }
    if (editing) {
      setData({ ...data, compras: data.compras.map(r => r.id === editing ? { ...r, ...form } : r) });
      toast('Compra actualizada', 'success');
    } else {
      setData({ ...data, compras: [...data.compras, { ...form, id: uid() }] });
      toast('Compra creada', 'success');
    }
    setShowModal(false);
  };

  const remove = async (id) => {
    if (await confirm('¿Eliminar esta orden de compra?')) {
      setData({ ...data, compras: data.compras.filter(r => r.id !== id) });
      toast('Orden eliminada', 'success');
    }
  };

  return (
    <div className="fade-in">
      <G cols={4} style={{ marginBottom: 16 }}>
        <K label="Total Compras" value={fmtQ(sum(data.compras, 'total'))} color={T.orange} icon={Icons.ShoppingCart} />
        <K label="Pendientes" value={data.compras.filter(c => c.estado === 'pendiente').length} color={T.yellow} icon={Icons.Clock} />
        <K label="Aprobadas" value={data.compras.filter(c => c.estado === 'aprobada').length} color={T.blue} icon={Icons.Check} />
        <K label="Recibidas" value={data.compras.filter(c => c.estado === 'recibida').length} color={T.green} icon={Icons.Package} />
      </G>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
        <div style={{ position: 'relative', width: 240 }}>
          <Icons.Search size={16} color={T.subtle} style={{ position: 'absolute', left: 10, top: 10 }} />
          <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Buscar compra..." style={{ paddingLeft: 32, height: 36, fontSize: 13 }} />
        </div>
        <div style={{ display: 'flex', gap: 8 }}>
          <Btn variant="ghost" size="sm" onClick={() => exportCSV(filtered, 'compras')} color={T.subtle}><Icons.Download size={14} />CSV</Btn>
          <Btn onClick={openNew} size="sm" color={T.orange}><Icons.Plus size={14} />Nueva Compra</Btn>
        </div>
      </div>
      <div style={{ background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, overflow: 'hidden' }}>
        <table>
          <thead><tr><th>Número</th><th>Proveedor</th><th>Fecha</th><th>Items</th><th>Subtotal</th><th>Total</th><th>Estado</th><th>Acciones</th></tr></thead>
          <tbody>
            {filtered.map(r => (
              <tr key={r.id}>
                <td style={{ fontWeight: 600 }}>{r.numero}</td>
                <td>{r.proveedor}</td>
                <td>{fmtD(r.fecha)}</td>
                <td>{r.items?.length || 0}</td>
                <td>{fmtQ(r.subtotal)}</td>
                <td style={{ fontWeight: 600 }}>{fmtQ(r.total)}</td>
                <td><Badge color={estadoColor[r.estado]}>{r.estado}</Badge></td>
                <td>
                  <div style={{ display: 'flex', gap: 4 }}>
                    <button onClick={() => openEdit(r)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}><Icons.Edit size={15} color={T.blue} /></button>
                    <button onClick={() => remove(r.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}><Icons.Trash size={15} color={T.red} /></button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <Modal open={showModal} onClose={() => setShowModal(false)} title={editing ? 'Editar Compra' : 'Nueva Compra'} width={700}>
        <G cols={2} gap={12}>
          <Inp label="Número" value={form.numero || ''} onChange={v => setForm({ ...form, numero: v })} />
          <Inp label="Proveedor" value={form.proveedor || ''} onChange={v => setForm({ ...form, proveedor: v })} options={data.proveedores.map(p => ({ value: p.nombre, label: p.nombre }))} required />
          <Inp label="Fecha" type="date" value={form.fecha || ''} onChange={v => setForm({ ...form, fecha: v })} />
          <Inp label="Estado" value={form.estado || ''} onChange={v => setForm({ ...form, estado: v })} options={['pendiente', 'aprobada', 'recibida', 'cancelada']} />
        </G>
        <div style={{ marginTop: 12 }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
            <label style={{ fontSize: 12, fontWeight: 600, color: T.subtle, textTransform: 'uppercase' }}>Líneas</label>
            <Btn size="sm" variant="ghost" onClick={addItem}><Icons.Plus size={14} />Agregar</Btn>
          </div>
          {(form.items || []).map((it, idx) => (
            <div key={idx} style={{ display: 'flex', gap: 8, marginBottom: 8, alignItems: 'flex-end' }}>
              <div style={{ flex: 3 }}><Inp label={idx === 0 ? "Producto" : ""} value={it.producto} onChange={v => updateItem(idx, 'producto', v)} /></div>
              <div style={{ flex: 1 }}><Inp label={idx === 0 ? "Cant" : ""} type="number" value={it.cantidad} onChange={v => updateItem(idx, 'cantidad', Number(v))} /></div>
              <div style={{ flex: 1 }}><Inp label={idx === 0 ? "Precio" : ""} type="number" value={it.precio} onChange={v => updateItem(idx, 'precio', Number(v))} /></div>
              <div style={{ flex: 1 }}><Inp label={idx === 0 ? "Total" : ""} value={fmtQ(it.total)} onChange={() => { }} /></div>
            </div>
          ))}
          <div style={{ display: 'flex', justifyContent: 'flex-end', gap: 24, padding: 12, background: T.card2, borderRadius: 8, marginTop: 8 }}>
            <div><span style={{ fontSize: 12, color: T.subtle }}>Subtotal: </span><span style={{ fontWeight: 600 }}>{fmtQ(form.subtotal)}</span></div>
            <div><span style={{ fontSize: 12, color: T.subtle }}>IVA 12%: </span><span style={{ fontWeight: 600 }}>{fmtQ(form.iva)}</span></div>
            <div><span style={{ fontSize: 12, color: T.subtle }}>Total: </span><span style={{ fontWeight: 700, color: T.orange }}>{fmtQ(form.total)}</span></div>
          </div>
        </div>
        <div style={{ display: 'flex', gap: 8, justifyContent: 'flex-end', marginTop: 16 }}>
          <Btn variant="outline" onClick={() => setShowModal(false)}>Cancelar</Btn>
          <Btn onClick={save} color={T.orange}>{editing ? 'Guardar' : 'Crear'}</Btn>
        </div>
      </Modal>
    </div>
  );
};

/* ============================================================
 *  MODULE: Inventario
 * ============================================================ */
const InventarioMod = ({ data, setData }) => {
  const columns = [
    { key: 'codigo', label: 'Código', width: 100, render: v => <span style={{ fontWeight: 600, color: T.blue }}>{v}</span> },
    { key: 'nombre', label: 'Producto', width: 200 },
    { key: 'categoria', label: 'Categoría', render: v => <Badge color={v === 'azúcar' ? T.green : v === 'subproducto' ? T.orange : T.purple}>{v}</Badge> },
    { key: 'stock', label: 'Stock', render: (v, r) => <span style={{ fontWeight: 600, color: v <= r.stockMin ? T.red : T.green }}>{fmtN(v)} {r.unidad}</span> },
    { key: 'stockMin', label: 'Stock Mín.', render: v => fmtN(v) },
    { key: 'precio', label: 'Precio', render: v => fmtQ(v) },
    { key: 'costo', label: 'Costo', render: v => fmtQ(v) },
    { key: 'ubicacion', label: 'Ubicación' }
  ];
  const fields = [
    { key: 'nombre', label: 'Nombre', required: true, fullWidth: true },
    { key: 'codigo', label: 'Código', required: true },
    { key: 'categoria', label: 'Categoría', options: ['azúcar', 'subproducto', 'derivado', 'insumo'] },
    { key: 'unidad', label: 'Unidad', options: ['quintal', 'tonelada', 'galón', 'litro', 'unidad', 'metro'] },
    { key: 'precio', label: 'Precio Venta', type: 'number' },
    { key: 'costo', label: 'Costo', type: 'number' },
    { key: 'stock', label: 'Stock Actual', type: 'number' },
    { key: 'stockMin', label: 'Stock Mínimo', type: 'number' },
    { key: 'ubicacion', label: 'Ubicación', fullWidth: true }
  ];
  const stockBajo = data.productos.filter(p => p.stock <= p.stockMin);
  return (
    <div>
      {stockBajo.length > 0 && (
        <div style={{ background: T.red + '15', border: `1px solid ${T.red}33`, borderRadius: 12, padding: 16, marginBottom: 16, display: 'flex', alignItems: 'center', gap: 12 }}>
          <Icons.AlertTriangle size={20} color={T.red} />
          <div>
            <div style={{ fontWeight: 600, color: T.red, fontSize: 14 }}>Alerta de Stock Bajo</div>
            <div style={{ fontSize: 13, color: T.subtle }}>{stockBajo.map(p => p.nombre).join(', ')}</div>
          </div>
        </div>
      )}
      <CrudModule title="Producto" icon={Icons.Package} data={data.productos}
        setData={v => setData({ ...data, productos: v })} columns={columns} formFields={fields}
        color={T.cyan} emptyObj={{ nombre: '', codigo: '', categoria: 'azúcar', unidad: 'quintal', precio: 0, costo: 0, stock: 0, stockMin: 0, ubicacion: '' }} exportName="inventario" />
    </div>
  );
};

/* ============================================================
 *  MODULE: Clientes
 * ============================================================ */
const ClientesMod = ({ data, setData }) => {
  const columns = [
    { key: 'nombre', label: 'Nombre', width: 200, render: v => <span style={{ fontWeight: 600 }}>{v}</span> },
    { key: 'nit', label: 'NIT' },
    { key: 'contacto', label: 'Contacto' },
    { key: 'email', label: 'Email', render: v => <span style={{ color: T.blue }}>{v}</span> },
    { key: 'telefono', label: 'Teléfono' },
    { key: 'tipo', label: 'Tipo', render: v => <Badge color={v === 'corporativo' ? T.blue : v === 'exportador' ? T.green : v === 'industrial' ? T.orange : T.subtle}>{v}</Badge> },
    { key: 'credito', label: 'Crédito', render: v => fmtQ(v) },
    { key: 'saldo', label: 'Saldo', render: v => fmtQ(v) }
  ];
  const fields = [
    { key: 'nombre', label: 'Nombre/Razón Social', required: true, fullWidth: true },
    { key: 'nit', label: 'NIT', required: true },
    { key: 'contacto', label: 'Contacto' },
    { key: 'email', label: 'Email', type: 'email' },
    { key: 'telefono', label: 'Teléfono' },
    { key: 'tipo', label: 'Tipo', options: ['corporativo', 'exportador', 'industrial', 'pyme', 'individual'] },
    { key: 'direccion', label: 'Dirección', fullWidth: true },
    { key: 'credito', label: 'Límite Crédito', type: 'number' },
    { key: 'saldo', label: 'Saldo', type: 'number' }
  ];
  return <CrudModule title="Cliente" icon={Icons.Users} data={data.clientes}
    setData={v => setData({ ...data, clientes: v })} columns={columns} formFields={fields}
    color={T.teal} emptyObj={{ nombre: '', nit: '', contacto: '', email: '', telefono: '', tipo: 'individual', direccion: '', credito: 0, saldo: 0, creado: today() }} exportName="clientes" />;
};

/* ============================================================
 *  MODULE: RRHH (Recursos Humanos)
 * ============================================================ */
const RRHHMod = ({ data, setData }) => {
  const [tab, setTab] = useState('empleados');
  const empColumns = [
    { key: 'nombre', label: 'Nombre', width: 220, render: v => <span style={{ fontWeight: 600 }}>{v}</span> },
    { key: 'dpi', label: 'DPI' },
    { key: 'puesto', label: 'Puesto' },
    { key: 'departamento', label: 'Depto.', render: v => <Badge color={T.blue}>{v}</Badge> },
    { key: 'salario', label: 'Salario', render: v => fmtQ(v) },
    { key: 'fechaIngreso', label: 'Ingreso', render: v => fmtD(v) },
    { key: 'estado', label: 'Estado', render: v => <Badge color={v === 'activo' ? T.green : T.red}>{v}</Badge> }
  ];
  const empFields = [
    { key: 'nombre', label: 'Nombre Completo', required: true, fullWidth: true },
    { key: 'dpi', label: 'DPI', required: true },
    { key: 'puesto', label: 'Puesto', required: true },
    { key: 'departamento', label: 'Departamento', options: data.departamentos.map(d => d.nombre) },
    { key: 'salario', label: 'Salario', type: 'number' },
    { key: 'fechaIngreso', label: 'Fecha Ingreso', type: 'date' },
    { key: 'telefono', label: 'Teléfono' },
    { key: 'email', label: 'Email', type: 'email' },
    { key: 'igss', label: 'No. IGSS' },
    { key: 'estado', label: 'Estado', options: ['activo', 'inactivo', 'suspendido'] }
  ];
  const deptColumns = [
    { key: 'nombre', label: 'Departamento', render: v => <span style={{ fontWeight: 600 }}>{v}</span> },
    { key: 'jefe', label: 'Jefe' },
    { key: 'empleados', label: 'Empleados', render: v => <Badge color={T.blue}>{v}</Badge> }
  ];
  const deptFields = [
    { key: 'nombre', label: 'Nombre', required: true },
    { key: 'jefe', label: 'Jefe', required: true },
    { key: 'empleados', label: 'No. Empleados', type: 'number' }
  ];
  return (
    <div className="fade-in">
      <Tabs tabs={[{ key: 'empleados', label: 'Empleados' }, { key: 'departamentos', label: 'Departamentos' }]} active={tab} onChange={setTab} />
      {tab === 'empleados' && <CrudModule title="Empleado" icon={Icons.Users} data={data.empleados}
        setData={v => setData({ ...data, empleados: v })} columns={empColumns} formFields={empFields}
        color={T.blue} emptyObj={{ nombre: '', dpi: '', puesto: '', departamento: '', salario: 0, fechaIngreso: today(), telefono: '', email: '', estado: 'activo', igss: '' }} exportName="empleados" />}
      {tab === 'departamentos' && <CrudModule title="Departamento" icon={Icons.Layers} data={data.departamentos}
        setData={v => setData({ ...data, departamentos: v })} columns={deptColumns} formFields={deptFields}
        color={T.purple} emptyObj={{ nombre: '', jefe: '', empleados: 0 }} exportName="departamentos" />}
    </div>
  );
};

/* ============================================================
 *  MODULE: CRM
 * ============================================================ */
const CRMMod = ({ data, setData }) => {
  const [tab, setTab] = useState('lista');
  const etapaColors = { prospecto: T.subtle, calificado: T.blue, propuesta: T.cyan, negociación: T.orange, ganado: T.green, perdido: T.red };
  const etapas = ['prospecto', 'calificado', 'propuesta', 'negociación', 'ganado', 'perdido'];
  const columns = [
    { key: 'nombre', label: 'Empresa', width: 200, render: v => <span style={{ fontWeight: 600 }}>{v}</span> },
    { key: 'contacto', label: 'Contacto' },
    { key: 'valor', label: 'Valor', render: v => fmtQ(v) },
    { key: 'etapa', label: 'Etapa', render: v => <Badge color={etapaColors[v]}>{v}</Badge> },
    { key: 'probabilidad', label: 'Prob.', render: v => <span>{v}%</span> },
    { key: 'origen', label: 'Origen', render: v => <Badge color={T.subtle}>{v}</Badge> },
    { key: 'creado', label: 'Creado', render: v => fmtD(v) }
  ];
  const fields = [
    { key: 'nombre', label: 'Empresa', required: true, fullWidth: true },
    { key: 'contacto', label: 'Contacto', required: true },
    { key: 'email', label: 'Email', type: 'email' },
    { key: 'telefono', label: 'Teléfono' },
    { key: 'valor', label: 'Valor Estimado (Q)', type: 'number', required: true },
    { key: 'etapa', label: 'Etapa', options: etapas },
    { key: 'probabilidad', label: 'Probabilidad %', type: 'number' },
    { key: 'origen', label: 'Origen', options: ['web', 'referido', 'feria', 'directo', 'publicidad'] },
    { key: 'notas', label: 'Notas', type: 'textarea', fullWidth: true }
  ];

  const pipelineView = (
    <div style={{ display: 'flex', gap: 12, overflow: 'auto', paddingBottom: 16 }}>
      {etapas.filter(e => e !== 'perdido').map(etapa => {
        const leads = data.leads.filter(l => l.etapa === etapa);
        return (
          <div key={etapa} style={{ minWidth: 220, flex: 1, background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, padding: 12 }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12, paddingBottom: 8, borderBottom: `2px solid ${etapaColors[etapa]}` }}>
              <span style={{ fontSize: 13, fontWeight: 700, color: etapaColors[etapa], textTransform: 'capitalize' }}>{etapa}</span>
              <Badge color={etapaColors[etapa]}>{leads.length}</Badge>
            </div>
            <div style={{ fontSize: 12, color: T.subtle, marginBottom: 8 }}>Total: {fmtQ(sum(leads, 'valor'))}</div>
            {leads.map(l => (
              <div key={l.id} style={{ background: T.card2, border: `1px solid ${T.border}`, borderRadius: 8, padding: 10, marginBottom: 8 }}>
                <div style={{ fontWeight: 600, fontSize: 13, marginBottom: 4 }}>{l.nombre}</div>
                <div style={{ fontSize: 12, color: T.subtle }}>{l.contacto}</div>
                <div style={{ fontSize: 13, fontWeight: 600, color: etapaColors[etapa], marginTop: 4 }}>{fmtQ(l.valor)}</div>
                <div style={{ marginTop: 4 }}><ProgressBar value={l.probabilidad} color={etapaColors[etapa]} height={4} /></div>
              </div>
            ))}
          </div>
        );
      })}
    </div>
  );

  return (
    <div className="fade-in">
      <G cols={4} style={{ marginBottom: 16 }}>
        <K label="Pipeline Total" value={fmtQ(sum(data.leads, 'valor'))} color={T.purple} icon={Icons.Target} />
        <K label="Ponderado" value={fmtQ(data.leads.reduce((a, l) => a + l.valor * (l.probabilidad / 100), 0))} color={T.blue} icon={Icons.TrendingUp} />
        <K label="Ganados" value={data.leads.filter(l => l.etapa === 'ganado').length} color={T.green} icon={Icons.Award} />
        <K label="En Negociación" value={data.leads.filter(l => l.etapa === 'negociación').length} color={T.orange} icon={Icons.Activity} />
      </G>
      <Tabs tabs={[{ key: 'lista', label: 'Lista' }, { key: 'pipeline', label: 'Pipeline' }]} active={tab} onChange={setTab} />
      {tab === 'lista' && <CrudModule title="Lead" icon={Icons.Target} data={data.leads}
        setData={v => setData({ ...data, leads: v })} columns={columns} formFields={fields}
        color={T.purple} emptyObj={{ nombre: '', contacto: '', email: '', telefono: '', valor: 0, etapa: 'prospecto', probabilidad: 10, origen: 'web', notas: '', creado: today() }} exportName="crm_leads" />}
      {tab === 'pipeline' && pipelineView}
    </div>
  );
};

/* ============================================================
 *  MODULE: Contabilidad
 * ============================================================ */
const ContabilidadMod = ({ data, setData }) => {
  const [tab, setTab] = useState('asientos');
  const [showModal, setShowModal] = useState(false);
  const [editing, setEditing] = useState(null);
  const [form, setForm] = useState({});
  const toast = useToast();
  const confirm = useConfirm();
  const tipoColor = { activo: T.blue, pasivo: T.orange, capital: T.green, ingreso: T.teal, gasto: T.red };

  const openNew = () => {
    setEditing(null);
    setForm({
      numero: `AS-2025-${String(data.asientos.length + 1).padStart(3, '0')}`,
      fecha: today(),
      descripcion: '',
      lineas: [{ cuenta: '', debe: 0, haber: 0 }, { cuenta: '', debe: 0, haber: 0 }],
      total: 0, estado: 'borrador'
    });
    setShowModal(true);
  };

  const openEdit = (r) => { setEditing(r.id); setForm({ ...r }); setShowModal(true); };

  const updateLinea = (idx, field, val) => {
    const lineas = [...form.lineas];
    lineas[idx] = { ...lineas[idx], [field]: field === 'cuenta' ? val : Number(val) };
    const totalDebe = lineas.reduce((a, l) => a + (l.debe || 0), 0);
    setForm({ ...form, lineas, total: totalDebe });
  };

  const addLinea = () => {
    setForm({ ...form, lineas: [...form.lineas, { cuenta: '', debe: 0, haber: 0 }] });
  };

  const save = () => {
    const totalDebe = form.lineas.reduce((a, l) => a + (l.debe || 0), 0);
    const totalHaber = form.lineas.reduce((a, l) => a + (l.haber || 0), 0);
    if (Math.abs(totalDebe - totalHaber) > 0.01) {
      toast('El asiento no cuadra: Debe y Haber deben ser iguales', 'error');
      return;
    }
    if (editing) {
      setData({ ...data, asientos: data.asientos.map(r => r.id === editing ? { ...r, ...form } : r) });
      toast('Asiento actualizado', 'success');
    } else {
      setData({ ...data, asientos: [...data.asientos, { ...form, id: uid() }] });
      toast('Asiento creado', 'success');
    }
    setShowModal(false);
  };

  const remove = async (id) => {
    if (await confirm('¿Eliminar asiento contable?')) {
      setData({ ...data, asientos: data.asientos.filter(r => r.id !== id) });
      toast('Asiento eliminado', 'success');
    }
  };

  return (
    <div className="fade-in">
      <Tabs tabs={[{ key: 'asientos', label: 'Asientos Contables' }, { key: 'cuentas', label: 'Plan de Cuentas' }]} active={tab} onChange={setTab} />
      {tab === 'cuentas' && (
        <div style={{ background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, overflow: 'hidden' }}>
          <table>
            <thead><tr><th>Código</th><th>Cuenta</th><th>Tipo</th><th>Saldo</th></tr></thead>
            <tbody>
              {data.cuentas.map(c => (
                <tr key={c.id}>
                  <td style={{ fontWeight: 600, color: T.blue }}>{c.codigo}</td>
                  <td style={{ fontWeight: c.padre ? 400 : 700, paddingLeft: c.padre ? 32 : 12 }}>{c.nombre}</td>
                  <td><Badge color={tipoColor[c.tipo]}>{c.tipo}</Badge></td>
                  <td style={{ fontWeight: 600 }}>{fmtQ(c.saldo)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
      {tab === 'asientos' && (
        <div>
          <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: 16 }}>
            <Btn onClick={openNew} size="sm" color={T.teal}><Icons.Plus size={14} />Nuevo Asiento</Btn>
          </div>
          <div style={{ background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, overflow: 'hidden' }}>
            <table>
              <thead><tr><th>Número</th><th>Fecha</th><th>Descripción</th><th>Líneas</th><th>Total</th><th>Estado</th><th>Acciones</th></tr></thead>
              <tbody>
                {data.asientos.map(r => (
                  <tr key={r.id}>
                    <td style={{ fontWeight: 600, color: T.teal }}>{r.numero}</td>
                    <td>{fmtD(r.fecha)}</td>
                    <td>{r.descripcion}</td>
                    <td>{r.lineas?.length || 0}</td>
                    <td style={{ fontWeight: 600 }}>{fmtQ(r.total)}</td>
                    <td><Badge color={r.estado === 'aprobado' ? T.green : T.orange}>{r.estado}</Badge></td>
                    <td>
                      <div style={{ display: 'flex', gap: 4 }}>
                        <button onClick={() => openEdit(r)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}><Icons.Edit size={15} color={T.blue} /></button>
                        <button onClick={() => remove(r.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}><Icons.Trash size={15} color={T.red} /></button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <Modal open={showModal} onClose={() => setShowModal(false)} title={editing ? 'Editar Asiento' : 'Nuevo Asiento'} width={700}>
            <G cols={2} gap={12}>
              <Inp label="Número" value={form.numero || ''} onChange={v => setForm({ ...form, numero: v })} />
              <Inp label="Fecha" type="date" value={form.fecha || ''} onChange={v => setForm({ ...form, fecha: v })} />
              <Inp label="Descripción" value={form.descripcion || ''} onChange={v => setForm({ ...form, descripcion: v })} style={{ gridColumn: '1/-1' }} />
              <Inp label="Estado" value={form.estado || ''} onChange={v => setForm({ ...form, estado: v })} options={['borrador', 'aprobado', 'anulado']} />
            </G>
            <div style={{ marginTop: 12 }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
                <label style={{ fontSize: 12, fontWeight: 600, color: T.subtle, textTransform: 'uppercase' }}>Líneas del Asiento</label>
                <Btn size="sm" variant="ghost" onClick={addLinea}><Icons.Plus size={14} />Línea</Btn>
              </div>
              {(form.lineas || []).map((l, idx) => (
                <div key={idx} style={{ display: 'flex', gap: 8, marginBottom: 8, alignItems: 'flex-end' }}>
                  <div style={{ flex: 2 }}><Inp label={idx === 0 ? "Cuenta" : ""} value={l.cuenta} onChange={v => updateLinea(idx, 'cuenta', v)} options={data.cuentas.map(c => ({ value: c.codigo, label: `${c.codigo} - ${c.nombre}` }))} /></div>
                  <div style={{ flex: 1 }}><Inp label={idx === 0 ? "Debe" : ""} type="number" value={l.debe} onChange={v => updateLinea(idx, 'debe', v)} /></div>
                  <div style={{ flex: 1 }}><Inp label={idx === 0 ? "Haber" : ""} type="number" value={l.haber} onChange={v => updateLinea(idx, 'haber', v)} /></div>
                </div>
              ))}
              <div style={{ display: 'flex', justifyContent: 'flex-end', gap: 24, padding: 12, background: T.card2, borderRadius: 8, marginTop: 8 }}>
                <div><span style={{ fontSize: 12, color: T.subtle }}>Total Debe: </span><span style={{ fontWeight: 600 }}>{fmtQ((form.lineas || []).reduce((a, l) => a + (l.debe || 0), 0))}</span></div>
                <div><span style={{ fontSize: 12, color: T.subtle }}>Total Haber: </span><span style={{ fontWeight: 600 }}>{fmtQ((form.lineas || []).reduce((a, l) => a + (l.haber || 0), 0))}</span></div>
                {Math.abs((form.lineas || []).reduce((a, l) => a + (l.debe || 0), 0) - (form.lineas || []).reduce((a, l) => a + (l.haber || 0), 0)) > 0.01 &&
                  <span style={{ color: T.red, fontWeight: 600, fontSize: 12 }}>Descuadrado</span>}
              </div>
            </div>
            <div style={{ display: 'flex', gap: 8, justifyContent: 'flex-end', marginTop: 16 }}>
              <Btn variant="outline" onClick={() => setShowModal(false)}>Cancelar</Btn>
              <Btn onClick={save} color={T.teal}>{editing ? 'Guardar' : 'Crear'}</Btn>
            </div>
          </Modal>
        </div>
      )}
    </div>
  );
};

/* ============================================================
 *  MODULE: Proveedores
 * ============================================================ */
const ProveedoresMod = ({ data, setData }) => {
  const columns = [
    { key: 'nombre', label: 'Nombre', width: 220, render: v => <span style={{ fontWeight: 600 }}>{v}</span> },
    { key: 'nit', label: 'NIT' },
    { key: 'contacto', label: 'Contacto' },
    { key: 'email', label: 'Email', render: v => <span style={{ color: T.blue }}>{v}</span> },
    { key: 'tipo', label: 'Tipo', render: v => <Badge color={T.orange}>{v}</Badge> },
    { key: 'condiciones', label: 'Condiciones Pago' },
    { key: 'creado', label: 'Registro', render: v => fmtD(v) }
  ];
  const fields = [
    { key: 'nombre', label: 'Razón Social', required: true, fullWidth: true },
    { key: 'nit', label: 'NIT', required: true },
    { key: 'contacto', label: 'Contacto' },
    { key: 'email', label: 'Email', type: 'email' },
    { key: 'telefono', label: 'Teléfono' },
    { key: 'tipo', label: 'Tipo', options: ['insumos', 'repuestos', 'combustible', 'químicos', 'empaques', 'transporte', 'servicios'] },
    { key: 'direccion', label: 'Dirección', fullWidth: true },
    { key: 'condiciones', label: 'Condiciones de Pago', options: ['contado', '15 días', '30 días', '45 días', '60 días'] }
  ];
  return <CrudModule title="Proveedor" icon={Icons.Truck} data={data.proveedores}
    setData={v => setData({ ...data, proveedores: v })} columns={columns} formFields={fields}
    color={T.orange} emptyObj={{ nombre: '', nit: '', contacto: '', email: '', telefono: '', tipo: 'insumos', direccion: '', condiciones: '30 días', creado: today() }} exportName="proveedores" />;
};

/* ============================================================
 *  MODULE: Órdenes de Compra
 * ============================================================ */
const OrdenesMod = ({ data, setData }) => {
  const estadoColor = { pendiente: T.orange, aprobada: T.blue, recibida: T.green, cancelada: T.red };
  const columns = [
    { key: 'numero', label: 'Número', render: v => <span style={{ fontWeight: 600, color: T.blue }}>{v}</span> },
    { key: 'proveedor', label: 'Proveedor', width: 200 },
    { key: 'fecha', label: 'Fecha', render: v => fmtD(v) },
    { key: 'total', label: 'Total', render: v => fmtQ(v) },
    { key: 'estado', label: 'Estado', render: v => <Badge color={estadoColor[v]}>{v}</Badge> }
  ];
  const fields = [
    { key: 'numero', label: 'Número' },
    { key: 'proveedor', label: 'Proveedor', required: true, options: data.proveedores.map(p => ({ value: p.nombre, label: p.nombre })) },
    { key: 'fecha', label: 'Fecha', type: 'date' },
    { key: 'total', label: 'Total', type: 'number' },
    { key: 'estado', label: 'Estado', options: ['pendiente', 'aprobada', 'recibida', 'cancelada'] }
  ];
  return <CrudModule title="Orden de Compra" icon={Icons.Clipboard} data={data.compras}
    setData={v => setData({ ...data, compras: v })} columns={columns} formFields={fields}
    color={T.blue} emptyObj={{ numero: '', proveedor: '', fecha: today(), items: [], subtotal: 0, iva: 0, total: 0, estado: 'pendiente' }} exportName="ordenes_compra" />;
};


/* ============================================================
 *  MODULE: Planificación de Zafra
 *  Harvest campaign management with goals and progress tracking
 * ============================================================ */
const ZafraMod = ({ data, setData }) => {
  const [showModal, setShowModal] = useState(false);
  const [editing, setEditing] = useState(null);
  const [form, setForm] = useState({});
  const toast = useToast();
  const confirm = useConfirm();
  const estadoColor = { activa: T.green, finalizada: T.blue, planificada: T.orange, cancelada: T.red };

  const openNew = () => {
    setEditing(null);
    setForm({ nombre: '', codigo: '', fechaInicio: '', fechaFin: '', metaToneladas: 0, toneladasProcesadas: 0, metaAzucar: 0, azucarProducida: 0, estado: 'planificada', notas: '' });
    setShowModal(true);
  };
  const openEdit = (z) => { setEditing(z.id); setForm({ ...z }); setShowModal(true); };
  const save = () => {
    if (!form.nombre) { toast('Nombre requerido', 'error'); return; }
    if (editing) {
      setData({ ...data, zafras: data.zafras.map(z => z.id === editing ? { ...z, ...form } : z) });
      toast('Zafra actualizada', 'success');
    } else {
      setData({ ...data, zafras: [...data.zafras, { ...form, id: uid() }] });
      toast('Zafra creada', 'success');
    }
    setShowModal(false);
  };
  const remove = async (id) => {
    if (await confirm('¿Eliminar esta zafra?')) {
      setData({ ...data, zafras: data.zafras.filter(z => z.id !== id) });
      toast('Zafra eliminada', 'success');
    }
  };

  return (
    <div className="fade-in">
      <G cols={4} style={{ marginBottom: 16 }}>
        <K label="Zafras Activas" value={data.zafras.filter(z => z.estado === 'activa').length} color={T.green} icon={Icons.Calendar} />
        <K label="Meta Toneladas" value={fmtN(sum(data.zafras.filter(z => z.estado === 'activa'), 'metaToneladas'))} color={T.blue} icon={Icons.TrendingUp} />
        <K label="Procesadas" value={fmtN(sum(data.zafras.filter(z => z.estado === 'activa'), 'toneladasProcesadas'))} color={T.cyan} icon={Icons.Package} />
        <K label="Azúcar Producida" value={`${fmtN(sum(data.zafras.filter(z => z.estado === 'activa'), 'azucarProducida'))} TM`} color={T.teal} icon={Icons.Star} />
      </G>
      <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: 16 }}>
        <Btn onClick={openNew} size="sm" color={T.green}><Icons.Plus size={14} />Nueva Zafra</Btn>
      </div>
      <div style={{ display: 'grid', gap: 16 }}>
        {data.zafras.map(z => {
          const cumplimiento = z.metaToneladas ? ((z.toneladasProcesadas / z.metaToneladas) * 100) : 0;
          const cumplAzucar = z.metaAzucar ? ((z.azucarProducida / z.metaAzucar) * 100) : 0;
          return (
            <div key={z.id} style={{ background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, padding: 20, borderLeft: `4px solid ${estadoColor[z.estado]}` }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 16 }}>
                <div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                    <h3 style={{ fontSize: 18, fontWeight: 700 }}>{z.nombre}</h3>
                    <Badge color={estadoColor[z.estado]}>{z.estado}</Badge>
                  </div>
                  <div style={{ fontSize: 13, color: T.subtle, marginTop: 4 }}>
                    Código: {z.codigo} | Período: {fmtD(z.fechaInicio)} - {fmtD(z.fechaFin)}
                  </div>
                </div>
                <div style={{ display: 'flex', gap: 4 }}>
                  <button onClick={() => openEdit(z)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}><Icons.Edit size={16} color={T.blue} /></button>
                  <button onClick={() => remove(z.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}><Icons.Trash size={16} color={T.red} /></button>
                </div>
              </div>
              <G cols={2} gap={20}>
                <div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 6 }}>
                    <span style={{ fontSize: 13, color: T.subtle }}>Caña Procesada</span>
                    <span style={{ fontSize: 13, fontWeight: 600 }}>{fmtN(z.toneladasProcesadas)} / {fmtN(z.metaToneladas)} TM</span>
                  </div>
                  <ProgressBar value={z.toneladasProcesadas} max={z.metaToneladas} color={cumplimiento >= 80 ? T.green : cumplimiento >= 50 ? T.orange : T.red} />
                  <div style={{ fontSize: 12, color: T.subtle, marginTop: 4 }}>Cumplimiento: {cumplimiento.toFixed(1)}%</div>
                </div>
                <div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 6 }}>
                    <span style={{ fontSize: 13, color: T.subtle }}>Producción Azúcar</span>
                    <span style={{ fontSize: 13, fontWeight: 600 }}>{fmtN(z.azucarProducida)} / {fmtN(z.metaAzucar)} TM</span>
                  </div>
                  <ProgressBar value={z.azucarProducida} max={z.metaAzucar} color={cumplAzucar >= 80 ? T.green : cumplAzucar >= 50 ? T.orange : T.red} />
                  <div style={{ fontSize: 12, color: T.subtle, marginTop: 4 }}>Cumplimiento: {cumplAzucar.toFixed(1)}%</div>
                </div>
              </G>
              {z.notas && <div style={{ marginTop: 12, fontSize: 13, color: T.subtle, fontStyle: 'italic' }}>{z.notas}</div>}
            </div>
          );
        })}
      </div>
      <Modal open={showModal} onClose={() => setShowModal(false)} title={editing ? 'Editar Zafra' : 'Nueva Zafra'} width={600}>
        <G cols={2} gap={12}>
          <Inp label="Nombre" value={form.nombre || ''} onChange={v => setForm({ ...form, nombre: v })} required />
          <Inp label="Código" value={form.codigo || ''} onChange={v => setForm({ ...form, codigo: v })} />
          <Inp label="Fecha Inicio" type="date" value={form.fechaInicio || ''} onChange={v => setForm({ ...form, fechaInicio: v })} />
          <Inp label="Fecha Fin" type="date" value={form.fechaFin || ''} onChange={v => setForm({ ...form, fechaFin: v })} />
          <Inp label="Meta Toneladas Caña" type="number" value={form.metaToneladas || 0} onChange={v => setForm({ ...form, metaToneladas: Number(v) })} />
          <Inp label="Toneladas Procesadas" type="number" value={form.toneladasProcesadas || 0} onChange={v => setForm({ ...form, toneladasProcesadas: Number(v) })} />
          <Inp label="Meta Azúcar (TM)" type="number" value={form.metaAzucar || 0} onChange={v => setForm({ ...form, metaAzucar: Number(v) })} />
          <Inp label="Azúcar Producida (TM)" type="number" value={form.azucarProducida || 0} onChange={v => setForm({ ...form, azucarProducida: Number(v) })} />
          <Inp label="Estado" value={form.estado || ''} onChange={v => setForm({ ...form, estado: v })} options={['planificada', 'activa', 'finalizada', 'cancelada']} />
        </G>
        <Inp label="Notas" type="textarea" value={form.notas || ''} onChange={v => setForm({ ...form, notas: v })} style={{ marginTop: 8 }} />
        <div style={{ display: 'flex', gap: 8, justifyContent: 'flex-end', marginTop: 16 }}>
          <Btn variant="outline" onClick={() => setShowModal(false)}>Cancelar</Btn>
          <Btn onClick={save} color={T.green}>{editing ? 'Guardar' : 'Crear'}</Btn>
        </div>
      </Modal>
    </div>
  );
};

/* ============================================================
 *  MODULE: Logística
 *  Transport routes and trips management
 * ============================================================ */
const LogisticaMod = ({ data, setData }) => {
  const [tab, setTab] = useState('viajes');
  const estadoColor = { completado: T.green, en_tránsito: T.blue, programado: T.orange, cancelado: T.red };

  const rutaColumns = [
    { key: 'nombre', label: 'Ruta', render: v => <span style={{ fontWeight: 600 }}>{v}</span> },
    { key: 'origen', label: 'Origen' },
    { key: 'destino', label: 'Destino' },
    { key: 'distanciaKm', label: 'Distancia', render: v => <span>{v} km</span> },
    { key: 'tiempoEstimado', label: 'Tiempo', render: v => <span>{v} min</span> },
    { key: 'tipo', label: 'Tipo', render: v => <Badge color={v === 'recolección' ? T.green : v === 'exportación' ? T.blue : T.orange}>{v}</Badge> },
    { key: 'estado', label: 'Estado', render: v => <Badge color={v === 'activa' ? T.green : T.red}>{v}</Badge> }
  ];
  const rutaFields = [
    { key: 'nombre', label: 'Nombre Ruta', required: true, fullWidth: true },
    { key: 'origen', label: 'Origen', required: true },
    { key: 'destino', label: 'Destino', required: true },
    { key: 'distanciaKm', label: 'Distancia (km)', type: 'number' },
    { key: 'tiempoEstimado', label: 'Tiempo (min)', type: 'number' },
    { key: 'tipo', label: 'Tipo', options: ['recolección', 'exportación', 'distribución'] },
    { key: 'estado', label: 'Estado', options: ['activa', 'inactiva'] }
  ];
  const viajeColumns = [
    { key: 'ruta', label: 'Ruta', render: v => <span style={{ fontWeight: 600 }}>{v}</span> },
    { key: 'conductor', label: 'Conductor' },
    { key: 'placa', label: 'Placa' },
    { key: 'fechaSalida', label: 'Salida', render: v => fmtDT(v) },
    { key: 'fechaLlegada', label: 'Llegada', render: v => v ? fmtDT(v) : '-' },
    { key: 'toneladas', label: 'Toneladas', render: v => <span style={{ fontWeight: 600 }}>{v} TM</span> },
    { key: 'estado', label: 'Estado', render: v => <Badge color={estadoColor[v]}>{v?.replace('_', ' ')}</Badge> }
  ];
  const viajeFields = [
    { key: 'ruta', label: 'Ruta', required: true, options: data.rutas.map(r => ({ value: r.nombre, label: r.nombre })) },
    { key: 'conductor', label: 'Conductor', required: true },
    { key: 'placa', label: 'Placa' },
    { key: 'fechaSalida', label: 'Salida', type: 'datetime-local' },
    { key: 'fechaLlegada', label: 'Llegada', type: 'datetime-local' },
    { key: 'toneladas', label: 'Toneladas', type: 'number' },
    { key: 'estado', label: 'Estado', options: ['programado', 'en_tránsito', 'completado', 'cancelado'] },
    { key: 'observaciones', label: 'Observaciones', type: 'textarea', fullWidth: true }
  ];

  return (
    <div className="fade-in">
      <G cols={4} style={{ marginBottom: 16 }}>
        <K label="Rutas Activas" value={data.rutas.filter(r => r.estado === 'activa').length} color={T.blue} icon={Icons.Route} />
        <K label="Viajes Hoy" value={data.viajes.filter(v => v.fechaSalida?.startsWith(today())).length} color={T.cyan} icon={Icons.Truck} />
        <K label="Ton. Transportadas" value={fmtN(sum(data.viajes.filter(v => v.estado === 'completado'), 'toneladas'))} color={T.green} icon={Icons.Package} />
        <K label="En Tránsito" value={data.viajes.filter(v => v.estado === 'en_tránsito').length} color={T.orange} icon={Icons.Activity} />
      </G>
      <Tabs tabs={[{ key: 'viajes', label: 'Viajes' }, { key: 'rutas', label: 'Rutas' }]} active={tab} onChange={setTab} />
      {tab === 'rutas' && <CrudModule title="Ruta" icon={Icons.Route} data={data.rutas}
        setData={v => setData({ ...data, rutas: v })} columns={rutaColumns} formFields={rutaFields}
        color={T.blue} emptyObj={{ nombre: '', origen: '', destino: '', distanciaKm: 0, tiempoEstimado: 0, tipo: 'recolección', estado: 'activa' }} exportName="rutas" />}
      {tab === 'viajes' && <CrudModule title="Viaje" icon={Icons.Truck} data={data.viajes}
        setData={v => setData({ ...data, viajes: v })} columns={viajeColumns} formFields={viajeFields}
        color={T.cyan} emptyObj={{ ruta: '', conductor: '', placa: '', fechaSalida: '', fechaLlegada: '', toneladas: 0, estado: 'programado', observaciones: '' }} exportName="viajes" />}
    </div>
  );
};

/* ============================================================
 *  MODULE: Laboratorio
 *  Sugar cane quality analysis with Brix/Pol/Fibra calculations
 * ============================================================ */
const LaboratorioMod = ({ data, setData }) => {
  const [showModal, setShowModal] = useState(false);
  const [editing, setEditing] = useState(null);
  const [form, setForm] = useState({});
  const [search, setSearch] = useState('');
  const toast = useToast();
  const confirm = useConfirm();
  const gradoColor = { A: T.green, B: T.blue, C: T.orange, D: T.red };

  /** Calculate laboratory values from Brix, Pol, and Fibra */
  const calcLab = (brix, pol, fibra) => {
    const b = Number(brix) || 0;
    const p = Number(pol) || 0;
    const f = Number(fibra) || 0;
    const pureza = b > 0 ? ((p / b) * 100) : 0;
    const rendimiento = p * (1 - f / 100) * 0.7;
    const grado = pureza >= 85 ? 'A' : pureza >= 75 ? 'B' : pureza >= 65 ? 'C' : 'D';
    return {
      pureza: Math.round(pureza * 100) / 100,
      rendimiento: Math.round(rendimiento * 100) / 100,
      grado: grado
    };
  };

  const updateForm = (field, val) => {
    const newForm = { ...form, [field]: val };
    if (['brix', 'pol', 'fibra'].includes(field)) {
      const calc = calcLab(newForm.brix, newForm.pol, newForm.fibra);
      Object.assign(newForm, calc);
    }
    setForm(newForm);
  };

  const filtered = useMemo(() => {
    if (!search) return data.muestras;
    const s = search.toLowerCase();
    return data.muestras.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(s)));
  }, [data.muestras, search]);

  const openNew = () => {
    setEditing(null);
    setForm({
      codigo: `LAB-2025-${String(data.muestras.length + 1).padStart(3, '0')}`,
      fecha: today(), origen: '', lote: '', brix: 0, pol: 0, fibra: 0,
      pureza: 0, rendimiento: 0, grado: '', analista: '', observaciones: ''
    });
    setShowModal(true);
  };
  const openEdit = (r) => { setEditing(r.id); setForm({ ...r }); setShowModal(true); };

  const save = () => {
    if (!form.origen) { toast('Origen requerido', 'error'); return; }
    const calc = calcLab(form.brix, form.pol, form.fibra);
    const record = { ...form, ...calc };
    if (editing) {
      setData({ ...data, muestras: data.muestras.map(r => r.id === editing ? { ...r, ...record } : r) });
      toast('Muestra actualizada', 'success');
    } else {
      setData({ ...data, muestras: [...data.muestras, { ...record, id: uid() }] });
      toast('Muestra registrada', 'success');
    }
    setShowModal(false);
  };

  const remove = async (id) => {
    if (await confirm('¿Eliminar esta muestra?')) {
      setData({ ...data, muestras: data.muestras.filter(r => r.id !== id) });
      toast('Muestra eliminada', 'success');
    }
  };

  const avgPureza = avg(data.muestras, 'pureza');
  const avgRendimiento = avg(data.muestras, 'rendimiento');
  const gradeCounts = {
    A: data.muestras.filter(m => m.grado === 'A').length,
    B: data.muestras.filter(m => m.grado === 'B').length,
    C: data.muestras.filter(m => m.grado === 'C').length,
    D: data.muestras.filter(m => m.grado === 'D').length
  };

  return (
    <div className="fade-in">
      <G cols={4} style={{ marginBottom: 16 }}>
        <K label="Total Muestras" value={data.muestras.length} color={T.purple} icon={Icons.Flask} />
        <K label="Pureza Promedio" value={`${avgPureza.toFixed(1)}%`} color={avgPureza >= 80 ? T.green : T.orange} icon={Icons.Activity} />
        <K label="Rendimiento Prom." value={avgRendimiento.toFixed(2)} color={T.blue} icon={Icons.TrendingUp} />
        <K label="Grado A" value={gradeCounts.A} color={T.green} icon={Icons.Award} sub={`B:${gradeCounts.B} C:${gradeCounts.C} D:${gradeCounts.D}`} />
      </G>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
          <div style={{ position: 'relative', width: 240 }}>
            <Icons.Search size={16} color={T.subtle} style={{ position: 'absolute', left: 10, top: 10 }} />
            <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Buscar muestra..." style={{ paddingLeft: 32, height: 36, fontSize: 13 }} />
          </div>
        </div>
        <div style={{ display: 'flex', gap: 8 }}>
          <Btn variant="ghost" size="sm" onClick={() => exportCSV(filtered, 'laboratorio')} color={T.subtle}><Icons.Download size={14} />CSV</Btn>
          <Btn onClick={openNew} size="sm" color={T.purple}><Icons.Plus size={14} />Nueva Muestra</Btn>
        </div>
      </div>
      <div style={{ background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, overflow: 'hidden' }}>
        <div style={{ overflowX: 'auto' }}>
          <table>
            <thead><tr><th>Código</th><th>Fecha</th><th>Origen</th><th>Lote</th><th>Brix</th><th>Pol</th><th>Fibra</th><th>Pureza %</th><th>Rendimiento</th><th>Grado</th><th>Analista</th><th>Acciones</th></tr></thead>
            <tbody>
              {filtered.map(r => (
                <tr key={r.id}>
                  <td style={{ fontWeight: 600, color: T.purple }}>{r.codigo}</td>
                  <td>{fmtD(r.fecha)}</td>
                  <td>{r.origen}</td>
                  <td>{r.lote}</td>
                  <td style={{ fontWeight: 600 }}>{r.brix}</td>
                  <td style={{ fontWeight: 600 }}>{r.pol}</td>
                  <td>{r.fibra}</td>
                  <td style={{ fontWeight: 600, color: r.pureza >= 80 ? T.green : r.pureza >= 70 ? T.orange : T.red }}>{r.pureza}%</td>
                  <td>{r.rendimiento}</td>
                  <td><Badge color={gradoColor[r.grado] || T.subtle} style={{ fontSize: 14, fontWeight: 800, minWidth: 32, textAlign: 'center' }}>{r.grado}</Badge></td>
                  <td style={{ fontSize: 12 }}>{r.analista}</td>
                  <td>
                    <div style={{ display: 'flex', gap: 4 }}>
                      <button onClick={() => openEdit(r)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}><Icons.Edit size={15} color={T.blue} /></button>
                      <button onClick={() => remove(r.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}><Icons.Trash size={15} color={T.red} /></button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Charts */}
      <G cols={2} gap={16} style={{ marginTop: 16 }}>
        <div style={{ background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, padding: 16 }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 12 }}>Distribución de Calidad</h3>
          <ResponsiveContainer width="100%" height={200}>
            <PieChart>
              <Pie data={[
                { name: 'Grado A', value: gradeCounts.A, fill: T.green },
                { name: 'Grado B', value: gradeCounts.B, fill: T.blue },
                { name: 'Grado C', value: gradeCounts.C, fill: T.orange },
                { name: 'Grado D', value: gradeCounts.D, fill: T.red }
              ].filter(d => d.value > 0)} cx="50%" cy="50%" innerRadius={40} outerRadius={70} paddingAngle={4} dataKey="value"
                label={({ name, value }) => `${name}: ${value}`}>
                {[T.green, T.blue, T.orange, T.red].map((c, i) => <Cell key={i} fill={c} />)}
              </Pie>
              <Tooltip contentStyle={{ background: T.card2, border: `1px solid ${T.border}`, borderRadius: 8, color: T.text }} />
            </PieChart>
          </ResponsiveContainer>
        </div>
        <div style={{ background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, padding: 16 }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 12 }}>Pureza por Muestra</h3>
          <ResponsiveContainer width="100%" height={200}>
            <BarChart data={data.muestras.map(m => ({ name: m.codigo.replace('LAB-2025-', ''), pureza: m.pureza }))}>
              <CartesianGrid strokeDasharray="3 3" stroke={T.border} />
              <XAxis dataKey="name" stroke={T.subtle} fontSize={11} />
              <YAxis stroke={T.subtle} fontSize={11} domain={[60, 100]} />
              <Tooltip contentStyle={{ background: T.card2, border: `1px solid ${T.border}`, borderRadius: 8, color: T.text }} />
              <Bar dataKey="pureza" radius={[4, 4, 0, 0]}>
                {data.muestras.map((m, i) => <Cell key={i} fill={gradoColor[m.grado]} />)}
              </Bar>
            </BarChart>
          </ResponsiveContainer>
        </div>
      </G>

      {/* Calculation reference */}
      <div style={{ marginTop: 16, padding: 16, background: T.card, border: `1px solid ${T.border}`, borderRadius: 12 }}>
        <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 8 }}>Referencia de Cálculos</h3>
        <G cols={3} gap={16}>
          <div style={{ padding: 12, background: T.card2, borderRadius: 8 }}>
            <div style={{ fontSize: 12, fontWeight: 600, color: T.purple, marginBottom: 4 }}>Pureza</div>
            <div style={{ fontSize: 13, color: T.text }}>= (Pol / Brix) x 100</div>
          </div>
          <div style={{ padding: 12, background: T.card2, borderRadius: 8 }}>
            <div style={{ fontSize: 12, fontWeight: 600, color: T.purple, marginBottom: 4 }}>Rendimiento</div>
            <div style={{ fontSize: 13, color: T.text }}>= Pol x (1 - Fibra/100) x 0.7</div>
          </div>
          <div style={{ padding: 12, background: T.card2, borderRadius: 8 }}>
            <div style={{ fontSize: 12, fontWeight: 600, color: T.purple, marginBottom: 4 }}>Grado de Calidad</div>
            <div style={{ fontSize: 12, color: T.text }}>
              <span style={{ color: T.green }}>A: Pureza mayor o igual 85%</span>{' | '}
              <span style={{ color: T.blue }}>B: mayor o igual 75%</span>{' | '}
              <span style={{ color: T.orange }}>C: mayor o igual 65%</span>{' | '}
              <span style={{ color: T.red }}>D: menor a 65%</span>
            </div>
          </div>
        </G>
      </div>

      {/* Create/Edit Modal */}
      <Modal open={showModal} onClose={() => setShowModal(false)} title={editing ? 'Editar Muestra' : 'Nueva Muestra'} width={650}>
        <G cols={2} gap={12}>
          <Inp label="Código" value={form.codigo || ''} onChange={v => updateForm('codigo', v)} />
          <Inp label="Fecha" type="date" value={form.fecha || ''} onChange={v => updateForm('fecha', v)} />
          <Inp label="Origen (Finca)" value={form.origen || ''} onChange={v => updateForm('origen', v)} required
            options={['Finca El Progreso', 'Finca Santa Lucía', 'Finca Las Palmas', 'Finca San Cristóbal', 'Finca El Paraíso', 'Finca Los Laureles']} />
          <Inp label="Lote" value={form.lote || ''} onChange={v => updateForm('lote', v)} />
          <Inp label="Brix" type="number" value={form.brix || 0} onChange={v => updateForm('brix', Number(v))} />
          <Inp label="Pol" type="number" value={form.pol || 0} onChange={v => updateForm('pol', Number(v))} />
          <Inp label="Fibra (%)" type="number" value={form.fibra || 0} onChange={v => updateForm('fibra', Number(v))} />
          <Inp label="Analista" value={form.analista || ''} onChange={v => updateForm('analista', v)}
            options={['Rosa María Castillo', 'Juan Pablo Méndez']} />
        </G>
        <div style={{ marginTop: 16, padding: 16, background: T.card2, borderRadius: 10, border: `1px solid ${T.border}` }}>
          <div style={{ fontSize: 12, fontWeight: 600, color: T.subtle, textTransform: 'uppercase', marginBottom: 8 }}>Resultados Calculados Automáticamente</div>
          <G cols={3} gap={12}>
            <div style={{ textAlign: 'center', padding: 12, background: T.card, borderRadius: 8 }}>
              <div style={{ fontSize: 11, color: T.subtle }}>Pureza</div>
              <div style={{ fontSize: 22, fontWeight: 700, color: form.pureza >= 80 ? T.green : form.pureza >= 70 ? T.orange : T.red }}>{(form.pureza || 0).toFixed(2)}%</div>
            </div>
            <div style={{ textAlign: 'center', padding: 12, background: T.card, borderRadius: 8 }}>
              <div style={{ fontSize: 11, color: T.subtle }}>Rendimiento</div>
              <div style={{ fontSize: 22, fontWeight: 700, color: T.blue }}>{(form.rendimiento || 0).toFixed(2)}</div>
            </div>
            <div style={{ textAlign: 'center', padding: 12, background: T.card, borderRadius: 8 }}>
              <div style={{ fontSize: 11, color: T.subtle }}>Grado</div>
              <div style={{ fontSize: 28, fontWeight: 800, color: gradoColor[form.grado] || T.subtle }}>{form.grado || '-'}</div>
            </div>
          </G>
        </div>
        <Inp label="Observaciones" type="textarea" value={form.observaciones || ''} onChange={v => updateForm('observaciones', v)} style={{ marginTop: 12 }} />
        <div style={{ display: 'flex', gap: 8, justifyContent: 'flex-end', marginTop: 16 }}>
          <Btn variant="outline" onClick={() => setShowModal(false)}>Cancelar</Btn>
          <Btn onClick={save} color={T.purple}>{editing ? 'Guardar' : 'Registrar'}</Btn>
        </div>
      </Modal>
    </div>
  );
};


/* ============================================================
 *  MODULE: Nómina
 *  Payroll with IGSS 4.83% and ISR calculations (Guatemala)
 * ============================================================ */
const NominaMod = ({ data, setData }) => {
  const [showModal, setShowModal] = useState(false);
  const [showDetalle, setShowDetalle] = useState(false);
  const [editing, setEditing] = useState(null);
  const [form, setForm] = useState({});
  const [selectedNomina, setSelectedNomina] = useState(null);
  const toast = useToast();
  const confirm = useConfirm();
  const estadoColor = { borrador: T.subtle, aprobada: T.blue, pagada: T.green, anulada: T.red };

  /** Calculate IGSS employee deduction (4.83%) */
  const calcIGSS = (salario) => salario * 0.0483;

  /** Calculate ISR (Guatemala progressive rates) */
  const calcISR = (salarioAnual) => {
    const exento = 48000; // Annual exempt amount
    const base = Math.max(salarioAnual - exento, 0);
    if (base <= 300000) return base * 0.05;
    return 300000 * 0.05 + (base - 300000) * 0.07;
  };

  /** Calculate payroll for all employees */
  const calcNomina = (empleados, tipo) => {
    const factor = tipo === 'quincenal' ? 24 : 12;
    return empleados.map(e => {
      const salarioPeriodo = e.salario / (tipo === 'quincenal' ? 2 : 1);
      const igss = calcIGSS(salarioPeriodo);
      const isrAnual = calcISR(e.salario * 12);
      const isrPeriodo = isrAnual / factor;
      const deducciones = igss + isrPeriodo;
      const neto = salarioPeriodo - deducciones;
      return {
        ...e,
        salarioPeriodo: salarioPeriodo,
        igss: Math.round(igss * 100) / 100,
        isrPeriodo: Math.round(isrPeriodo * 100) / 100,
        deducciones: Math.round(deducciones * 100) / 100,
        neto: Math.round(neto * 100) / 100
      };
    });
  };

  const openNew = () => {
    setEditing(null);
    setForm({
      periodo: `2025-03 Q1`, tipo: 'quincenal', fechaInicio: '', fechaFin: '',
      estado: 'borrador', totalBruto: 0, totalIGSS: 0, totalISR: 0,
      totalDeducciones: 0, totalNeto: 0, aprobadoPor: '', fechaAprobacion: '',
      empleados: data.empleados.length
    });
    setShowModal(true);
  };
  const openEdit = (r) => { setEditing(r.id); setForm({ ...r }); setShowModal(true); };

  const save = () => {
    if (!form.periodo) { toast('Período requerido', 'error'); return; }
    const empleadosCalc = calcNomina(data.empleados.filter(e => e.estado === 'activo'), form.tipo);
    const totals = {
      totalBruto: sum(empleadosCalc, 'salarioPeriodo'),
      totalIGSS: sum(empleadosCalc, 'igss'),
      totalISR: sum(empleadosCalc, 'isrPeriodo'),
      totalDeducciones: sum(empleadosCalc, 'deducciones'),
      totalNeto: sum(empleadosCalc, 'neto'),
      empleados: empleadosCalc.length
    };
    const record = { ...form, ...totals };
    if (editing) {
      setData({ ...data, nominas: data.nominas.map(r => r.id === editing ? { ...r, ...record } : r) });
      toast('Nómina actualizada', 'success');
    } else {
      setData({ ...data, nominas: [...data.nominas, { ...record, id: uid() }] });
      toast('Nómina calculada y creada', 'success');
    }
    setShowModal(false);
  };

  const aprobar = async (id) => {
    if (await confirm('¿Aprobar esta nómina para pago?')) {
      setData({ ...data, nominas: data.nominas.map(n => n.id === id ? { ...n, estado: 'aprobada', aprobadoPor: 'Carlos Alberto Galarreta Morales', fechaAprobacion: today() } : n) });
      toast('Nómina aprobada', 'success');
    }
  };

  const pagar = async (id) => {
    if (await confirm('¿Marcar nómina como pagada?')) {
      setData({ ...data, nominas: data.nominas.map(n => n.id === id ? { ...n, estado: 'pagada' } : n) });
      toast('Nómina marcada como pagada', 'success');
    }
  };

  const remove = async (id) => {
    if (await confirm('¿Eliminar este período de nómina?')) {
      setData({ ...data, nominas: data.nominas.filter(r => r.id !== id) });
      toast('Nómina eliminada', 'success');
    }
  };

  const verDetalle = (nom) => {
    const empleadosCalc = calcNomina(data.empleados.filter(e => e.estado === 'activo'), nom.tipo);
    setSelectedNomina({ ...nom, detalle: empleadosCalc });
    setShowDetalle(true);
  };

  return (
    <div className="fade-in">
      <G cols={4} style={{ marginBottom: 16 }}>
        <K label="Total Bruto" value={fmtQ(sum(data.nominas, 'totalBruto'))} color={T.blue} icon={Icons.Banknote} />
        <K label="Total IGSS (4.83%)" value={fmtQ(sum(data.nominas, 'totalIGSS'))} color={T.orange} icon={Icons.CreditCard} />
        <K label="Total ISR" value={fmtQ(sum(data.nominas, 'totalISR'))} color={T.red} icon={Icons.DollarSign} />
        <K label="Total Neto" value={fmtQ(sum(data.nominas, 'totalNeto'))} color={T.green} icon={Icons.Banknote} />
      </G>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
        <h3 style={{ fontSize: 16, fontWeight: 600 }}>Períodos de Nómina</h3>
        <Btn onClick={openNew} size="sm" color={T.blue}><Icons.Plus size={14} />Nuevo Período</Btn>
      </div>
      <div style={{ background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, overflow: 'hidden' }}>
        <table>
          <thead><tr><th>Período</th><th>Tipo</th><th>Fechas</th><th>Emp.</th><th>Bruto</th><th>IGSS</th><th>ISR</th><th>Neto</th><th>Estado</th><th>Acciones</th></tr></thead>
          <tbody>
            {data.nominas.map(n => (
              <tr key={n.id}>
                <td style={{ fontWeight: 600 }}>{n.periodo}</td>
                <td><Badge color={n.tipo === 'quincenal' ? T.blue : T.purple}>{n.tipo}</Badge></td>
                <td style={{ fontSize: 12 }}>{fmtD(n.fechaInicio)} - {fmtD(n.fechaFin)}</td>
                <td>{n.empleados}</td>
                <td>{fmtQ(n.totalBruto)}</td>
                <td style={{ color: T.orange }}>{fmtQ(n.totalIGSS)}</td>
                <td style={{ color: T.red }}>{fmtQ(n.totalISR)}</td>
                <td style={{ fontWeight: 600, color: T.green }}>{fmtQ(n.totalNeto)}</td>
                <td><Badge color={estadoColor[n.estado]}>{n.estado}</Badge></td>
                <td>
                  <div style={{ display: 'flex', gap: 4 }}>
                    <button onClick={() => verDetalle(n)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }} title="Ver detalle"><Icons.Eye size={15} color={T.blue} /></button>
                    {n.estado === 'borrador' && <button onClick={() => aprobar(n.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }} title="Aprobar"><Icons.Check size={15} color={T.green} /></button>}
                    {n.estado === 'aprobada' && <button onClick={() => pagar(n.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }} title="Pagar"><Icons.Banknote size={15} color={T.green} /></button>}
                    <button onClick={() => openEdit(n)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}><Icons.Edit size={15} color={T.blue} /></button>
                    <button onClick={() => remove(n.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4 }}><Icons.Trash size={15} color={T.red} /></button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Calculation reference */}
      <div style={{ marginTop: 16, padding: 16, background: T.card, border: `1px solid ${T.border}`, borderRadius: 12 }}>
        <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 8 }}>Referencia de Cálculos - Guatemala</h3>
        <G cols={3} gap={16}>
          <div style={{ padding: 12, background: T.card2, borderRadius: 8 }}>
            <div style={{ fontSize: 12, fontWeight: 600, color: T.orange, marginBottom: 4 }}>IGSS Laboral</div>
            <div style={{ fontSize: 13 }}>4.83% del salario bruto</div>
            <div style={{ fontSize: 11, color: T.subtle, marginTop: 4 }}>Deducción obligatoria del empleado</div>
          </div>
          <div style={{ padding: 12, background: T.card2, borderRadius: 8 }}>
            <div style={{ fontSize: 12, fontWeight: 600, color: T.red, marginBottom: 4 }}>ISR Progresivo</div>
            <div style={{ fontSize: 13 }}>Exento: Q48,000/año</div>
            <div style={{ fontSize: 12, color: T.subtle }}>5% hasta Q300,000 | 7% excedente</div>
          </div>
          <div style={{ padding: 12, background: T.card2, borderRadius: 8 }}>
            <div style={{ fontSize: 12, fontWeight: 600, color: T.blue, marginBottom: 4 }}>Flujo de Aprobación</div>
            <div style={{ fontSize: 12, color: T.subtle }}>
              <Badge color={T.subtle}>borrador</Badge>{' -> '}
              <Badge color={T.blue}>aprobada</Badge>{' -> '}
              <Badge color={T.green}>pagada</Badge>
            </div>
          </div>
        </G>
      </div>

      {/* Create/Edit Modal */}
      <Modal open={showModal} onClose={() => setShowModal(false)} title={editing ? 'Editar Nómina' : 'Nueva Nómina'} width={500}>
        <G cols={2} gap={12}>
          <Inp label="Período" value={form.periodo || ''} onChange={v => setForm({ ...form, periodo: v })} required />
          <Inp label="Tipo" value={form.tipo || ''} onChange={v => setForm({ ...form, tipo: v })} options={['quincenal', 'mensual']} />
          <Inp label="Fecha Inicio" type="date" value={form.fechaInicio || ''} onChange={v => setForm({ ...form, fechaInicio: v })} />
          <Inp label="Fecha Fin" type="date" value={form.fechaFin || ''} onChange={v => setForm({ ...form, fechaFin: v })} />
          <Inp label="Estado" value={form.estado || ''} onChange={v => setForm({ ...form, estado: v })} options={['borrador', 'aprobada', 'pagada', 'anulada']} />
        </G>
        <div style={{ display: 'flex', gap: 8, justifyContent: 'flex-end', marginTop: 16 }}>
          <Btn variant="outline" onClick={() => setShowModal(false)}>Cancelar</Btn>
          <Btn onClick={save}>{editing ? 'Guardar' : 'Calcular y Crear'}</Btn>
        </div>
      </Modal>

      {/* Detail Modal */}
      <Modal open={showDetalle} onClose={() => setShowDetalle(false)} title={`Detalle Nómina: ${selectedNomina?.periodo || ''}`} width={900}>
        {selectedNomina && (
          <div style={{ overflowX: 'auto' }}>
            <table>
              <thead><tr><th>Empleado</th><th>Departamento</th><th>Salario Período</th><th>IGSS 4.83%</th><th>ISR</th><th>Deducciones</th><th>Neto a Pagar</th></tr></thead>
              <tbody>
                {(selectedNomina.detalle || []).map(e => (
                  <tr key={e.id}>
                    <td style={{ fontWeight: 600, fontSize: 13 }}>{e.nombre}</td>
                    <td><Badge color={T.blue}>{e.departamento}</Badge></td>
                    <td>{fmtQ(e.salarioPeriodo)}</td>
                    <td style={{ color: T.orange }}>{fmtQ(e.igss)}</td>
                    <td style={{ color: T.red }}>{fmtQ(e.isrPeriodo)}</td>
                    <td>{fmtQ(e.deducciones)}</td>
                    <td style={{ fontWeight: 600, color: T.green }}>{fmtQ(e.neto)}</td>
                  </tr>
                ))}
                <tr style={{ background: T.card2 }}>
                  <td colSpan={2} style={{ fontWeight: 700 }}>TOTALES</td>
                  <td style={{ fontWeight: 700 }}>{fmtQ(sum(selectedNomina.detalle, 'salarioPeriodo'))}</td>
                  <td style={{ fontWeight: 700, color: T.orange }}>{fmtQ(sum(selectedNomina.detalle, 'igss'))}</td>
                  <td style={{ fontWeight: 700, color: T.red }}>{fmtQ(sum(selectedNomina.detalle, 'isrPeriodo'))}</td>
                  <td style={{ fontWeight: 700 }}>{fmtQ(sum(selectedNomina.detalle, 'deducciones'))}</td>
                  <td style={{ fontWeight: 700, color: T.green }}>{fmtQ(sum(selectedNomina.detalle, 'neto'))}</td>
                </tr>
              </tbody>
            </table>
          </div>
        )}
      </Modal>
    </div>
  );
};

/* ============================================================
 *  MODULE: Portal Colonos
 *  Farmer registration and delivery tracking
 * ============================================================ */
const ColonosMod = ({ data, setData }) => {
  const [tab, setTab] = useState('colonos');
  const colonoColumns = [
    { key: 'nombre', label: 'Nombre', width: 200, render: v => <span style={{ fontWeight: 600 }}>{v}</span> },
    { key: 'dpi', label: 'DPI' },
    { key: 'finca', label: 'Finca', render: v => <Badge color={T.green}>{v}</Badge> },
    { key: 'hectareas', label: 'Hectáreas', render: v => <span style={{ fontWeight: 600 }}>{v} ha</span> },
    { key: 'variedad', label: 'Variedad' },
    { key: 'banco', label: 'Banco' },
    { key: 'estado', label: 'Estado', render: v => <Badge color={v === 'activo' ? T.green : T.red}>{v}</Badge> }
  ];
  const colonoFields = [
    { key: 'nombre', label: 'Nombre Completo', required: true, fullWidth: true },
    { key: 'dpi', label: 'DPI', required: true },
    { key: 'finca', label: 'Finca' },
    { key: 'hectareas', label: 'Hectáreas', type: 'number' },
    { key: 'variedad', label: 'Variedad Caña', options: ['CP 72-2086', 'MEX 79-431', 'SP 79-2233', 'RB 72-454', 'CG 98-78'] },
    { key: 'telefono', label: 'Teléfono' },
    { key: 'email', label: 'Email', type: 'email' },
    { key: 'banco', label: 'Banco', options: ['Banrural', 'Industrial', 'G&T Continental', 'BAM', 'Crédito Hipotecario'] },
    { key: 'cuenta', label: 'No. Cuenta' },
    { key: 'estado', label: 'Estado', options: ['activo', 'inactivo'] }
  ];
  const entregaColumns = [
    { key: 'colono', label: 'Colono', width: 180, render: v => <span style={{ fontWeight: 600 }}>{v}</span> },
    { key: 'fecha', label: 'Fecha', render: v => fmtD(v) },
    { key: 'toneladasBruta', label: 'Bruta', render: v => <span>{v} TM</span> },
    { key: 'tara', label: 'Tara' },
    { key: 'toneladasNeta', label: 'Neta', render: v => <span style={{ fontWeight: 600 }}>{v} TM</span> },
    { key: 'precioTonelada', label: 'Q/TM', render: v => fmtQ(v) },
    { key: 'total', label: 'Total', render: v => <span style={{ fontWeight: 600, color: T.green }}>{fmtQ(v)}</span> },
    { key: 'zafra', label: 'Zafra', render: v => <Badge color={T.blue}>{v}</Badge> },
    { key: 'estado', label: 'Estado', render: v => <Badge color={v === 'liquidada' ? T.green : v === 'pendiente' ? T.orange : T.subtle}>{v}</Badge> }
  ];
  const entregaFields = [
    { key: 'colono', label: 'Colono', required: true, options: data.colonos.map(c => ({ value: c.nombre, label: c.nombre })) },
    { key: 'fecha', label: 'Fecha', type: 'date' },
    { key: 'toneladasBruta', label: 'Toneladas Bruta', type: 'number' },
    { key: 'tara', label: 'Tara', type: 'number' },
    { key: 'toneladasNeta', label: 'Toneladas Neta', type: 'number' },
    { key: 'precioTonelada', label: 'Precio/Tonelada', type: 'number' },
    { key: 'total', label: 'Total (Q)', type: 'number' },
    { key: 'zafra', label: 'Zafra', options: data.zafras.map(z => ({ value: z.nombre, label: z.nombre })) },
    { key: 'estado', label: 'Estado', options: ['programada', 'pendiente', 'liquidada'] },
    { key: 'boleta', label: 'No. Boleta' }
  ];
  return (
    <div className="fade-in">
      <G cols={4} style={{ marginBottom: 16 }}>
        <K label="Colonos Activos" value={data.colonos.filter(c => c.estado === 'activo').length} color={T.teal} icon={Icons.UserCheck} />
        <K label="Hectáreas Totales" value={`${fmtN(sum(data.colonos.filter(c => c.estado === 'activo'), 'hectareas'))} ha`} color={T.green} icon={Icons.Leaf} />
        <K label="Entregas Período" value={data.entregas.length} color={T.blue} icon={Icons.Truck} />
        <K label="Total Liquidado" value={fmtQ(sum(data.entregas.filter(e => e.estado === 'liquidada'), 'total'))} color={T.green} icon={Icons.DollarSign} />
      </G>
      <Tabs tabs={[{ key: 'colonos', label: 'Colonos' }, { key: 'entregas', label: 'Entregas' }]} active={tab} onChange={setTab} />
      {tab === 'colonos' && <CrudModule title="Colono" icon={Icons.UserCheck} data={data.colonos}
        setData={v => setData({ ...data, colonos: v })} columns={colonoColumns} formFields={colonoFields}
        color={T.teal} emptyObj={{ nombre: '', dpi: '', finca: '', hectareas: 0, variedad: 'CP 72-2086', telefono: '', email: '', banco: 'Banrural', cuenta: '', estado: 'activo', creado: today() }} exportName="colonos" />}
      {tab === 'entregas' && <CrudModule title="Entrega" icon={Icons.Truck} data={data.entregas}
        setData={v => setData({ ...data, entregas: v })} columns={entregaColumns} formFields={entregaFields}
        color={T.green} emptyObj={{ colono: '', colonoId: '', fecha: today(), toneladasBruta: 0, tara: 0, toneladasNeta: 0, precioTonelada: 380, total: 0, zafra: 'Zafra 2025-2026', estado: 'pendiente', boleta: '' }} exportName="entregas" />}
    </div>
  );
};

/* ============================================================
 *  MODULE: Business Intelligence
 *  KPI snapshots, alerts, and aggregated metrics
 * ============================================================ */
const BIMod = ({ data }) => {
  const totalVentas = sum(data.facturas.filter(f => f.estado !== 'cotización' && f.estado !== 'borrador'), 'total');
  const totalCompras = sum(data.compras, 'total');
  const margen = totalVentas - totalCompras;
  const tonTransportadas = sum(data.viajes.filter(v => v.estado === 'completado'), 'toneladas');
  const avgPureza = avg(data.muestras, 'pureza');
  const equiposOp = data.equipos.filter(e => e.estado === 'operativo').length;

  const ventasTrend = [
    { mes: 'Sep', valor: 780000 }, { mes: 'Oct', valor: 850000 }, { mes: 'Nov', valor: 920000 },
    { mes: 'Dic', valor: 1050000 }, { mes: 'Ene', valor: 1180720 }, { mes: 'Feb', valor: 1280720 }
  ];
  const produccionDia = [
    { dia: 'Lun', toneladas: 145 }, { dia: 'Mar', toneladas: 158 }, { dia: 'Mie', toneladas: 132 },
    { dia: 'Jue', toneladas: 167 }, { dia: 'Vie', toneladas: 143 }, { dia: 'Sab', toneladas: 89 }
  ];

  return (
    <div className="fade-in">
      <div style={{ marginBottom: 16 }}>
        <h3 style={{ fontSize: 16, fontWeight: 700, marginBottom: 4 }}>Panel de Business Intelligence</h3>
        <p style={{ fontSize: 13, color: T.subtle }}>Métricas agregadas y análisis integral del sistema TransCaña</p>
      </div>
      <G cols={3} style={{ marginBottom: 16 }}>
        <K label="Ingresos Totales" value={fmtQ(totalVentas)} color={T.green} icon={Icons.TrendingUp} sub="Período actual" />
        <K label="Margen Operativo" value={fmtQ(margen)} color={margen > 0 ? T.green : T.red} icon={Icons.DollarSign} sub={`${((margen / totalVentas) * 100 || 0).toFixed(1)}% del ingreso`} />
        <K label="Pureza Lab." value={`${avgPureza.toFixed(1)}%`} color={avgPureza >= 80 ? T.green : T.orange} icon={Icons.Flask} />
      </G>
      <G cols={2} gap={16} style={{ marginBottom: 16 }}>
        <div style={{ background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, padding: 16 }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 12 }}>Tendencia de Ventas (Q)</h3>
          <ResponsiveContainer width="100%" height={220}>
            <AreaChart data={ventasTrend}>
              <CartesianGrid strokeDasharray="3 3" stroke={T.border} />
              <XAxis dataKey="mes" stroke={T.subtle} fontSize={12} />
              <YAxis stroke={T.subtle} fontSize={11} tickFormatter={v => `${(v / 1000).toFixed(0)}k`} />
              <Tooltip contentStyle={{ background: T.card2, border: `1px solid ${T.border}`, borderRadius: 8, color: T.text }} formatter={v => fmtQ(v)} />
              <Area type="monotone" dataKey="valor" stroke={T.green} fill={T.green + '33'} strokeWidth={2} />
            </AreaChart>
          </ResponsiveContainer>
        </div>
        <div style={{ background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, padding: 16 }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 12 }}>Producción Diaria (TM)</h3>
          <ResponsiveContainer width="100%" height={220}>
            <BarChart data={produccionDia}>
              <CartesianGrid strokeDasharray="3 3" stroke={T.border} />
              <XAxis dataKey="dia" stroke={T.subtle} fontSize={12} />
              <YAxis stroke={T.subtle} fontSize={11} />
              <Tooltip contentStyle={{ background: T.card2, border: `1px solid ${T.border}`, borderRadius: 8, color: T.text }} />
              <Bar dataKey="toneladas" fill={T.cyan} radius={[4, 4, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </G>
      <G cols={2} gap={16} style={{ marginBottom: 16 }}>
        <div style={{ background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, padding: 16 }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 12 }}>KPI Snapshots</h3>
          <table>
            <thead><tr><th>Fecha</th><th>Ventas</th><th>Margen</th><th>TM/Día</th><th>Equipos</th></tr></thead>
            <tbody>
              {data.biSnapshots.map(s => (
                <tr key={s.id}>
                  <td>{fmtD(s.fecha)}</td>
                  <td>{fmtQ(s.ventasMes)}</td>
                  <td style={{ color: T.green }}>{fmtQ(s.margen)}</td>
                  <td>{s.toneladasDia}</td>
                  <td>{s.equiposOperativos}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        <div style={{ background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, padding: 16 }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 12 }}>Alertas del Sistema</h3>
          <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
            {data.alertas.map(a => {
              const colores = { warning: T.orange, error: T.red, info: T.blue, success: T.green };
              return (
                <div key={a.id} style={{ display: 'flex', alignItems: 'flex-start', gap: 10, padding: 10, background: T.card2, borderRadius: 8, borderLeft: `3px solid ${colores[a.tipo]}`, opacity: a.leida ? 0.6 : 1 }}>
                  <Icons.AlertTriangle size={16} color={colores[a.tipo]} style={{ marginTop: 2, flexShrink: 0 }} />
                  <div>
                    <div style={{ fontSize: 13, fontWeight: a.leida ? 400 : 600 }}>{a.mensaje}</div>
                    <div style={{ fontSize: 11, color: T.subtle, marginTop: 2 }}>{a.modulo} | {fmtD(a.fecha)}</div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </G>
      <div style={{ background: T.card, border: `1px solid ${T.border}`, borderRadius: 12, padding: 16 }}>
        <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 12 }}>Resumen de Métricas Clave</h3>
        <G cols={4} gap={12}>
          <div style={{ padding: 12, background: T.card2, borderRadius: 8, textAlign: 'center' }}>
            <div style={{ fontSize: 11, color: T.subtle, textTransform: 'uppercase' }}>Facturación</div>
            <div style={{ fontSize: 20, fontWeight: 700, color: T.green }}>{fmtQ(totalVentas)}</div>
          </div>
          <div style={{ padding: 12, background: T.card2, borderRadius: 8, textAlign: 'center' }}>
            <div style={{ fontSize: 11, color: T.subtle, textTransform: 'uppercase' }}>Ton. Transportadas</div>
            <div style={{ fontSize: 20, fontWeight: 700, color: T.cyan }}>{fmtN(tonTransportadas)}</div>
          </div>
          <div style={{ padding: 12, background: T.card2, borderRadius: 8, textAlign: 'center' }}>
            <div style={{ fontSize: 11, color: T.subtle, textTransform: 'uppercase' }}>Calidad Promedio</div>
            <div style={{ fontSize: 20, fontWeight: 700, color: avgPureza >= 80 ? T.green : T.orange }}>{avgPureza.toFixed(1)}%</div>
          </div>
          <div style={{ padding: 12, background: T.card2, borderRadius: 8, textAlign: 'center' }}>
            <div style={{ fontSize: 11, color: T.subtle, textTransform: 'uppercase' }}>Equipos Operativos</div>
            <div style={{ fontSize: 20, fontWeight: 700, color: T.blue }}>{equiposOp}/{data.equipos.length}</div>
          </div>
        </G>
      </div>
    </div>
  );
};

/* ============================================================
 *  MODULE: Mantenimiento Industrial
 *  Equipment registry, work orders, and spare parts
 * ============================================================ */
const MantenimientoMod = ({ data, setData }) => {
  const [tab, setTab] = useState('equipos');
  const estadoEquipoColor = { operativo: T.green, mantenimiento: T.orange, fuera_servicio: T.red };
  const prioridadColor = { baja: T.subtle, media: T.blue, alta: T.orange, crítica: T.red };
  const estadoOTColor = { pendiente: T.orange, en_progreso: T.blue, en_espera: T.yellow, completada: T.green, cancelada: T.red };

  const equipoColumns = [
    { key: 'codigo', label: 'Código', render: v => <span style={{ fontWeight: 600, color: T.blue }}>{v}</span> },
    { key: 'nombre', label: 'Equipo', width: 180, render: v => <span style={{ fontWeight: 600 }}>{v}</span> },
    { key: 'tipo', label: 'Tipo', render: v => <Badge color={T.subtle}>{v}</Badge> },
    { key: 'estado', label: 'Estado', render: v => <Badge color={estadoEquipoColor[v]}>{v?.replace('_', ' ')}</Badge> },
    { key: 'fabricante', label: 'Fabricante' },
    { key: 'horasUso', label: 'Horas', render: v => <span>{fmtN(v)} hrs</span> },
    { key: 'ultimoMant', label: 'Últ. Mant.', render: v => fmtD(v) },
    { key: 'proximoMant', label: 'Próx. Mant.', render: v => fmtD(v) }
  ];
  const equipoFields = [
    { key: 'nombre', label: 'Nombre Equipo', required: true, fullWidth: true },
    { key: 'codigo', label: 'Código', required: true },
    { key: 'tipo', label: 'Tipo', options: ['producción', 'generación', 'pesaje', 'transporte', 'auxiliar'] },
    { key: 'ubicacion', label: 'Ubicación' },
    { key: 'estado', label: 'Estado', options: ['operativo', 'mantenimiento', 'fuera_servicio'] },
    { key: 'fabricante', label: 'Fabricante' },
    { key: 'modelo', label: 'Modelo' },
    { key: 'anio', label: 'Año', type: 'number' },
    { key: 'ultimoMant', label: 'Último Mant.', type: 'date' },
    { key: 'proximoMant', label: 'Próximo Mant.', type: 'date' },
    { key: 'horasUso', label: 'Horas Uso', type: 'number' },
    { key: 'observaciones', label: 'Observaciones', type: 'textarea', fullWidth: true }
  ];
  const otColumns = [
    { key: 'numero', label: 'OT', render: v => <span style={{ fontWeight: 600, color: T.blue }}>{v}</span> },
    { key: 'equipo', label: 'Equipo', width: 160 },
    { key: 'tipo', label: 'Tipo', render: v => <Badge color={v === 'correctivo' ? T.red : T.blue}>{v}</Badge> },
    { key: 'prioridad', label: 'Prior.', render: v => <Badge color={prioridadColor[v]}>{v}</Badge> },
    { key: 'descripcion', label: 'Descripción', width: 200, render: v => <span style={{ fontSize: 12 }}>{v?.substring(0, 60)}</span> },
    { key: 'asignado', label: 'Asignado', render: v => <span style={{ fontSize: 12 }}>{v?.split(' ').slice(0, 2).join(' ')}</span> },
    { key: 'estado', label: 'Estado', render: v => <Badge color={estadoOTColor[v]}>{v?.replace('_', ' ')}</Badge> },
    { key: 'costoEstimado', label: 'Costo Est.', render: v => fmtQ(v) },
    { key: 'costoReal', label: 'Costo Real', render: v => v ? fmtQ(v) : '-' }
  ];
  const otFields = [
    { key: 'numero', label: 'Número OT' },
    { key: 'equipo', label: 'Equipo', required: true, options: data.equipos.map(e => ({ value: e.nombre, label: e.nombre })) },
    { key: 'tipo', label: 'Tipo', options: ['preventivo', 'correctivo', 'predictivo'] },
    { key: 'prioridad', label: 'Prioridad', options: ['baja', 'media', 'alta', 'crítica'] },
    { key: 'descripcion', label: 'Descripción', type: 'textarea', fullWidth: true, required: true },
    { key: 'asignado', label: 'Asignado a' },
    { key: 'fechaCreacion', label: 'Fecha Creación', type: 'date' },
    { key: 'fechaInicio', label: 'Fecha Inicio', type: 'date' },
    { key: 'fechaFin', label: 'Fecha Fin', type: 'date' },
    { key: 'estado', label: 'Estado', options: ['pendiente', 'en_progreso', 'en_espera', 'completada', 'cancelada'] },
    { key: 'costoEstimado', label: 'Costo Estimado', type: 'number' },
    { key: 'costoReal', label: 'Costo Real', type: 'number' },
    { key: 'observaciones', label: 'Observaciones', type: 'textarea', fullWidth: true }
  ];
  const repuestoColumns = [
    { key: 'codigo', label: 'Código', render: v => <span style={{ fontWeight: 600, color: T.blue }}>{v}</span> },
    { key: 'nombre', label: 'Repuesto', width: 200, render: v => <span style={{ fontWeight: 600 }}>{v}</span> },
    { key: 'equipo', label: 'Equipo' },
    { key: 'stock', label: 'Stock', render: (v, r) => <span style={{ fontWeight: 600, color: v <= r.stockMin ? T.red : T.green }}>{v} {r.unidad}</span> },
    { key: 'stockMin', label: 'Mínimo' },
    { key: 'costo', label: 'Costo Unit.', render: v => fmtQ(v) },
    { key: 'proveedor', label: 'Proveedor', render: v => <span style={{ fontSize: 12 }}>{v}</span> },
    { key: 'ubicacion', label: 'Ubicación' }
  ];
  const repuestoFields = [
    { key: 'nombre', label: 'Nombre', required: true, fullWidth: true },
    { key: 'codigo', label: 'Código', required: true },
    { key: 'equipo', label: 'Equipo Asociado' },
    { key: 'stock', label: 'Stock Actual', type: 'number' },
    { key: 'stockMin', label: 'Stock Mínimo', type: 'number' },
    { key: 'unidad', label: 'Unidad', options: ['unidad', 'metro', 'litro', 'kg', 'cartucho'] },
    { key: 'costo', label: 'Costo Unitario', type: 'number' },
    { key: 'proveedor', label: 'Proveedor' },
    { key: 'ubicacion', label: 'Ubicación' }
  ];
  const repuestosBajos = data.repuestos.filter(r => r.stock <= r.stockMin);

  return (
    <div className="fade-in">
      <G cols={4} style={{ marginBottom: 16 }}>
        <K label="Equipos Operativos" value={`${data.equipos.filter(e => e.estado === 'operativo').length}/${data.equipos.length}`} color={T.green} icon={Icons.Wrench} />
        <K label="OT Abiertas" value={data.ordenesT.filter(o => o.estado !== 'completada' && o.estado !== 'cancelada').length} color={T.orange} icon={Icons.Clipboard} />
        <K label="En Mantenimiento" value={data.equipos.filter(e => e.estado === 'mantenimiento').length} color={T.yellow} icon={Icons.Settings} />
        <K label="Repuestos Bajo Stock" value={repuestosBajos.length} color={repuestosBajos.length > 0 ? T.red : T.green} icon={Icons.AlertTriangle} />
      </G>
      {repuestosBajos.length > 0 && (
        <div style={{ background: T.red + '15', border: `1px solid ${T.red}33`, borderRadius: 12, padding: 12, marginBottom: 16, display: 'flex', alignItems: 'center', gap: 12 }}>
          <Icons.AlertTriangle size={18} color={T.red} />
          <div style={{ fontSize: 13 }}>
            <span style={{ fontWeight: 600, color: T.red }}>Repuestos bajo stock: </span>
            <span style={{ color: T.text }}>{repuestosBajos.map(r => `${r.nombre} (${r.stock})`).join(', ')}</span>
          </div>
        </div>
      )}
      <Tabs tabs={[{ key: 'equipos', label: 'Equipos' }, { key: 'ot', label: 'Órdenes de Trabajo' }, { key: 'repuestos', label: 'Repuestos' }]} active={tab} onChange={setTab} />
      {tab === 'equipos' && <CrudModule title="Equipo" icon={Icons.Wrench} data={data.equipos}
        setData={v => setData({ ...data, equipos: v })} columns={equipoColumns} formFields={equipoFields}
        color={T.green} emptyObj={{ nombre: '', codigo: '', tipo: 'producción', ubicacion: '', estado: 'operativo', fabricante: '', modelo: '', anio: 2024, ultimoMant: today(), proximoMant: '', horasUso: 0, observaciones: '' }} exportName="equipos" />}
      {tab === 'ot' && <CrudModule title="Orden de Trabajo" icon={Icons.Clipboard} data={data.ordenesT}
        setData={v => setData({ ...data, ordenesT: v })} columns={otColumns} formFields={otFields}
        color={T.orange} emptyObj={{ numero: `OT-2025-${String(data.ordenesT.length + 1).padStart(3, '0')}`, equipo: '', tipo: 'preventivo', prioridad: 'media', descripcion: '', asignado: '', fechaCreacion: today(), fechaInicio: '', fechaFin: '', estado: 'pendiente', costoEstimado: 0, costoReal: 0, observaciones: '' }} exportName="ordenes_trabajo" />}
      {tab === 'repuestos' && <CrudModule title="Repuesto" icon={Icons.Package} data={data.repuestos}
        setData={v => setData({ ...data, repuestos: v })} columns={repuestoColumns} formFields={repuestoFields}
        color={T.blue} emptyObj={{ nombre: '', codigo: '', equipo: '', stock: 0, stockMin: 0, unidad: 'unidad', costo: 0, proveedor: '', ubicacion: '' }} exportName="repuestos" />}
    </div>
  );
};


/* ============================================================
 *  MAIN APPLICATION COMPONENT
 *  Routes all 17 modules and manages global state
 * ============================================================ */
const App = () => {
  // Authentication state
  const [user, setUser] = useState(LS.get('user', null));

  // Navigation state
  const [page, setPage] = useState(LS.get('page', 'dashboard'));

  // Sidebar collapsed state
  const [collapsed, setCollapsed] = useState(LS.get('collapsed', false));

  // Application data - initialize from localStorage or defaults
  const [data, setDataRaw] = useState(() => {
    const saved = LS.get('data', null);
    if (saved && saved.clientes && saved.zafras) {
      return saved;
    }
    // First load: merge core and TransCaña data
    const core = initData();
    const tc = initTransCana();
    return { ...core, ...tc };
  });

  // Persist data to localStorage on every change
  const setData = (newData) => {
    setDataRaw(newData);
    LS.set('data', newData);
  };

  // Persist navigation state
  useEffect(() => { LS.set('page', page); }, [page]);
  useEffect(() => { LS.set('collapsed', collapsed); }, [collapsed]);

  // Authentication handlers
  const handleLogin = (u) => {
    setUser(u);
    LS.set('user', u);
  };

  const handleLogout = () => {
    setUser(null);
    LS.set('user', null);
  };

  // Navigation handler
  const handleNav = (p) => setPage(p);

  // Sidebar toggle
  const toggleCollapse = () => setCollapsed(!collapsed);

  // Show login screen if not authenticated
  if (!user) {
    return <LoginScreen onLogin={handleLogin} />;
  }

  // Page title mapping
  const pageTitle = {
    dashboard:     'Dashboard',
    ventas:        'Ventas / Facturación',
    compras:       'Compras',
    inventario:    'Inventario',
    clientes:      'Clientes',
    rrhh:          'Recursos Humanos',
    crm:           'CRM - Gestión de Relaciones',
    contabilidad:  'Contabilidad',
    proveedores:   'Proveedores',
    ordenes:       'Órdenes de Compra',
    zafra:         'Planificación de Zafra',
    logistica:     'Logística de Transporte',
    laboratorio:   'Laboratorio de Calidad',
    nomina:        'Nómina y Planilla',
    colonos:       'Portal de Colonos',
    bi:            'Business Intelligence',
    mantenimiento: 'Mantenimiento Industrial'
  };

  const sidebarWidth = collapsed ? 64 : 260;

  // Render the active module
  const renderPage = () => {
    switch (page) {
      case 'dashboard':
        return <DashboardMod data={data} />;
      case 'ventas':
        return <VentasMod data={data} setData={setData} />;
      case 'compras':
        return <ComprasMod data={data} setData={setData} />;
      case 'inventario':
        return <InventarioMod data={data} setData={setData} />;
      case 'clientes':
        return <ClientesMod data={data} setData={setData} />;
      case 'rrhh':
        return <RRHHMod data={data} setData={setData} />;
      case 'crm':
        return <CRMMod data={data} setData={setData} />;
      case 'contabilidad':
        return <ContabilidadMod data={data} setData={setData} />;
      case 'proveedores':
        return <ProveedoresMod data={data} setData={setData} />;
      case 'ordenes':
        return <OrdenesMod data={data} setData={setData} />;
      case 'zafra':
        return <ZafraMod data={data} setData={setData} />;
      case 'logistica':
        return <LogisticaMod data={data} setData={setData} />;
      case 'laboratorio':
        return <LaboratorioMod data={data} setData={setData} />;
      case 'nomina':
        return <NominaMod data={data} setData={setData} />;
      case 'colonos':
        return <ColonosMod data={data} setData={setData} />;
      case 'bi':
        return <BIMod data={data} />;
      case 'mantenimiento':
        return <MantenimientoMod data={data} setData={setData} />;
      default:
        return <DashboardMod data={data} />;
    }
  };

  return (
    <ToastProvider>
      <ConfirmProvider>
        <div style={{ display: 'flex', minHeight: '100vh', background: T.bg }}>
          {/* Sidebar */}
          <Sidebar
            active={page}
            onNav={handleNav}
            collapsed={collapsed}
            onToggle={toggleCollapse}
            user={user}
          />

          {/* Main content area */}
          <div style={{
            flex: 1,
            marginLeft: sidebarWidth,
            transition: 'margin-left 0.3s ease'
          }}>
            {/* Top bar */}
            <TopBar
              title={pageTitle[page] || 'TransCaña ERPremium'}
              onLogout={handleLogout}
              sidebarWidth={sidebarWidth}
            />

            {/* Page content */}
            <div style={{
              padding: 24,
              paddingTop: 80,
              minHeight: '100vh'
            }}>
              {renderPage()}
            </div>

            {/* Footer */}
            <div style={{
              padding: '16px 24px',
              borderTop: `1px solid ${T.border}`,
              textAlign: 'center'
            }}>
              <span style={{ fontSize: 11, color: T.subtle }}>
                TransCaña ERPremium v2.0 | Sistema ERP para Industria Azucarera
                {' | '}Guatemala | Powered by InnovaQ Solution
                {' | '}&copy; {new Date().getFullYear()}
              </span>
            </div>
          </div>
        </div>
      </ConfirmProvider>
    </ToastProvider>
  );
};

/* ============================================================
 *  MOUNT APPLICATION
 * ============================================================ */
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(App));

  </script>
</body>
</html>
