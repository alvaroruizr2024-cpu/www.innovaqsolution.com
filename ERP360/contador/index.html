<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SumaERP · Portal Contador</title>
    <meta name="description" content="SumaERP - Portal Contador · Vista consolidada">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>Σ</text></svg>">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>* { margin: 0; padding: 0; box-sizing: border-box; } html, body, #root { width: 100%; height: 100%; }</style>
</head>
<body style="background:#05070c;color:#d6e0f0;font-family:DM Sans,sans-serif">
    <div id="root"><div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#4a6080;font-size:14px">Cargando Portal Contador...</div></div>
    <script type="text/babel">
const { useState, useEffect, useMemo } = React;
const P = { bg:"#05070c",c1:"#0a0e17",c2:"#0f1520",bd:"#1a2540",tx:"#d6e0f0",s1:"#8095b3",s2:"#4a6080",blue:"#0A84FF",grn:"#32D74B",org:"#FF9F0A",red:"#FF453A",pur:"#BF5AF2",cyan:"#64D2FF",yel:"#FFD60A",tl:"#2AC7B8" };
const nn = v => (typeof v === "number" ? v : parseFloat(v) || 0);
const \$ = (v) => "S/ " + Math.abs(nn(v)).toLocaleString("es-PE",{minimumFractionDigits:2,maximumFractionDigits:2});
const SUPA_URL = "https://uinoropxppiuqgzktqjr.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVpbm9yb3B4cHBpdXFnemt0cWpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NjU0MTUsImV4cCI6MjA4NTE0MTQxNX0.V9sTNqTC_aldhwgE6RF66BEXfRvTF6jDLqm1WvbInTo";
const Badge = ({s}) => { const cm={Emitida:P.blue,Pagada:P.grn,Pendiente:P.org,Pagado:P.grn,Anulada:P.red,"Aprobado IA":P.grn}; const c=cm[s]||P.s2; return <span style={{fontSize:8,padding:"1px 6px",borderRadius:4,background:c+"15",color:c,fontWeight:600}}>{s}</span>; };

function ContadorPortal() {
  const [loading, setLoading] = useState(true);
  const [empresas, setEmpresas] = useState([]);
  const [erpData, setErpData] = useState([]);
  const [scannedDocs, setScannedDocs] = useState([]);
  const [filtroEmpresa, setFiltroEmpresa] = useState("todas");
  const [tab, setTab] = useState("resumen");
  const [error, setError] = useState(null);

  const loadAll = async () => {
    setLoading(true);
    try {
      const sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);
      const [empRes, dataRes, docsRes] = await Promise.all([
        sb.from("erp_empresas").select("*").order("razon_social"),
        sb.from("erp_data").select("*").order("created_at",{ascending:false}),
        sb.from("erp_scanned_docs").select("*").order("created_at",{ascending:false})
      ]);
      if(empRes.data) setEmpresas(empRes.data);
      if(dataRes.data) setErpData(dataRes.data);
      if(docsRes.data) setScannedDocs(docsRes.data);
      setError(null);
    } catch(e) { setError(e.message); }
    setLoading(false);
  };
  useEffect(() => { loadAll(); }, []);

  const eMap = useMemo(() => { const m={}; empresas.forEach(e => m[e.ruc]=e.razon_social); return m; }, [empresas]);
  const facturas = useMemo(() => erpData.filter(d => d.tabla==="facturas").map(d => ({...d.data,_emp:d.empresa_ruc,_at:d.created_at})), [erpData]);
  const compras = useMemo(() => erpData.filter(d => d.tabla==="compras").map(d => ({...d.data,_emp:d.empresa_ruc,_at:d.created_at})), [erpData]);
  const docs = useMemo(() => scannedDocs.map(d => ({...d.data,_emp:d.empresa_ruc,_at:d.created_at})), [scannedDocs]);
  const fF = useMemo(() => filtroEmpresa==="todas"?facturas:facturas.filter(f=>f._emp===filtroEmpresa), [facturas,filtroEmpresa]);
  const fC = useMemo(() => filtroEmpresa==="todas"?compras:compras.filter(c=>c._emp===filtroEmpresa), [compras,filtroEmpresa]);
  const fD = useMemo(() => filtroEmpresa==="todas"?docs:docs.filter(d=>d._emp===filtroEmpresa), [docs,filtroEmpresa]);
  const uEmps = useMemo(() => { const s=new Set([...erpData.map(d=>d.empresa_ruc),...scannedDocs.map(d=>d.empresa_ruc)]); return Array.from(s).map(r=>({ruc:r,razon:eMap[r]||r})).sort((a,b)=>a.razon.localeCompare(b.razon)); }, [erpData,scannedDocs,eMap]);
  const tV=fF.reduce((a,f)=>a+nn(f.total),0), tC=fC.reduce((a,c)=>a+nn(c.total),0);
  const tID=fF.reduce((a,f)=>a+nn(f.igv),0), tIC=fC.reduce((a,c)=>a+nn(c.igv),0);
  const cH={padding:"5px 7px",color:P.s2,fontSize:8,fontWeight:700,borderBottom:\`1px solid \${P.bd}\`,textAlign:"left",textTransform:"uppercase",whiteSpace:"nowrap"};
  const cS={padding:"4px 7px",fontSize:10,borderBottom:\`1px solid \${P.bd}08\`};

  const Tbl = ({data,cols,empty}) => (
    <div style={{background:P.c1,border:\`1px solid \${P.bd}\`,borderRadius:8,overflow:"hidden"}}><div style={{overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse"}}><thead><tr>{cols.map(c=><th key={c.k} style={{...cH,textAlign:c.r?"right":"left"}}>{c.l}</th>)}</tr></thead><tbody>{data.length===0?<tr><td colSpan={cols.length} style={{padding:24,textAlign:"center",color:P.s2,fontSize:11}}>{empty}</td></tr>:data.map((row,i)=><tr key={row.id||i}>{cols.map(c=><td key={c.k} style={{...cS,textAlign:c.r?"right":"left",fontFamily:c.mono?"monospace":"inherit",color:c.color||P.tx,fontWeight:c.b?700:400}}>{c.fmt?c.fmt(row[c.k]):c.render?c.render(row):row[c.k]}</td>)}</tr>)}</tbody></table></div></div>
  );

  if(loading) return (<div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:12,background:P.bg}}><div style={{width:40,height:40,border:\`3px solid \${P.bd}\`,borderTopColor:P.pur,borderRadius:"50%",animation:"spin .8s linear infinite"}}/><div style={{fontSize:12,color:P.s2}}>Cargando datos de Supabase...</div><style>{\`@keyframes spin{to{transform:rotate(360deg)}}\`}</style></div>);

  return (
    <div style={{display:"flex",height:"100vh",background:P.bg,fontFamily:"'DM Sans',sans-serif",color:P.tx,overflow:"hidden",fontSize:13}}>
      <aside style={{width:200,background:"linear-gradient(180deg,#080c15,#050710)",borderRight:\`1px solid \${P.bd}\`,display:"flex",flexDirection:"column",flexShrink:0}}>
        <div style={{padding:"10px 9px",borderBottom:\`1px solid \${P.bd}\`,display:"flex",alignItems:"center",gap:6}}>
          <div style={{width:26,height:26,borderRadius:6,background:"linear-gradient(135deg,#BF5AF2,#0A84FF)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:13,fontWeight:800,color:"#fff"}}>Σ</div>
          <div><div style={{fontSize:11,fontWeight:700}}>SumaERP</div><div style={{fontSize:7,color:P.s2,fontWeight:600}}>Portal Contador</div></div>
        </div>
        <div style={{flex:1,padding:"8px 6px",display:"flex",flexDirection:"column",gap:2}}>
          {[{id:"resumen",l:"Resumen General"},{id:"ventas",l:"Ventas (Todas)"},{id:"compras",l:"Compras (Todas)"},{id:"escaneados",l:"Docs Escaneados"}].map(n=>(
            <div key={n.id} onClick={()=>setTab(n.id)} style={{display:"flex",alignItems:"center",gap:7,padding:"7px 8px",borderRadius:6,cursor:"pointer",fontSize:11,fontWeight:tab===n.id?600:400,background:tab===n.id?P.pur+"12":"transparent",color:tab===n.id?P.pur:P.s1,borderLeft:tab===n.id?\`2px solid \${P.pur}\`:"2px solid transparent"}}>{n.l}</div>
          ))}
        </div>
        <div style={{padding:"8px 6px",borderTop:\`1px solid \${P.bd}\`}}>
          <div style={{fontSize:8,color:P.s2,marginBottom:4}}>FILTRAR EMPRESA</div>
          <select value={filtroEmpresa} onChange={e=>setFiltroEmpresa(e.target.value)} style={{width:"100%",background:P.c2,border:\`1px solid \${P.bd}\`,borderRadius:4,padding:"4px 6px",color:P.tx,fontSize:9,fontFamily:"inherit"}}>
            <option value="todas">Todas las empresas</option>
            {uEmps.map(e=><option key={e.ruc} value={e.ruc}>{e.razon}</option>)}
          </select>
        </div>
      </aside>
      <main style={{flex:1,overflow:"auto",padding:16,scrollbarWidth:"thin"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <div><div style={{fontSize:16,fontWeight:800}}>{tab==="resumen"?"Resumen General":tab==="ventas"?"Ventas Consolidadas":tab==="compras"?"Compras Consolidadas":"Documentos Escaneados"}</div><div style={{fontSize:10,color:P.s2}}>Portal Contador · {erpData.length} registros · {scannedDocs.length} docs escaneados</div></div>
          <button onClick={loadAll} style={{padding:"6px 12px",fontSize:11,fontWeight:600,borderRadius:6,cursor:"pointer",border:\`1px solid \${P.bd}\`,background:P.pur+"15",color:P.pur,fontFamily:"inherit"}}>↻ Actualizar</button>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:8,marginBottom:14}}>
          {[{l:"Total Ventas",v:\$(tV),c:P.grn},{l:"Total Compras",v:\$(tC),c:P.org},{l:"IGV Débito",v:\$(tID),c:P.red},{l:"IGV Crédito",v:\$(tIC),c:P.blue},{l:"Crédito Fiscal",v:\$(tID-tIC),c:tID-tIC>=0?P.red:P.grn}].map((k,i)=>(
            <div key={i} style={{background:P.c1,border:\`1px solid \${P.bd}\`,borderRadius:8,padding:12}}><div style={{fontSize:9,color:P.s2,marginBottom:3}}>{k.l}</div><div style={{fontSize:18,fontWeight:800,color:k.c}}>{k.v}</div></div>
          ))}
        </div>
        {tab==="resumen"&&<Tbl data={uEmps.map(e=>{const ef=facturas.filter(f=>f._emp===e.ruc),ec=compras.filter(c=>c._emp===e.ruc),ed=docs.filter(d=>d._emp===e.ruc);return{ruc:e.ruc,razon:e.razon,ventas:ef.reduce((a,f)=>a+nn(f.total),0),comprasT:ec.reduce((a,c)=>a+nn(c.total),0),nF:ef.length,nC:ec.length,nD:ed.length};})} cols={[{k:"ruc",l:"RUC",mono:1,color:P.cyan},{k:"razon",l:"Empresa",b:1},{k:"nF",l:"Facturas",r:1},{k:"ventas",l:"Total Ventas",r:1,fmt:v=>\$(v),color:P.grn},{k:"nC",l:"Compras",r:1},{k:"comprasT",l:"Total Compras",r:1,fmt:v=>\$(v),color:P.org},{k:"nD",l:"Docs IA",r:1}]} empty="Sin datos"/>}
        {tab==="ventas"&&<Tbl data={fF} cols={[{k:"_emp",l:"Empresa",render:r=><span style={{fontSize:9}}><span style={{color:P.cyan,fontFamily:"monospace"}}>{r._emp}</span> <span style={{color:P.s1}}>{eMap[r._emp]||""}</span></span>},{k:"serie",l:"Serie",mono:1,color:"#5B9CF6",b:1},{k:"numero",l:"Num",mono:1},{k:"fecha",l:"Fecha"},{k:"tipo",l:"Tipo"},{k:"cliente",l:"Cliente"},{k:"moneda",l:"Mon",color:P.yel},{k:"subtotal",l:"Base",r:1,fmt:v=>\$(v)},{k:"igv",l:"IGV",r:1,fmt:v=>\$(v)},{k:"total",l:"Total",r:1,b:1,fmt:v=>\$(v)},{k:"estado",l:"Estado",render:r=><Badge s={r.estado}/>}]} empty="Sin ventas"/>}
        {tab==="compras"&&<Tbl data={fC} cols={[{k:"_emp",l:"Empresa",render:r=><span style={{fontSize:9}}><span style={{color:P.cyan,fontFamily:"monospace"}}>{r._emp}</span> <span style={{color:P.s1}}>{eMap[r._emp]||""}</span></span>},{k:"serie",l:"Serie",mono:1,color:"#5B9CF6",b:1},{k:"numero",l:"Num",mono:1},{k:"fecha",l:"Fecha"},{k:"tipo",l:"Tipo"},{k:"proveedor",l:"Proveedor"},{k:"moneda",l:"Mon",color:P.yel},{k:"subtotal",l:"Base",r:1,fmt:v=>\$(v)},{k:"igv",l:"IGV",r:1,fmt:v=>\$(v)},{k:"total",l:"Total",r:1,b:1,fmt:v=>\$(v)},{k:"estado",l:"Estado",render:r=><Badge s={r.estado}/>}]} empty="Sin compras"/>}
        {tab==="escaneados"&&<Tbl data={fD} cols={[{k:"_emp",l:"Empresa",render:r=><span style={{fontSize:9}}><span style={{color:P.cyan,fontFamily:"monospace"}}>{r._emp}</span> <span style={{color:P.s1}}>{eMap[r._emp]||""}</span></span>},{k:"serie",l:"Serie",mono:1},{k:"numero",l:"Num",mono:1},{k:"fecha",l:"Fecha"},{k:"tipo",l:"Tipo CDP"},{k:"archivo",l:"Archivo"},{k:"total",l:"Total",r:1,b:1,fmt:v=>\$(v)},{k:"scanIA",l:"IA",render:r=><Badge s={r.scanIA}/>},{k:"modulo",l:"Módulo"}]} empty="Sin documentos escaneados"/>}
        {error&&<div style={{marginTop:12,padding:10,background:P.red+"10",border:\`1px solid \${P.red}30\`,borderRadius:6,fontSize:10,color:P.red}}>Error: {error}</div>}
      </main>
    </div>
  );
}
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(ContadorPortal));
    </script>
</body>
</html>
